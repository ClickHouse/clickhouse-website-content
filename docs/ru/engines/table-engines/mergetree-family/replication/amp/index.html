<!doctype html><html ⚡ lang=ru> <head><meta charset=utf-8><script async src=https://cdn.ampproject.org/v0.js></script><title>Репликация данных | Документация ClickHouse</title><link href=https://clickhouse.tech/docs/ru/engines/table-engines/mergetree-family/replication/ rel=canonical><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><script type=application/ld+json>[{
"@context": "http://schema.org",
"@type": "TechArticle",
"headline": "Репликация данных | Документация ClickHouse",
"mainEntityOfPage": "https://clickhouse.tech/docs/ru/engines/table-engines/mergetree-family/replication/",




"image": "https://clickhouse.tech/images/logo-209x60.png",
"author": {
  "@type": "Project",
  "name": "ClickHouse"
},
"publisher": {
  "@type": "Organization",
  "name": "Yandex LLC",
  "logo": {
    "@type": "ImageObject",
    "url": "https://clickhouse.tech/images/yandex.png",
    "width": 163,
    "height": 60
  }
}}, {
"@context": "http://schema.org",
"@type": "Episode",
"name": "Репликация данных | Документация ClickHouse",
"aggregateRating": {
  "@type": "AggregateRating",
  "ratingValue": RATING_VALUE,
  "ratingCount": RATING_COUNT
}
}]</script><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><style amp-custom>:root{--blue:#007bff;--indigo:#6610f2;--purple:#6f42c1;--pink:#e83e8c;--red:#dc3545;--orange:#fd7e14;--yellow:#ffc107;--green:#28a745;--teal:#20c997;--cyan:#17a2b8;--white:#fff;--gray:#6c757d;--gray-dark:#343a40;--primary:#007bff;--secondary:#6c757d;--success:#28a745;--info:#17a2b8;--warning:#ffc107;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--breakpoint-xs:0;--breakpoint-sm:576px;--breakpoint-md:768px;--breakpoint-lg:992px;--breakpoint-xl:1200px;--font-family-sans-serif:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-family-monospace:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}*,::after,::before{box-sizing:border-box}html{font-family:sans-serif;line-height:1.15;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}article,footer{display:block}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;text-align:left;background-color:#fff}[tabindex="-1"]:focus:not(:focus-visible){outline:0}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem}p{margin-top:0;margin-bottom:1rem}ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}b,strong{font-weight:bolder}a{color:#007bff;text-decoration:none;background-color:transparent}a:hover{color:#0056b3;text-decoration:underline}a:not([href]){color:inherit;text-decoration:none}a:not([href]):hover{color:inherit;text-decoration:none}code,pre{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em}pre{margin-top:0;margin-bottom:1rem;overflow:auto}img{vertical-align:middle;border-style:none}svg{overflow:hidden;vertical-align:middle}table{border-collapse:collapse}select{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}select{text-transform:none}select{word-wrap:normal}[type=button],[type=reset],[type=submit]{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled){cursor:pointer}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{padding:0;border-style:none}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:none}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}summary{display:list-item;cursor:pointer}[hidden]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:500;line-height:1.2}.h1,h1{font-size:2rem}.h2,h2{font-size:1.5rem}.h3,h3{font-size:1.25rem}.h4,h4{font-size:1rem}.h5,h5{font-size:1rem}.h6,h6{font-size:1rem}.display-1{font-size:6rem;font-weight:300;line-height:1.2}.display-2{font-size:5.5rem;font-weight:300;line-height:1.2}.display-3{font-size:4.5rem;font-weight:300;line-height:1.2}.display-4{font-size:3.5rem;font-weight:300;line-height:1.2}.img-fluid{max-width:100%;height:auto}code{font-size:87.5%;color:#e83e8c;word-wrap:break-word}a>code{color:inherit}pre{display:block;font-size:87.5%;color:#212529}pre code{font-size:inherit;color:inherit;word-break:normal}.container{width:100%;padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media(min-width:576px){.container{max-width:540px}}@media(min-width:768px){.container{max-width:720px}}@media(min-width:992px){.container{max-width:960px}}@media(min-width:1200px){.container{max-width:1140px}}.container-fluid,.container-lg,.container-md{width:100%;padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media(min-width:576px){.container{max-width:540px}}@media(min-width:768px){.container,.container-md{max-width:720px}}@media(min-width:992px){.container,.container-lg,.container-md{max-width:960px}}@media(min-width:1200px){.container,.container-lg,.container-md{max-width:1140px}}.row{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-15px;margin-left:-15px}.col,.col-1,.col-10,.col-11,.col-12,.col-2,.col-3,.col-4,.col-5,.col-6,.col-7,.col-8,.col-9,.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9{position:relative;width:100%;padding-right:15px;padding-left:15px}.col{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-0{-ms-flex-order:0;order:0}.order-1{-ms-flex-order:1;order:1}.order-2{-ms-flex-order:2;order:2}.order-3{-ms-flex-order:3;order:3}.order-4{-ms-flex-order:4;order:4}.order-5{-ms-flex-order:5;order:5}.order-6{-ms-flex-order:6;order:6}.order-7{-ms-flex-order:7;order:7}.order-8{-ms-flex-order:8;order:8}.order-9{-ms-flex-order:9;order:9}.order-10{-ms-flex-order:10;order:10}.order-11{-ms-flex-order:11;order:11}.order-12{-ms-flex-order:12;order:12}@media(min-width:768px){.col-md{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-md-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-md-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-md-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-md-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-md-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-md-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-md-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-md-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-md-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-md-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-md-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-md-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-md-0{-ms-flex-order:0;order:0}.order-md-1{-ms-flex-order:1;order:1}.order-md-2{-ms-flex-order:2;order:2}.order-md-3{-ms-flex-order:3;order:3}.order-md-4{-ms-flex-order:4;order:4}.order-md-5{-ms-flex-order:5;order:5}.order-md-6{-ms-flex-order:6;order:6}.order-md-7{-ms-flex-order:7;order:7}.order-md-8{-ms-flex-order:8;order:8}.order-md-9{-ms-flex-order:9;order:9}.order-md-10{-ms-flex-order:10;order:10}.order-md-11{-ms-flex-order:11;order:11}.order-md-12{-ms-flex-order:12;order:12}}@media(min-width:992px){.col-lg{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-lg-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-lg-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-lg-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-lg-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-lg-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-lg-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-lg-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-lg-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-lg-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-lg-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-lg-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-lg-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-lg-0{-ms-flex-order:0;order:0}.order-lg-1{-ms-flex-order:1;order:1}.order-lg-2{-ms-flex-order:2;order:2}.order-lg-3{-ms-flex-order:3;order:3}.order-lg-4{-ms-flex-order:4;order:4}.order-lg-5{-ms-flex-order:5;order:5}.order-lg-6{-ms-flex-order:6;order:6}.order-lg-7{-ms-flex-order:7;order:7}.order-lg-8{-ms-flex-order:8;order:8}.order-lg-9{-ms-flex-order:9;order:9}.order-lg-10{-ms-flex-order:10;order:10}.order-lg-11{-ms-flex-order:11;order:11}.order-lg-12{-ms-flex-order:12;order:12}}.table{width:100%;margin-bottom:1rem;color:#212529}.table-warning{background-color:#ffeeba}.table-light{background-color:#fdfdfe}.table-dark{background-color:#c6c8ca}.table-dark{color:#fff;background-color:#343a40}.btn{display:inline-block;font-weight:400;color:#212529;text-align:center;vertical-align:middle;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background-color:transparent;border:1px solid transparent;padding:.375rem .75rem;font-size:1rem;line-height:1.5;border-radius:.25rem}@media(prefers-reduced-motion:reduce){.btn{transition:none}}.btn:hover{color:#212529;text-decoration:none}.btn:focus{outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.btn:disabled{opacity:.65}.btn-warning{color:#212529;background-color:#ffc107;border-color:#ffc107}.btn-warning:hover{color:#212529;background-color:#e0a800;border-color:#d39e00}.btn-warning:focus{color:#212529;background-color:#e0a800;border-color:#d39e00;box-shadow:0 0 0 .2rem rgba(222,170,12,.5)}.btn-warning:disabled{color:#212529;background-color:#ffc107;border-color:#ffc107}.btn-light{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-light:hover{color:#212529;background-color:#e2e6ea;border-color:#dae0e5}.btn-light:focus{color:#212529;background-color:#e2e6ea;border-color:#dae0e5;box-shadow:0 0 0 .2rem rgba(216,217,219,.5)}.btn-light:disabled{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-dark{color:#fff;background-color:#343a40;border-color:#343a40}.btn-dark:hover{color:#fff;background-color:#23272b;border-color:#1d2124}.btn-dark:focus{color:#fff;background-color:#23272b;border-color:#1d2124;box-shadow:0 0 0 .2rem rgba(82,88,93,.5)}.btn-dark:disabled{color:#fff;background-color:#343a40;border-color:#343a40}.btn-outline-warning{color:#ffc107;border-color:#ffc107}.btn-outline-warning:hover{color:#212529;background-color:#ffc107;border-color:#ffc107}.btn-outline-warning:focus{box-shadow:0 0 0 .2rem rgba(255,193,7,.5)}.btn-outline-warning:disabled{color:#ffc107;background-color:transparent}.btn-outline-light{color:#f8f9fa;border-color:#f8f9fa}.btn-outline-light:hover{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-outline-light:focus{box-shadow:0 0 0 .2rem rgba(248,249,250,.5)}.btn-outline-light:disabled{color:#f8f9fa;background-color:transparent}.btn-outline-dark{color:#343a40;border-color:#343a40}.btn-outline-dark:hover{color:#fff;background-color:#343a40;border-color:#343a40}.btn-outline-dark:focus{box-shadow:0 0 0 .2rem rgba(52,58,64,.5)}.btn-outline-dark:disabled{color:#343a40;background-color:transparent}.btn-link{font-weight:400;color:#007bff;text-decoration:none}.btn-link:hover{color:#0056b3;text-decoration:underline}.btn-link:focus{text-decoration:underline;box-shadow:none}.btn-link:disabled{color:#6c757d;pointer-events:none}.btn-lg{padding:.5rem 1rem;font-size:1.25rem;line-height:1.5;border-radius:.3rem}.btn-block{display:block;width:100%}.btn-block+.btn-block{margin-top:.5rem}.custom-select{display:inline-block;width:100%;height:calc(1.5em+.75rem+2px);padding:.375rem 1.75rem .375rem .75rem;font-size:1rem;font-weight:400;line-height:1.5;color:#495057;vertical-align:middle;background:#fff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='4' height='5' viewBox='0 0 4 5'%3e%3cpath fill='%23343a40' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e") no-repeat right .75rem center/8px 10px;border:1px solid #ced4da;border-radius:.25rem;-webkit-appearance:none;-moz-appearance:none;appearance:none}.custom-select:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.custom-select:focus::-ms-value{color:#495057;background-color:#fff}.custom-select[multiple],.custom-select[size]:not([size="1"]){height:auto;padding-right:.75rem;background-image:none}.custom-select:disabled{color:#6c757d;background-color:#e9ecef}.custom-select::-ms-expand{display:none}.custom-select:-moz-focusring{color:transparent;text-shadow:0 0 0 #495057}.custom-select-lg{height:calc(1.5em+1rem+2px);padding-top:.5rem;padding-bottom:.5rem;padding-left:1rem;font-size:1.25rem}@media(prefers-reduced-motion:reduce){.custom-select{transition:none}}.alert{position:relative;padding:.75rem 1.25rem;margin-bottom:1rem;border:1px solid transparent;border-radius:.25rem}.alert-heading{color:inherit}.alert-link{font-weight:700}.alert-warning{color:#856404;background-color:#fff3cd;border-color:#ffeeba}.alert-warning .alert-link{color:#533f03}.alert-light{color:#818182;background-color:#fefefe;border-color:#fdfdfe}.alert-light .alert-link{color:#686868}.alert-dark{color:#1b1e21;background-color:#d6d8d9;border-color:#c6c8ca}.alert-dark .alert-link{color:#040505}@-webkit-keyframes progress-bar-stripes{from{background-position:1rem 0}to{background-position:0 0}}@keyframes progress-bar-stripes{from{background-position:1rem 0}to{background-position:0 0}}@-webkit-keyframes spinner-border{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spinner-border{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-webkit-keyframes spinner-grow{0%{-webkit-transform:scale(0);transform:scale(0)}50%{opacity:1}}@keyframes spinner-grow{0%{-webkit-transform:scale(0);transform:scale(0)}50%{opacity:1}}.bg-warning{background-color:#ffc107}a.bg-warning:focus,a.bg-warning:hover{background-color:#d39e00}.bg-light{background-color:#f8f9fa}a.bg-light:focus,a.bg-light:hover{background-color:#dae0e5}.bg-dark{background-color:#343a40}a.bg-dark:focus,a.bg-dark:hover{background-color:#1d2124}.bg-white{background-color:#fff}.d-none{display:none}.d-inline{display:inline}.d-inline-block{display:inline-block}.d-block{display:block}.d-table{display:table}.d-table-row{display:table-row}@media(min-width:768px){.d-md-none{display:none}.d-md-inline{display:inline}.d-md-inline-block{display:inline-block}.d-md-block{display:block}.d-md-table{display:table}.d-md-table-row{display:table-row}}@media(min-width:992px){.d-lg-none{display:none}.d-lg-inline{display:inline}.d-lg-inline-block{display:inline-block}.d-lg-block{display:block}.d-lg-table{display:table}.d-lg-table-row{display:table-row}}.float-right{float:right}.float-none{float:none}@media(min-width:768px){.float-md-right{float:right}.float-md-none{float:none}}@media(min-width:992px){.float-lg-right{float:right}.float-lg-none{float:none}}.fixed-bottom{position:fixed;right:0;bottom:0;left:0;z-index:1030}.h-25{height:25%}.h-50{height:50%}.h-75{height:75%}.h-100{height:100%}.my-0{margin-top:0}.mr-0{margin-right:0}.mb-0,.my-0{margin-bottom:0}.my-1{margin-top:.25rem}.mr-1{margin-right:.25rem}.mb-1,.my-1{margin-bottom:.25rem}.my-2{margin-top:.5rem}.mr-2{margin-right:.5rem}.mb-2,.my-2{margin-bottom:.5rem}.my-3{margin-top:1rem}.mr-3{margin-right:1rem}.mb-3,.my-3{margin-bottom:1rem}.my-4{margin-top:1.5rem}.mr-4{margin-right:1.5rem}.mb-4,.my-4{margin-bottom:1.5rem}.my-5{margin-top:3rem}.mr-5{margin-right:3rem}.mb-5,.my-5{margin-bottom:3rem}.p-0{padding:0}.pt-0,.py-0{padding-top:0}.pb-0,.py-0{padding-bottom:0}.p-1{padding:.25rem}.pt-1,.py-1{padding-top:.25rem}.pb-1,.py-1{padding-bottom:.25rem}.p-2{padding:.5rem}.pt-2,.py-2{padding-top:.5rem}.pb-2,.py-2{padding-bottom:.5rem}.p-3{padding:1rem}.pt-3,.py-3{padding-top:1rem}.pb-3,.py-3{padding-bottom:1rem}.p-4{padding:1.5rem}.pt-4,.py-4{padding-top:1.5rem}.pb-4,.py-4{padding-bottom:1.5rem}.p-5{padding:3rem}.pt-5,.py-5{padding-top:3rem}.pb-5,.py-5{padding-bottom:3rem}.my-n1{margin-top:-.25rem}.mr-n1{margin-right:-.25rem}.mb-n1,.my-n1{margin-bottom:-.25rem}.my-n2{margin-top:-.5rem}.mr-n2{margin-right:-.5rem}.mb-n2,.my-n2{margin-bottom:-.5rem}.my-n3{margin-top:-1rem}.mr-n3{margin-right:-1rem}.mb-n3,.my-n3{margin-bottom:-1rem}.my-n4{margin-top:-1.5rem}.mr-n4{margin-right:-1.5rem}.mb-n4,.my-n4{margin-bottom:-1.5rem}.my-n5{margin-top:-3rem}.mr-n5{margin-right:-3rem}.mb-n5,.my-n5{margin-bottom:-3rem}@media(min-width:768px){.my-md-0{margin-top:0}.mr-md-0{margin-right:0}.mb-md-0,.my-md-0{margin-bottom:0}.my-md-1{margin-top:.25rem}.mr-md-1{margin-right:.25rem}.mb-md-1,.my-md-1{margin-bottom:.25rem}.my-md-2{margin-top:.5rem}.mr-md-2{margin-right:.5rem}.mb-md-2,.my-md-2{margin-bottom:.5rem}.my-md-3{margin-top:1rem}.mr-md-3{margin-right:1rem}.mb-md-3,.my-md-3{margin-bottom:1rem}.my-md-4{margin-top:1.5rem}.mr-md-4{margin-right:1.5rem}.mb-md-4,.my-md-4{margin-bottom:1.5rem}.my-md-5{margin-top:3rem}.mr-md-5{margin-right:3rem}.mb-md-5,.my-md-5{margin-bottom:3rem}.p-md-0{padding:0}.pt-md-0,.py-md-0{padding-top:0}.pb-md-0,.py-md-0{padding-bottom:0}.p-md-1{padding:.25rem}.pt-md-1,.py-md-1{padding-top:.25rem}.pb-md-1,.py-md-1{padding-bottom:.25rem}.p-md-2{padding:.5rem}.pt-md-2,.py-md-2{padding-top:.5rem}.pb-md-2,.py-md-2{padding-bottom:.5rem}.p-md-3{padding:1rem}.pt-md-3,.py-md-3{padding-top:1rem}.pb-md-3,.py-md-3{padding-bottom:1rem}.p-md-4{padding:1.5rem}.pt-md-4,.py-md-4{padding-top:1.5rem}.pb-md-4,.py-md-4{padding-bottom:1.5rem}.p-md-5{padding:3rem}.pt-md-5,.py-md-5{padding-top:3rem}.pb-md-5,.py-md-5{padding-bottom:3rem}.my-md-n1{margin-top:-.25rem}.mr-md-n1{margin-right:-.25rem}.mb-md-n1,.my-md-n1{margin-bottom:-.25rem}.my-md-n2{margin-top:-.5rem}.mr-md-n2{margin-right:-.5rem}.mb-md-n2,.my-md-n2{margin-bottom:-.5rem}.my-md-n3{margin-top:-1rem}.mr-md-n3{margin-right:-1rem}.mb-md-n3,.my-md-n3{margin-bottom:-1rem}.my-md-n4{margin-top:-1.5rem}.mr-md-n4{margin-right:-1.5rem}.mb-md-n4,.my-md-n4{margin-bottom:-1.5rem}.my-md-n5{margin-top:-3rem}.mr-md-n5{margin-right:-3rem}.mb-md-n5,.my-md-n5{margin-bottom:-3rem}}@media(min-width:992px){.my-lg-0{margin-top:0}.mr-lg-0{margin-right:0}.mb-lg-0,.my-lg-0{margin-bottom:0}.my-lg-1{margin-top:.25rem}.mr-lg-1{margin-right:.25rem}.mb-lg-1,.my-lg-1{margin-bottom:.25rem}.my-lg-2{margin-top:.5rem}.mr-lg-2{margin-right:.5rem}.mb-lg-2,.my-lg-2{margin-bottom:.5rem}.my-lg-3{margin-top:1rem}.mr-lg-3{margin-right:1rem}.mb-lg-3,.my-lg-3{margin-bottom:1rem}.my-lg-4{margin-top:1.5rem}.mr-lg-4{margin-right:1.5rem}.mb-lg-4,.my-lg-4{margin-bottom:1.5rem}.my-lg-5{margin-top:3rem}.mr-lg-5{margin-right:3rem}.mb-lg-5,.my-lg-5{margin-bottom:3rem}.p-lg-0{padding:0}.pt-lg-0,.py-lg-0{padding-top:0}.pb-lg-0,.py-lg-0{padding-bottom:0}.p-lg-1{padding:.25rem}.pt-lg-1,.py-lg-1{padding-top:.25rem}.pb-lg-1,.py-lg-1{padding-bottom:.25rem}.p-lg-2{padding:.5rem}.pt-lg-2,.py-lg-2{padding-top:.5rem}.pb-lg-2,.py-lg-2{padding-bottom:.5rem}.p-lg-3{padding:1rem}.pt-lg-3,.py-lg-3{padding-top:1rem}.pb-lg-3,.py-lg-3{padding-bottom:1rem}.p-lg-4{padding:1.5rem}.pt-lg-4,.py-lg-4{padding-top:1.5rem}.pb-lg-4,.py-lg-4{padding-bottom:1.5rem}.p-lg-5{padding:3rem}.pt-lg-5,.py-lg-5{padding-top:3rem}.pb-lg-5,.py-lg-5{padding-bottom:3rem}.my-lg-n1{margin-top:-.25rem}.mr-lg-n1{margin-right:-.25rem}.mb-lg-n1,.my-lg-n1{margin-bottom:-.25rem}.my-lg-n2{margin-top:-.5rem}.mr-lg-n2{margin-right:-.5rem}.mb-lg-n2,.my-lg-n2{margin-bottom:-.5rem}.my-lg-n3{margin-top:-1rem}.mr-lg-n3{margin-right:-1rem}.mb-lg-n3,.my-lg-n3{margin-bottom:-1rem}.my-lg-n4{margin-top:-1.5rem}.mr-lg-n4{margin-right:-1.5rem}.mb-lg-n4,.my-lg-n4{margin-bottom:-1.5rem}.my-lg-n5{margin-top:-3rem}.mr-lg-n5{margin-right:-3rem}.mb-lg-n5,.my-lg-n5{margin-bottom:-3rem}}.text-right{text-align:right}.text-center{text-align:center}@media(min-width:768px){.text-md-right{text-align:right}.text-md-center{text-align:center}}@media(min-width:992px){.text-lg-right{text-align:right}.text-lg-center{text-align:center}}.text-white{color:#fff}.text-warning{color:#ffc107}a.text-warning:focus,a.text-warning:hover{color:#ba8b00}.text-light{color:#f8f9fa}a.text-light:focus,a.text-light:hover{color:#cbd3da}.text-dark{color:#343a40}a.text-dark:focus,a.text-dark:hover{color:#121416}.text-body{color:#212529}.text-muted{color:#6c757d}.text-black-50{color:rgba(0,0,0,.5)}.text-white-50{color:rgba(255,255,255,.5)}.text-hide{font:0/0 a;color:transparent;text-shadow:none;background-color:transparent;border:0}.text-decoration-none{text-decoration:none}.text-reset{color:inherit}.visible{visibility:visible}@media print{*,::after,::before{text-shadow:none;box-shadow:none}a:not(.btn){text-decoration:underline}pre{white-space:pre-wrap}pre{border:1px solid #adb5bd;page-break-inside:avoid}img{page-break-inside:avoid}h2,h3,p{orphans:3;widows:3}h2,h3{page-break-after:avoid}@page{size:a3}body{min-width:992px}.container{min-width:992px}.table{border-collapse:collapse}.table-dark{color:inherit}}@-webkit-keyframes sbx-reset-in{0%{-webkit-transform:translate3d(-20%,0,0);transform:translate3d(-20%,0,0);opacity:0}100%{-webkit-transform:none;transform:none;opacity:1}}@keyframes sbx-reset-in{0%{-webkit-transform:translate3d(-20%,0,0);transform:translate3d(-20%,0,0);opacity:0}100%{-webkit-transform:none;transform:none;opacity:1}}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}a:link,a:visited{color:#f14600;text-decoration:none}a:active,a:hover{text-decoration:underline}.btn:disabled{cursor:default;opacity:.4}#logo-text{width:180px;margin-left:12px}.display-5{font-size:2rem;font-weight:300;line-height:1.2}.display-6{font-size:1.75rem;font-weight:300;line-height:1.2}.bg-dark-alt,.bg-dark-alt:focus{background:#36363f}.bg-orange,.bg-orange:focus{background:#f14600}.text-dark-alt{color:#36363f}.btn-dark-alt{background:#36363f}.btn-dark-alt:focus{background:#36363f}.btn-outline-orange{border-color:#f14600;color:#f14600}.btn-orange,.btn-outline-orange:hover{background:#f14600;color:#fff}.btn:active,.btn:hover{text-decoration:none}.text-orange{color:#f14600}details{background:#444451;color:#eee;padding:1rem;margin-bottom:1rem;margin-top:1rem}summary{font-weight:700;color:#eee}.headerlink{text-decoration:none;margin-left:.5rem}#content table{border:1px solid #dee2e6;width:100%;margin-bottom:1rem;overflow-x:auto}#content code{color:#000;background:#eee;padding:.125rem .25rem}#content code.syntax{padding:0}#content pre{background:#efefef;padding:1rem;line-height:1.25}@media print{body{min-width:0}code,h1,h2,h3,h4,h5,h6,img,li,p,pre{page-break-inside:avoid}}@media(prefers-color-scheme:dark){#to-full-website,body.amp,body[data-spy]{background:#1c1c1c;color:#efefef}.invert-dark{filter:invert(100%)}#content table{border:1px solid #2a2b2c}#content code{background:#444;color:#eee;padding:.125rem .25rem}#content pre{background:#444;color:#eee}}.syntax{background:#f8f9fa;color:#2f1e2e}.syntax .k{color:#000;font-weight:700}.syntax .n{color:#2f1e2e}.syntax .o{color:#800}.syntax .p{color:#2f1e2e}.syntax .ld{color:#48b685}.syntax .s{color:#48b685}.syntax .na{color:#06b6ef}.syntax .py{color:#2f1e2e}.syntax .nt{color:#5bc4bf}.syntax .mi{color:#08f}.syntax .sc{color:#2f1e2e}.syntax .s2{color:#48b685}.syntax .s1{color:#080}@media(prefers-color-scheme:dark){.syntax .k{color:#c78cff}.syntax .ld{color:#64ffbb}.syntax .s{color:#64ffbb}.syntax .s2{color:#64ffbb}.syntax .s1{color:#64ffbb}.syntax .n{color:#f8f9fa}.syntax .p{color:#f8f9fa}.syntax .py{color:#f8f9fa}.syntax .sc{color:#f8f9fa}}</style><script async custom-element=amp-analytics src=https://cdn.ampproject.org/v0/amp-analytics-0.1.js></script><script async custom-element=amp-iframe src=https://cdn.ampproject.org/v0/amp-iframe-0.1.js></script></head> <body class=amp dir=ltr> <div class="container-fluid container-lg pb-5"> <div class="row pt-3 mb-3"> <div class=col> <a href=/ class=text-decoration-none> <amp-img class="d-inline-block mr-3" layout=fixed width=40 height=36 src=/images/logo.svg alt="ClickHouse logo" title="ClickHouse logo"></amp-img><amp-img class="invert-dark d-inline-block" layout=fixed width=238 height=36 src=/images/clickhouse-black.svg alt=ClickHouse title=ClickHouse></amp-img> </a> </div> </div> <div class=row> <div id=content class=col> <h1 id=table_engines-replication>Репликация данных<a class=headerlink href=../amp/#table_engines-replication title="Permanent link"> </a></h1> <p>Репликация поддерживается только для таблиц семейства MergeTree:</p> <ul> <li>ReplicatedMergeTree</li> <li>ReplicatedSummingMergeTree</li> <li>ReplicatedReplacingMergeTree</li> <li>ReplicatedAggregatingMergeTree</li> <li>ReplicatedCollapsingMergeTree</li> <li>ReplicatedVersionedCollapsingMergeTree</li> <li>ReplicatedGraphiteMergeTree</li> </ul> <p>Репликация работает на уровне отдельных таблиц, а не всего сервера. То есть, на сервере могут быть расположены одновременно реплицируемые и не реплицируемые таблицы.</p> <p>Репликация не зависит от шардирования. На каждом шарде репликация работает независимо.</p> <p>Реплицируются сжатые данные запросов <code class=syntax>INSERT</code>, <code class=syntax>ALTER</code> (см. подробности в описании запроса <a href=../../../../../sql-reference/statements/alter/amp/#query_language_queries_alter>ALTER</a>).</p> <p>Запросы <code class=syntax>CREATE</code>, <code class=syntax>DROP</code>, <code class=syntax>ATTACH</code>, <code class=syntax>DETACH</code> и <code class=syntax>RENAME</code> выполняются на одном сервере и не реплицируются:</p> <ul> <li>Запрос <code class=syntax>CREATE TABLE</code> создаёт новую реплицируемую таблицу на том сервере, где его выполнили. Если таблица уже существует на других серверах, запрос добавляет новую реплику.</li> <li><code class=syntax>DROP TABLE</code> удаляет реплику, расположенную на том сервере, где выполняется запрос.</li> <li>Запрос <code class=syntax>RENAME</code> переименовывает таблицу на одной реплик. Другими словами, реплицируемые таблицы на разных репликах могут называться по-разному.</li> </ul> <p>ClickHouse хранит метаинформацию о репликах в <a href=https://zookeeper.apache.org rel="external nofollow noreferrer" target=_blank>Apache ZooKeeper</a>. Используйте ZooKeeper 3.4.5 или новее.</p> <p>Для использовании репликации, установите параметры в секции <a href=../../../../../operations/server-configuration-parameters/settings/amp/#server-settings_zookeeper>zookeeper</a> конфигурации сервера.</p> <div class="admonition attention alert pb-0 mb-4 alert-warning" role=alert> <p class="admonition-title alert-heading display-6 mb-2">Внимание</p> <p>Не пренебрегайте настройками безопасности. ClickHouse поддерживает <a class=alert-link href=https://zookeeper.apache.org/doc/current/zookeeperProgrammers.html#sc_ZooKeeperAccessControl rel="external nofollow noreferrer" target=_blank>ACL схему</a> <code class=syntax>digest</code> подсистемы безопасности ZooKeeper.</p> </div> <p>Пример указания адресов кластера ZooKeeper:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=nt>&lt;zookeeper&gt;</span>
    <span class=nt>&lt;node</span> <span class=na>index=</span><span class=s>"1"</span><span class=nt>&gt;</span>
        <span class=nt>&lt;host&gt;</span>example1<span class=nt>&lt;/host&gt;</span>
        <span class=nt>&lt;port&gt;</span>2181<span class=nt>&lt;/port&gt;</span>
    <span class=nt>&lt;/node&gt;</span>
    <span class=nt>&lt;node</span> <span class=na>index=</span><span class=s>"2"</span><span class=nt>&gt;</span>
        <span class=nt>&lt;host&gt;</span>example2<span class=nt>&lt;/host&gt;</span>
        <span class=nt>&lt;port&gt;</span>2181<span class=nt>&lt;/port&gt;</span>
    <span class=nt>&lt;/node&gt;</span>
    <span class=nt>&lt;node</span> <span class=na>index=</span><span class=s>"3"</span><span class=nt>&gt;</span>
        <span class=nt>&lt;host&gt;</span>example3<span class=nt>&lt;/host&gt;</span>
        <span class=nt>&lt;port&gt;</span>2181<span class=nt>&lt;/port&gt;</span>
    <span class=nt>&lt;/node&gt;</span>
<span class=nt>&lt;/zookeeper&gt;</span>
</code></pre></div> <p>Можно указать любой имеющийся у вас ZooKeeper-кластер - система будет использовать в нём одну директорию для своих данных (директория указывается при создании реплицируемой таблицы).</p> <p>Если в конфигурационном файле не настроен ZooKeeper, то вы не сможете создать реплицируемые таблицы, а уже имеющиеся реплицируемые таблицы будут доступны в режиме только на чтение.</p> <p>При запросах <code class=syntax>SELECT</code>, ZooKeeper не используется, т.е. репликация не влияет на производительность <code class=syntax>SELECT</code> и запросы работают так же быстро, как и для нереплицируемых таблиц. При запросах к распределенным реплицированным таблицам поведение ClickHouse регулируется настройками <a href=../../../../../operations/settings/settings/amp/#settings-max_replica_delay_for_distributed_queries>max_replica_delay_for_distributed_queries</a> and <a href=../../../../../operations/settings/settings/amp/ >fallback_to_stale_replicas_for_distributed_queries</a>.</p> <p>При каждом запросе <code class=syntax>INSERT</code>, делается около десятка записей в ZooKeeper в рамках нескольких транзакций. (Чтобы быть более точным, это для каждого вставленного блока данных; запрос INSERT содержит один блок или один блок на <code class=syntax>max_insert_block_size = 1048576</code> строк.) Это приводит к некоторому увеличению задержек при <code class=syntax>INSERT</code>, по сравнению с нереплицируемыми таблицами. Но если придерживаться обычных рекомендаций - вставлять данные пачками не более одного <code class=syntax>INSERT</code> в секунду, то это не составляет проблем. На всём кластере ClickHouse, использующим для координации один кластер ZooKeeper, может быть в совокупности несколько сотен <code class=syntax>INSERT</code> в секунду. Пропускная способность при вставке данных (количество строчек в секунду) такая же высокая, как для нереплицируемых таблиц.</p> <p>Для очень больших кластеров, можно использовать разные кластеры ZooKeeper для разных шардов. Впрочем, на кластере Яндекс.Метрики (примерно 300 серверов) такой необходимости не возникает.</p> <p>Репликация асинхронная, мульти-мастер. Запросы <code class=syntax>INSERT</code> и <code class=syntax>ALTER</code> можно направлять на любой доступный сервер. Данные вставятся на сервер, где выполнен запрос, а затем скопируются на остальные серверы. В связи с асинхронностью, только что вставленные данные появляются на остальных репликах с небольшой задержкой. Если часть реплик недоступна, данные на них запишутся тогда, когда они станут доступны. Если реплика доступна, то задержка составляет столько времени, сколько требуется для передачи блока сжатых данных по сети. Количество потоков для выполнения фоновых задач можно задать с помощью настройки <a href=../../../../../operations/settings/settings/amp/#background_schedule_pool_size>background_schedule_pool_size</a>.</p> <p>По умолчанию, запрос INSERT ждёт подтверждения записи только от одной реплики. Если данные были успешно записаны только на одну реплику, и сервер с этой репликой перестал существовать, то записанные данные будут потеряны. Вы можете включить подтверждение записи от нескольких реплик, используя настройку <code class=syntax>insert_quorum</code>.</p> <p>Каждый блок данных записывается атомарно. Запрос INSERT разбивается на блоки данных размером до <code class=syntax>max_insert_block_size = 1048576</code> строк. То есть, если в запросе <code class=syntax>INSERT</code> менее 1048576 строк, то он делается атомарно.</p> <p>Блоки данных дедуплицируются. При многократной записи одного и того же блока данных (блоков данных одинакового размера, содержащих одни и те же строчки в одном и том же порядке), блок будет записан только один раз. Это сделано для того, чтобы в случае сбоя в сети, когда клиентское приложение не может понять, были ли данные записаны в БД, можно было просто повторить запрос <code class=syntax>INSERT</code>. При этом не имеет значения, на какую реплику будут отправлены INSERT-ы с одинаковыми данными. Запрос <code class=syntax>INSERT</code> идемпотентный. Параметры дедуплицирования регулируются настройками сервера <a href=../../../../../operations/server-configuration-parameters/settings/amp/#server_configuration_parameters-merge_tree>merge_tree</a></p> <p>При репликации, по сети передаются только исходные вставляемые данные. Дальнейшие преобразования данных (слияния) координируются и делаются на всех репликах одинаковым образом. За счёт этого минимизируется использование сети, и благодаря этому, репликация хорошо работает при расположении реплик в разных дата-центрах. (Стоит заметить, что дублирование данных в разных дата-центрах, по сути, является основной задачей репликации).</p> <p>Количество реплик одних и тех же данных может быть произвольным. В Яндекс.Метрике в продакшене используется двукратная репликация. На каждом сервере используется RAID-5 или RAID-6, в некоторых случаях RAID-10. Это является сравнительно надёжным и удобным для эксплуатации решением.</p> <p>Система следит за синхронностью данных на репликах и умеет восстанавливаться после сбоя. Восстановление после сбоя автоматическое (в случае небольших различий в данных) или полуавтоматическое (когда данные отличаются слишком сильно, что может свидетельствовать об ошибке конфигурации).</p> <h2 id=creating-replicated-tables>Создание реплицируемых таблиц<a class=headerlink href=../amp/#creating-replicated-tables title="Permanent link"> </a></h2> <p>В начало имени движка таблицы добавляется <code class=syntax>Replicated</code>. Например, <code class=syntax>ReplicatedMergeTree</code>.</p> <p><strong>Параметры Replicated*MergeTree</strong></p> <ul> <li><code class=syntax>zoo_path</code> — путь к таблице в ZooKeeper.</li> <li><code class=syntax>replica_name</code> — имя реплики в ZooKeeper.</li> <li><code class=syntax>other_parameters</code> — параметры движка, для которого создаётся реплицированная версия, например, версия для <code class=syntax>ReplacingMergeTree</code>.</li> </ul> <p>Пример:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=k>table_name</span>
<span class=p>(</span>
    <span class=n>EventDate</span> <span class=n>DateTime</span><span class=p>,</span>
    <span class=n>CounterID</span> <span class=n>UInt32</span><span class=p>,</span>
    <span class=n>UserID</span> <span class=n>UInt32</span><span class=p>,</span>
    <span class=n>ver</span> <span class=n>UInt16</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>ReplicatedReplacingMergeTree</span><span class=p>(</span><span class=s1>'/clickhouse/tables/{layer}-{shard}/table_name'</span><span class=p>,</span> <span class=s1>'{replica}'</span><span class=p>,</span> <span class=n>ver</span><span class=p>)</span>
<span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>toYYYYMM</span><span class=p>(</span><span class=n>EventDate</span><span class=p>)</span>
<span class=k>ORDER</span> <span class=k>BY</span> <span class=p>(</span><span class=n>CounterID</span><span class=p>,</span> <span class=n>EventDate</span><span class=p>,</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>))</span>
<span class=n>SAMPLE</span> <span class=k>BY</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>)</span>
</code></pre></div> <details><summary>Пример в устаревшем синтаксисе</summary> <p></p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=k>table_name</span>
<span class=p>(</span>
    <span class=n>EventDate</span> <span class=n>DateTime</span><span class=p>,</span>
    <span class=n>CounterID</span> <span class=n>UInt32</span><span class=p>,</span>
    <span class=n>UserID</span> <span class=n>UInt32</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>ReplicatedMergeTree</span><span class=p>(</span><span class=s1>'/clickhouse/tables/{layer}-{shard}/table_name'</span><span class=p>,</span> <span class=s1>'{replica}'</span><span class=p>,</span> <span class=n>EventDate</span><span class=p>,</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>),</span> <span class=p>(</span><span class=n>CounterID</span><span class=p>,</span> <span class=n>EventDate</span><span class=p>,</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>),</span> <span class=n>EventTime</span><span class=p>),</span> <span class=mi>8192</span><span class=p>)</span>
</code></pre></div> </details> <p>Как видно в примере, эти параметры могут содержать подстановки в фигурных скобках. Подставляемые значения достаются из конфигурационного файла, из секции «<a href=../../../../operations/server-configuration-parameters/settings/amp/#macros>macros</a>». </p> <p>Пример:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=nt>&lt;macros&gt;</span>
    <span class=nt>&lt;layer&gt;</span>05<span class=nt>&lt;/layer&gt;</span>
    <span class=nt>&lt;shard&gt;</span>02<span class=nt>&lt;/shard&gt;</span>
    <span class=nt>&lt;replica&gt;</span>example05-02-1.yandex.ru<span class=nt>&lt;/replica&gt;</span>
<span class=nt>&lt;/macros&gt;</span>
</code></pre></div> <p>Путь к таблице в ZooKeeper должен быть разным для каждой реплицируемой таблицы. В том числе, для таблиц на разных шардах, должны быть разные пути.<br> В данном случае, путь состоит из следующих частей:</p> <p><code class=syntax>/clickhouse/tables/</code> — общий префикс. Рекомендуется использовать именно его.</p> <p><code class=syntax>{layer}-{shard}</code> — идентификатор шарда. В данном примере он состоит из двух частей, так как на кластере Яндекс.Метрики используется двухуровневое шардирование. Для большинства задач, оставьте только подстановку {shard}, которая будет раскрываться в идентификатор шарда.</p> <p><code class=syntax>table_name</code> - имя узла для таблицы в ZooKeeper. Разумно делать его таким же, как имя таблицы. Оно указывается явно, так как, в отличие от имени таблицы, оно не меняется после запроса RENAME.<br> <em>Подсказка</em>: можно также указать имя базы данных перед <code class=syntax>table_name</code>, например <code class=syntax>db_name.table_name</code></p> <p>Можно использовать две встроенных подстановки <code class=syntax>{database}</code> и <code class=syntax>{table}</code>, они раскрываются в имя таблицы и в имя базы данных соответственно (если эти подстановки не переопределены в секции <code class=syntax>macros</code>). Т.о. Zookeeper путь можно задать как <code class=syntax>'/clickhouse/tables/{layer}-{shard}/{database}/{table}'</code>. <br> Будьте осторожны с переименованиями таблицы при использовании этих автоматических подстановок. Путь в Zookeeper-е нельзя изменить, а подстановка при переименовании таблицы раскроется в другой путь, таблица будет обращаться к несуществующему в Zookeeper-е пути и перейдет в режим только для чтения.</p> <p>Имя реплики — то, что идентифицирует разные реплики одной и той же таблицы. Можно использовать для него имя сервера, как показано в примере. Впрочем, достаточно, чтобы имя было уникально лишь в пределах каждого шарда.</p> <p>Можно не использовать подстановки, а указать соответствующие параметры явно. Это может быть удобным для тестирования и при настройке маленьких кластеров. Однако в этом случае нельзя пользоваться распределенными DDL-запросами (<code class=syntax>ON CLUSTER</code>).</p> <p>При работе с большими кластерами мы рекомендуем использовать подстановки, они уменьшают вероятность ошибки.</p> <p>Можно указать аргументы по умолчанию для движка реплицируемых таблиц в файле конфигурации сервера.</p> <div class=codehilite><pre><span></span><code class=syntax><span class=nt>&lt;default_replica_path&gt;</span>/clickhouse/tables/{shard}/{database}/{table}<span class=nt>&lt;/default_replica_path&gt;</span>
<span class=nt>&lt;default_replica_name&gt;</span>{replica}<span class=nt>&lt;/default_replica_name&gt;</span>
</code></pre></div> <p>В этом случае можно опустить аргументы при создании таблиц:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=k>table_name</span> <span class=p>(</span>
    <span class=n>x</span> <span class=n>UInt32</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>ReplicatedMergeTree</span> 
<span class=k>ORDER</span> <span class=k>BY</span> <span class=n>x</span><span class=p>;</span>
</code></pre></div> <p>Это будет эквивалентно следующему запросу:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=k>table_name</span> <span class=p>(</span>
    <span class=n>x</span> <span class=n>UInt32</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>ReplicatedMergeTree</span><span class=p>(</span><span class=s1>'/clickhouse/tables/{shard}/{database}/table_name'</span><span class=p>,</span> <span class=s1>'{replica}'</span><span class=p>)</span> 
<span class=k>ORDER</span> <span class=k>BY</span> <span class=n>x</span><span class=p>;</span>
</code></pre></div> <p>Выполните запрос <code class=syntax>CREATE TABLE</code> на каждой реплике. Запрос создаёт новую реплицируемую таблицу, или добавляет новую реплику к имеющимся.</p> <p>Если вы добавляете новую реплику после того, как таблица на других репликах уже содержит некоторые данные, то после выполнения запроса, данные на новую реплику будут скачаны с других реплик. То есть, новая реплика синхронизирует себя с остальными.</p> <p>Для удаления реплики, выполните запрос <code class=syntax>DROP TABLE</code>. При этом, удаляется только одна реплика — расположенная на том сервере, где вы выполняете запрос.</p> <h2 id=vosstanovlenie-posle-sboia>Восстановление после сбоя<a class=headerlink href=../amp/#vosstanovlenie-posle-sboia title="Permanent link"> </a></h2> <p>Если при старте сервера, недоступен ZooKeeper, реплицируемые таблицы переходят в режим только для чтения. Система будет пытаться периодически установить соединение с ZooKeeper.</p> <p>Если при <code class=syntax>INSERT</code> недоступен ZooKeeper, или происходит ошибка при взаимодействии с ним, будет выкинуто исключение.</p> <p>При подключении к ZooKeeper, система проверяет соответствие между имеющимся в локальной файловой системе набором данных и ожидаемым набором данных (информация о котором хранится в ZooKeeper). Если имеются небольшие несоответствия, то система устраняет их, синхронизируя данные с реплик.</p> <p>Обнаруженные битые куски данных (с файлами несоответствующего размера) или неизвестные куски (куски, записанные в файловую систему, но информация о которых не была записана в ZooKeeper) переносятся в поддиректорию detached (не удаляются). Недостающие куски скачиваются с реплик.</p> <p>Стоит заметить, что ClickHouse не делает самостоятельно никаких деструктивных действий типа автоматического удаления большого количества данных.</p> <p>При старте сервера (или создании новой сессии с ZooKeeper), проверяется только количество и размеры всех файлов. Если у файлов совпадают размеры, но изменены байты где-то посередине, то это обнаруживается не сразу, а только при попытке их прочитать при каком-либо запросе <code class=syntax>SELECT</code>. Запрос кинет исключение о несоответствующей чексумме или размере сжатого блока. В этом случае, куски данных добавляются в очередь на проверку, и при необходимости, скачиваются с реплик.</p> <p>Если обнаруживается, что локальный набор данных слишком сильно отличается от ожидаемого, то срабатывает защитный механизм. Сервер сообщает об этом в лог и отказывается запускаться. Это сделано, так как такой случай может свидетельствовать об ошибке конфигурации - например, если реплика одного шарда была случайно сконфигурирована, как реплика другого шарда. Тем не менее, пороги защитного механизма поставлены довольно низкими, и такая ситуация может возникнуть и при обычном восстановлении после сбоя. В этом случае, восстановление делается полуавтоматически - «по кнопке».</p> <p>Для запуска восстановления, создайте в ZooKeeper узел <code class=syntax>/path_to_table/replica_name/flags/force_restore_data</code> с любым содержимым или выполните команду для восстановления всех реплицируемых таблиц:</p> <div class=codehilite><pre><span></span><code class=syntax>$ sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data
</code></pre></div> <p>Затем запустите сервер. При старте, сервер удалит эти флаги и запустит восстановление.</p> <h2 id=vosstanovlenie-v-sluchae-poteri-vsekh-dannykh>Восстановление в случае потери всех данных<a class=headerlink href=../amp/#vosstanovlenie-v-sluchae-poteri-vsekh-dannykh title="Permanent link"> </a></h2> <p>Если на одном из серверов исчезли все данные и метаданные, восстановление делается следующим образом:</p> <ol> <li>Установите на сервер ClickHouse. Корректно пропишите подстановки в конфигурационном файле, отвечающие за идентификатор шарда и реплики, если вы их используете.</li> <li>Если у вас были нереплицируемые таблицы, которые должны быть вручную продублированы на серверах, скопируйте их данные (в директории <code class=syntax>/var/lib/clickhouse/data/db_name/table_name/</code>) с реплики.</li> <li>Скопируйте с реплики определения таблиц, находящиеся в <code class=syntax>/var/lib/clickhouse/metadata/</code>. Если в определениях таблиц, идентификатор шарда или реплики, прописаны в явном виде - исправьте их, чтобы они соответствовали данной реплике. (Альтернативный вариант - запустить сервер и сделать самостоятельно все запросы <code class=syntax>ATTACH TABLE</code>, которые должны были бы быть в соответствующих .sql файлах в <code class=syntax>/var/lib/clickhouse/metadata/</code>.)</li> <li>Создайте в ZooKeeper узел <code class=syntax>/path_to_table/replica_name/flags/force_restore_data</code> с любым содержимым или выполните команду для восстановления всех реплицируемых таблиц: <code class=syntax>sudo -u clickhouse touch /var/lib/clickhouse/flags/force_restore_data</code></li> </ol> <p>Затем запустите сервер (перезапустите, если уже запущен). Данные будут скачаны с реплик.</p> <p>В качестве альтернативного варианта восстановления, вы можете удалить из ZooKeeper информацию о потерянной реплике (<code class=syntax>/path_to_table/replica_name</code>), и затем создать реплику заново, как написано в разделе <a href=../amp/#creating-replicated-tables>Создание реплицированных таблиц</a> .</p> <p>Отсутствует ограничение на использование сетевой полосы при восстановлении. Имейте это ввиду, если восстанавливаете сразу много реплик.</p> <h2 id=preobrazovanie-iz-mergetree-v-replicatedmergetree>Преобразование из MergeTree в ReplicatedMergeTree<a class=headerlink href=../amp/#preobrazovanie-iz-mergetree-v-replicatedmergetree title="Permanent link"> </a></h2> <p>Здесь и далее, под <code class=syntax>MergeTree</code> подразумеваются все движки таблиц семейства <code class=syntax>MergeTree</code>, так же для <code class=syntax>ReplicatedMergeTree</code>.</p> <p>Если у вас была таблица типа <code class=syntax>MergeTree</code>, репликация которой делалась вручную, вы можете преобразовать её в реплицируемую таблицу. Это может понадобиться лишь в случаях, когда вы уже успели накопить большое количество данных в таблице типа <code class=syntax>MergeTree</code>, а сейчас хотите включить репликацию.</p> <p>Если на разных репликах данные отличаются, то сначала синхронизируйте их, либо удалите эти данные на всех репликах кроме одной.</p> <p>Переименуйте имеющуюся MergeTree таблицу, затем создайте со старым именем таблицу типа <code class=syntax>ReplicatedMergeTree</code>.<br> Перенесите данные из старой таблицы в поддиректорию detached в директории с данными новой таблицы (<code class=syntax>/var/lib/clickhouse/data/db_name/table_name/</code>).<br> Затем добавьте эти куски данных в рабочий набор с помощью выполнения запросов <code class=syntax>ALTER TABLE ATTACH PARTITION</code> на одной из реплик.</p> <h2 id=preobrazovanie-iz-replicatedmergetree-v-mergetree>Преобразование из ReplicatedMergeTree в MergeTree<a class=headerlink href=../amp/#preobrazovanie-iz-replicatedmergetree-v-mergetree title="Permanent link"> </a></h2> <p>Создайте таблицу типа MergeTree с другим именем. Перенесите в её директорию с данными все данные из директории с данными таблицы типа <code class=syntax>ReplicatedMergeTree</code>. Затем удалите таблицу типа <code class=syntax>ReplicatedMergeTree</code> и перезапустите сервер.</p> <p>Если вы хотите избавиться от таблицы <code class=syntax>ReplicatedMergeTree</code>, не запуская сервер, то</p> <ul> <li>удалите соответствующий файл <code class=syntax>.sql</code> в директории с метаданными (<code class=syntax>/var/lib/clickhouse/metadata/</code>);</li> <li>удалите соответствующий путь в ZooKeeper (<code class=syntax>/path_to_table/replica_name</code>);</li> </ul> <p>После этого, вы можете запустить сервер, создать таблицу типа <code class=syntax>MergeTree</code>, перенести данные в её директорию, и перезапустить сервер.</p> <h2 id=vosstanovlenie-v-sluchae-poteri-ili-povrezhdeniia-metadannykh-na-zookeeper-klastere>Восстановление в случае потери или повреждения метаданных на ZooKeeper кластере<a class=headerlink href=../amp/#vosstanovlenie-v-sluchae-poteri-ili-povrezhdeniia-metadannykh-na-zookeeper-klastere title="Permanent link"> </a></h2> <p>Если данные в ZooKeeper оказались утеряны или повреждены, то вы можете сохранить данные, переместив их в нереплицируемую таблицу, как описано в пункте выше.</p> <p><strong>Смотрите также</strong></p> <ul> <li><a href=../../../../../operations/settings/settings/amp/#background_schedule_pool_size>background_schedule_pool_size</a></li> <li><a href=../../../../../operations/settings/settings/amp/#execute-merges-on-single-replica-time-threshold>execute_merges_on_single_replica_time_threshold</a></li> </ul> <p><a href=https://clickhouse.tech/docs/ru/operations/table_engines/replication/ target=_blank>Оригинальная статья</a> <!--hide--></p> </div> </div> <div class=row> <div class=col> <div class="alert alert-light my-3"> <p class="float-right mb-0">Rating: RATING_VALUE - RATING_COUNT votes</p> <span class="alert-heading display-6">Article Rating</span> <div id=rating-stars class="display-6 mb-0">RATING_STARS</div> </div> <div id=content-footer class="text-muted pt-3 mb-5"> <div class=float-md-right>©2016–2020 Yandex LLC</div> <div>Built from <a href=https://github.com/ClickHouse/ClickHouse/commit/b030bfedd7db4603034643fd183cf7784a820193 rel="external nofollow noreferrer" target=_blank class=text-reset>b030bfedd7</a> </div> </div> </div> </div> <div id=to-full-website class="row fixed-bottom text-center bg-white py-3"> <div class=col> <a href=https://clickhouse.tech/docs/ru/engines/table-engines/mergetree-family/replication/ class="btn btn-lg btn-outline-orange">To full website</a> </div> </div> </div> <amp-analytics type=metrika> <script type=application/json>{
"vars": {
  "counterId": "18343495",
  "triggers": {
    "notBounce": {
      "on": "timer",
      "timerSpec": {
        "immediate": false,
        "interval": 15,
        "maxTimerLength": 16
      },
      "request": "notBounce"
    }
  }
}
}</script> </amp-analytics> </body> </html> 