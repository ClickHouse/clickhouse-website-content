<!doctype html><html ⚡ lang=fr> <head><meta charset=utf-8><script async src=https://cdn.ampproject.org/v0.js></script><title>Vue d'ensemble de L'Architecture ClickHouse | Documentation ClickHouse</title><link href=https://clickhouse.tech/docs/fr/development/architecture/ rel=canonical><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><script type=application/ld+json>[{
"@context": "http://schema.org",
"@type": "TechArticle",
"headline": "Vue d'ensemble de L'Architecture ClickHouse | Documentation ClickHouse",
"mainEntityOfPage": "https://clickhouse.tech/docs/fr/development/architecture/",




"image": "https://clickhouse.tech/images/logo-209x60.png",
"author": {
  "@type": "Project",
  "name": "ClickHouse"
},
"publisher": {
  "@type": "Organization",
  "name": "Yandex LLC",
  "logo": {
    "@type": "ImageObject",
    "url": "https://clickhouse.tech/images/yandex.png",
    "width": 163,
    "height": 60
  }
}}, {
"@context": "http://schema.org",
"@type": "Episode",
"name": "Vue d'ensemble de L'Architecture ClickHouse | Documentation ClickHouse",
"aggregateRating": {
  "@type": "AggregateRating",
  "ratingValue": RATING_VALUE,
  "ratingCount": RATING_COUNT
}
}]</script><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><style amp-custom>:root{--blue:#007bff;--indigo:#6610f2;--purple:#6f42c1;--pink:#e83e8c;--red:#dc3545;--orange:#fd7e14;--yellow:#ffc107;--green:#28a745;--teal:#20c997;--cyan:#17a2b8;--white:#fff;--gray:#6c757d;--gray-dark:#343a40;--primary:#007bff;--secondary:#6c757d;--success:#28a745;--info:#17a2b8;--warning:#ffc107;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--breakpoint-xs:0;--breakpoint-sm:576px;--breakpoint-md:768px;--breakpoint-lg:992px;--breakpoint-xl:1200px;--font-family-sans-serif:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-family-monospace:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}*,::after,::before{box-sizing:border-box}html{font-family:sans-serif;line-height:1.15;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}article,footer,main,section{display:block}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;text-align:left;background-color:#fff}[tabindex="-1"]:focus:not(:focus-visible){outline:0}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem}p{margin-top:0;margin-bottom:1rem}ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}a{color:#007bff;text-decoration:none;background-color:transparent}a:hover{color:#0056b3;text-decoration:underline}a:not([href]){color:inherit;text-decoration:none}a:not([href]):hover{color:inherit;text-decoration:none}code{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em}img{vertical-align:middle;border-style:none}svg{overflow:hidden;vertical-align:middle}table{border-collapse:collapse}select{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}select{text-transform:none}select{word-wrap:normal}[type=button],[type=reset],[type=submit]{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled){cursor:pointer}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{padding:0;border-style:none}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:none}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}[hidden]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:500;line-height:1.2}.h1,h1{font-size:2rem}.h2,h2{font-size:1.5rem}.h3,h3{font-size:1.25rem}.h4,h4{font-size:1rem}.h5,h5{font-size:1rem}.h6,h6{font-size:1rem}.lead{font-size:1.25rem;font-weight:300}.display-1{font-size:6rem;font-weight:300;line-height:1.2}.display-2{font-size:5.5rem;font-weight:300;line-height:1.2}.display-3{font-size:4.5rem;font-weight:300;line-height:1.2}.display-4{font-size:3.5rem;font-weight:300;line-height:1.2}.blockquote{margin-bottom:1rem;font-size:1.25rem}.blockquote-footer{display:block;font-size:80%;color:#6c757d}.blockquote-footer::before{content:"\2014\00A0"}.img-fluid{max-width:100%;height:auto}code{font-size:87.5%;color:#e83e8c;word-wrap:break-word}a>code{color:inherit}.container{width:100%;padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media(min-width:576px){.container{max-width:540px}}@media(min-width:768px){.container{max-width:720px}}@media(min-width:992px){.container{max-width:960px}}@media(min-width:1200px){.container{max-width:1140px}}.container-fluid,.container-lg,.container-md{width:100%;padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media(min-width:576px){.container{max-width:540px}}@media(min-width:768px){.container,.container-md{max-width:720px}}@media(min-width:992px){.container,.container-lg,.container-md{max-width:960px}}@media(min-width:1200px){.container,.container-lg,.container-md{max-width:1140px}}.row{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-15px;margin-left:-15px}.col,.col-1,.col-10,.col-11,.col-12,.col-2,.col-3,.col-4,.col-5,.col-6,.col-7,.col-8,.col-9,.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9{position:relative;width:100%;padding-right:15px;padding-left:15px}.col{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-0{-ms-flex-order:0;order:0}.order-1{-ms-flex-order:1;order:1}.order-2{-ms-flex-order:2;order:2}.order-3{-ms-flex-order:3;order:3}.order-4{-ms-flex-order:4;order:4}.order-5{-ms-flex-order:5;order:5}.order-6{-ms-flex-order:6;order:6}.order-7{-ms-flex-order:7;order:7}.order-8{-ms-flex-order:8;order:8}.order-9{-ms-flex-order:9;order:9}.order-10{-ms-flex-order:10;order:10}.order-11{-ms-flex-order:11;order:11}.order-12{-ms-flex-order:12;order:12}@media(min-width:768px){.col-md{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-md-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-md-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-md-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-md-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-md-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-md-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-md-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-md-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-md-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-md-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-md-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-md-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-md-0{-ms-flex-order:0;order:0}.order-md-1{-ms-flex-order:1;order:1}.order-md-2{-ms-flex-order:2;order:2}.order-md-3{-ms-flex-order:3;order:3}.order-md-4{-ms-flex-order:4;order:4}.order-md-5{-ms-flex-order:5;order:5}.order-md-6{-ms-flex-order:6;order:6}.order-md-7{-ms-flex-order:7;order:7}.order-md-8{-ms-flex-order:8;order:8}.order-md-9{-ms-flex-order:9;order:9}.order-md-10{-ms-flex-order:10;order:10}.order-md-11{-ms-flex-order:11;order:11}.order-md-12{-ms-flex-order:12;order:12}}@media(min-width:992px){.col-lg{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-lg-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-lg-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-lg-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-lg-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-lg-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-lg-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-lg-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-lg-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-lg-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-lg-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-lg-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-lg-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-lg-0{-ms-flex-order:0;order:0}.order-lg-1{-ms-flex-order:1;order:1}.order-lg-2{-ms-flex-order:2;order:2}.order-lg-3{-ms-flex-order:3;order:3}.order-lg-4{-ms-flex-order:4;order:4}.order-lg-5{-ms-flex-order:5;order:5}.order-lg-6{-ms-flex-order:6;order:6}.order-lg-7{-ms-flex-order:7;order:7}.order-lg-8{-ms-flex-order:8;order:8}.order-lg-9{-ms-flex-order:9;order:9}.order-lg-10{-ms-flex-order:10;order:10}.order-lg-11{-ms-flex-order:11;order:11}.order-lg-12{-ms-flex-order:12;order:12}}.table{width:100%;margin-bottom:1rem;color:#212529}.table-primary{background-color:#b8daff}.table-light{background-color:#fdfdfe}.table-dark{background-color:#c6c8ca}.table-dark{color:#fff;background-color:#343a40}.btn{display:inline-block;font-weight:400;color:#212529;text-align:center;vertical-align:middle;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background-color:transparent;border:1px solid transparent;padding:.375rem .75rem;font-size:1rem;line-height:1.5;border-radius:.25rem}@media(prefers-reduced-motion:reduce){.btn{transition:none}}.btn:hover{color:#212529;text-decoration:none}.btn:focus{outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.btn:disabled{opacity:.65}.btn-primary{color:#fff;background-color:#007bff;border-color:#007bff}.btn-primary:hover{color:#fff;background-color:#0069d9;border-color:#0062cc}.btn-primary:focus{color:#fff;background-color:#0069d9;border-color:#0062cc;box-shadow:0 0 0 .2rem rgba(38,143,255,.5)}.btn-primary:disabled{color:#fff;background-color:#007bff;border-color:#007bff}.btn-light{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-light:hover{color:#212529;background-color:#e2e6ea;border-color:#dae0e5}.btn-light:focus{color:#212529;background-color:#e2e6ea;border-color:#dae0e5;box-shadow:0 0 0 .2rem rgba(216,217,219,.5)}.btn-light:disabled{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-dark{color:#fff;background-color:#343a40;border-color:#343a40}.btn-dark:hover{color:#fff;background-color:#23272b;border-color:#1d2124}.btn-dark:focus{color:#fff;background-color:#23272b;border-color:#1d2124;box-shadow:0 0 0 .2rem rgba(82,88,93,.5)}.btn-dark:disabled{color:#fff;background-color:#343a40;border-color:#343a40}.btn-outline-primary{color:#007bff;border-color:#007bff}.btn-outline-primary:hover{color:#fff;background-color:#007bff;border-color:#007bff}.btn-outline-primary:focus{box-shadow:0 0 0 .2rem rgba(0,123,255,.5)}.btn-outline-primary:disabled{color:#007bff;background-color:transparent}.btn-outline-light{color:#f8f9fa;border-color:#f8f9fa}.btn-outline-light:hover{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-outline-light:focus{box-shadow:0 0 0 .2rem rgba(248,249,250,.5)}.btn-outline-light:disabled{color:#f8f9fa;background-color:transparent}.btn-outline-dark{color:#343a40;border-color:#343a40}.btn-outline-dark:hover{color:#fff;background-color:#343a40;border-color:#343a40}.btn-outline-dark:focus{box-shadow:0 0 0 .2rem rgba(52,58,64,.5)}.btn-outline-dark:disabled{color:#343a40;background-color:transparent}.btn-link{font-weight:400;color:#007bff;text-decoration:none}.btn-link:hover{color:#0056b3;text-decoration:underline}.btn-link:focus{text-decoration:underline;box-shadow:none}.btn-link:disabled{color:#6c757d;pointer-events:none}.btn-group-lg>.btn,.btn-lg{padding:.5rem 1rem;font-size:1.25rem;line-height:1.5;border-radius:.3rem}.btn-block{display:block;width:100%}.btn-block+.btn-block{margin-top:.5rem}.btn-group{position:relative;display:-ms-inline-flexbox;display:inline-flex;vertical-align:middle}.btn-group>.btn{position:relative;-ms-flex:1 1 auto;flex:1 1 auto}.btn-group>.btn:hover{z-index:1}.btn-group>.btn:active,.btn-group>.btn:focus{z-index:1}.btn-group>.btn-group:not(:first-child),.btn-group>.btn:not(:first-child){margin-left:-1px}.btn-group>.btn-group:not(:last-child)>.btn{border-top-right-radius:0;border-bottom-right-radius:0}.btn-group>.btn-group:not(:first-child)>.btn,.btn-group>.btn:not(:first-child){border-top-left-radius:0;border-bottom-left-radius:0}.custom-select{display:inline-block;width:100%;height:calc(1.5em+.75rem+2px);padding:.375rem 1.75rem .375rem .75rem;font-size:1rem;font-weight:400;line-height:1.5;color:#495057;vertical-align:middle;background:#fff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='4' height='5' viewBox='0 0 4 5'%3e%3cpath fill='%23343a40' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e") no-repeat right .75rem center/8px 10px;border:1px solid #ced4da;border-radius:.25rem;-webkit-appearance:none;-moz-appearance:none;appearance:none}.custom-select:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.custom-select:focus::-ms-value{color:#495057;background-color:#fff}.custom-select[multiple],.custom-select[size]:not([size="1"]){height:auto;padding-right:.75rem;background-image:none}.custom-select:disabled{color:#6c757d;background-color:#e9ecef}.custom-select::-ms-expand{display:none}.custom-select:-moz-focusring{color:transparent;text-shadow:0 0 0 #495057}.custom-select-lg{height:calc(1.5em+1rem+2px);padding-top:.5rem;padding-bottom:.5rem;padding-left:1rem;font-size:1.25rem}.custom-file{position:relative;display:inline-block;width:100%;height:calc(1.5em+.75rem+2px);margin-bottom:0}@media(prefers-reduced-motion:reduce){.custom-select{transition:none}}.page-link{position:relative;display:block;padding:.5rem .75rem;margin-left:-1px;line-height:1.25;color:#007bff;background-color:#fff;border:1px solid #dee2e6}.page-link:hover{z-index:2;color:#0056b3;text-decoration:none;background-color:#e9ecef;border-color:#dee2e6}.page-link:focus{z-index:3;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.alert{position:relative;padding:.75rem 1.25rem;margin-bottom:1rem;border:1px solid transparent;border-radius:.25rem}.alert-heading{color:inherit}.alert-link{font-weight:700}.alert-primary{color:#004085;background-color:#cce5ff;border-color:#b8daff}.alert-primary .alert-link{color:#002752}.alert-light{color:#818182;background-color:#fefefe;border-color:#fdfdfe}.alert-light .alert-link{color:#686868}.alert-dark{color:#1b1e21;background-color:#d6d8d9;border-color:#c6c8ca}.alert-dark .alert-link{color:#040505}@-webkit-keyframes progress-bar-stripes{from{background-position:1rem 0}to{background-position:0 0}}@keyframes progress-bar-stripes{from{background-position:1rem 0}to{background-position:0 0}}@-webkit-keyframes spinner-border{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spinner-border{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-webkit-keyframes spinner-grow{0%{-webkit-transform:scale(0);transform:scale(0)}50%{opacity:1}}@keyframes spinner-grow{0%{-webkit-transform:scale(0);transform:scale(0)}50%{opacity:1}}.align-bottom{vertical-align:bottom}.align-text-bottom{vertical-align:text-bottom}.bg-primary{background-color:#007bff}a.bg-primary:focus,a.bg-primary:hover{background-color:#0062cc}.bg-light{background-color:#f8f9fa}a.bg-light:focus,a.bg-light:hover{background-color:#dae0e5}.bg-dark{background-color:#343a40}a.bg-dark:focus,a.bg-dark:hover{background-color:#1d2124}.bg-white{background-color:#fff}.d-none{display:none}.d-inline{display:inline}.d-inline-block{display:inline-block}.d-block{display:block}.d-table{display:table}.d-table-row{display:table-row}@media(min-width:768px){.d-md-none{display:none}.d-md-inline{display:inline}.d-md-inline-block{display:inline-block}.d-md-block{display:block}.d-md-table{display:table}.d-md-table-row{display:table-row}}@media(min-width:992px){.d-lg-none{display:none}.d-lg-inline{display:inline}.d-lg-inline-block{display:inline-block}.d-lg-block{display:block}.d-lg-table{display:table}.d-lg-table-row{display:table-row}}.align-content-start{-ms-flex-line-pack:start;align-content:flex-start}.align-content-end{-ms-flex-line-pack:end;align-content:flex-end}.align-content-center{-ms-flex-line-pack:center;align-content:center}@media(min-width:768px){.align-content-md-start{-ms-flex-line-pack:start;align-content:flex-start}.align-content-md-end{-ms-flex-line-pack:end;align-content:flex-end}.align-content-md-center{-ms-flex-line-pack:center;align-content:center}}@media(min-width:992px){.align-content-lg-start{-ms-flex-line-pack:start;align-content:flex-start}.align-content-lg-end{-ms-flex-line-pack:end;align-content:flex-end}.align-content-lg-center{-ms-flex-line-pack:center;align-content:center}}.float-right{float:right}.float-none{float:none}@media(min-width:768px){.float-md-right{float:right}.float-md-none{float:none}}@media(min-width:992px){.float-lg-right{float:right}.float-lg-none{float:none}}.position-fixed{position:fixed}.fixed-bottom{position:fixed;right:0;bottom:0;left:0;z-index:1030}.h-25{height:25%}.h-50{height:50%}.h-75{height:75%}.h-100{height:100%}.m-0{margin:0}.my-0{margin-top:0}.mr-0{margin-right:0}.mb-0,.my-0{margin-bottom:0}.m-1{margin:.25rem}.my-1{margin-top:.25rem}.mr-1{margin-right:.25rem}.mb-1,.my-1{margin-bottom:.25rem}.m-2{margin:.5rem}.my-2{margin-top:.5rem}.mr-2{margin-right:.5rem}.mb-2,.my-2{margin-bottom:.5rem}.m-3{margin:1rem}.my-3{margin-top:1rem}.mr-3{margin-right:1rem}.mb-3,.my-3{margin-bottom:1rem}.m-4{margin:1.5rem}.my-4{margin-top:1.5rem}.mr-4{margin-right:1.5rem}.mb-4,.my-4{margin-bottom:1.5rem}.m-5{margin:3rem}.my-5{margin-top:3rem}.mr-5{margin-right:3rem}.mb-5,.my-5{margin-bottom:3rem}.p-0{padding:0}.pt-0,.py-0{padding-top:0}.pr-0{padding-right:0}.pb-0,.py-0{padding-bottom:0}.p-1{padding:.25rem}.pt-1,.py-1{padding-top:.25rem}.pr-1{padding-right:.25rem}.pb-1,.py-1{padding-bottom:.25rem}.p-2{padding:.5rem}.pt-2,.py-2{padding-top:.5rem}.pr-2{padding-right:.5rem}.pb-2,.py-2{padding-bottom:.5rem}.p-3{padding:1rem}.pt-3,.py-3{padding-top:1rem}.pr-3{padding-right:1rem}.pb-3,.py-3{padding-bottom:1rem}.p-4{padding:1.5rem}.pt-4,.py-4{padding-top:1.5rem}.pr-4{padding-right:1.5rem}.pb-4,.py-4{padding-bottom:1.5rem}.p-5{padding:3rem}.pt-5,.py-5{padding-top:3rem}.pr-5{padding-right:3rem}.pb-5,.py-5{padding-bottom:3rem}.m-n1{margin:-.25rem}.my-n1{margin-top:-.25rem}.mr-n1{margin-right:-.25rem}.mb-n1,.my-n1{margin-bottom:-.25rem}.m-n2{margin:-.5rem}.my-n2{margin-top:-.5rem}.mr-n2{margin-right:-.5rem}.mb-n2,.my-n2{margin-bottom:-.5rem}.m-n3{margin:-1rem}.my-n3{margin-top:-1rem}.mr-n3{margin-right:-1rem}.mb-n3,.my-n3{margin-bottom:-1rem}.m-n4{margin:-1.5rem}.my-n4{margin-top:-1.5rem}.mr-n4{margin-right:-1.5rem}.mb-n4,.my-n4{margin-bottom:-1.5rem}.m-n5{margin:-3rem}.my-n5{margin-top:-3rem}.mr-n5{margin-right:-3rem}.mb-n5,.my-n5{margin-bottom:-3rem}@media(min-width:768px){.m-md-0{margin:0}.my-md-0{margin-top:0}.mr-md-0{margin-right:0}.mb-md-0,.my-md-0{margin-bottom:0}.m-md-1{margin:.25rem}.my-md-1{margin-top:.25rem}.mr-md-1{margin-right:.25rem}.mb-md-1,.my-md-1{margin-bottom:.25rem}.m-md-2{margin:.5rem}.my-md-2{margin-top:.5rem}.mr-md-2{margin-right:.5rem}.mb-md-2,.my-md-2{margin-bottom:.5rem}.m-md-3{margin:1rem}.my-md-3{margin-top:1rem}.mr-md-3{margin-right:1rem}.mb-md-3,.my-md-3{margin-bottom:1rem}.m-md-4{margin:1.5rem}.my-md-4{margin-top:1.5rem}.mr-md-4{margin-right:1.5rem}.mb-md-4,.my-md-4{margin-bottom:1.5rem}.m-md-5{margin:3rem}.my-md-5{margin-top:3rem}.mr-md-5{margin-right:3rem}.mb-md-5,.my-md-5{margin-bottom:3rem}.p-md-0{padding:0}.pt-md-0,.py-md-0{padding-top:0}.pr-md-0{padding-right:0}.pb-md-0,.py-md-0{padding-bottom:0}.p-md-1{padding:.25rem}.pt-md-1,.py-md-1{padding-top:.25rem}.pr-md-1{padding-right:.25rem}.pb-md-1,.py-md-1{padding-bottom:.25rem}.p-md-2{padding:.5rem}.pt-md-2,.py-md-2{padding-top:.5rem}.pr-md-2{padding-right:.5rem}.pb-md-2,.py-md-2{padding-bottom:.5rem}.p-md-3{padding:1rem}.pt-md-3,.py-md-3{padding-top:1rem}.pr-md-3{padding-right:1rem}.pb-md-3,.py-md-3{padding-bottom:1rem}.p-md-4{padding:1.5rem}.pt-md-4,.py-md-4{padding-top:1.5rem}.pr-md-4{padding-right:1.5rem}.pb-md-4,.py-md-4{padding-bottom:1.5rem}.p-md-5{padding:3rem}.pt-md-5,.py-md-5{padding-top:3rem}.pr-md-5{padding-right:3rem}.pb-md-5,.py-md-5{padding-bottom:3rem}.m-md-n1{margin:-.25rem}.my-md-n1{margin-top:-.25rem}.mr-md-n1{margin-right:-.25rem}.mb-md-n1,.my-md-n1{margin-bottom:-.25rem}.m-md-n2{margin:-.5rem}.my-md-n2{margin-top:-.5rem}.mr-md-n2{margin-right:-.5rem}.mb-md-n2,.my-md-n2{margin-bottom:-.5rem}.m-md-n3{margin:-1rem}.my-md-n3{margin-top:-1rem}.mr-md-n3{margin-right:-1rem}.mb-md-n3,.my-md-n3{margin-bottom:-1rem}.m-md-n4{margin:-1.5rem}.my-md-n4{margin-top:-1.5rem}.mr-md-n4{margin-right:-1.5rem}.mb-md-n4,.my-md-n4{margin-bottom:-1.5rem}.m-md-n5{margin:-3rem}.my-md-n5{margin-top:-3rem}.mr-md-n5{margin-right:-3rem}.mb-md-n5,.my-md-n5{margin-bottom:-3rem}}@media(min-width:992px){.m-lg-0{margin:0}.my-lg-0{margin-top:0}.mr-lg-0{margin-right:0}.mb-lg-0,.my-lg-0{margin-bottom:0}.m-lg-1{margin:.25rem}.my-lg-1{margin-top:.25rem}.mr-lg-1{margin-right:.25rem}.mb-lg-1,.my-lg-1{margin-bottom:.25rem}.m-lg-2{margin:.5rem}.my-lg-2{margin-top:.5rem}.mr-lg-2{margin-right:.5rem}.mb-lg-2,.my-lg-2{margin-bottom:.5rem}.m-lg-3{margin:1rem}.my-lg-3{margin-top:1rem}.mr-lg-3{margin-right:1rem}.mb-lg-3,.my-lg-3{margin-bottom:1rem}.m-lg-4{margin:1.5rem}.my-lg-4{margin-top:1.5rem}.mr-lg-4{margin-right:1.5rem}.mb-lg-4,.my-lg-4{margin-bottom:1.5rem}.m-lg-5{margin:3rem}.my-lg-5{margin-top:3rem}.mr-lg-5{margin-right:3rem}.mb-lg-5,.my-lg-5{margin-bottom:3rem}.p-lg-0{padding:0}.pt-lg-0,.py-lg-0{padding-top:0}.pr-lg-0{padding-right:0}.pb-lg-0,.py-lg-0{padding-bottom:0}.p-lg-1{padding:.25rem}.pt-lg-1,.py-lg-1{padding-top:.25rem}.pr-lg-1{padding-right:.25rem}.pb-lg-1,.py-lg-1{padding-bottom:.25rem}.p-lg-2{padding:.5rem}.pt-lg-2,.py-lg-2{padding-top:.5rem}.pr-lg-2{padding-right:.5rem}.pb-lg-2,.py-lg-2{padding-bottom:.5rem}.p-lg-3{padding:1rem}.pt-lg-3,.py-lg-3{padding-top:1rem}.pr-lg-3{padding-right:1rem}.pb-lg-3,.py-lg-3{padding-bottom:1rem}.p-lg-4{padding:1.5rem}.pt-lg-4,.py-lg-4{padding-top:1.5rem}.pr-lg-4{padding-right:1.5rem}.pb-lg-4,.py-lg-4{padding-bottom:1.5rem}.p-lg-5{padding:3rem}.pt-lg-5,.py-lg-5{padding-top:3rem}.pr-lg-5{padding-right:3rem}.pb-lg-5,.py-lg-5{padding-bottom:3rem}.m-lg-n1{margin:-.25rem}.my-lg-n1{margin-top:-.25rem}.mr-lg-n1{margin-right:-.25rem}.mb-lg-n1,.my-lg-n1{margin-bottom:-.25rem}.m-lg-n2{margin:-.5rem}.my-lg-n2{margin-top:-.5rem}.mr-lg-n2{margin-right:-.5rem}.mb-lg-n2,.my-lg-n2{margin-bottom:-.5rem}.m-lg-n3{margin:-1rem}.my-lg-n3{margin-top:-1rem}.mr-lg-n3{margin-right:-1rem}.mb-lg-n3,.my-lg-n3{margin-bottom:-1rem}.m-lg-n4{margin:-1.5rem}.my-lg-n4{margin-top:-1.5rem}.mr-lg-n4{margin-right:-1.5rem}.mb-lg-n4,.my-lg-n4{margin-bottom:-1.5rem}.m-lg-n5{margin:-3rem}.my-lg-n5{margin-top:-3rem}.mr-lg-n5{margin-right:-3rem}.mb-lg-n5,.my-lg-n5{margin-bottom:-3rem}}.text-right{text-align:right}.text-center{text-align:center}@media(min-width:768px){.text-md-right{text-align:right}.text-md-center{text-align:center}}@media(min-width:992px){.text-lg-right{text-align:right}.text-lg-center{text-align:center}}.text-white{color:#fff}.text-primary{color:#007bff}a.text-primary:focus,a.text-primary:hover{color:#0056b3}.text-light{color:#f8f9fa}a.text-light:focus,a.text-light:hover{color:#cbd3da}.text-dark{color:#343a40}a.text-dark:focus,a.text-dark:hover{color:#121416}.text-body{color:#212529}.text-muted{color:#6c757d}.text-black-50{color:rgba(0,0,0,.5)}.text-white-50{color:rgba(255,255,255,.5)}.text-decoration-none{text-decoration:none}.text-reset{color:inherit}.visible{visibility:visible}@media print{*,::after,::before{text-shadow:none;box-shadow:none}a:not(.btn){text-decoration:underline}blockquote{border:1px solid #adb5bd;page-break-inside:avoid}img,tr{page-break-inside:avoid}h2,h3,p{orphans:3;widows:3}h2,h3{page-break-after:avoid}@page{size:a3}body{min-width:992px}.container{min-width:992px}.table{border-collapse:collapse}.table-dark{color:inherit}}@-webkit-keyframes sbx-reset-in{0%{-webkit-transform:translate3d(-20%,0,0);transform:translate3d(-20%,0,0);opacity:0}100%{-webkit-transform:none;transform:none;opacity:1}}@keyframes sbx-reset-in{0%{-webkit-transform:translate3d(-20%,0,0);transform:translate3d(-20%,0,0);opacity:0}100%{-webkit-transform:none;transform:none;opacity:1}}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}a:link,a:visited{color:#f14600;text-decoration:none}a:active,a:hover{text-decoration:underline}.btn:disabled{cursor:default;opacity:.4}#logo-text{width:180px;margin-left:12px}.display-5{font-size:2rem;font-weight:300;line-height:1.2}.display-6{font-size:1.75rem;font-weight:300;line-height:1.2}.bg-dark-alt,.bg-dark-alt:focus{background:#36363f}.bg-orange,.bg-orange:focus{background:#f14600}.text-dark-alt{color:#36363f}.btn-dark-alt{background:#36363f}.btn-dark-alt:focus{background:#36363f}.btn-outline-orange{border-color:#f14600;color:#f14600}.btn-orange,.btn-outline-orange:hover{background:#f14600;color:#fff}.btn:active,.btn:hover{text-decoration:none}.text-orange{color:#f14600}.bg-number{position:absolute;font-size:900%;font-weight:700;color:rgba(241,70,0,.1);line-height:1;margin-top:-1rem}.headerlink{text-decoration:none;margin-left:.5rem}#content table{border:1px solid #dee2e6;width:100%;margin-bottom:1rem;overflow-x:auto}#content code{color:#000;background:#eee;padding:.125rem .25rem}#content code.syntax{padding:0}@media print{body{min-width:0}code,h1,h2,h3,h4,h5,h6,img,li,p,tr{page-break-inside:avoid}}@media(prefers-color-scheme:dark){#to-full-website,body.amp,body[data-spy]{background:#1c1c1c;color:#efefef}.invert-dark{filter:invert(100%)}#content table{border:1px solid #2a2b2c}#content code{background:#444;color:#eee;padding:.125rem .25rem}}.syntax{background:#f8f9fa;color:#2f1e2e}.syntax .c{color:#8d8687}.syntax .k{color:#000;font-weight:700}.syntax .l{color:#08f}.syntax .n{color:#2f1e2e}.syntax .o{color:#800}.syntax .p{color:#2f1e2e}.syntax .c1{color:#8d8687}.syntax .cs{color:#8d8687}.syntax .ld{color:#48b685}.syntax .m{color:#08f}.syntax .s{color:#48b685}.syntax .ni{color:#2f1e2e}.syntax .ne{color:#ef6155}.syntax .py{color:#2f1e2e}.syntax .mo{color:#08f}.syntax .s2{color:#48b685}.syntax .se{color:#08f}.syntax .si{color:#08f}.syntax .s1{color:#080}.syntax .il{color:#08f}@media(prefers-color-scheme:dark){.syntax .k{color:#c78cff}.syntax .ld{color:#64ffbb}.syntax .s{color:#64ffbb}.syntax .s2{color:#64ffbb}.syntax .s1{color:#64ffbb}.syntax .c{color:#64ffbb}.syntax .n{color:#f8f9fa}.syntax .p{color:#f8f9fa}.syntax .ni{color:#f8f9fa}.syntax .py{color:#f8f9fa}}</style><script async custom-element=amp-analytics src=https://cdn.ampproject.org/v0/amp-analytics-0.1.js></script><script async custom-element=amp-iframe src=https://cdn.ampproject.org/v0/amp-iframe-0.1.js></script></head> <body class=amp dir=ltr> <div class="container-fluid container-lg pb-5"> <div class="row pt-3 mb-3"> <div class=col> <a href=/ class=text-decoration-none> <amp-img class="d-inline-block mr-3" layout=fixed width=40 height=36 src=/images/logo.svg alt="ClickHouse logo" title="ClickHouse logo"></amp-img><amp-img class="invert-dark d-inline-block" layout=fixed width=238 height=36 src=/images/clickhouse-black.svg alt=ClickHouse title=ClickHouse></amp-img> </a> </div> </div> <div class=row> <div id=content class=col> <div class="alert alert-primary" role=alert> <p class="display-5 mb-2">Help wanted!</p> <p class=lead>The following content of this documentation page has been machine-translated. But unlike other websites, it is not done on the fly. This translated text lives on GitHub repository alongside main ClickHouse codebase and waits for fellow native speakers to make it more human-readable. <a href=/docs/en/development/architecture/ class=alert-link>You can also use the original English version as a reference.</a></p> <p class=lead> <a class="btn btn-lg btn-primary text-white" href=https://github.com/ClickHouse/ClickHouse/edit/master/docs/fr/development/architecture.md target=_blank rel="external nofollow noreferrer"> Help ClickHouse documentation by editing this page </a> </p> </div> <h1 id=overview-of-clickhouse-architecture>Vue d'ensemble de L'Architecture ClickHouse<a class=headerlink href=../amp/#overview-of-clickhouse-architecture title="Permanent link"> </a></h1> <p>ClickHouse est un véritable SGBD orienté colonne. Les données sont stockées par colonnes et lors de l'exécution de tableaux (vecteurs ou morceaux de colonnes). Dans la mesure du possible, les opérations sont distribuées sur des tableaux, plutôt que sur des valeurs individuelles. Il est appelé “vectorized query execution,” et cela aide à réduire le coût du traitement des données réel.</p> <blockquote> <p>Cette idée n'est pas nouvelle. Il remonte à la <code class=syntax>APL</code> langage de programmation et ses descendants: <code class=syntax>A +</code>, <code class=syntax>J</code>, <code class=syntax>K</code>, et <code class=syntax>Q</code>. La programmation de tableau est utilisée dans le traitement des données scientifiques. Cette idée n'est pas non plus nouvelle dans les bases de données relationnelles: par exemple, elle est utilisée dans le <code class=syntax>Vectorwise</code> système.</p> </blockquote> <p>Il existe deux approches différentes pour accélérer le traitement des requêtes: l'exécution vectorisée des requêtes et la génération de code d'exécution. Ce dernier supprime toute indirection et expédition dynamique. Aucune de ces approches est strictement meilleure que l'autre. La génération de code d'exécution peut être meilleure lorsqu'elle fusionne de nombreuses opérations, utilisant ainsi pleinement les unités D'exécution du processeur et le pipeline. L'exécution de requête vectorisée peut être moins pratique car elle implique des vecteurs temporaires qui doivent être écrits dans le cache et lus. Si les données temporaires ne rentre pas dans le cache L2, cela devient un problème. Mais l'exécution de requête vectorisée utilise plus facilement les capacités SIMD de la CPU. Un <a href=http://15721.courses.cs.cmu.edu/spring2016/papers/p5-sompolski.pdf rel="external nofollow noreferrer" target=_blank>document de recherche</a> écrit par nos amis montre qu'il est préférable de combiner les deux approches. ClickHouse utilise l'exécution de requête vectorisée et a un support initial limité pour la génération de code d'exécution.</p> <h2 id=columns>Colonne<a class=headerlink href=../amp/#columns title="Permanent link"> </a></h2> <p><code class=syntax>IColumn</code> l'interface est utilisée pour représenter des colonnes en mémoire (en fait, des morceaux de colonnes). Cette interface fournit des méthodes d'aide pour la mise en œuvre de divers opérateurs relationnels. Presque toutes les opérations sont immuables: elles ne modifient pas la colonne d'origine, mais en créent une nouvelle modifiée. Par exemple, l' <code class=syntax>IColumn :: filter</code> méthode accepte un masque d'octet de filtre. Il est utilisé pour le <code class=syntax>WHERE</code> et <code class=syntax>HAVING</code> opérateurs relationnels. Exemples supplémentaires: <code class=syntax>IColumn :: permute</code> méthode de soutien <code class=syntax>ORDER BY</code>, le <code class=syntax>IColumn :: cut</code> méthode de soutien <code class=syntax>LIMIT</code>.</p> <p>Divers <code class=syntax>IColumn</code> application (<code class=syntax>ColumnUInt8</code>, <code class=syntax>ColumnString</code> et ainsi de suite) sont responsables de la mémoire disposition de colonnes. La disposition de la mémoire est généralement un tableau contigu. Pour le type entier de colonnes, c'est juste un contiguë tableau, comme <code class=syntax>std :: vector</code>. Pour <code class=syntax>String</code> et <code class=syntax>Array</code> colonnes, il s'agit de deux vecteurs: Un pour tous les éléments du tableau, placé de manière contiguë, et un second pour les décalages au début de chaque tableau. Il y a aussi <code class=syntax>ColumnConst</code> cela stocke une seule valeur en mémoire, mais ressemble à une colonne.</p> <h2 id=field>Champ<a class=headerlink href=../amp/#field title="Permanent link"> </a></h2> <p>Néanmoins, il est possible de travailler avec des valeurs individuelles ainsi. Pour représenter une valeur individuelle, la <code class=syntax>Field</code> est utilisée. <code class=syntax>Field</code> est juste une union discriminée de <code class=syntax>UInt64</code>, <code class=syntax>Int64</code>, <code class=syntax>Float64</code>, <code class=syntax>String</code> et <code class=syntax>Array</code>. <code class=syntax>IColumn</code> a l' <code class=syntax>operator[]</code> méthode pour obtenir la n-ème valeur en tant que <code class=syntax>Field</code> et la <code class=syntax>insert</code> méthode pour ajouter un <code class=syntax>Field</code> à la fin d'une colonne. Ces méthodes ne sont pas très efficaces, car ils nécessitent de traiter avec temporaire <code class=syntax>Field</code> des objets représentant une valeur individuelle. Il existe des méthodes plus efficaces, telles que <code class=syntax>insertFrom</code>, <code class=syntax>insertRangeFrom</code> et ainsi de suite.</p> <p><code class=syntax>Field</code> ne pas avoir assez d'informations sur un type de données spécifique pour une table. Exemple, <code class=syntax>UInt8</code>, <code class=syntax>UInt16</code>, <code class=syntax>UInt32</code>, et <code class=syntax>UInt64</code> tous sont représentés comme <code class=syntax>UInt64</code> dans un <code class=syntax>Field</code>.</p> <h2 id=leaky-abstractions>Abstractions Qui Fuient<a class=headerlink href=../amp/#leaky-abstractions title="Permanent link"> </a></h2> <p><code class=syntax>IColumn</code> a des méthodes pour les transformations relationnelles communes des données, mais elles ne répondent pas à tous les besoins. Exemple, <code class=syntax>ColumnUInt64</code> ne pas avoir une méthode pour calculer la somme des deux colonnes, et <code class=syntax>ColumnString</code> n'a pas de méthode pour exécuter une recherche de sous-chaîne. Ces innombrables routines sont mises en œuvre en dehors de <code class=syntax>IColumn</code>.</p> <p>Diverses fonctions sur les colonnes peuvent être implémentées de manière générique et non efficace en utilisant <code class=syntax>IColumn</code> méthodes pour extraire <code class=syntax>Field</code> valeurs, ou d'une manière spécialisée en utilisant la connaissance de la disposition de la mémoire interne des données dans un <code class=syntax>IColumn</code> application. Il est implémenté en lançant des fonctions à un <code class=syntax>IColumn</code> tapez et traitez directement la représentation interne. Exemple, <code class=syntax>ColumnUInt64</code> a l' <code class=syntax>getData</code> méthode qui renvoie une référence à un tableau interne, puis une autre routine lit ou remplit ce tableau directement. Nous avons “leaky abstractions” permettent de spécialisations diverses routines.</p> <h2 id=data_types>Types De Données<a class=headerlink href=../amp/#data_types title="Permanent link"> </a></h2> <p><code class=syntax>IDataType</code> est responsable de la sérialisation et de la désérialisation: pour la lecture et l'écriture de morceaux de colonnes ou de valeurs individuelles sous forme binaire ou de texte. <code class=syntax>IDataType</code> correspond directement aux types de données dans les tables. Par exemple, il y a <code class=syntax>DataTypeUInt32</code>, <code class=syntax>DataTypeDateTime</code>, <code class=syntax>DataTypeString</code> et ainsi de suite.</p> <p><code class=syntax>IDataType</code> et <code class=syntax>IColumn</code> ne sont que faiblement liés les uns aux autres. Différents types de données peuvent être représentés en mémoire par le même <code class=syntax>IColumn</code> application. Exemple, <code class=syntax>DataTypeUInt32</code> et <code class=syntax>DataTypeDateTime</code> sont tous deux représentés par <code class=syntax>ColumnUInt32</code> ou <code class=syntax>ColumnConstUInt32</code>. En outre, le même type de données peut être représentée par différents <code class=syntax>IColumn</code> application. Exemple, <code class=syntax>DataTypeUInt8</code> peut être représenté par <code class=syntax>ColumnUInt8</code> ou <code class=syntax>ColumnConstUInt8</code>.</p> <p><code class=syntax>IDataType</code> stocke uniquement les métadonnées. Par exemple, <code class=syntax>DataTypeUInt8</code> ne stocke rien du tout (sauf vptr) et <code class=syntax>DataTypeFixedString</code> magasins juste <code class=syntax>N</code> (la taille des chaînes de taille fixe).</p> <p><code class=syntax>IDataType</code> a des méthodes d'aide pour différents formats de données. Des exemples sont des méthodes pour sérialiser une valeur avec des guillemets possibles, pour sérialiser une valeur pour JSON et pour sérialiser une valeur dans le format XML. Il n'y a pas de correspondance directe avec les formats de données. Par exemple, les différents formats de données <code class=syntax>Pretty</code> et <code class=syntax>TabSeparated</code> pouvez utiliser le même <code class=syntax>serializeTextEscaped</code> méthode d'aide à partir de la <code class=syntax>IDataType</code> interface.</p> <h2 id=block>Bloc<a class=headerlink href=../amp/#block title="Permanent link"> </a></h2> <p>A <code class=syntax>Block</code> est un conteneur qui représente un sous-ensemble (morceau) d'une table en mémoire. C'est juste un ensemble de triplets: <code class=syntax>(IColumn, IDataType, column name)</code>. Pendant l'exécution de la requête, les données sont traitées par <code class=syntax>Block</code>s. Si nous avons un <code class=syntax>Block</code>, nous disposons de données (dans le <code class=syntax>IColumn</code> objet), nous avons des informations sur son type (dans <code class=syntax>IDataType</code>) qui nous indique comment traiter cette colonne, et nous avons le nom de la colonne. Il peut s'agir du nom de colonne d'origine de la table ou d'un nom artificiel attribué pour obtenir des résultats temporaires de calculs.</p> <p>Lorsque nous calculons une fonction sur des colonnes dans un bloc, nous ajoutons une autre colonne avec son résultat au bloc, et nous ne touchons pas les colonnes pour les arguments de la fonction car les opérations sont immuables. Plus tard, les colonnes inutiles peuvent être supprimées du bloc, mais pas modifiées. Il est pratique pour l'élimination des sous-expressions communes.</p> <p>Des blocs sont créés pour chaque bloc de données traité. Notez que pour le même type de calcul, les noms et les types de colonnes restent les mêmes pour différents blocs, et seules les données de colonne changent. Il est préférable de diviser les données de bloc de l'en-tête de bloc car les petites tailles de Bloc ont une surcharge élevée de chaînes temporaires pour copier shared_ptrs et les noms de colonnes.</p> <h2 id=block-streams>Bloquer Les Flux<a class=headerlink href=../amp/#block-streams title="Permanent link"> </a></h2> <p>Les flux de blocs sont destinés au traitement des données. Nous utilisons des flux de blocs pour lire des données quelque part, effectuer des transformations de données ou écrire des données quelque part. <code class=syntax>IBlockInputStream</code> a l' <code class=syntax>read</code> méthode pour récupérer le bloc suivant, tandis que des. <code class=syntax>IBlockOutputStream</code> a l' <code class=syntax>write</code> méthode pour pousser le bloc quelque part.</p> <p>Les flux sont responsables de:</p> <ol> <li>De la lecture ou de l'écriture dans une table. La table renvoie simplement un flux pour lire ou écrire des blocs.</li> <li>Mise en œuvre des formats de données. Par exemple, si vous souhaitez envoyer des données vers un terminal <code class=syntax>Pretty</code> format, vous créez un flux de sortie de bloc où vous poussez des blocs, et il les formate.</li> <li>Effectuer des transformations de données. Disons que vous avez <code class=syntax>IBlockInputStream</code> et veulent créer un flux filtré. Vous créez <code class=syntax>FilterBlockInputStream</code> et l'initialiser avec votre flux de données. Puis quand vous tirez un bloc de <code class=syntax>FilterBlockInputStream</code>, il extrait un bloc de votre flux, le filtre et vous renvoie le bloc filtré. Les pipelines d'exécution des requêtes sont représentés de cette façon.</li> </ol> <p>Il y a des transformations plus sophistiquées. Par exemple, lorsque vous tirez de <code class=syntax>AggregatingBlockInputStream</code> il lit toutes les données à partir de sa source, agrégats, puis renvoie un flux de données agrégées pour vous. Un autre exemple: <code class=syntax>UnionBlockInputStream</code> accepte de nombreuses sources d'entrée dans le constructeur et également un certain nombre de threads. Il lance plusieurs threads et lit à partir de plusieurs sources en parallèle.</p> <blockquote> <p>Les flux de blocs utilisent le “pull” approche pour contrôler le flux: lorsque vous extrayez un bloc du premier flux, il extrait par conséquent les blocs requis des flux imbriqués, et l'ensemble du pipeline d'exécution fonctionnera. Ni “pull” ni “push” est la meilleure solution, car le flux de contrôle est implicite, ce qui limite l'implémentation de diverses fonctionnalités telles que l'exécution simultanée de plusieurs requêtes (fusion de plusieurs pipelines ensemble). Cette limitation pourrait être surmontée avec des coroutines ou simplement en exécutant des threads supplémentaires qui s'attendent les uns aux autres. Nous pouvons avoir plus de possibilités si nous rendons le flux de contrôle explicite: si nous localisons la logique pour passer des données d'une unité de calcul à une autre en dehors de ces unités de calcul. Lire ce <a href=http://journal.stuffwithstuff.com/2013/01/13/iteration-inside-and-out/ rel="external nofollow noreferrer" target=_blank>article</a> pour plus de pensées.</p> </blockquote> <p>Il convient de noter que le pipeline d'exécution de la requête crée des données temporaires à chaque étape. Nous essayons de garder la taille du bloc suffisamment petite pour que les données temporaires tiennent dans le cache du processeur. Avec cette hypothèse, l'écriture et la lecture de données temporaires sont presque libres en comparaison avec d'autres calculs. Nous pourrions envisager une alternative, qui est de fusionner de nombreuses opérations dans le pipeline ensemble. Cela pourrait rendre le pipeline aussi court que possible et supprimer une grande partie des données temporaires, ce qui pourrait être un avantage, mais cela présente également des inconvénients. Par exemple, un pipeline divisé facilite l'implémentation de la mise en cache de données intermédiaires, le vol de données intermédiaires à partir de requêtes similaires exécutées en même temps et la fusion de pipelines pour des requêtes similaires.</p> <h2 id=formats>Format<a class=headerlink href=../amp/#formats title="Permanent link"> </a></h2> <p>Les formats de données sont implémentés avec des flux de blocs. Il y a “presentational” formats appropriés uniquement pour la sortie de données vers le client, tels que <code class=syntax>Pretty</code> format, qui fournit seulement <code class=syntax>IBlockOutputStream</code>. Et il existe des formats d'entrée / sortie, tels que <code class=syntax>TabSeparated</code> ou <code class=syntax>JSONEachRow</code>.</p> <p>Il y a aussi des flux de lignes: <code class=syntax>IRowInputStream</code> et <code class=syntax>IRowOutputStream</code>. Ils vous permettent de tirer/pousser des données par des lignes individuelles, pas par des blocs. Et ils ne sont nécessaires que pour simplifier la mise en œuvre des formats orientés ligne. Wrapper <code class=syntax>BlockInputStreamFromRowInputStream</code> et <code class=syntax>BlockOutputStreamFromRowOutputStream</code> vous permet de convertir des flux orientés ligne en flux orientés blocs réguliers.</p> <h2 id=io>I/O<a class=headerlink href=../amp/#io title="Permanent link"> </a></h2> <p>Pour l'entrée/sortie orientée octet, il y a <code class=syntax>ReadBuffer</code> et <code class=syntax>WriteBuffer</code> les classes abstraites. Ils sont utilisés à la place de C++ <code class=syntax>iostream</code>s. Ne vous inquiétez pas: chaque projet c++ mature utilise autre chose que <code class=syntax>iostream</code>s pour de bonnes raisons.</p> <p><code class=syntax>ReadBuffer</code> et <code class=syntax>WriteBuffer</code> sont juste un tampon contigu et un curseur pointant vers la position dans ce tampon. Les implémentations peuvent posséder ou non la mémoire du tampon. Il existe une méthode virtuelle pour remplir le tampon avec les données suivantes (pour <code class=syntax>ReadBuffer</code>) ou pour vider le tampon quelque part (pour <code class=syntax>WriteBuffer</code>). Les méthodes virtuelles sont rarement cités.</p> <p>Les implémentations de <code class=syntax>ReadBuffer</code>/<code class=syntax>WriteBuffer</code> sont utilisés pour travailler avec des fichiers et des descripteurs de fichiers et des sockets réseau, pour implémenter la compression (<code class=syntax>CompressedWriteBuffer</code> is initialized with another WriteBuffer and performs compression before writing data to it), and for other purposes – the names <code class=syntax>ConcatReadBuffer</code>, <code class=syntax>LimitReadBuffer</code>, et <code class=syntax>HashingWriteBuffer</code> parler pour eux-mêmes.</p> <p>Read / WriteBuffers ne traite que les octets. Il y a des fonctions de <code class=syntax>ReadHelpers</code> et <code class=syntax>WriteHelpers</code> fichiers d'en-tête pour aider à formater l'entrée / sortie. Par exemple, il existe des assistants pour écrire un nombre au format décimal.</p> <p>Regardons ce qui se passe lorsque vous voulez écrire un ensemble de résultats dans <code class=syntax>JSON</code> format de sortie standard (stdout). Vous avez un jeu de résultats prêt à être récupéré <code class=syntax>IBlockInputStream</code>. Vous créez <code class=syntax>WriteBufferFromFileDescriptor(STDOUT_FILENO)</code> pour écrire des octets dans stdout. Vous créez <code class=syntax>JSONRowOutputStream</code>, initialisé avec qui <code class=syntax>WriteBuffer</code>, pour écrire des lignes dans <code class=syntax>JSON</code> à stdout. Vous créez <code class=syntax>BlockOutputStreamFromRowOutputStream</code> de plus, pour la représenter comme <code class=syntax>IBlockOutputStream</code>. Ensuite, vous appelez <code class=syntax>copyData</code> pour transférer des données de <code class=syntax>IBlockInputStream</code> de <code class=syntax>IBlockOutputStream</code> et tout fonctionne. Interne, <code class=syntax>JSONRowOutputStream</code> écrira divers délimiteurs JSON et appellera <code class=syntax>IDataType::serializeTextJSON</code> méthode avec une référence à <code class=syntax>IColumn</code> et le numéro de ligne comme arguments. Conséquent, <code class=syntax>IDataType::serializeTextJSON</code> appellera une méthode de <code class=syntax>WriteHelpers.h</code>: exemple, <code class=syntax>writeText</code> pour les types numériques et <code class=syntax>writeJSONString</code> pour <code class=syntax>DataTypeString</code>.</p> <h2 id=tables>Table<a class=headerlink href=../amp/#tables title="Permanent link"> </a></h2> <p>Le <code class=syntax>IStorage</code> l'interface représente les tables. Différentes implémentations de cette interface sont des moteurs de table différents. Les exemples sont <code class=syntax>StorageMergeTree</code>, <code class=syntax>StorageMemory</code> et ainsi de suite. Les Instances de ces classes ne sont que des tables.</p> <p>Clé <code class=syntax>IStorage</code> les méthodes sont <code class=syntax>read</code> et <code class=syntax>write</code>. Il y a aussi des <code class=syntax>alter</code>, <code class=syntax>rename</code>, <code class=syntax>drop</code> et ainsi de suite. Le <code class=syntax>read</code> méthode accepte les arguments suivants: l'ensemble de colonnes à lire à partir d'un tableau, l' <code class=syntax>AST</code> requête à considérer, et le nombre souhaité de flux de retour. Il renvoie un ou plusieurs <code class=syntax>IBlockInputStream</code> objets et informations sur l'étape de traitement des données qui a été effectuée dans un moteur de table lors de l'exécution de la requête.</p> <p>Dans la plupart des cas, la méthode read n'est responsable que de la lecture des colonnes spécifiées à partir d'une table, et non d'un traitement ultérieur des données. Tout traitement ultérieur des données est effectué par l'interpréteur de requêtes et n'est pas de la responsabilité de <code class=syntax>IStorage</code>.</p> <p>Mais il y a des exceptions notables:</p> <ul> <li>La requête AST est transmise au <code class=syntax>read</code> et le moteur de table peut l'utiliser pour dériver l'utilisation de l'index et pour lire moins de données à partir d'une table.</li> <li>Parfois, le moteur de table peut traiter les données lui-même à une étape spécifique. Exemple, <code class=syntax>StorageDistributed</code> peut envoyer une requête aux serveurs distants, leur demander de traiter les données à une étape où les données de différents serveurs distants peuvent être fusionnées, et renvoyer ces données prétraitées. L'interpréteur de requête termine ensuite le traitement des données.</li> </ul> <p>Table <code class=syntax>read</code> la méthode peut retourner plusieurs <code class=syntax>IBlockInputStream</code> objets permettant le traitement parallèle des données. Ces flux d'entrée de bloc multiples peuvent lire à partir d'une table en parallèle. Ensuite, vous pouvez envelopper ces flux avec diverses transformations (telles que l'évaluation d'expression ou le filtrage) qui peuvent être calculées indépendamment et créer un <code class=syntax>UnionBlockInputStream</code> en plus d'eux, pour lire à partir de plusieurs flux en parallèle.</p> <p>Il y a aussi des <code class=syntax>TableFunction</code>s. Ce sont des fonctions qui renvoient un <code class=syntax>IStorage</code> objet à utiliser dans le <code class=syntax>FROM</code> la clause d'une requête.</p> <p>Pour avoir une idée rapide de la façon d'implémenter votre moteur de table, regardez quelque chose de simple, comme <code class=syntax>StorageMemory</code> ou <code class=syntax>StorageTinyLog</code>.</p> <blockquote> <p>Comme le résultat de l' <code class=syntax>read</code> méthode, <code class=syntax>IStorage</code> retourner <code class=syntax>QueryProcessingStage</code> – information about what parts of the query were already calculated inside storage.</p> </blockquote> <h2 id=parsers>Analyseur<a class=headerlink href=../amp/#parsers title="Permanent link"> </a></h2> <p>Un analyseur de descente récursif écrit à la main analyse une requête. Exemple, <code class=syntax>ParserSelectQuery</code> appelle simplement récursivement les analyseurs sous-jacents pour diverses parties de la requête. Les analyseurs créent un <code class=syntax>AST</code>. Le <code class=syntax>AST</code> est représenté par des nœuds, qui sont des instances de <code class=syntax>IAST</code>.</p> <blockquote> <p>Les générateurs d'analyseurs ne sont pas utilisés pour des raisons historiques.</p> </blockquote> <h2 id=interpreters>Interprète<a class=headerlink href=../amp/#interpreters title="Permanent link"> </a></h2> <p>Les interprètes sont responsables de la création du pipeline d'exécution des requêtes à partir <code class=syntax>AST</code>. Il existe des interprètes simples, tels que <code class=syntax>InterpreterExistsQuery</code> et <code class=syntax>InterpreterDropQuery</code> ou le plus sophistiqué de <code class=syntax>InterpreterSelectQuery</code>. Le pipeline d'exécution de requête est une combinaison de flux d'entrée ou de sortie de bloc. Par exemple, le résultat de l'interprétation de la <code class=syntax>SELECT</code> la requête est la <code class=syntax>IBlockInputStream</code> pour lire le jeu de résultats; le résultat de la requête d'INSERTION est l' <code class=syntax>IBlockOutputStream</code> pour écrire des données à insérer, et le résultat de l'interprétation <code class=syntax>INSERT SELECT</code> la requête est la <code class=syntax>IBlockInputStream</code> cela renvoie un jeu de résultats vide lors de la première lecture, mais qui copie <code class=syntax>SELECT</code> de <code class=syntax>INSERT</code> dans le même temps.</p> <p><code class=syntax>InterpreterSelectQuery</code> utiliser <code class=syntax>ExpressionAnalyzer</code> et <code class=syntax>ExpressionActions</code> machines pour l'analyse des requêtes et des transformations. C'est là que la plupart des optimisations de requêtes basées sur des règles sont effectuées. <code class=syntax>ExpressionAnalyzer</code> est assez désordonné et devrait être réécrit: diverses transformations et optimisations de requête doivent être extraites dans des classes séparées pour permettre des transformations modulaires ou une requête.</p> <h2 id=functions>Fonction<a class=headerlink href=../amp/#functions title="Permanent link"> </a></h2> <p>Il y a des fonctions ordinaires et des fonctions agrégées. Pour les fonctions d'agrégation, voir la section suivante.</p> <p>Ordinary functions don't change the number of rows – they work as if they are processing each row independently. In fact, functions are not called for individual rows, but for <code class=syntax>Block</code>'s de données pour implémenter l'exécution de requête vectorisée.</p> <p>Il y a quelques fonctions diverses, comme <a href=../../../sql-reference/functions/other-functions/amp/#function-blocksize>la taille de bloc</a>, <a href=../../../sql-reference/functions/other-functions/amp/#function-rownumberinblock>rowNumberInBlock</a>, et <a href=../../../sql-reference/functions/other-functions/amp/#function-runningaccumulate>runningAccumulate</a>, qui exploitent le traitement de bloc et violent l'indépendance des lignes.</p> <p>ClickHouse a un typage fort, donc il n'y a pas de conversion de type implicite. Si une fonction ne prend pas en charge une combinaison spécifique de types, elle lève une exception. Mais les fonctions peuvent fonctionner (être surchargées) pour de nombreuses combinaisons de types différentes. Par exemple, l' <code class=syntax>plus</code> fonction (pour mettre en œuvre la <code class=syntax>+</code> opérateur) fonctionne pour toute combinaison de types numériques: <code class=syntax>UInt8</code> + <code class=syntax>Float32</code>, <code class=syntax>UInt16</code> + <code class=syntax>Int8</code> et ainsi de suite. En outre, certaines fonctions variadiques peuvent accepter n'importe quel nombre d'arguments, tels que <code class=syntax>concat</code> fonction.</p> <p>L'implémentation d'une fonction peut être légèrement gênante car une fonction distribue explicitement les types de données pris en charge et pris en charge <code class=syntax>IColumns</code>. Par exemple, l' <code class=syntax>plus</code> la fonction a du code généré par l'instanciation D'un modèle C++ pour chaque combinaison de types numériques, et des arguments gauche et droit constants ou non constants.</p> <p>C'est un excellent endroit pour implémenter la génération de code d'exécution pour éviter le gonflement du code de modèle. En outre, il permet d'ajouter des fonctions fusionnées comme Fusionné Multiplier-Ajouter ou de faire plusieurs comparaisons dans une itération de boucle.</p> <p>En raison de l'exécution de requête vectorisée, les fonctions ne sont pas court-circuitées. Par exemple, si vous écrivez <code class=syntax>WHERE f(x) AND g(y)</code> les deux faces sont calculés, même pour les lignes, quand <code class=syntax>f(x)</code> est égal à zéro (sauf quand <code class=syntax>f(x)</code> est une expression constante nulle). Mais si la sélectivité de l' <code class=syntax>f(x)</code> la condition est élevée, et le calcul de <code class=syntax>f(x)</code> est beaucoup moins cher que <code class=syntax>g(y)</code>, il est préférable d'implémenter le calcul multi-pass. Il serait d'abord calculer <code class=syntax>f(x)</code> puis filtrer les colonnes par la suite, puis de calculer <code class=syntax>g(y)</code> uniquement pour les petits morceaux de données filtrés.</p> <h2 id=aggregate-functions>Les Fonctions D'Agrégation<a class=headerlink href=../amp/#aggregate-functions title="Permanent link"> </a></h2> <p>Les fonctions d'agrégation sont des fonctions avec État. Ils accumulent les valeurs passées dans certains etats et vous permettent d'obtenir des résultats de cet état. Ils sont gérés avec le <code class=syntax>IAggregateFunction</code> interface. Les États peuvent être assez simples (l'État pour <code class=syntax>AggregateFunctionCount</code> est juste un seul <code class=syntax>UInt64</code> valeur) ou très complexes (l'état de <code class=syntax>AggregateFunctionUniqCombined</code> est une combinaison linéaire du tableau, d'une table de hachage, et un <code class=syntax>HyperLogLog</code> structure probabiliste des données).</p> <p>Les États sont répartis en <code class=syntax>Arena</code> (un pool de mémoire) pour traiter plusieurs états lors de l'exécution d'une cardinalité élevée <code class=syntax>GROUP BY</code> requête. Les États peuvent avoir un constructeur et un destructeur non triviaux: par exemple, les États d'agrégation compliqués peuvent allouer eux-mêmes de la mémoire supplémentaire. Il faut accorder une certaine attention à la création et à la destruction des États et à la transmission appropriée de leur propriété et de leur ordre de destruction.</p> <p>Les États d'agrégation peuvent être sérialisés et désérialisés pour passer sur le réseau pendant l'exécution de la requête distribuée ou pour les écrire sur le disque où il n'y a pas assez de RAM. Ils peuvent même être stockés dans une table avec le <code class=syntax>DataTypeAggregateFunction</code> pour permettre l'agrégation incrémentielle des données.</p> <blockquote> <p>Le format de données sérialisé pour les états de fonction d'agrégat n'est pas versionné pour le moment. C'est ok si les États d'agrégat ne sont stockés que temporairement. Mais nous avons l' <code class=syntax>AggregatingMergeTree</code> moteur de table pour l'agrégation incrémentielle, et les gens l'utilisent déjà en production. C'est la raison pour laquelle la rétrocompatibilité est requise lors de la modification du format sérialisé pour toute fonction d'agrégat à l'avenir.</p> </blockquote> <h2 id=server>Serveur<a class=headerlink href=../amp/#server title="Permanent link"> </a></h2> <p>Le serveur implémente plusieurs interfaces différentes:</p> <ul> <li>Une interface HTTP pour tous les clients étrangers.</li> <li>Une interface TCP pour le client clickhouse natif et pour la communication inter-serveur lors de l'exécution de la requête distribuée.</li> <li>Une interface pour transférer des données pour la réplication.</li> </ul> <p>En interne, il s'agit simplement d'un serveur multithread primitif sans coroutines ni fibres. Étant donné que le serveur n'est pas conçu pour traiter un taux élevé de requêtes simples, mais pour traiter un taux relativement faible de requêtes complexes, chacun d'eux peut traiter une grande quantité de données à des fins d'analyse.</p> <p>Le serveur initialise le <code class=syntax>Context</code> classe avec l'environnement nécessaire à l'exécution des requêtes: la liste des bases de données disponibles, des utilisateurs et des droits d'accès, des paramètres, des clusters, la liste des processus, le journal des requêtes, etc. Les interprètes utilisent cet environnement.</p> <p>Nous maintenons une compatibilité ascendante et descendante complète pour le protocole TCP du serveur: les anciens clients peuvent parler à de nouveaux serveurs, et les nouveaux clients peuvent parler à d'anciens serveurs. Mais nous ne voulons pas le maintenir éternellement, et nous supprimons le support pour les anciennes versions après environ un an.</p> <div class="admonition note alert pb-0 mb-4 alert-primary" role=alert> <p class="admonition-title alert-heading display-6 mb-2">Note</p> <p>Pour la plupart des applications externes, nous vous recommandons d'utiliser L'interface HTTP car elle est simple et facile à utiliser. Le protocole TCP est plus étroitement lié aux structures de données internes: il utilise un format interne pour passer des blocs de données, et il utilise un cadrage personnalisé pour les données compressées. Nous n'avons pas publié de bibliothèque C pour ce protocole car elle nécessite de lier la plupart de la base de code ClickHouse, ce qui n'est pas pratique.</p> </div> <h2 id=distributed-query-execution>Exécution De Requête Distribuée<a class=headerlink href=../amp/#distributed-query-execution title="Permanent link"> </a></h2> <p>Les serveurs d'une configuration de cluster sont pour la plupart indépendants. Vous pouvez créer un <code class=syntax>Distributed</code> table sur un ou tous les serveurs dans un cluster. Le <code class=syntax>Distributed</code> table does not store data itself – it only provides a “view” à toutes les tables sur plusieurs nœuds d'un cluster. Lorsque vous sélectionnez à partir d'un <code class=syntax>Distributed</code> table, il réécrit cette requête, choisit les nœuds distants en fonction des paramètres d'équilibrage de charge et leur envoie la requête. Le <code class=syntax>Distributed</code> table demande aux serveurs distants de traiter une requête jusqu'à une étape où les résultats intermédiaires de différents serveurs peuvent être fusionnés. Puis il reçoit les résultats intermédiaires et les fusionne. La table distribuée essaie de distribuer autant de travail que possible aux serveurs distants et n'envoie pas beaucoup de données intermédiaires sur le réseau.</p> <p>Les choses deviennent plus compliquées lorsque vous avez des sous-requêtes dans des clauses IN ou JOIN, et que chacune d'elles utilise un <code class=syntax>Distributed</code> table. Nous avons différentes stratégies pour l'exécution de ces requêtes.</p> <p>Il n'existe pas de plan de requête global pour l'exécution des requêtes distribuées. Chaque nœud a son plan de requête local pour sa partie du travail. Nous n'avons qu'une simple exécution de requête distribuée en une seule passe: nous envoyons des requêtes pour les nœuds distants, puis fusionnons les résultats. Mais cela n'est pas possible pour les requêtes compliquées avec des groupes de cardinalité élevés ou avec une grande quantité de données temporaires pour la jointure. Dans de tels cas, nous avons besoin de “reshuffle” données entre les serveurs, ce qui nécessite une coordination supplémentaire. ClickHouse ne supporte pas ce type d'exécution de requête, et nous devons y travailler.</p> <h2 id=merge-tree>Fusion De L'Arbre<a class=headerlink href=../amp/#merge-tree title="Permanent link"> </a></h2> <p><code class=syntax>MergeTree</code> est une famille de moteurs de stockage qui prend en charge l'indexation par clé primaire. La clé primaire peut être un tuple arbitraire de colonnes ou d'expressions. De données dans un <code class=syntax>MergeTree</code> la table est stockée dans “parts”. Chaque partie stocke les données dans l'ordre de la clé primaire, de sorte que les données sont ordonnées lexicographiquement par le tuple de clé primaire. Toutes les colonnes du tableau sont stockés dans différents <code class=syntax>column.bin</code> les fichiers dans ces régions. Les fichiers sont constitués de blocs compressés. Chaque bloc est généralement de 64 KO à 1 Mo de données non compressées, en fonction de la taille de la valeur moyenne. Les blocs sont constitués de valeurs de colonne placées de manière contiguë l'une après l'autre. Les valeurs de colonne sont dans le même ordre pour chaque colonne (la clé primaire définit l'ordre), donc lorsque vous itérez par plusieurs colonnes, vous obtenez des valeurs pour les lignes correspondantes.</p> <p>La clé primaire elle-même est “sparse”. Il ne traite pas chaque ligne, mais seulement certaines plages de données. Séparé <code class=syntax>primary.idx</code> fichier a la valeur de la clé primaire pour chaque N-ième ligne, où N est appelé <code class=syntax>index_granularity</code> (habituellement, N = 8192). Aussi, pour chaque colonne, nous avons <code class=syntax>column.mrk</code> les fichiers avec l' “marks,” qui sont des décalages à chaque N-ème ligne dans le fichier de données. Chaque marque est une paire: le décalage dans le fichier au début du bloc compressé, et le décalage dans le bloc décompressé au début des données. Habituellement, les blocs compressés sont alignés par des marques, et le décalage dans le bloc décompressé est nul. Les données pour <code class=syntax>primary.idx</code> réside toujours dans la mémoire, et les données pour <code class=syntax>column.mrk</code> les fichiers sont mis en cache.</p> <p>Quand nous allons lire quelque chose d'une partie dans <code class=syntax>MergeTree</code> nous regardons <code class=syntax>primary.idx</code> données et locate plages qui pourraient contenir des données demandées, puis regardez <code class=syntax>column.mrk</code> données et calculer des décalages pour savoir où commencer à lire ces plages. En raison de la rareté, les données excédentaires peuvent être lues. ClickHouse ne convient pas à une charge élevée de requêtes ponctuelles simples, car toute la gamme avec <code class=syntax>index_granularity</code> les lignes doivent être lues pour chaque clé, et le bloc compressé entier doit être décompressé pour chaque colonne. Nous avons rendu l'index clairsemé parce que nous devons être en mesure de maintenir des milliards de lignes par serveur unique sans consommation de mémoire notable pour l'index. De plus, comme la clé primaire est clairsemée, elle n'est pas unique: elle ne peut pas vérifier l'existence de la clé dans la table au moment de l'insertion. Vous pourriez avoir plusieurs lignes avec la même clé dans une table.</p> <p>Lorsque vous <code class=syntax>INSERT</code> un tas de données dans <code class=syntax>MergeTree</code>, ce groupe est trié par ordre de clé primaire et forme une nouvelle partie. Il existe des threads d'arrière-plan qui sélectionnent périodiquement certaines parties et les fusionnent en une seule partie triée pour maintenir le nombre de parties relativement faible. C'est pourquoi il est appelé <code class=syntax>MergeTree</code>. Bien sûr, la fusion conduit à “write amplification”. Toutes les parties sont immuables: elles sont seulement créées et supprimées, mais pas modifiées. Lorsque SELECT est exécuté, il contient un instantané de la table (un ensemble de parties). Après la Fusion, nous conservons également les anciennes pièces pendant un certain temps pour faciliter une récupération après une défaillance, donc si nous voyons qu'une partie fusionnée est probablement cassée, nous pouvons la remplacer par ses parties sources.</p> <p><code class=syntax>MergeTree</code> n'est pas un arbre LSM car il ne contient pas “memtable” et “log”: inserted data is written directly to the filesystem. This makes it suitable only to INSERT data in batches, not by individual row and not very frequently – about once per second is ok, but a thousand times a second is not. We did it this way for simplicity's sake, and because we are already inserting data in batches in our applications.</p> <blockquote> <p>Les tables MergeTree ne peuvent avoir qu'un seul index (primaire): il n'y a pas d'index secondaires. Il serait bon d'autoriser plusieurs représentations physiques sous une table logique, par exemple, pour stocker des données dans plus d'un ordre physique ou même pour autoriser des représentations avec des données pré-agrégées avec des données originales.</p> </blockquote> <p>Il existe des moteurs MergeTree qui effectuent un travail supplémentaire lors des fusions en arrière-plan. Les exemples sont <code class=syntax>CollapsingMergeTree</code> et <code class=syntax>AggregatingMergeTree</code>. Cela pourrait être traité comme un support spécial pour les mises à jour. Gardez à l'esprit que ce ne sont pas de vraies mises à jour car les utilisateurs n'ont généralement aucun contrôle sur le moment où les fusions en arrière-plan sont exécutées et les données dans un <code class=syntax>MergeTree</code> la table est presque toujours stockée dans plus d'une partie, pas sous une forme complètement fusionnée.</p> <h2 id=replication>Réplication<a class=headerlink href=../amp/#replication title="Permanent link"> </a></h2> <p>La réplication dans ClickHouse peut être configurée sur une base par table. Vous pouvez avoir des tables répliquées et des tables non répliquées sur le même serveur. Vous pouvez également avoir des tables répliquées de différentes manières, comme une table avec une réplication à deux facteurs et une autre avec trois facteurs.</p> <p>La réplication est implémentée dans le <code class=syntax>ReplicatedMergeTree</code> moteur de stockage. Le chemin d'accès dans <code class=syntax>ZooKeeper</code> est spécifié comme paramètre pour le moteur de stockage. Toutes les tables avec le même chemin dans <code class=syntax>ZooKeeper</code> devenez des répliques les unes des autres: elles synchronisent leurs données et maintiennent la cohérence. Les répliques peuvent être ajoutées et supprimées dynamiquement simplement en créant ou en supprimant une table.</p> <p>La réplication utilise un schéma multi-maître asynchrone. Vous pouvez insérer des données dans n'importe quel réplica qui a une session avec <code class=syntax>ZooKeeper</code>, et les données sont répliquées à toutes les autres répliques de manière asynchrone. Parce que ClickHouse ne prend pas en charge les mises à jour, la réplication est sans conflit. Comme il n'y a pas d'accusé de réception de quorum des insertions, les données juste insérées peuvent être perdues si un nœud échoue.</p> <p>Les métadonnées pour la réplication sont stockées dans ZooKeeper. Il existe un journal de réplication qui répertorie les actions à effectuer. Les Actions sont: obtenir une partie; fusionner des parties; déposer une partition, et ainsi de suite. Chaque réplica copie le journal de réplication dans sa file d'attente, puis exécute les actions de la file d'attente. Par exemple, sur l'insertion, l' “get the part” l'action est créée dans le journal, et chaque réplique téléchargements de la partie. Les fusions sont coordonnées entre les répliques pour obtenir des résultats identiques aux octets. Toutes les parties sont fusionnées de la même manière sur toutes les répliques. Il est réalisé en élisant une réplique en tant que leader, et cette réplique initie fusionne et écrit “merge parts” actions dans le journal.</p> <p>La réplication est physique: seules les parties compressées sont transférées entre les nœuds, pas les requêtes. Les fusions sont traitées sur chaque réplique indépendamment dans la plupart des cas pour réduire les coûts du réseau en évitant l'amplification du réseau. Grand fusionné les pièces sont envoyées sur le réseau uniquement en cas de retard de réplication.</p> <p>En outre, chaque réplique stocke son état dans ZooKeeper comme l'ensemble des pièces et ses sommes de contrôle. Lorsque l'état sur le système de fichiers local diverge de l'état de référence dans ZooKeeper, le réplica restaure sa cohérence en téléchargeant les parties manquantes et brisées à partir d'autres réplicas. Lorsqu'il y a des données inattendues ou brisées dans le système de fichiers local, ClickHouse ne les supprime pas, mais les déplace dans un répertoire séparé et les oublie.</p> <div class="admonition note alert pb-0 mb-4 alert-primary" role=alert> <p class="admonition-title alert-heading display-6 mb-2">Note</p> <p>Le cluster ClickHouse est constitué de fragments indépendants, et chaque fragment est constitué de répliques. Le cluster est <strong>pas élastique</strong>, donc, après avoir ajouté un nouveau fragment, les données ne sont pas rééquilibrées automatiquement entre les fragments. Au lieu de cela, la charge du cluster est censée être ajustée pour être inégale. Cette implémentation vous donne plus de contrôle, et c'est ok pour des clusters relativement petits, tels que des dizaines de nœuds. Mais pour les clusters avec des centaines de nœuds que nous utilisons en production, cette approche devient un inconvénient important. Nous devrions implémenter un moteur de table qui s'étend sur le cluster avec des régions répliquées dynamiquement qui pourraient être divisées et équilibrées automatiquement entre les clusters.</p> </div> </div> </div> <div class=row> <div class=col> <div class="alert alert-light my-3"> <p class="float-right mb-0">Rating: RATING_VALUE - RATING_COUNT votes</p> <span class="alert-heading display-6">Article Rating</span> <div id=rating-stars class="display-6 mb-0">RATING_STARS</div> </div> <div id=content-footer class="text-muted pt-3 mb-5"> <div class=float-md-right>©2016–2020 Yandex LLC</div> <div>Built from <a href=https://github.com/ClickHouse/ClickHouse/commit/b030bfedd7db4603034643fd183cf7784a820193 rel="external nofollow noreferrer" target=_blank class=text-reset>b030bfedd7</a> </div> </div> </div> </div> <div id=to-full-website class="row fixed-bottom text-center bg-white py-3"> <div class=col> <a href=https://clickhouse.tech/docs/fr/development/architecture/ class="btn btn-lg btn-outline-orange">To full website</a> </div> </div> </div> <amp-analytics type=metrika> <script type=application/json>{
"vars": {
  "counterId": "18343495",
  "triggers": {
    "notBounce": {
      "on": "timer",
      "timerSpec": {
        "immediate": false,
        "interval": 15,
        "maxTimerLength": 16
      },
      "request": "notBounce"
    }
  }
}
}</script> </amp-analytics> </body> </html> 