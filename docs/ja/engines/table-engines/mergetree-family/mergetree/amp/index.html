<!doctype html><html ⚡ lang=ja> <head><meta charset=utf-8><script async src=https://cdn.ampproject.org/v0.js></script><title>メルゲツリー | ClickHouseドキュメント</title><link href=https://clickhouse.tech/docs/ja/engines/table-engines/mergetree-family/mergetree/ rel=canonical><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><script type=application/ld+json>[{
"@context": "http://schema.org",
"@type": "TechArticle",
"headline": "メルゲツリー | ClickHouseドキュメント",
"mainEntityOfPage": "https://clickhouse.tech/docs/ja/engines/table-engines/mergetree-family/mergetree/",




"image": "https://clickhouse.tech/images/logo-209x60.png",
"author": {
  "@type": "Project",
  "name": "ClickHouse"
},
"publisher": {
  "@type": "Organization",
  "name": "Yandex LLC",
  "logo": {
    "@type": "ImageObject",
    "url": "https://clickhouse.tech/images/yandex.png",
    "width": 163,
    "height": 60
  }
}}, {
"@context": "http://schema.org",
"@type": "Episode",
"name": "メルゲツリー | ClickHouseドキュメント",
"aggregateRating": {
  "@type": "AggregateRating",
  "ratingValue": RATING_VALUE,
  "ratingCount": RATING_COUNT
}
}]</script><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><style amp-custom>:root{--blue:#007bff;--indigo:#6610f2;--purple:#6f42c1;--pink:#e83e8c;--red:#dc3545;--orange:#fd7e14;--yellow:#ffc107;--green:#28a745;--teal:#20c997;--cyan:#17a2b8;--white:#fff;--gray:#6c757d;--gray-dark:#343a40;--primary:#007bff;--secondary:#6c757d;--success:#28a745;--info:#17a2b8;--warning:#ffc107;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--breakpoint-xs:0;--breakpoint-sm:576px;--breakpoint-md:768px;--breakpoint-lg:992px;--breakpoint-xl:1200px;--font-family-sans-serif:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-family-monospace:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}*,::after,::before{box-sizing:border-box}html{font-family:sans-serif;line-height:1.15;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}article,footer,header,main{display:block}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;text-align:left;background-color:#fff}[tabindex="-1"]:focus:not(:focus-visible){outline:0}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem}p{margin-top:0;margin-bottom:1rem}ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}b,strong{font-weight:bolder}a{color:#007bff;text-decoration:none;background-color:transparent}a:hover{color:#0056b3;text-decoration:underline}a:not([href]){color:inherit;text-decoration:none}a:not([href]):hover{color:inherit;text-decoration:none}code,pre{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em}pre{margin-top:0;margin-bottom:1rem;overflow:auto}img{vertical-align:middle;border-style:none}svg{overflow:hidden;vertical-align:middle}table{border-collapse:collapse}th{text-align:inherit}select{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}select{text-transform:none}select{word-wrap:normal}[type=button],[type=reset],[type=submit]{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled){cursor:pointer}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{padding:0;border-style:none}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:none}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}summary{display:list-item;cursor:pointer}[hidden]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:500;line-height:1.2}.h1,h1{font-size:2rem}.h2,h2{font-size:1.5rem}.h3,h3{font-size:1.25rem}.h4,h4{font-size:1rem}.h5,h5{font-size:1rem}.h6,h6{font-size:1rem}.lead{font-size:1.25rem;font-weight:300}.display-1{font-size:6rem;font-weight:300;line-height:1.2}.display-2{font-size:5.5rem;font-weight:300;line-height:1.2}.display-3{font-size:4.5rem;font-weight:300;line-height:1.2}.display-4{font-size:3.5rem;font-weight:300;line-height:1.2}.mark,mark{padding:.2em;background-color:#fcf8e3}.list-inline{padding-left:0;list-style:none}.img-fluid{max-width:100%;height:auto}code{font-size:87.5%;color:#e83e8c;word-wrap:break-word}a>code{color:inherit}pre{display:block;font-size:87.5%;color:#212529}pre code{font-size:inherit;color:inherit;word-break:normal}.container{width:100%;padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media(min-width:576px){.container{max-width:540px}}@media(min-width:768px){.container{max-width:720px}}@media(min-width:992px){.container{max-width:960px}}@media(min-width:1200px){.container{max-width:1140px}}.container-fluid,.container-lg,.container-md{width:100%;padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media(min-width:576px){.container{max-width:540px}}@media(min-width:768px){.container,.container-md{max-width:720px}}@media(min-width:992px){.container,.container-lg,.container-md{max-width:960px}}@media(min-width:1200px){.container,.container-lg,.container-md{max-width:1140px}}.row{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-15px;margin-left:-15px}.col,.col-1,.col-10,.col-11,.col-12,.col-2,.col-3,.col-4,.col-5,.col-6,.col-7,.col-8,.col-9,.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9{position:relative;width:100%;padding-right:15px;padding-left:15px}.col{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-last{-ms-flex-order:13;order:13}.order-0{-ms-flex-order:0;order:0}.order-1{-ms-flex-order:1;order:1}.order-2{-ms-flex-order:2;order:2}.order-3{-ms-flex-order:3;order:3}.order-4{-ms-flex-order:4;order:4}.order-5{-ms-flex-order:5;order:5}.order-6{-ms-flex-order:6;order:6}.order-7{-ms-flex-order:7;order:7}.order-8{-ms-flex-order:8;order:8}.order-9{-ms-flex-order:9;order:9}.order-10{-ms-flex-order:10;order:10}.order-11{-ms-flex-order:11;order:11}.order-12{-ms-flex-order:12;order:12}@media(min-width:768px){.col-md{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-md-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-md-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-md-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-md-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-md-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-md-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-md-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-md-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-md-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-md-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-md-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-md-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-md-last{-ms-flex-order:13;order:13}.order-md-0{-ms-flex-order:0;order:0}.order-md-1{-ms-flex-order:1;order:1}.order-md-2{-ms-flex-order:2;order:2}.order-md-3{-ms-flex-order:3;order:3}.order-md-4{-ms-flex-order:4;order:4}.order-md-5{-ms-flex-order:5;order:5}.order-md-6{-ms-flex-order:6;order:6}.order-md-7{-ms-flex-order:7;order:7}.order-md-8{-ms-flex-order:8;order:8}.order-md-9{-ms-flex-order:9;order:9}.order-md-10{-ms-flex-order:10;order:10}.order-md-11{-ms-flex-order:11;order:11}.order-md-12{-ms-flex-order:12;order:12}}@media(min-width:992px){.col-lg{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-lg-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-lg-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-lg-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-lg-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-lg-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-lg-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-lg-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-lg-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-lg-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-lg-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-lg-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-lg-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-lg-last{-ms-flex-order:13;order:13}.order-lg-0{-ms-flex-order:0;order:0}.order-lg-1{-ms-flex-order:1;order:1}.order-lg-2{-ms-flex-order:2;order:2}.order-lg-3{-ms-flex-order:3;order:3}.order-lg-4{-ms-flex-order:4;order:4}.order-lg-5{-ms-flex-order:5;order:5}.order-lg-6{-ms-flex-order:6;order:6}.order-lg-7{-ms-flex-order:7;order:7}.order-lg-8{-ms-flex-order:8;order:8}.order-lg-9{-ms-flex-order:9;order:9}.order-lg-10{-ms-flex-order:10;order:10}.order-lg-11{-ms-flex-order:11;order:11}.order-lg-12{-ms-flex-order:12;order:12}}.table{width:100%;margin-bottom:1rem;color:#212529}.table td,.table th{padding:.75rem;vertical-align:top;border-top:1px solid #dee2e6}.table thead th{vertical-align:bottom;border-bottom:2px solid #dee2e6}.table tbody+tbody{border-top:2px solid #dee2e6}.table-primary,.table-primary>td,.table-primary>th{background-color:#b8daff}.table-primary tbody+tbody,.table-primary td,.table-primary th,.table-primary thead th{border-color:#7abaff}.table-info,.table-info>td,.table-info>th{background-color:#bee5eb}.table-info tbody+tbody,.table-info td,.table-info th,.table-info thead th{border-color:#86cfda}.table-warning,.table-warning>td,.table-warning>th{background-color:#ffeeba}.table-warning tbody+tbody,.table-warning td,.table-warning th,.table-warning thead th{border-color:#ffdf7e}.table-light,.table-light>td,.table-light>th{background-color:#fdfdfe}.table-light tbody+tbody,.table-light td,.table-light th,.table-light thead th{border-color:#fbfcfc}.table-dark,.table-dark>td,.table-dark>th{background-color:#c6c8ca}.table-dark tbody+tbody,.table-dark td,.table-dark th,.table-dark thead th{border-color:#95999c}.table .thead-dark th{color:#fff;background-color:#343a40;border-color:#454d55}.table .thead-light th{color:#495057;background-color:#e9ecef;border-color:#dee2e6}.table-dark{color:#fff;background-color:#343a40}.table-dark td,.table-dark th,.table-dark thead th{border-color:#454d55}.btn{display:inline-block;font-weight:400;color:#212529;text-align:center;vertical-align:middle;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background-color:transparent;border:1px solid transparent;padding:.375rem .75rem;font-size:1rem;line-height:1.5;border-radius:.25rem}@media(prefers-reduced-motion:reduce){.btn{transition:none}}.btn:hover{color:#212529;text-decoration:none}.btn:focus{outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.btn:disabled{opacity:.65}.btn-primary{color:#fff;background-color:#007bff;border-color:#007bff}.btn-primary:hover{color:#fff;background-color:#0069d9;border-color:#0062cc}.btn-primary:focus{color:#fff;background-color:#0069d9;border-color:#0062cc;box-shadow:0 0 0 .2rem rgba(38,143,255,.5)}.btn-primary:disabled{color:#fff;background-color:#007bff;border-color:#007bff}.btn-info{color:#fff;background-color:#17a2b8;border-color:#17a2b8}.btn-info:hover{color:#fff;background-color:#138496;border-color:#117a8b}.btn-info:focus{color:#fff;background-color:#138496;border-color:#117a8b;box-shadow:0 0 0 .2rem rgba(58,176,195,.5)}.btn-info:disabled{color:#fff;background-color:#17a2b8;border-color:#17a2b8}.btn-warning{color:#212529;background-color:#ffc107;border-color:#ffc107}.btn-warning:hover{color:#212529;background-color:#e0a800;border-color:#d39e00}.btn-warning:focus{color:#212529;background-color:#e0a800;border-color:#d39e00;box-shadow:0 0 0 .2rem rgba(222,170,12,.5)}.btn-warning:disabled{color:#212529;background-color:#ffc107;border-color:#ffc107}.btn-light{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-light:hover{color:#212529;background-color:#e2e6ea;border-color:#dae0e5}.btn-light:focus{color:#212529;background-color:#e2e6ea;border-color:#dae0e5;box-shadow:0 0 0 .2rem rgba(216,217,219,.5)}.btn-light:disabled{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-dark{color:#fff;background-color:#343a40;border-color:#343a40}.btn-dark:hover{color:#fff;background-color:#23272b;border-color:#1d2124}.btn-dark:focus{color:#fff;background-color:#23272b;border-color:#1d2124;box-shadow:0 0 0 .2rem rgba(82,88,93,.5)}.btn-dark:disabled{color:#fff;background-color:#343a40;border-color:#343a40}.btn-outline-primary{color:#007bff;border-color:#007bff}.btn-outline-primary:hover{color:#fff;background-color:#007bff;border-color:#007bff}.btn-outline-primary:focus{box-shadow:0 0 0 .2rem rgba(0,123,255,.5)}.btn-outline-primary:disabled{color:#007bff;background-color:transparent}.btn-outline-info{color:#17a2b8;border-color:#17a2b8}.btn-outline-info:hover{color:#fff;background-color:#17a2b8;border-color:#17a2b8}.btn-outline-info:focus{box-shadow:0 0 0 .2rem rgba(23,162,184,.5)}.btn-outline-info:disabled{color:#17a2b8;background-color:transparent}.btn-outline-warning{color:#ffc107;border-color:#ffc107}.btn-outline-warning:hover{color:#212529;background-color:#ffc107;border-color:#ffc107}.btn-outline-warning:focus{box-shadow:0 0 0 .2rem rgba(255,193,7,.5)}.btn-outline-warning:disabled{color:#ffc107;background-color:transparent}.btn-outline-light{color:#f8f9fa;border-color:#f8f9fa}.btn-outline-light:hover{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-outline-light:focus{box-shadow:0 0 0 .2rem rgba(248,249,250,.5)}.btn-outline-light:disabled{color:#f8f9fa;background-color:transparent}.btn-outline-dark{color:#343a40;border-color:#343a40}.btn-outline-dark:hover{color:#fff;background-color:#343a40;border-color:#343a40}.btn-outline-dark:focus{box-shadow:0 0 0 .2rem rgba(52,58,64,.5)}.btn-outline-dark:disabled{color:#343a40;background-color:transparent}.btn-link{font-weight:400;color:#007bff;text-decoration:none}.btn-link:hover{color:#0056b3;text-decoration:underline}.btn-link:focus{text-decoration:underline;box-shadow:none}.btn-link:disabled{color:#6c757d;pointer-events:none}.btn-group-lg>.btn,.btn-lg{padding:.5rem 1rem;font-size:1.25rem;line-height:1.5;border-radius:.3rem}.btn-block{display:block;width:100%}.btn-block+.btn-block{margin-top:.5rem}.btn-group{position:relative;display:-ms-inline-flexbox;display:inline-flex;vertical-align:middle}.btn-group>.btn{position:relative;-ms-flex:1 1 auto;flex:1 1 auto}.btn-group>.btn:hover{z-index:1}.btn-group>.btn:active,.btn-group>.btn:focus{z-index:1}.btn-group>.btn-group:not(:first-child),.btn-group>.btn:not(:first-child){margin-left:-1px}.btn-group>.btn-group:not(:last-child)>.btn{border-top-right-radius:0;border-bottom-right-radius:0}.btn-group>.btn-group:not(:first-child)>.btn,.btn-group>.btn:not(:first-child){border-top-left-radius:0;border-bottom-left-radius:0}.custom-control{position:relative;display:block;min-height:1.5rem;padding-left:1.5rem}.custom-control-inline{display:-ms-inline-flexbox;display:inline-flex;margin-right:1rem}.custom-select{display:inline-block;width:100%;height:calc(1.5em+.75rem+2px);padding:.375rem 1.75rem .375rem .75rem;font-size:1rem;font-weight:400;line-height:1.5;color:#495057;vertical-align:middle;background:#fff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='4' height='5' viewBox='0 0 4 5'%3e%3cpath fill='%23343a40' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e") no-repeat right .75rem center/8px 10px;border:1px solid #ced4da;border-radius:.25rem;-webkit-appearance:none;-moz-appearance:none;appearance:none}.custom-select:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.custom-select:focus::-ms-value{color:#495057;background-color:#fff}.custom-select[multiple],.custom-select[size]:not([size="1"]){height:auto;padding-right:.75rem;background-image:none}.custom-select:disabled{color:#6c757d;background-color:#e9ecef}.custom-select::-ms-expand{display:none}.custom-select:-moz-focusring{color:transparent;text-shadow:0 0 0 #495057}.custom-select-lg{height:calc(1.5em+1rem+2px);padding-top:.5rem;padding-bottom:.5rem;padding-left:1rem;font-size:1.25rem}@media(prefers-reduced-motion:reduce){.custom-select{transition:none}}.page-link{position:relative;display:block;padding:.5rem .75rem;margin-left:-1px;line-height:1.25;color:#007bff;background-color:#fff;border:1px solid #dee2e6}.page-link:hover{z-index:2;color:#0056b3;text-decoration:none;background-color:#e9ecef;border-color:#dee2e6}.page-link:focus{z-index:3;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.alert{position:relative;padding:.75rem 1.25rem;margin-bottom:1rem;border:1px solid transparent;border-radius:.25rem}.alert-heading{color:inherit}.alert-link{font-weight:700}.alert-primary{color:#004085;background-color:#cce5ff;border-color:#b8daff}.alert-primary .alert-link{color:#002752}.alert-info{color:#0c5460;background-color:#d1ecf1;border-color:#bee5eb}.alert-info .alert-link{color:#062c33}.alert-warning{color:#856404;background-color:#fff3cd;border-color:#ffeeba}.alert-warning .alert-link{color:#533f03}.alert-light{color:#818182;background-color:#fefefe;border-color:#fdfdfe}.alert-light .alert-link{color:#686868}.alert-dark{color:#1b1e21;background-color:#d6d8d9;border-color:#c6c8ca}.alert-dark .alert-link{color:#040505}@-webkit-keyframes progress-bar-stripes{from{background-position:1rem 0}to{background-position:0 0}}@keyframes progress-bar-stripes{from{background-position:1rem 0}to{background-position:0 0}}.list-group{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;padding-left:0;margin-bottom:0}@-webkit-keyframes spinner-border{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spinner-border{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-webkit-keyframes spinner-grow{0%{-webkit-transform:scale(0);transform:scale(0)}50%{opacity:1}}@keyframes spinner-grow{0%{-webkit-transform:scale(0);transform:scale(0)}50%{opacity:1}}.bg-primary{background-color:#007bff}a.bg-primary:focus,a.bg-primary:hover{background-color:#0062cc}.bg-info{background-color:#17a2b8}a.bg-info:focus,a.bg-info:hover{background-color:#117a8b}.bg-warning{background-color:#ffc107}a.bg-warning:focus,a.bg-warning:hover{background-color:#d39e00}.bg-light{background-color:#f8f9fa}a.bg-light:focus,a.bg-light:hover{background-color:#dae0e5}.bg-dark{background-color:#343a40}a.bg-dark:focus,a.bg-dark:hover{background-color:#1d2124}.bg-white{background-color:#fff}.d-none{display:none}.d-inline{display:inline}.d-inline-block{display:inline-block}.d-block{display:block}.d-table{display:table}.d-table-row{display:table-row}@media(min-width:768px){.d-md-none{display:none}.d-md-inline{display:inline}.d-md-inline-block{display:inline-block}.d-md-block{display:block}.d-md-table{display:table}.d-md-table-row{display:table-row}}@media(min-width:992px){.d-lg-none{display:none}.d-lg-inline{display:inline}.d-lg-inline-block{display:inline-block}.d-lg-block{display:block}.d-lg-table{display:table}.d-lg-table-row{display:table-row}}.float-right{float:right}.float-none{float:none}@media(min-width:768px){.float-md-right{float:right}.float-md-none{float:none}}@media(min-width:992px){.float-lg-right{float:right}.float-lg-none{float:none}}.fixed-bottom{position:fixed;right:0;bottom:0;left:0;z-index:1030}.shadow{box-shadow:0 .5rem 1rem rgba(0,0,0,.15)}.shadow-lg{box-shadow:0 1rem 3rem rgba(0,0,0,.175)}.shadow-none{box-shadow:none}.w-25{width:25%}.w-50{width:50%}.w-75{width:75%}.w-100{width:100%}.h-25{height:25%}.h-50{height:50%}.h-75{height:75%}.h-100{height:100%}.my-0{margin-top:0}.mr-0{margin-right:0}.mb-0,.my-0{margin-bottom:0}.my-1{margin-top:.25rem}.mr-1{margin-right:.25rem}.mb-1,.my-1{margin-bottom:.25rem}.my-2{margin-top:.5rem}.mr-2{margin-right:.5rem}.mb-2,.my-2{margin-bottom:.5rem}.my-3{margin-top:1rem}.mr-3{margin-right:1rem}.mb-3,.my-3{margin-bottom:1rem}.my-4{margin-top:1.5rem}.mr-4{margin-right:1.5rem}.mb-4,.my-4{margin-bottom:1.5rem}.my-5{margin-top:3rem}.mr-5{margin-right:3rem}.mb-5,.my-5{margin-bottom:3rem}.p-0{padding:0}.pt-0,.py-0{padding-top:0}.pb-0,.py-0{padding-bottom:0}.p-1{padding:.25rem}.pt-1,.py-1{padding-top:.25rem}.pb-1,.py-1{padding-bottom:.25rem}.p-2{padding:.5rem}.pt-2,.py-2{padding-top:.5rem}.pb-2,.py-2{padding-bottom:.5rem}.p-3{padding:1rem}.pt-3,.py-3{padding-top:1rem}.pb-3,.py-3{padding-bottom:1rem}.p-4{padding:1.5rem}.pt-4,.py-4{padding-top:1.5rem}.pb-4,.py-4{padding-bottom:1.5rem}.p-5{padding:3rem}.pt-5,.py-5{padding-top:3rem}.pb-5,.py-5{padding-bottom:3rem}.my-n1{margin-top:-.25rem}.mr-n1{margin-right:-.25rem}.mb-n1,.my-n1{margin-bottom:-.25rem}.my-n2{margin-top:-.5rem}.mr-n2{margin-right:-.5rem}.mb-n2,.my-n2{margin-bottom:-.5rem}.my-n3{margin-top:-1rem}.mr-n3{margin-right:-1rem}.mb-n3,.my-n3{margin-bottom:-1rem}.my-n4{margin-top:-1.5rem}.mr-n4{margin-right:-1.5rem}.mb-n4,.my-n4{margin-bottom:-1.5rem}.my-n5{margin-top:-3rem}.mr-n5{margin-right:-3rem}.mb-n5,.my-n5{margin-bottom:-3rem}@media(min-width:768px){.my-md-0{margin-top:0}.mr-md-0{margin-right:0}.mb-md-0,.my-md-0{margin-bottom:0}.my-md-1{margin-top:.25rem}.mr-md-1{margin-right:.25rem}.mb-md-1,.my-md-1{margin-bottom:.25rem}.my-md-2{margin-top:.5rem}.mr-md-2{margin-right:.5rem}.mb-md-2,.my-md-2{margin-bottom:.5rem}.my-md-3{margin-top:1rem}.mr-md-3{margin-right:1rem}.mb-md-3,.my-md-3{margin-bottom:1rem}.my-md-4{margin-top:1.5rem}.mr-md-4{margin-right:1.5rem}.mb-md-4,.my-md-4{margin-bottom:1.5rem}.my-md-5{margin-top:3rem}.mr-md-5{margin-right:3rem}.mb-md-5,.my-md-5{margin-bottom:3rem}.p-md-0{padding:0}.pt-md-0,.py-md-0{padding-top:0}.pb-md-0,.py-md-0{padding-bottom:0}.p-md-1{padding:.25rem}.pt-md-1,.py-md-1{padding-top:.25rem}.pb-md-1,.py-md-1{padding-bottom:.25rem}.p-md-2{padding:.5rem}.pt-md-2,.py-md-2{padding-top:.5rem}.pb-md-2,.py-md-2{padding-bottom:.5rem}.p-md-3{padding:1rem}.pt-md-3,.py-md-3{padding-top:1rem}.pb-md-3,.py-md-3{padding-bottom:1rem}.p-md-4{padding:1.5rem}.pt-md-4,.py-md-4{padding-top:1.5rem}.pb-md-4,.py-md-4{padding-bottom:1.5rem}.p-md-5{padding:3rem}.pt-md-5,.py-md-5{padding-top:3rem}.pb-md-5,.py-md-5{padding-bottom:3rem}.my-md-n1{margin-top:-.25rem}.mr-md-n1{margin-right:-.25rem}.mb-md-n1,.my-md-n1{margin-bottom:-.25rem}.my-md-n2{margin-top:-.5rem}.mr-md-n2{margin-right:-.5rem}.mb-md-n2,.my-md-n2{margin-bottom:-.5rem}.my-md-n3{margin-top:-1rem}.mr-md-n3{margin-right:-1rem}.mb-md-n3,.my-md-n3{margin-bottom:-1rem}.my-md-n4{margin-top:-1.5rem}.mr-md-n4{margin-right:-1.5rem}.mb-md-n4,.my-md-n4{margin-bottom:-1.5rem}.my-md-n5{margin-top:-3rem}.mr-md-n5{margin-right:-3rem}.mb-md-n5,.my-md-n5{margin-bottom:-3rem}}@media(min-width:992px){.my-lg-0{margin-top:0}.mr-lg-0{margin-right:0}.mb-lg-0,.my-lg-0{margin-bottom:0}.my-lg-1{margin-top:.25rem}.mr-lg-1{margin-right:.25rem}.mb-lg-1,.my-lg-1{margin-bottom:.25rem}.my-lg-2{margin-top:.5rem}.mr-lg-2{margin-right:.5rem}.mb-lg-2,.my-lg-2{margin-bottom:.5rem}.my-lg-3{margin-top:1rem}.mr-lg-3{margin-right:1rem}.mb-lg-3,.my-lg-3{margin-bottom:1rem}.my-lg-4{margin-top:1.5rem}.mr-lg-4{margin-right:1.5rem}.mb-lg-4,.my-lg-4{margin-bottom:1.5rem}.my-lg-5{margin-top:3rem}.mr-lg-5{margin-right:3rem}.mb-lg-5,.my-lg-5{margin-bottom:3rem}.p-lg-0{padding:0}.pt-lg-0,.py-lg-0{padding-top:0}.pb-lg-0,.py-lg-0{padding-bottom:0}.p-lg-1{padding:.25rem}.pt-lg-1,.py-lg-1{padding-top:.25rem}.pb-lg-1,.py-lg-1{padding-bottom:.25rem}.p-lg-2{padding:.5rem}.pt-lg-2,.py-lg-2{padding-top:.5rem}.pb-lg-2,.py-lg-2{padding-bottom:.5rem}.p-lg-3{padding:1rem}.pt-lg-3,.py-lg-3{padding-top:1rem}.pb-lg-3,.py-lg-3{padding-bottom:1rem}.p-lg-4{padding:1.5rem}.pt-lg-4,.py-lg-4{padding-top:1.5rem}.pb-lg-4,.py-lg-4{padding-bottom:1.5rem}.p-lg-5{padding:3rem}.pt-lg-5,.py-lg-5{padding-top:3rem}.pb-lg-5,.py-lg-5{padding-bottom:3rem}.my-lg-n1{margin-top:-.25rem}.mr-lg-n1{margin-right:-.25rem}.mb-lg-n1,.my-lg-n1{margin-bottom:-.25rem}.my-lg-n2{margin-top:-.5rem}.mr-lg-n2{margin-right:-.5rem}.mb-lg-n2,.my-lg-n2{margin-bottom:-.5rem}.my-lg-n3{margin-top:-1rem}.mr-lg-n3{margin-right:-1rem}.mb-lg-n3,.my-lg-n3{margin-bottom:-1rem}.my-lg-n4{margin-top:-1.5rem}.mr-lg-n4{margin-right:-1.5rem}.mb-lg-n4,.my-lg-n4{margin-bottom:-1.5rem}.my-lg-n5{margin-top:-3rem}.mr-lg-n5{margin-right:-3rem}.mb-lg-n5,.my-lg-n5{margin-bottom:-3rem}}.text-right{text-align:right}.text-center{text-align:center}@media(min-width:768px){.text-md-right{text-align:right}.text-md-center{text-align:center}}@media(min-width:992px){.text-lg-right{text-align:right}.text-lg-center{text-align:center}}.text-white{color:#fff}.text-primary{color:#007bff}a.text-primary:focus,a.text-primary:hover{color:#0056b3}.text-info{color:#17a2b8}a.text-info:focus,a.text-info:hover{color:#0f6674}.text-warning{color:#ffc107}a.text-warning:focus,a.text-warning:hover{color:#ba8b00}.text-light{color:#f8f9fa}a.text-light:focus,a.text-light:hover{color:#cbd3da}.text-dark{color:#343a40}a.text-dark:focus,a.text-dark:hover{color:#121416}.text-body{color:#212529}.text-muted{color:#6c757d}.text-black-50{color:rgba(0,0,0,.5)}.text-white-50{color:rgba(255,255,255,.5)}.text-hide{font:0/0 a;color:transparent;text-shadow:none;background-color:transparent;border:0}.text-decoration-none{text-decoration:none}.text-reset{color:inherit}.visible{visibility:visible}@media print{*,::after,::before{text-shadow:none;box-shadow:none}a:not(.btn){text-decoration:underline}pre{white-space:pre-wrap}pre{border:1px solid #adb5bd;page-break-inside:avoid}thead{display:table-header-group}img,tr{page-break-inside:avoid}h2,h3,p{orphans:3;widows:3}h2,h3{page-break-after:avoid}@page{size:a3}body{min-width:992px}.container{min-width:992px}.table{border-collapse:collapse}.table td,.table th{background-color:#fff}.table-dark{color:inherit}.table-dark tbody+tbody,.table-dark td,.table-dark th,.table-dark thead th{border-color:#dee2e6}.table .thead-dark th{color:inherit;border-color:#dee2e6}}@-webkit-keyframes sbx-reset-in{0%{-webkit-transform:translate3d(-20%,0,0);transform:translate3d(-20%,0,0);opacity:0}100%{-webkit-transform:none;transform:none;opacity:1}}@keyframes sbx-reset-in{0%{-webkit-transform:translate3d(-20%,0,0);transform:translate3d(-20%,0,0);opacity:0}100%{-webkit-transform:none;transform:none;opacity:1}}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}a:link,a:visited{color:#f14600;text-decoration:none}a:active,a:hover{text-decoration:underline}.btn:disabled{cursor:default;opacity:.4}#logo-text{width:180px;margin-left:12px}.display-5{font-size:2rem;font-weight:300;line-height:1.2}.display-6{font-size:1.75rem;font-weight:300;line-height:1.2}.bg-dark-alt,.bg-dark-alt:focus{background:#36363f}.bg-orange,.bg-orange:focus{background:#f14600}.text-dark-alt{color:#36363f}.btn-dark-alt{background:#36363f}.btn-dark-alt:focus{background:#36363f}.btn-outline-orange{border-color:#f14600;color:#f14600}.btn-orange,.btn-outline-orange:hover{background:#f14600;color:#fff}.btn:active,.btn:hover{text-decoration:none}.text-orange{color:#f14600}.bg-number{position:absolute;font-size:900%;font-weight:700;color:rgba(241,70,0,.1);line-height:1;margin-top:-1rem}.w-15{width:15%}details{background:#444451;color:#eee;padding:1rem;margin-bottom:1rem;margin-top:1rem}summary{font-weight:700;color:#eee}.headerlink{text-decoration:none;margin-left:.5rem}#content table{border:1px solid #dee2e6;width:100%;margin-bottom:1rem;overflow-x:auto}#content thead{background:#444451;color:#fff}#content td,#content th{padding:.75rem;vertical-align:top}#content td{border:1px solid #dee2e6}#content th{border:1px solid #444451}#content code{color:#000;background:#eee;padding:.125rem .25rem}#content code.syntax{padding:0}#content pre{background:#efefef;padding:1rem;line-height:1.25}@media print{body{min-width:0}code,h1,h2,h3,h4,h5,h6,img,li,p,pre,td,th,thead,tr{page-break-inside:avoid}}@media(prefers-color-scheme:dark){#to-full-website,body.amp,body[data-spy]{background:#1c1c1c;color:#efefef}.invert-dark{filter:invert(100%)}#content table{border:1px solid #2a2b2c}#content thead{background:#333}#content td{border:1px solid #444451}#content code{background:#444;color:#eee;padding:.125rem .25rem}#content pre{background:#444;color:#eee}}@media(prefers-color-scheme:dark){.syntax{background:#2d2d2d;color:#f2f0ec}.syntax .c{color:#747369}.syntax .err{color:#f2777a}.syntax .k{color:#c9c}.syntax .l{color:#f99157}.syntax .n{color:#f2f0ec}.syntax .o{color:#6cc}.syntax .p{color:#f2f0ec}.syntax .c1{color:#747369}.syntax .ld{color:#9c9}.syntax .s{color:#9c9}.syntax .nb{color:#f2f0ec}.syntax .nc{color:#fc6}.syntax .no{color:#f2777a}.syntax .nl{color:#f2f0ec}.syntax .py{color:#f2f0ec}.syntax .nt{color:#6cc}.syntax .w{color:#f2f0ec}.syntax .mi{color:#f99157}.syntax .s2{color:#9c9}.syntax .s1{color:#9c9}}</style><script async custom-element=amp-analytics src=https://cdn.ampproject.org/v0/amp-analytics-0.1.js></script><script async custom-element=amp-iframe src=https://cdn.ampproject.org/v0/amp-iframe-0.1.js></script></head> <body class=amp dir=ltr> <div class="container-fluid container-lg pb-5"> <div class="row pt-3 mb-3"> <div class=col> <a href=/ class=text-decoration-none> <amp-img class="d-inline-block mr-3" layout=fixed width=40 height=36 src=/images/logo.svg alt="ClickHouse logo" title="ClickHouse logo"></amp-img><amp-img class="invert-dark d-inline-block" layout=fixed width=238 height=36 src=/images/clickhouse-black.svg alt=ClickHouse title=ClickHouse></amp-img> </a> </div> </div> <div class=row> <div id=content class=col> <div class="alert alert-primary" role=alert> <p class="display-5 mb-2">Help wanted!</p> <p class=lead>The following content of this documentation page has been machine-translated. But unlike other websites, it is not done on the fly. This translated text lives on GitHub repository alongside main ClickHouse codebase and waits for fellow native speakers to make it more human-readable. <a href=/docs/en/engines/table-engines/mergetree-family/mergetree/ class=alert-link>You can also use the original English version as a reference.</a></p> <p class=lead> <a class="btn btn-lg btn-primary text-white" href=https://github.com/ClickHouse/ClickHouse/edit/master/docs/ja/engines/table-engines/mergetree-family/mergetree.md target=_blank rel="external nofollow noreferrer"> Help ClickHouse documentation by editing this page </a> </p> </div> <h1 id=table_engines-mergetree>メルゲツリー<a class=headerlink href=../amp/#table_engines-mergetree title="Permanent link"> </a></h1> <p>その <code class=syntax>MergeTree</code> この家族のエンジンそして他のエンジン (<code class=syntax>*MergeTree</code>）は、最も堅牢なClickHouseテーブルエンジンです。</p> <p>のエンジン <code class=syntax>MergeTree</code> ファミリは、非常に大量のデータをテーブルに挿入するために設計されています。 のデータが書き込まれ、テーブル部、そのルール適用のための統合のパーツです。 この方法は効率よく継続的に書き換えのデータストレージ中をサポートしていません。</p> <p>主な特長:</p> <ul> <li> <p>主キ</p> <p>これを作成できる小型疎指標を見つけるデータを高速に行います。</p> </li> <li> <p>この場合、 <a href=../../custom-partitioning-key/amp/ >分割キー</a> が指定される。</p> <p>ClickHouseは、同じ結果を持つ同じデータに対する一般的な操作よりも効果的なパーティションを持つ特定の操作をサポートします。 ClickHouseも自動的に遮断すると、パーティションデータのパーティショニングキーで指定されたクエリ。 この改善するためのクエリ。</p> </li> <li> <p>データ複製のサポート。</p> <p>の家族 <code class=syntax>ReplicatedMergeTree</code> テーブルを提供データレプリケーション. 詳細については、 <a href=../../replication/amp/ >データ複製</a>.</p> </li> <li> <p>データサンプリングです。</p> <p>必要に応じて、テーブル内でデータサンプリング方法を設定できます。</p> </li> </ul> <div class="admonition info alert pb-0 mb-4 alert-primary" role=alert> <p class="admonition-title alert-heading display-6 mb-2">情報</p> <p>その <a class=alert-link href=../../../special/merge/amp/#merge>マージ</a> エンジンはに属しません <code class=syntax>*MergeTree</code> 家族だ</p> </div> <h2 id=table_engine-mergetree-creating-a-table>テーブルの作成<a class=headerlink href=../amp/#table_engine-mergetree-creating-a-table title="Permanent link"> </a></h2> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=p>[</span><span class=k>IF</span> <span class=k>NOT</span> <span class=k>EXISTS</span><span class=p>]</span> <span class=p>[</span><span class=n>db</span><span class=p>.]</span><span class=k>table_name</span> <span class=p>[</span><span class=k>ON</span> <span class=k>CLUSTER</span> <span class=k>cluster</span><span class=p>]</span>
<span class=p>(</span>
    <span class=n>name1</span> <span class=p>[</span><span class=n>type1</span><span class=p>]</span> <span class=p>[</span><span class=k>DEFAULT</span><span class=o>|</span><span class=n>MATERIALIZED</span><span class=o>|</span><span class=k>ALIAS</span> <span class=n>expr1</span><span class=p>]</span> <span class=p>[</span><span class=n>TTL</span> <span class=n>expr1</span><span class=p>],</span>
    <span class=n>name2</span> <span class=p>[</span><span class=n>type2</span><span class=p>]</span> <span class=p>[</span><span class=k>DEFAULT</span><span class=o>|</span><span class=n>MATERIALIZED</span><span class=o>|</span><span class=k>ALIAS</span> <span class=n>expr2</span><span class=p>]</span> <span class=p>[</span><span class=n>TTL</span> <span class=n>expr2</span><span class=p>],</span>
    <span class=p>...</span>
    <span class=k>INDEX</span> <span class=n>index_name1</span> <span class=n>expr1</span> <span class=k>TYPE</span> <span class=n>type1</span><span class=p>(...)</span> <span class=n>GRANULARITY</span> <span class=n>value1</span><span class=p>,</span>
    <span class=k>INDEX</span> <span class=n>index_name2</span> <span class=n>expr2</span> <span class=k>TYPE</span> <span class=n>type2</span><span class=p>(...)</span> <span class=n>GRANULARITY</span> <span class=n>value2</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span><span class=p>()</span>
<span class=p>[</span><span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>expr</span><span class=p>]</span>
<span class=p>[</span><span class=k>ORDER</span> <span class=k>BY</span> <span class=n>expr</span><span class=p>]</span>
<span class=p>[</span><span class=k>PRIMARY</span> <span class=k>KEY</span> <span class=n>expr</span><span class=p>]</span>
<span class=p>[</span><span class=n>SAMPLE</span> <span class=k>BY</span> <span class=n>expr</span><span class=p>]</span>
<span class=p>[</span><span class=n>TTL</span> <span class=n>expr</span> <span class=p>[</span><span class=k>DELETE</span><span class=o>|</span><span class=k>TO</span> <span class=n>DISK</span> <span class=s1>'xxx'</span><span class=o>|</span><span class=k>TO</span> <span class=n>VOLUME</span> <span class=s1>'xxx'</span><span class=p>],</span> <span class=p>...]</span>
<span class=p>[</span><span class=n>SETTINGS</span> <span class=n>name</span><span class=o>=</span><span class=n>value</span><span class=p>,</span> <span class=p>...]</span>
</code></pre></div> <p>パラメータの説明については、 <a href=../../../../../sql-reference/statements/create/amp/ >クエリの説明の作成</a>.</p> <div class="admonition note alert pb-0 mb-4 alert-primary" role=alert> <p class="admonition-title alert-heading display-6 mb-2">注</p> <p><code class=syntax>INDEX</code> 実験的な機能です。 <a class=alert-link href=../amp/#table_engine-mergetree-data_skipping-indexes>データスキップ索引</a>.</p> </div> <h3 id=mergetree-query-clauses>クエリ句<a class=headerlink href=../amp/#mergetree-query-clauses title="Permanent link"> </a></h3> <ul> <li> <p><code class=syntax>ENGINE</code> — Name and parameters of the engine. <code class=syntax>ENGINE = MergeTree()</code>. その <code class=syntax>MergeTree</code> エンジンにはパラメータがない。</p> </li> <li> <p><code class=syntax>PARTITION BY</code> — The <a href=../../custom-partitioning-key/amp/ >分割キー</a>.</p> <p>月によるパーティション分割の場合は、 <code class=syntax>toYYYYMM(date_column)</code> 式、ここで <code class=syntax>date_column</code> 型の日付を持つ列です <a href=../../../../../sql-reference/data-types/date/amp/ >日付</a>. ここでのパーティション名は <code class=syntax>"YYYYMM"</code> 形式。</p> </li> <li> <p><code class=syntax>ORDER BY</code> — The sorting key.</p> <p>列または任意の式のタプル。 例: <code class=syntax>ORDER BY (CounterID, EventDate)</code>.</p> </li> <li> <p><code class=syntax>PRIMARY KEY</code> — The primary key if it <a href=../amp/#choosing-a-primary-key-that-differs-from-the-sorting-key>ソートキーとは異なります</a>.</p> <p>デフォルトでは、プライマリキーはソートキーと同じです。 <code class=syntax>ORDER BY</code> 節）。 したがって、ほとんどの場合、別の <code class=syntax>PRIMARY KEY</code> 句。</p> </li> <li> <p><code class=syntax>SAMPLE BY</code> — An expression for sampling.</p> <p>サンプリング式を使用する場合は、主キーにそれを含める必要があります。 例: <code class=syntax>SAMPLE BY intHash32(UserID) ORDER BY (CounterID, EventDate, intHash32(UserID))</code>.</p> </li> <li> <p><code class=syntax>TTL</code> — A list of rules specifying storage duration of rows and defining logic of automatic parts movement <a href=../amp/#table_engine-mergetree-multiple-volumes>ディスクとボリューム間</a>.</p> <p>式には次のものが必要です <code class=syntax>Date</code> または <code class=syntax>DateTime</code> 結果としての列。 例:<br> <code class=syntax>TTL date + INTERVAL 1 DAY</code></p> <p>ルールのタイプ <code class=syntax>DELETE|TO DISK 'xxx'|TO VOLUME 'xxx'</code> 式が満たされた場合(現在の時刻に達した場合)、パートに対して実行されるアクションを指定します:期限切れの行の削除、パートの移動(パート内のすべての (<code class=syntax>TO DISK 'xxx'</code>）またはボリュームに (<code class=syntax>TO VOLUME 'xxx'</code>). ルールの既定の種類は削除です (<code class=syntax>DELETE</code>). リストに複数のルール指定がありませんよ <code class=syntax>DELETE</code> ルール</p> <p>詳細は、を参照してください <a href=../amp/#table_engine-mergetree-ttl>列および表のTTL</a></p> </li> <li> <p><code class=syntax>SETTINGS</code> — Additional parameters that control the behavior of the <code class=syntax>MergeTree</code>:</p> <ul> <li><code class=syntax>index_granularity</code> — Maximum number of data rows between the marks of an index. Default value: 8192. See <a href=../amp/#mergetree-data-storage>データ保存</a>.</li> <li><code class=syntax>index_granularity_bytes</code> — Maximum size of data granules in bytes. Default value: 10Mb. To restrict the granule size only by number of rows, set to 0 (not recommended). See <a href=../amp/#mergetree-data-storage>データ保存</a>.</li> <li><code class=syntax>enable_mixed_granularity_parts</code> — Enables or disables transitioning to control the granule size with the <code class=syntax>index_granularity_bytes</code> 設定。 バージョン19.11以前は <code class=syntax>index_granularity</code> 制限の微粒のサイズのための設定。 その <code class=syntax>index_granularity_bytes</code> 設定の改善ClickHouse性能の選定からデータをテーブルの大きな行(数十、数百人のメガバイト). いテーブルの大きな行きのこの設定のテーブルの効率化 <code class=syntax>SELECT</code> クエリ。</li> <li><code class=syntax>use_minimalistic_part_header_in_zookeeper</code> — Storage method of the data parts headers in ZooKeeper. If <code class=syntax>use_minimalistic_part_header_in_zookeeper=1</code> その飼育係の店が少ない。 詳細については、を参照してください <a href=../../../../../operations/server-configuration-parameters/settings/amp/#server-settings-use_minimalistic_part_header_in_zookeeper>設定の説明</a> で “Server configuration parameters”.</li> <li><code class=syntax>min_merge_bytes_to_use_direct_io</code> — The minimum data volume for merge operation that is required for using direct I/O access to the storage disk. When merging data parts, ClickHouse calculates the total storage volume of all the data to be merged. If the volume exceeds <code class=syntax>min_merge_bytes_to_use_direct_io</code> バイト、ClickHouseは直接入出力インターフェイスを使用して記憶域ディスクにデータを読み、書きます (<code class=syntax>O_DIRECT</code> オプション）。 もし <code class=syntax>min_merge_bytes_to_use_direct_io = 0</code> その後、直接I/Oが無効になります。 デフォルト値: <code class=syntax>10 * 1024 * 1024 * 1024</code> バイト数。<br> <a name=mergetree_setting-merge_with_ttl_timeout></a></li> <li><code class=syntax>merge_with_ttl_timeout</code> — Minimum delay in seconds before repeating a merge with TTL. Default value: 86400 (1 day).</li> <li><code class=syntax>write_final_mark</code> — Enables or disables writing the final index mark at the end of data part (after the last byte). Default value: 1. Don't turn it off.</li> <li><code class=syntax>merge_max_block_size</code> — Maximum number of rows in block for merge operations. Default value: 8192.</li> <li><code class=syntax>storage_policy</code> — Storage policy. See <a href=../amp/#table_engine-mergetree-multiple-volumes>複数のブロックデバイスのためのデータ保存</a>.</li> </ul> </li> </ul> <p><strong>セクション設定例</strong></p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>ENGINE</span> <span class=n>MergeTree</span><span class=p>()</span> <span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>toYYYYMM</span><span class=p>(</span><span class=n>EventDate</span><span class=p>)</span> <span class=k>ORDER</span> <span class=k>BY</span> <span class=p>(</span><span class=n>CounterID</span><span class=p>,</span> <span class=n>EventDate</span><span class=p>,</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>))</span> <span class=n>SAMPLE</span> <span class=k>BY</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>)</span> <span class=n>SETTINGS</span> <span class=n>index_granularity</span><span class=o>=</span><span class=mi>8192</span>
</code></pre></div> <p>この例では、月別にパーティション分割を設定します。</p> <p>また、ユーザIDによってハッシュとしてサンプリングする式を設定します。 これにより、各テーブルのデータを擬似乱数化することができます <code class=syntax>CounterID</code> と <code class=syntax>EventDate</code>. を定義すると <a href=../../../../../sql-reference/statements/select/sample/amp/#select-sample-clause>SAMPLE</a> 句データを選択すると、ClickHouseはユーザーのサブセットに対して均等な擬似乱数データサンプルを返します。</p> <p>その <code class=syntax>index_granularity</code> 8192がデフォルト値であるため、設定を省略できます。</p> <details><summary>推奨されていません法テーブルを作成する</summary> <p></p> <div class="admonition attention alert pb-0 mb-4 alert-warning" role=alert> <p class="admonition-title alert-heading display-6 mb-2">注意</p> <p>用途では使用しないでください方法で新規プロジェクト. 可能であれば、古いプロジェクトを上記の方法に切り替えます。</p> </div> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=p>[</span><span class=k>IF</span> <span class=k>NOT</span> <span class=k>EXISTS</span><span class=p>]</span> <span class=p>[</span><span class=n>db</span><span class=p>.]</span><span class=k>table_name</span> <span class=p>[</span><span class=k>ON</span> <span class=k>CLUSTER</span> <span class=k>cluster</span><span class=p>]</span>
<span class=p>(</span>
    <span class=n>name1</span> <span class=p>[</span><span class=n>type1</span><span class=p>]</span> <span class=p>[</span><span class=k>DEFAULT</span><span class=o>|</span><span class=n>MATERIALIZED</span><span class=o>|</span><span class=k>ALIAS</span> <span class=n>expr1</span><span class=p>],</span>
    <span class=n>name2</span> <span class=p>[</span><span class=n>type2</span><span class=p>]</span> <span class=p>[</span><span class=k>DEFAULT</span><span class=o>|</span><span class=n>MATERIALIZED</span><span class=o>|</span><span class=k>ALIAS</span> <span class=n>expr2</span><span class=p>],</span>
    <span class=p>...</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=p>[</span><span class=o>=</span><span class=p>]</span> <span class=n>MergeTree</span><span class=p>(</span><span class=nb>date</span><span class=o>-</span><span class=k>column</span> <span class=p>[,</span> <span class=n>sampling_expression</span><span class=p>],</span> <span class=p>(</span><span class=k>primary</span><span class=p>,</span> <span class=k>key</span><span class=p>),</span> <span class=n>index_granularity</span><span class=p>)</span>
</code></pre></div> <p><strong>MergeTree()パラメータ</strong></p> <ul> <li><code class=syntax>date-column</code> — The name of a column of the <a href=../../../../../sql-reference/data-types/date/amp/ >日付</a> タイプ。 ClickHouseを自動でパーティション月に基づきます。 パーティション名は <code class=syntax>"YYYYMM"</code> 形式。</li> <li><code class=syntax>sampling_expression</code> — An expression for sampling.</li> <li><code class=syntax>(primary, key)</code> — Primary key. Type: <a href=../../../../../sql-reference/data-types/tuple/amp/ >タプル()</a></li> <li><code class=syntax>index_granularity</code> — The granularity of an index. The number of data rows between the “marks” インデックスの。 値8192は、ほとんどのタスクに適しています。</li> </ul> <p><strong>例</strong></p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>MergeTree</span><span class=p>(</span><span class=n>EventDate</span><span class=p>,</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>),</span> <span class=p>(</span><span class=n>CounterID</span><span class=p>,</span> <span class=n>EventDate</span><span class=p>,</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>)),</span> <span class=mi>8192</span><span class=p>)</span>
</code></pre></div> <p>その <code class=syntax>MergeTree</code> エンジンは、メインエンジンの構成方法については、上記の例と同様に構成されています。</p> </details> <h2 id=mergetree-data-storage>データ保存<a class=headerlink href=../amp/#mergetree-data-storage title="Permanent link"> </a></h2> <p>テーブルのデータ部品の分別によりその有効なタイプを利用します。</p> <p>データがテーブルに挿入されると、個別のデータパーツが作成され、それぞれが主キーで辞書順に並べ替えられます。 たとえば、主キーが <code class=syntax>(CounterID, Date)</code> パーツ内のデータは次のようにソートされます <code class=syntax>CounterID</code>、およびそれぞれの中 <code class=syntax>CounterID</code>、それは順序付けられます <code class=syntax>Date</code>.</p> <p>データに属する別のパーティションが分離の異なる部品です。 背景では、ClickHouseはより有効な貯蔵のためのデータ部分を併合する。 異なる区画に属する部分はマージされません。 マージ機構では、同じ主キーを持つすべての行が同じデータ部分に含まれることは保証されません。</p> <p>各データ部分は論理的にグラニュールに分割されます。 顆粒は、データを選択するときにClickHouseが読み取る最小の不可分データセットです。 ClickHouseは行や値を分割しないため、各グラニュールには常に整数の行が含まれます。 顆粒の最初の行には、行の主キーの値がマークされます。 各データ、ClickHouseを作成しインデックスファイルを格納するのです。 各列について、主キーにあるかどうかにかかわらず、ClickHouseにも同じマークが格納されます。 これらのマークまたはデータを見つの直列のファイルです。</p> <p>微粒のサイズはによって制限されます <code class=syntax>index_granularity</code> と <code class=syntax>index_granularity_bytes</code> テーブルエンジンの設定。 微粒の列の数はで置きます <code class=syntax>[1, index_granularity]</code> 行のサイズに応じて、範囲。 微粒のサイズは超過できます <code class=syntax>index_granularity_bytes</code> 単一行のサイズが設定の値より大きい場合。 この場合、顆粒のサイズは行のサイズに等しい。</p> <h2 id=primary-keys-and-indexes-in-queries>クエリ内の主キーとインデックス<a class=headerlink href=../amp/#primary-keys-and-indexes-in-queries title="Permanent link"> </a></h2> <p>を取る <code class=syntax>(CounterID, Date)</code> 例として主キー。 この場合、ソートとインデックスは次のように示すことができます:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=w>  </span><span class=n>Whole</span><span class=w> </span><span class=k>data</span><span class=err>:</span><span class=w>     </span><span class=o>[</span><span class=n>---------------------------------------------</span><span class=o>]</span><span class=w></span>
<span class=w>  </span><span class=nl>CounterID</span><span class=p>:</span><span class=w>      </span><span class=o>[</span><span class=n>aaaaaaaaaaaaaaaaaabbbbcdeeeeeeeeeeeeefgggggggghhhhhhhhhiiiiiiiiikllllllll</span><span class=o>]</span><span class=w></span>
<span class=w>  </span><span class=nc>Date</span><span class=err>:</span><span class=w>           </span><span class=o>[</span><span class=n>1111111222222233331233211111222222333211111112122222223111112223311122333</span><span class=o>]</span><span class=w></span>
<span class=w>  </span><span class=nl>Marks</span><span class=p>:</span><span class=w>           </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w></span>
<span class=w>                  </span><span class=n>a</span><span class=p>,</span><span class=mi>1</span><span class=w>    </span><span class=n>a</span><span class=p>,</span><span class=mi>2</span><span class=w>    </span><span class=n>a</span><span class=p>,</span><span class=mi>3</span><span class=w>    </span><span class=n>b</span><span class=p>,</span><span class=mi>3</span><span class=w>    </span><span class=n>e</span><span class=p>,</span><span class=mi>2</span><span class=w>    </span><span class=n>e</span><span class=p>,</span><span class=mi>3</span><span class=w>    </span><span class=n>g</span><span class=p>,</span><span class=mi>1</span><span class=w>    </span><span class=n>h</span><span class=p>,</span><span class=mi>2</span><span class=w>    </span><span class=n>i</span><span class=p>,</span><span class=mi>1</span><span class=w>    </span><span class=n>i</span><span class=p>,</span><span class=mi>3</span><span class=w>    </span><span class=n>l</span><span class=p>,</span><span class=mi>3</span><span class=w></span>
<span class=w>  </span><span class=n>Marks</span><span class=w> </span><span class=nl>numbers</span><span class=p>:</span><span class=w>   </span><span class=mi>0</span><span class=w>      </span><span class=mi>1</span><span class=w>      </span><span class=mi>2</span><span class=w>      </span><span class=mi>3</span><span class=w>      </span><span class=mi>4</span><span class=w>      </span><span class=mi>5</span><span class=w>      </span><span class=mi>6</span><span class=w>      </span><span class=mi>7</span><span class=w>      </span><span class=mi>8</span><span class=w>      </span><span class=mi>9</span><span class=w>      </span><span class=mi>10</span><span class=w></span>
</code></pre></div> <p>データクエリが指定する場合:</p> <ul> <li><code class=syntax>CounterID in ('a', 'h')</code>、サーバーはマークの範囲のデータを読み取ります <code class=syntax>[0, 3)</code> と <code class=syntax>[6, 8)</code>.</li> <li><code class=syntax>CounterID IN ('a', 'h') AND Date = 3</code>、サーバーはマークの範囲のデータを読み取ります <code class=syntax>[1, 3)</code> と <code class=syntax>[7, 8)</code>.</li> <li><code class=syntax>Date = 3</code>、サーバは、マークの範囲内のデータを読み取ります <code class=syntax>[1, 10]</code>.</li> </ul> <p>上記の例としては常に使用するのがより効果的指標により、フルスキャン！</p> <p>に乏指数で追加するデータを読み込みます。 プライマリキーの単一の範囲を読み取るとき <code class=syntax>index_granularity * 2</code> 余分な列の各データブロック読み取ることができます。</p> <p>疎指標できる作業は非常に多くのテーブル行において、多くの場合、指数はコンピュータのアプリです。</p> <p>ClickHouseでは一意の主キーは必要ありません。 同じ主キーで複数の行を挿入できます。</p> <h3 id=selecting-the-primary-key>主キーの選択<a class=headerlink href=../amp/#selecting-the-primary-key title="Permanent link"> </a></h3> <p>主キーの列の数は明示的に制限されません。 データ構造によっては、主キーに多かれ少なかれ含めることができます。 これは:</p> <ul> <li> <p>索引のパフォーマンスを向上させます。</p> <p>主キーが <code class=syntax>(a, b)</code> 次に、別の列を追加します <code class=syntax>c</code> 以下の条件を満たすと、パフォーマンスが向上します:</p> <ul> <li>列に条件を持つクエリがあります <code class=syntax>c</code>.</li> <li>長いデータ範囲(長いデータ範囲より数倍長い <code class=syntax>index_granularity</code>)と同一の値を持つ。 <code class=syntax>(a, b)</code> 一般的です。 つまり、別の列を追加すると、かなり長いデータ範囲をスキップすることができます。</li> </ul> </li> <li> <p>データ圧縮を改善します。</p> <p>ClickHouseは主キーによってデータを並べ替えるので、一貫性が高いほど圧縮が良くなります。</p> </li> <li> <p>追加的なロジックが統合データ部分の <a href=../../collapsingmergetree/amp/#table_engine-collapsingmergetree>折りたたみマージツリー</a> と <a href=../../summingmergetree/amp/ >サミングマーゲツリー</a> エンジンだ</p> <p>この場合、 <em>ソートキー</em> これは主キーとは異なります。</p> </li> </ul> <p>長い主キーは挿入のパフォーマンスとメモリ消費に悪影響を及ぼしますが、主キーの追加の列はClickHouseのパフォーマンスには影響しません <code class=syntax>SELECT</code> クエリ。</p> <h3 id=choosing-a-primary-key-that-differs-from-the-sorting-key>並べ替えキーとは異なる主キーの選択<a class=headerlink href=../amp/#choosing-a-primary-key-that-differs-from-the-sorting-key title="Permanent link"> </a></h3> <p>ソートキー(データ部分の行をソートする式)とは異なる主キー(マークごとにインデックスファイルに書き込まれる値を持つ式)を指定することができます。 この場合、主キー式タプルは、並べ替えキー式タプルのプレフィックスでなければなりません。</p> <p>この機能は、 <a href=../../summingmergetree/amp/ >サミングマーゲツリー</a> と<br> <a href=../../aggregatingmergetree/amp/ >AggregatingMergeTree</a> テーブルエンジン。 共通の場合はご利用になられる場合はエンジンのテーブルは、二種類のカラム: <em>寸法</em> と <em>対策</em>. 典型的なクエリは、任意のメジャー列の値を集計します <code class=syntax>GROUP BY</code> そして次元によるろ過。 SumingmergetreeとAggregatingMergeTreeは並べ替えキーの値が同じ行を集計するため、すべてのディメンションを追加するのは自然です。 その結果、キー式は列の長いリストで構成され、このリストは頻繁に新しく追加されたディメンションで更新する必要があります。</p> <p>この場合、効率的な範囲スキャンを提供し、残りのディメンション列を並べ替えキータプルに追加する主キーには数列のみを残すことが理にかなって</p> <p><a href=../../../../../sql-reference/statements/alter/amp/ >ALTER</a> 新しい列がテーブルとソートキーに同時に追加されると、既存のデータ部分を変更する必要がないため、ソートキーの軽量な操作です。 古い並べ替えキーは新しい並べ替えキーのプレフィックスであり、新しく追加された列にデータがないため、テーブルの変更の瞬間に、データは新旧の並べ替え</p> <h3 id=use-of-indexes-and-partitions-in-queries>クエリでの索引とパーティションの使用<a class=headerlink href=../amp/#use-of-indexes-and-partitions-in-queries title="Permanent link"> </a></h3> <p>のために <code class=syntax>SELECT</code> クClickHouseを分析するかどうかの指標を使用できます。 インデックスは、次の場合に使用できます <code class=syntax>WHERE/PREWHERE</code> 句には、等価比較演算または不等比較演算を表す式（連結要素のいずれかとして、または完全に）があります。 <code class=syntax>IN</code> または <code class=syntax>LIKE</code> 主キーまたはパーティショニングキーにある列または式、またはこれらの列の特定の部分的に反復機能、またはこれらの式の論理的関係に固定プレフィッ</p> <p>したがって、主キーの一つまたは多くの範囲でクエリを迅速に実行することができます。 この例では、特定の追跡タグ、特定のタグと日付範囲、特定のタグと日付、日付範囲を持つ複数のタグなどに対してクエリを実行すると、クエリが高速</p> <p>次のように構成されたエンジンを見てみましょう:</p> <div class=codehilite><pre><span></span><code class=syntax>  ENGINE MergeTree() PARTITION BY toYYYYMM(EventDate) ORDER BY (CounterID, EventDate) SETTINGS index_granularity=8192
</code></pre></div> <p>この場合、クエリで:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>EventDate</span> <span class=o>=</span> <span class=n>toDate</span><span class=p>(</span><span class=n>now</span><span class=p>())</span> <span class=k>AND</span> <span class=n>CounterID</span> <span class=o>=</span> <span class=mi>34</span>
<span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>EventDate</span> <span class=o>=</span> <span class=n>toDate</span><span class=p>(</span><span class=n>now</span><span class=p>())</span> <span class=k>AND</span> <span class=p>(</span><span class=n>CounterID</span> <span class=o>=</span> <span class=mi>34</span> <span class=k>OR</span> <span class=n>CounterID</span> <span class=o>=</span> <span class=mi>42</span><span class=p>)</span>
<span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=p>((</span><span class=n>EventDate</span> <span class=o>&gt;=</span> <span class=n>toDate</span><span class=p>(</span><span class=s1>'2014-01-01'</span><span class=p>)</span> <span class=k>AND</span> <span class=n>EventDate</span> <span class=o>&lt;=</span> <span class=n>toDate</span><span class=p>(</span><span class=s1>'2014-01-31'</span><span class=p>))</span> <span class=k>OR</span> <span class=n>EventDate</span> <span class=o>=</span> <span class=n>toDate</span><span class=p>(</span><span class=s1>'2014-05-01'</span><span class=p>))</span> <span class=k>AND</span> <span class=n>CounterID</span> <span class=k>IN</span> <span class=p>(</span><span class=mi>101500</span><span class=p>,</span> <span class=mi>731962</span><span class=p>,</span> <span class=mi>160656</span><span class=p>)</span> <span class=k>AND</span> <span class=p>(</span><span class=n>CounterID</span> <span class=o>=</span> <span class=mi>101500</span> <span class=k>OR</span> <span class=n>EventDate</span> <span class=o>!=</span> <span class=n>toDate</span><span class=p>(</span><span class=s1>'2014-05-01'</span><span class=p>))</span>
</code></pre></div> <p>ClickHouseの主キー指標のトリムで不正なデータを毎月パーティショニングキーパンフレット、ホームページの間仕切りする不適切な日。</p> <p>上記のクエリのインデックスが使用されるときにも複雑な表現です。 テーブルからの読み取りがいを使用した指標できないっぱいたします。</p> <p>以下の例では、インデックスは使用できません。</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>CounterID</span> <span class=o>=</span> <span class=mi>34</span> <span class=k>OR</span> <span class=n>URL</span> <span class=k>LIKE</span> <span class=s1>'%upyachka%'</span>
</code></pre></div> <p>クエリの実行時にClickHouseがインデックスを使用できるかどうかを確認するには、設定を使用します <a href=../../../../../operations/settings/settings/amp/#settings-force_index_by_date>force_index_by_date</a> と <a href=../../../../../operations/settings/settings/amp/ >force_primary_key</a>.</p> <p>の分割による月で読み込みのみこれらのデータブロックを含むからスピーチへのマークの範囲内で適切に取扱います。 この場合、データブロックには多くの日付(月全体まで)のデータが含まれる場合があります。 ブロック内では、データは主キーによってソートされます。 このため、主キープレフィックスを指定しない日付条件のみのクエリを使用すると、単一の日付よりも多くのデータが読み取られます。</p> <h3 id=use-of-index-for-partially-monotonic-primary-keys>部分的に単調な主キーのインデックスの使用<a class=headerlink href=../amp/#use-of-index-for-partially-monotonic-primary-keys title="Permanent link"> </a></h3> <p>例えば、月の日を考えてみましょう。 それらはaを形作る <a href=https://en.wikipedia.org/wiki/Monotonic_function rel="external nofollow noreferrer" target=_blank>単調系列</a> 一ヶ月のために、しかし、より長期間単調ではありません。 これは部分的に単調なシーケンスです。 ユーザーが部分的に単調な主キーでテーブルを作成する場合、ClickHouseは通常どおりスパースインデックスを作成します。 ユーザーがこの種のテーブルからデータを選択すると、ClickHouseはクエリ条件を分析します。 これは、クエリのパラメータとインデックスマークの間の距離を計算できるためです。</p> <p>クエリパラメータ範囲内の主キーの値が単調なシーケンスを表していない場合、ClickHouseはインデックスを使用できません。 この場合、ClickHouseはフルスキャン方法を使用します。</p> <p>ClickHouseは、このロジックを月の日数シーケンスだけでなく、部分的に単調なシーケンスを表す主キーにも使用します。</p> <h3 id=table_engine-mergetree-data_skipping-indexes>データスキップインデックス(実験)<a class=headerlink href=../amp/#table_engine-mergetree-data_skipping-indexes title="Permanent link"> </a></h3> <p>インデックス宣言は、 <code class=syntax>CREATE</code> クエリ。</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>INDEX</span> <span class=n>index_name</span> <span class=n>expr</span> <span class=k>TYPE</span> <span class=k>type</span><span class=p>(...)</span> <span class=n>GRANULARITY</span> <span class=n>granularity_value</span>
</code></pre></div> <p>からのテーブルのため <code class=syntax>*MergeTree</code> 家族データの飛び指標を指定できます。</p> <p>これらのインデックスは、指定された式に関する情報をブロックに集約します。 <code class=syntax>granularity_value</code> 微粒（微粒のサイズはを使用して指定されます <code class=syntax>index_granularity</code> テーブルエンジンでの設定）。 次に、これらの集計は <code class=syntax>SELECT</code> クエリを削減量のデータから読み込むディスクにより操大きなブロックのデータを <code class=syntax>where</code> クエリが満たされません。</p> <p><strong>例</strong></p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=k>table_name</span>
<span class=p>(</span>
    <span class=n>u64</span> <span class=n>UInt64</span><span class=p>,</span>
    <span class=n>i32</span> <span class=n>Int32</span><span class=p>,</span>
    <span class=n>s</span> <span class=n>String</span><span class=p>,</span>
    <span class=p>...</span>
    <span class=k>INDEX</span> <span class=n>a</span> <span class=p>(</span><span class=n>u64</span> <span class=o>*</span> <span class=n>i32</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span> <span class=k>TYPE</span> <span class=n>minmax</span> <span class=n>GRANULARITY</span> <span class=mi>3</span><span class=p>,</span>
    <span class=k>INDEX</span> <span class=n>b</span> <span class=p>(</span><span class=n>u64</span> <span class=o>*</span> <span class=k>length</span><span class=p>(</span><span class=n>s</span><span class=p>))</span> <span class=k>TYPE</span> <span class=k>set</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span> <span class=n>GRANULARITY</span> <span class=mi>4</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span><span class=p>()</span>
<span class=p>...</span>
</code></pre></div> <p>この例のインデックスをClickHouseで使用すると、次のクエリでディスクから読み取るデータ量を減らすことができます:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>s</span> <span class=o>&lt;</span> <span class=s1>'z'</span>
<span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>u64</span> <span class=o>*</span> <span class=n>i32</span> <span class=o>==</span> <span class=mi>10</span> <span class=k>AND</span> <span class=n>u64</span> <span class=o>*</span> <span class=k>length</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>1234</span>
</code></pre></div> <h4 id=available-types-of-indices>使用可能なインデックスタイプ<a class=headerlink href=../amp/#available-types-of-indices title="Permanent link"> </a></h4> <ul> <li> <p><code class=syntax>minmax</code></p> <p>指定された式の極値を格納します(式が <code class=syntax>tuple</code> の各要素の極値を格納します。 <code class=syntax>tuple</code>)を使用して保存情報の飛びブロックのようなデータは、その有効なタイプを利用します。</p> </li> <li> <p><code class=syntax>set(max_rows)</code></p> <p>指定された式の一意の値を格納します。 <code class=syntax>max_rows</code> 行, <code class=syntax>max_rows=0</code> つまり “no limits”). 値を使用して、 <code class=syntax>WHERE</code> 式はデータのブロックでは満足できません。</p> </li> <li> <p><code class=syntax>ngrambf_v1(n, size_of_bloom_filter_in_bytes, number_of_hash_functions, random_seed)</code></p> <p>ストアa <a href=https://en.wikipedia.org/wiki/Bloom_filter rel="external nofollow noreferrer" target=_blank>Bloomフィルタ</a> これによりngramsからブロックのデータです。 文字列でのみ動作します。 の最適化に使用することができます <code class=syntax>equals</code>, <code class=syntax>like</code> と <code class=syntax>in</code> 式。</p> <ul> <li><code class=syntax>n</code> — ngram size,</li> <li><code class=syntax>size_of_bloom_filter_in_bytes</code> — Bloom filter size in bytes (you can use large values here, for example, 256 or 512, because it can be compressed well).</li> <li><code class=syntax>number_of_hash_functions</code> — The number of hash functions used in the Bloom filter.</li> <li><code class=syntax>random_seed</code> — The seed for Bloom filter hash functions.</li> </ul> </li> <li> <p><code class=syntax>tokenbf_v1(size_of_bloom_filter_in_bytes, number_of_hash_functions, random_seed)</code></p> <p>と同じ <code class=syntax>ngrambf_v1</code> しかし、ngramsの代わりにトークンを格納します。 トークンは英数字以外の文字で区切られた配列です。</p> </li> <li> <p><code class=syntax>bloom_filter([false_positive])</code> — Stores a <a href=https://en.wikipedia.org/wiki/Bloom_filter rel="external nofollow noreferrer" target=_blank>Bloomフィルタ</a> 指定された列の場合。</p> <p>任意 <code class=syntax>false_positive</code> パラメータは、フィルタから偽陽性応答を受信する確率です。 可能な値:(0,1)。 既定値は0.025です。</p> <p>対応するデータ型: <code class=syntax>Int*</code>, <code class=syntax>UInt*</code>, <code class=syntax>Float*</code>, <code class=syntax>Enum</code>, <code class=syntax>Date</code>, <code class=syntax>DateTime</code>, <code class=syntax>String</code>, <code class=syntax>FixedString</code>, <code class=syntax>Array</code>, <code class=syntax>LowCardinality</code>, <code class=syntax>Nullable</code>.</p> <p>以下の関数が使用できます: <a href=../../../../../sql-reference/functions/comparison-functions/amp/ >等しい</a>, <a href=../../../../../sql-reference/functions/comparison-functions/amp/ >notEquals</a>, <a href=../../../../../sql-reference/functions/in-functions/amp/ >で</a>, <a href=../../../../../sql-reference/functions/in-functions/amp/ >ノティン</a>, <a href=../../../../../sql-reference/functions/array-functions/amp/ >は</a>.</p> </li> </ul> <!-- --> <div class=codehilite><pre><span></span><code class=syntax><span class=k>INDEX</span> <span class=n>sample_index</span> <span class=p>(</span><span class=n>u64</span> <span class=o>*</span> <span class=k>length</span><span class=p>(</span><span class=n>s</span><span class=p>))</span> <span class=k>TYPE</span> <span class=n>minmax</span> <span class=n>GRANULARITY</span> <span class=mi>4</span>
<span class=k>INDEX</span> <span class=n>sample_index2</span> <span class=p>(</span><span class=n>u64</span> <span class=o>*</span> <span class=k>length</span><span class=p>(</span><span class=n>str</span><span class=p>),</span> <span class=n>i32</span> <span class=o>+</span> <span class=n>f64</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span> <span class=nb>date</span><span class=p>,</span> <span class=n>str</span><span class=p>)</span> <span class=k>TYPE</span> <span class=k>set</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span> <span class=n>GRANULARITY</span> <span class=mi>4</span>
<span class=k>INDEX</span> <span class=n>sample_index3</span> <span class=p>(</span><span class=k>lower</span><span class=p>(</span><span class=n>str</span><span class=p>),</span> <span class=n>str</span><span class=p>)</span> <span class=k>TYPE</span> <span class=n>ngrambf_v1</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=n>GRANULARITY</span> <span class=mi>4</span>
</code></pre></div> <h4 id=functions-support>機能サポート<a class=headerlink href=../amp/#functions-support title="Permanent link"> </a></h4> <p>の条件 <code class=syntax>WHERE</code> 句には、列で動作する関数の呼び出しが含まれます。 列がインデックスの一部である場合、ClickHouseは関数の実行時にこのインデックスを使用しようとします。 ClickHouse支援の異なるサブセットの機能を使用。</p> <p>その <code class=syntax>set</code> 索引はすべての機能と使用することができる。 その他のインデックスの関数サブセットを以下の表に示します。</p> <table> <thead> <tr> <th>関数(演算子)/インデックス</th> <th>主キー</th> <th>minmax</th> <th>ngrambf_v1</th> <th>tokenbf_v1</th> <th>bloom_filter name</th> </tr> </thead> <tbody> <tr> <td><a href=../../../../../sql-reference/functions/comparison-functions/amp/#function-equals>等しい(=,==)</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/comparison-functions/amp/#function-notequals>notEquals(!=, \&lt;&gt;)</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/string-search-functions/amp/#function-like>のように</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/string-search-functions/amp/#function-notlike>notLike</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/string-functions/amp/#startswith>スタート</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/string-functions/amp/#endswith>endsWith</a></td> <td>✗</td> <td>✗</td> <td>✔</td> <td>✔</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/string-search-functions/amp/#function-multisearchany>マルチサーチ</a></td> <td>✗</td> <td>✗</td> <td>✔</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/in-functions/amp/#in-functions>で</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/in-functions/amp/#in-functions>ノティン</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/comparison-functions/amp/#function-less>less(\&lt;)</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/comparison-functions/amp/#function-greater>グレーター(&gt;)</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/comparison-functions/amp/#function-lessorequals>lessOrEquals(\&lt;=)</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/comparison-functions/amp/#function-greaterorequals>greaterOrEquals(&gt;=)</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/array-functions/amp/#function-empty>空</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../../sql-reference/functions/array-functions/amp/#function-notempty>ノーテンプティ</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td>ヘイストケン</td> <td>✗</td> <td>✗</td> <td>✗</td> <td>✔</td> <td>✗</td> </tr> </tbody> </table> <p>Ngramサイズよりも小さい定数引数を持つ関数は、次のように使用できません <code class=syntax>ngrambf_v1</code> クエリ最適化のため。</p> <p>ブルでは偽陽性一致すので、 <code class=syntax>ngrambf_v1</code>, <code class=syntax>tokenbf_v1</code>,and <code class=syntax>bloom_filter</code> インデックスは、関数の結果がfalseになると予想されるクエリの最適化には使用できません。:</p> <ul> <li>最適化できます:<ul> <li><code class=syntax>s LIKE '%test%'</code></li> <li><code class=syntax>NOT s NOT LIKE '%test%'</code></li> <li><code class=syntax>s = 1</code></li> <li><code class=syntax>NOT s != 1</code></li> <li><code class=syntax>startsWith(s, 'test')</code></li> </ul> </li> <li>最適化できない:<ul> <li><code class=syntax>NOT s LIKE '%test%'</code></li> <li><code class=syntax>s NOT LIKE '%test%'</code></li> <li><code class=syntax>NOT s = 1</code></li> <li><code class=syntax>s != 1</code></li> <li><code class=syntax>NOT startsWith(s, 'test')</code></li> </ul> </li> </ul> <h2 id=concurrent-data-access>同時データアクセス<a class=headerlink href=../amp/#concurrent-data-access title="Permanent link"> </a></h2> <p>同時テーブルアクセスには、マルチバージョン管理を使用します。 つまり、テーブルの読み取りと更新が同時に行われると、クエリの時点で現在の部分のセットからデータが読み取られます。 長いロックはありません。 挿入は読み取り操作の邪魔になりません。</p> <p>テーブルからの読み取りは自動的に並列化されます。</p> <h2 id=table_engine-mergetree-ttl>列および表のTTL<a class=headerlink href=../amp/#table_engine-mergetree-ttl title="Permanent link"> </a></h2> <p>値の有効期間を決定します。</p> <p>その <code class=syntax>TTL</code> 句は、テーブル全体および個々の列ごとに設定できます。 テーブルレベルのTTLで指定した論理の自動移動のデータディスクの間とします。</p> <p>表現を行い、評価しなければならなす <a href=../../../../../sql-reference/data-types/date/amp/ >日付</a> または <a href=../../../../../sql-reference/data-types/datetime/amp/ >DateTime</a> データ型。</p> <p>例:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>TTL</span> <span class=n>time_column</span>
<span class=n>TTL</span> <span class=n>time_column</span> <span class=o>+</span> <span class=nb>interval</span>
</code></pre></div> <p>定義するには <code class=syntax>interval</code>,use <a href=../../../../../sql-reference/operators/amp/#operators-datetime>時間間隔</a> 演算子。</p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>TTL</span> <span class=n>date_time</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span>
<span class=n>TTL</span> <span class=n>date_time</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>15</span> <span class=n>HOUR</span>
</code></pre></div> <h3 id=mergetree-column-ttl>列TTL<a class=headerlink href=../amp/#mergetree-column-ttl title="Permanent link"> </a></h3> <p>列の値が期限切れになると、ClickHouseは列のデータ型の既定値に置き換えます。 データ部分のすべての列の値が期限切れになった場合、ClickHouseはファイルシステム内のデータ部分からこの列を削除します。</p> <p>その <code class=syntax>TTL</code> 句はキー列には使用できません。</p> <p>例:</p> <p>TTLを使用したテーブルの作成</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>example_table</span>
<span class=p>(</span>
    <span class=n>d</span> <span class=n>DateTime</span><span class=p>,</span>
    <span class=n>a</span> <span class=nb>Int</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span><span class=p>,</span>
    <span class=n>b</span> <span class=nb>Int</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span><span class=p>,</span>
    <span class=k>c</span> <span class=n>String</span>
<span class=p>)</span>
<span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span>
<span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>toYYYYMM</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
<span class=k>ORDER</span> <span class=k>BY</span> <span class=n>d</span><span class=p>;</span>
</code></pre></div> <p>既存のテーブルの列へのTTLの追加</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>ALTER</span> <span class=k>TABLE</span> <span class=n>example_table</span>
    <span class=k>MODIFY</span> <span class=k>COLUMN</span>
    <span class=k>c</span> <span class=n>String</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>DAY</span><span class=p>;</span>
</code></pre></div> <p>列のTTLを変更する</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>ALTER</span> <span class=k>TABLE</span> <span class=n>example_table</span>
    <span class=k>MODIFY</span> <span class=k>COLUMN</span>
    <span class=k>c</span> <span class=n>String</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span><span class=p>;</span>
</code></pre></div> <h3 id=mergetree-table-ttl>テーブルTTL<a class=headerlink href=../amp/#mergetree-table-ttl title="Permanent link"> </a></h3> <p>テーブルでの表現の除去に終了しました列、複数の表現を自動で部品の移動と <a href=../amp/#table_engine-mergetree-multiple-volumes>ディスクまた</a>. 表の行が期限切れになると、ClickHouseは対応するすべての行を削除します。 パーツ移動フィーチャの場合、パーツのすべての行が移動式基準を満たす必要があります。</p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>TTL</span> <span class=n>expr</span> <span class=p>[</span><span class=k>DELETE</span><span class=o>|</span><span class=k>TO</span> <span class=n>DISK</span> <span class=s1>'aaa'</span><span class=o>|</span><span class=k>TO</span> <span class=n>VOLUME</span> <span class=s1>'bbb'</span><span class=p>],</span> <span class=p>...</span>
</code></pre></div> <p>TTL規則のタイプは、各TTL式に従うことができます。 これは、式が満たされた後（現在の時刻に達する）に実行されるアクションに影響します):</p> <ul> <li><code class=syntax>DELETE</code> 削除行を終了しました(デフォルトアクション);</li> <li><code class=syntax>TO DISK 'aaa'</code> -ディスクへの部分の移動 <code class=syntax>aaa</code>;</li> <li><code class=syntax>TO VOLUME 'bbb'</code> -ディスクへの部分の移動 <code class=syntax>bbb</code>.</li> </ul> <p>例:</p> <p>TTLを使用したテーブルの作成</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>example_table</span>
<span class=p>(</span>
    <span class=n>d</span> <span class=n>DateTime</span><span class=p>,</span>
    <span class=n>a</span> <span class=nb>Int</span>
<span class=p>)</span>
<span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span>
<span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>toYYYYMM</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
<span class=k>ORDER</span> <span class=k>BY</span> <span class=n>d</span>
<span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span> <span class=p>[</span><span class=k>DELETE</span><span class=p>],</span>
    <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=n>WEEK</span> <span class=k>TO</span> <span class=n>VOLUME</span> <span class=s1>'aaa'</span><span class=p>,</span>
    <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>2</span> <span class=n>WEEK</span> <span class=k>TO</span> <span class=n>DISK</span> <span class=s1>'bbb'</span><span class=p>;</span>
</code></pre></div> <p>テーブルのTTLの変更</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>ALTER</span> <span class=k>TABLE</span> <span class=n>example_table</span>
    <span class=k>MODIFY</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>DAY</span><span class=p>;</span>
</code></pre></div> <p><strong>データの削除</strong></p> <p>期限切れのTTLのデータはClickHouseがデータ部分を結合するとき取除かれる。</p> <p>時ClickHouseるデータの期間は終了しましたので、行offスケジュール内スケジュールする必要がありません。 このようなマージの頻度を制御するには、次のように設定できます <code class=syntax>merge_with_ttl_timeout</code>. 値が小さすぎると、大量のリソースを消費する可能性のある、スケジュール外のマージが多数実行されます。</p> <p>を実行する場合 <code class=syntax>SELECT</code> クエリと合併はありませんが、できれば終了しました。 それを避けるには、 <a href=../../../../../sql-reference/statements/misc/amp/#misc_operations-optimize>OPTIMIZE</a> クエリの前に <code class=syntax>SELECT</code>.</p> <h2 id=table_engine-mergetree-multiple-volumes>複数のブロックデバイスのためのデータ保存<a class=headerlink href=../amp/#table_engine-mergetree-multiple-volumes title="Permanent link"> </a></h2> <h3 id=introduction>はじめに<a class=headerlink href=../amp/#introduction title="Permanent link"> </a></h3> <p><code class=syntax>MergeTree</code> 家族のテーブルエンジンでデータを複数のブロックデバイス たとえば、特定のテーブルのデータが暗黙的に次のように分割される場合に便利です “hot” と “cold”. 最新のデータは定期的に要求されますが、わずかなスペースしか必要ありません。 逆に、fat-tailed履歴データはほとんど要求されません。 複数のディスクが利用できれば、 “hot” データは高速ディスク(例えば、NVMe Ssdまたはメモリ内)に配置されることがあります。 “cold” データ-比較的遅いもの（例えば、HDD）。</p> <p>データ部分は最低の移動可能な単位のためのです <code class=syntax>MergeTree</code>-エンジンテーブル。 ある部分に属するデータは、一つのディスクに保存されます。 データパーツは、バックグラウンドで(ユーザー設定に従って)ディスク間で移動することができます。 <a href=../../../../../sql-reference/statements/alter/amp/#alter_move-partition>ALTER</a> クエリ。</p> <h3 id=terms>用語<a class=headerlink href=../amp/#terms title="Permanent link"> </a></h3> <ul> <li>Disk — Block device mounted to the filesystem.</li> <li>Default disk — Disk that stores the path specified in the <a href=../../../../../operations/server-configuration-parameters/settings/amp/#server_configuration_parameters-path>パス</a> サーバー設定。</li> <li>Volume — Ordered set of equal disks (similar to <a href=https://en.wikipedia.org/wiki/Non-RAID_drive_architectures rel="external nofollow noreferrer" target=_blank>JBOD</a>).</li> <li>Storage policy — Set of volumes and the rules for moving data between them.</li> </ul> <p>の名称を記載することから、システムテーブル, <a href=../../../../../operations/system-tables/amp/#system_tables-storage_policies>システムストレージポリシー</a> と <a href=../../../../../operations/system-tables/amp/#system_tables-disks>システムディスク</a>. 適用の設定を保存政策のためのテーブルを使用 <code class=syntax>storage_policy</code> 設定の <code class=syntax>MergeTree</code>-エンジン家族のテーブル。</p> <h3 id=table_engine-mergetree-multiple-volumes_configure>設定<a class=headerlink href=../amp/#table_engine-mergetree-multiple-volumes_configure title="Permanent link"> </a></h3> <p>ディスク、ボリューム、およびストレージポリシーは、 <code class=syntax>&lt;storage_configuration&gt;</code> メインファイルにタグを付ける <code class=syntax>config.xml</code> または、 <code class=syntax>config.d</code> ディレクトリ。</p> <p>構成構造:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=nt>&lt;storage_configuration&gt;</span>
    <span class=nt>&lt;disks&gt;</span>
        <span class=nt>&lt;disk_name_1&gt;</span> <span class=c>&lt;!-- disk name --&gt;</span>
            <span class=nt>&lt;path&gt;</span>/mnt/fast_ssd/clickhouse/<span class=nt>&lt;/path&gt;</span>
        <span class=nt>&lt;/disk_name_1&gt;</span>
        <span class=nt>&lt;disk_name_2&gt;</span>
            <span class=nt>&lt;path&gt;</span>/mnt/hdd1/clickhouse/<span class=nt>&lt;/path&gt;</span>
            <span class=nt>&lt;keep_free_space_bytes&gt;</span>10485760<span class=nt>&lt;/keep_free_space_bytes&gt;</span>
        <span class=nt>&lt;/disk_name_2&gt;</span>
        <span class=nt>&lt;disk_name_3&gt;</span>
            <span class=nt>&lt;path&gt;</span>/mnt/hdd2/clickhouse/<span class=nt>&lt;/path&gt;</span>
            <span class=nt>&lt;keep_free_space_bytes&gt;</span>10485760<span class=nt>&lt;/keep_free_space_bytes&gt;</span>
        <span class=nt>&lt;/disk_name_3&gt;</span>

        ...
    <span class=nt>&lt;/disks&gt;</span>

    ...
<span class=nt>&lt;/storage_configuration&gt;</span>
</code></pre></div> <p>タグ:</p> <ul> <li><code class=syntax>&lt;disk_name_N&gt;</code> — Disk name. Names must be different for all disks.</li> <li><code class=syntax>path</code> — path under which a server will store data (<code class=syntax>data</code> と <code class=syntax>shadow</code> フォルダ）で終了する必要があります。 ‘/’.</li> <li><code class=syntax>keep_free_space_bytes</code> — the amount of free disk space to be reserved.</li> </ul> <p>ディスク定義の順序は重要ではありません。</p> <p>保管方針の設定のマークアップ:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=nt>&lt;storage_configuration&gt;</span>
    ...
    <span class=nt>&lt;policies&gt;</span>
        <span class=nt>&lt;policy_name_1&gt;</span>
            <span class=nt>&lt;volumes&gt;</span>
                <span class=nt>&lt;volume_name_1&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>disk_name_from_disks_configuration<span class=nt>&lt;/disk&gt;</span>
                    <span class=nt>&lt;max_data_part_size_bytes&gt;</span>1073741824<span class=nt>&lt;/max_data_part_size_bytes&gt;</span>
                <span class=nt>&lt;/volume_name_1&gt;</span>
                <span class=nt>&lt;volume_name_2&gt;</span>
                    <span class=c>&lt;!-- configuration --&gt;</span>
                <span class=nt>&lt;/volume_name_2&gt;</span>
                <span class=c>&lt;!-- more volumes --&gt;</span>
            <span class=nt>&lt;/volumes&gt;</span>
            <span class=nt>&lt;move_factor&gt;</span>0.2<span class=nt>&lt;/move_factor&gt;</span>
        <span class=nt>&lt;/policy_name_1&gt;</span>
        <span class=nt>&lt;policy_name_2&gt;</span>
            <span class=c>&lt;!-- configuration --&gt;</span>
        <span class=nt>&lt;/policy_name_2&gt;</span>

        <span class=c>&lt;!-- more policies --&gt;</span>
    <span class=nt>&lt;/policies&gt;</span>
    ...
<span class=nt>&lt;/storage_configuration&gt;</span>
</code></pre></div> <p>タグ:</p> <ul> <li><code class=syntax>policy_name_N</code> — Policy name. Policy names must be unique.</li> <li><code class=syntax>volume_name_N</code> — Volume name. Volume names must be unique.</li> <li><code class=syntax>disk</code> — a disk within a volume.</li> <li><code class=syntax>max_data_part_size_bytes</code> — the maximum size of a part that can be stored on any of the volume's disks.</li> <li><code class=syntax>move_factor</code> — when the amount of available space gets lower than this factor, data automatically start to move on the next volume if any (by default, 0.1).</li> </ul> <p>構成の例:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=nt>&lt;storage_configuration&gt;</span>
    ...
    <span class=nt>&lt;policies&gt;</span>
        <span class=nt>&lt;hdd_in_order&gt;</span> <span class=c>&lt;!-- policy name --&gt;</span>
            <span class=nt>&lt;volumes&gt;</span>
                <span class=nt>&lt;single&gt;</span> <span class=c>&lt;!-- volume name --&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>disk1<span class=nt>&lt;/disk&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>disk2<span class=nt>&lt;/disk&gt;</span>
                <span class=nt>&lt;/single&gt;</span>
            <span class=nt>&lt;/volumes&gt;</span>
        <span class=nt>&lt;/hdd_in_order&gt;</span>

        <span class=nt>&lt;moving_from_ssd_to_hdd&gt;</span>
            <span class=nt>&lt;volumes&gt;</span>
                <span class=nt>&lt;hot&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>fast_ssd<span class=nt>&lt;/disk&gt;</span>
                    <span class=nt>&lt;max_data_part_size_bytes&gt;</span>1073741824<span class=nt>&lt;/max_data_part_size_bytes&gt;</span>
                <span class=nt>&lt;/hot&gt;</span>
                <span class=nt>&lt;cold&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>disk1<span class=nt>&lt;/disk&gt;</span>
                <span class=nt>&lt;/cold&gt;</span>
            <span class=nt>&lt;/volumes&gt;</span>
            <span class=nt>&lt;move_factor&gt;</span>0.2<span class=nt>&lt;/move_factor&gt;</span>
        <span class=nt>&lt;/moving_from_ssd_to_hdd&gt;</span>
    <span class=nt>&lt;/policies&gt;</span>
    ...
<span class=nt>&lt;/storage_configuration&gt;</span>
</code></pre></div> <p>与えられた例では、 <code class=syntax>hdd_in_order</code> ポリシーは、 <a href=https://en.wikipedia.org/wiki/Round-robin_scheduling rel="external nofollow noreferrer" target=_blank>ラウンドロビン</a> アプローチ このようにこの方針を定義しみ量 (<code class=syntax>single</code>）、データ部分は円形の順序ですべてのディスクに格納されています。 こうした政策れぞれの知見について学ぶとともに有が複数ある場合は同様のディスク搭載のシステムがRAIDな設定を行います。 個々のディスクドライブは信頼できないため、複製係数が3以上で補う必要がある場合があります。</p> <p>システムで使用可能なディスクの種類が異なる場合, <code class=syntax>moving_from_ssd_to_hdd</code> 代わりにポリシーを使用できます。 ボリューム <code class=syntax>hot</code> SSDディスクで構成されています (<code class=syntax>fast_ssd</code>)、このボリュームに格納できるパーツの最大サイズは1GBです。 1GBより大きいサイズのすべての部品はで直接貯えられます <code class=syntax>cold</code> HDDディスクを含むボリューム <code class=syntax>disk1</code>.<br> また、一度ディスク <code class=syntax>fast_ssd</code> 80%以上によって満たされて、データはに移ります得ます <code class=syntax>disk1</code> 背景プロセスによって。</p> <p>ストレージポリシー内のボリューム列挙の順序は重要です。 ボリュームが満杯になると、データは次のボリュームに移動されます。 データは順番に格納されるため、ディスク列挙の順序も重要です。</p> <p>作成時にテーブルは、適用の設定を保存方針で:</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>table_with_non_default_policy</span> <span class=p>(</span>
    <span class=n>EventDate</span> <span class=nb>Date</span><span class=p>,</span>
    <span class=n>OrderID</span> <span class=n>UInt64</span><span class=p>,</span>
    <span class=n>BannerID</span> <span class=n>UInt64</span><span class=p>,</span>
    <span class=n>SearchPhrase</span> <span class=n>String</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span>
<span class=k>ORDER</span> <span class=k>BY</span> <span class=p>(</span><span class=n>OrderID</span><span class=p>,</span> <span class=n>BannerID</span><span class=p>)</span>
<span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>toYYYYMM</span><span class=p>(</span><span class=n>EventDate</span><span class=p>)</span>
<span class=n>SETTINGS</span> <span class=n>storage_policy</span> <span class=o>=</span> <span class=s1>'moving_from_ssd_to_hdd'</span>
</code></pre></div> <p>その <code class=syntax>default</code> ストレージポリシーは、一つのボリュームのみを使用することを意味します。 <code class=syntax>&lt;path&gt;</code>. テーブルを作成すると、そのストレージポリシーは変更できません。</p> <h3 id=details>詳細<a class=headerlink href=../amp/#details title="Permanent link"> </a></h3> <p>の場合 <code class=syntax>MergeTree</code> テーブル、データがあるディスクには、異なる方法:</p> <ul> <li>挿入の結果として (<code class=syntax>INSERT</code> クエリ）。</li> <li>バックグラウンドマージ中 <a href=../../../../../sql-reference/statements/alter/amp/#alter-mutations>突然変異</a>.</li> <li>別のレプリカからダウンロ</li> <li>パーティションの凍結の結果として <a href=../../../../../sql-reference/statements/alter/amp/#alter_freeze-partition>ALTER TABLE … FREEZE PARTITION</a>.</li> </ul> <p>すべてのこれらの場合を除き、突然変異とパーティションの凍結は、一部が保存され、大量のディスクに保存政策:</p> <ol> <li>部品を格納するのに十分なディスク領域を持つ最初のボリューム(定義順) (<code class=syntax>unreserved_space &gt; current_part_size</code>）と指定されたサイズの部分を格納することができます (<code class=syntax>max_data_part_size_bytes &gt; current_part_size</code>）が選ばれる。</li> <li>このボリューム内では、データの前のチャンクを格納するために使用され、パートサイズよりも空き領域が多いディスクが選択されます (<code class=syntax>unreserved_space - keep_free_space_bytes &gt; current_part_size</code>).</li> </ol> <p>フードの下で、突然変異および仕切りの凍結は利用します <a href=https://en.wikipedia.org/wiki/Hard_link rel="external nofollow noreferrer" target=_blank>ハードリンク</a>. ハードリンクとディスクには対応していないため、この場合、パーツの保管と同じディスクの初期ます。</p> <p>バックグラウンドでは、部品は空き領域の量に基づいてボリューム間で移動されます (<code class=syntax>move_factor</code> パラメータ)ボリュームが設定ファイルで宣言されている順序に従って。<br> データは、最後のデータから最初のデータに転送されることはありません。 システムテーブル <a href=../../../../../operations/system-tables/amp/#system_tables-part-log>システムpart_log</a> （フィールド <code class=syntax>type = MOVE_PART</code>)と <a href=../../../../../operations/system-tables/amp/#system_tables-parts>システム部品</a> （フィールド <code class=syntax>path</code> と <code class=syntax>disk</code>）背景の動きを監視します。 また、詳細情報はサーバーログに記載されています。</p> <p>ユーザーの力で移動中の一部またはパーティションから量別のクエリ <a href=../../../../../sql-reference/statements/alter/amp/#alter_move-partition>ALTER TABLE … MOVE PART|PARTITION … TO VOLUME|DISK …</a> バックグラウンド操作のすべての制限が考慮されます。 クエリは単独で移動を開始し、バックグラウンド操作が完了するまで待機しません。 十分な空き領域がない場合、または必要な条件のいずれかが満たされていない場合、ユーザーはエラーメッセージを表示します。</p> <p>データの移動は、データの複製を妨げません。 そのため、異なる保管方針を指定することができ、同じテーブルの異なるレプリカ.</p> <p>バックグラウンドマージと突然変異の完了後、古い部分は一定時間後にのみ削除されます (<code class=syntax>old_parts_lifetime</code>).<br> この間、他のボリュームまたはディスクには移動されません。 したがって、部品が最終的に除去されるまで、それらは占有されたディスク領域の評価のために考慮される。</p> <p><a href=https://clickhouse.tech/docs/ru/operations/table_engines/mergetree/ target=_blank>元の記事</a> <!--hide--></p> </div> </div> <div class=row> <div class=col> <div class="alert alert-light my-3"> <p class="float-right mb-0">Rating: RATING_VALUE - RATING_COUNT votes</p> <span class="alert-heading display-6">Article Rating</span> <div id=rating-stars class="display-6 mb-0">RATING_STARS</div> </div> <div id=content-footer class="text-muted pt-3 mb-5"> <div class=float-md-right>©2016–2021 Yandex LLC</div> <div>Built from <a href=https://github.com/ClickHouse/ClickHouse/commit/878a159538935028f2d2dce3eb3074d44eb191df rel="external nofollow noreferrer" target=_blank class=text-reset>878a159538</a> </div> </div> </div> </div> <div id=to-full-website class="row fixed-bottom text-center bg-white py-3"> <div class=col> <a href=https://clickhouse.tech/docs/ja/engines/table-engines/mergetree-family/mergetree/ class="btn btn-lg btn-outline-orange">To full website</a> </div> </div> </div> <amp-analytics type=metrika> <script type=application/json>{
"vars": {
  "counterId": "18343495",
  "triggers": {
    "notBounce": {
      "on": "timer",
      "timerSpec": {
        "immediate": false,
        "interval": 15,
        "maxTimerLength": 16
      },
      "request": "notBounce"
    }
  }
}
}</script> </amp-analytics> </body> </html> 