<!doctype html><html ⚡ lang=ru> <head><meta charset=utf-8><script async src=https://cdn.ampproject.org/v0.js></script><title>Обзор архитектуры ClickHouse | Документация ClickHouse</title><link href=https://clickhouse.tech/docs/ru/development/architecture/ rel=canonical><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><script type=application/ld+json>[{
"@context": "http://schema.org",
"@type": "TechArticle",
"headline": "Обзор архитектуры ClickHouse | Документация ClickHouse",
"mainEntityOfPage": "https://clickhouse.tech/docs/ru/development/architecture/",




"image": "https://clickhouse.tech/images/logo-209x60.png",
"author": {
  "@type": "Project",
  "name": "ClickHouse"
},
"publisher": {
  "@type": "Organization",
  "name": "Yandex LLC",
  "logo": {
    "@type": "ImageObject",
    "url": "https://clickhouse.tech/images/yandex.png",
    "width": 163,
    "height": 60
  }
}}, {
"@context": "http://schema.org",
"@type": "Episode",
"name": "Обзор архитектуры ClickHouse | Документация ClickHouse",
"aggregateRating": {
  "@type": "AggregateRating",
  "ratingValue": RATING_VALUE,
  "ratingCount": RATING_COUNT
}
}]</script><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><style amp-custom>:root{--blue:#007bff;--indigo:#6610f2;--purple:#6f42c1;--pink:#e83e8c;--red:#dc3545;--orange:#fd7e14;--yellow:#ffc107;--green:#28a745;--teal:#20c997;--cyan:#17a2b8;--white:#fff;--gray:#6c757d;--gray-dark:#343a40;--primary:#007bff;--secondary:#6c757d;--success:#28a745;--info:#17a2b8;--warning:#ffc107;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--breakpoint-xs:0;--breakpoint-sm:576px;--breakpoint-md:768px;--breakpoint-lg:992px;--breakpoint-xl:1200px;--font-family-sans-serif:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-family-monospace:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}*,::after,::before{box-sizing:border-box}html{font-family:sans-serif;line-height:1.15;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}article,footer{display:block}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;text-align:left;background-color:#fff}[tabindex="-1"]:focus:not(:focus-visible){outline:0}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem}p{margin-top:0;margin-bottom:1rem}ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}blockquote{margin:0 0 1rem}strong{font-weight:bolder}a{color:#007bff;text-decoration:none;background-color:transparent}a:hover{color:#0056b3;text-decoration:underline}a:not([href]){color:inherit;text-decoration:none}a:not([href]):hover{color:inherit;text-decoration:none}code{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em}img{vertical-align:middle;border-style:none}svg{overflow:hidden;vertical-align:middle}select{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}select{text-transform:none}select{word-wrap:normal}[type=button],[type=reset],[type=submit]{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled){cursor:pointer}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{padding:0;border-style:none}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:none}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}[hidden]{display:none}.h1,.h2,.h3,.h4,.h5,.h6,h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:500;line-height:1.2}.h1,h1{font-size:2rem}.h2,h2{font-size:1.5rem}.h3,h3{font-size:1.25rem}.h4,h4{font-size:1rem}.h5,h5{font-size:1rem}.h6,h6{font-size:1rem}.display-1{font-size:6rem;font-weight:300;line-height:1.2}.display-2{font-size:5.5rem;font-weight:300;line-height:1.2}.display-3{font-size:4.5rem;font-weight:300;line-height:1.2}.display-4{font-size:3.5rem;font-weight:300;line-height:1.2}.blockquote{margin-bottom:1rem;font-size:1.25rem}.blockquote-footer{display:block;font-size:80%;color:#6c757d}.blockquote-footer::before{content:"\2014\00A0"}.img-fluid{max-width:100%;height:auto}code{font-size:87.5%;color:#e83e8c;word-wrap:break-word}a>code{color:inherit}.container{width:100%;padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media(min-width:576px){.container{max-width:540px}}@media(min-width:768px){.container{max-width:720px}}@media(min-width:992px){.container{max-width:960px}}@media(min-width:1200px){.container{max-width:1140px}}.container-fluid,.container-lg,.container-md{width:100%;padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}@media(min-width:576px){.container{max-width:540px}}@media(min-width:768px){.container,.container-md{max-width:720px}}@media(min-width:992px){.container,.container-lg,.container-md{max-width:960px}}@media(min-width:1200px){.container,.container-lg,.container-md{max-width:1140px}}.row{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-15px;margin-left:-15px}.col,.col-1,.col-10,.col-11,.col-12,.col-2,.col-3,.col-4,.col-5,.col-6,.col-7,.col-8,.col-9,.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9{position:relative;width:100%;padding-right:15px;padding-left:15px}.col{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-0{-ms-flex-order:0;order:0}.order-1{-ms-flex-order:1;order:1}.order-2{-ms-flex-order:2;order:2}.order-3{-ms-flex-order:3;order:3}.order-4{-ms-flex-order:4;order:4}.order-5{-ms-flex-order:5;order:5}.order-6{-ms-flex-order:6;order:6}.order-7{-ms-flex-order:7;order:7}.order-8{-ms-flex-order:8;order:8}.order-9{-ms-flex-order:9;order:9}.order-10{-ms-flex-order:10;order:10}.order-11{-ms-flex-order:11;order:11}.order-12{-ms-flex-order:12;order:12}@media(min-width:768px){.col-md{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-md-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-md-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-md-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-md-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-md-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-md-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-md-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-md-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-md-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-md-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-md-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-md-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-md-0{-ms-flex-order:0;order:0}.order-md-1{-ms-flex-order:1;order:1}.order-md-2{-ms-flex-order:2;order:2}.order-md-3{-ms-flex-order:3;order:3}.order-md-4{-ms-flex-order:4;order:4}.order-md-5{-ms-flex-order:5;order:5}.order-md-6{-ms-flex-order:6;order:6}.order-md-7{-ms-flex-order:7;order:7}.order-md-8{-ms-flex-order:8;order:8}.order-md-9{-ms-flex-order:9;order:9}.order-md-10{-ms-flex-order:10;order:10}.order-md-11{-ms-flex-order:11;order:11}.order-md-12{-ms-flex-order:12;order:12}}@media(min-width:992px){.col-lg{-ms-flex-preferred-size:0;flex-basis:0;-ms-flex-positive:1;flex-grow:1;max-width:100%}.col-lg-1{-ms-flex:0 0 8.333333%;flex:0 0 8.333333%;max-width:8.333333%}.col-lg-2{-ms-flex:0 0 16.666667%;flex:0 0 16.666667%;max-width:16.666667%}.col-lg-3{-ms-flex:0 0 25%;flex:0 0 25%;max-width:25%}.col-lg-4{-ms-flex:0 0 33.333333%;flex:0 0 33.333333%;max-width:33.333333%}.col-lg-5{-ms-flex:0 0 41.666667%;flex:0 0 41.666667%;max-width:41.666667%}.col-lg-6{-ms-flex:0 0 50%;flex:0 0 50%;max-width:50%}.col-lg-7{-ms-flex:0 0 58.333333%;flex:0 0 58.333333%;max-width:58.333333%}.col-lg-8{-ms-flex:0 0 66.666667%;flex:0 0 66.666667%;max-width:66.666667%}.col-lg-9{-ms-flex:0 0 75%;flex:0 0 75%;max-width:75%}.col-lg-10{-ms-flex:0 0 83.333333%;flex:0 0 83.333333%;max-width:83.333333%}.col-lg-11{-ms-flex:0 0 91.666667%;flex:0 0 91.666667%;max-width:91.666667%}.col-lg-12{-ms-flex:0 0 100%;flex:0 0 100%;max-width:100%}.order-lg-0{-ms-flex-order:0;order:0}.order-lg-1{-ms-flex-order:1;order:1}.order-lg-2{-ms-flex-order:2;order:2}.order-lg-3{-ms-flex-order:3;order:3}.order-lg-4{-ms-flex-order:4;order:4}.order-lg-5{-ms-flex-order:5;order:5}.order-lg-6{-ms-flex-order:6;order:6}.order-lg-7{-ms-flex-order:7;order:7}.order-lg-8{-ms-flex-order:8;order:8}.order-lg-9{-ms-flex-order:9;order:9}.order-lg-10{-ms-flex-order:10;order:10}.order-lg-11{-ms-flex-order:11;order:11}.order-lg-12{-ms-flex-order:12;order:12}}.btn{display:inline-block;font-weight:400;color:#212529;text-align:center;vertical-align:middle;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background-color:transparent;border:1px solid transparent;padding:.375rem .75rem;font-size:1rem;line-height:1.5;border-radius:.25rem}@media(prefers-reduced-motion:reduce){.btn{transition:none}}.btn:hover{color:#212529;text-decoration:none}.btn:focus{outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.btn:disabled{opacity:.65}.btn-primary{color:#fff;background-color:#007bff;border-color:#007bff}.btn-primary:hover{color:#fff;background-color:#0069d9;border-color:#0062cc}.btn-primary:focus{color:#fff;background-color:#0069d9;border-color:#0062cc;box-shadow:0 0 0 .2rem rgba(38,143,255,.5)}.btn-primary:disabled{color:#fff;background-color:#007bff;border-color:#007bff}.btn-light{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-light:hover{color:#212529;background-color:#e2e6ea;border-color:#dae0e5}.btn-light:focus{color:#212529;background-color:#e2e6ea;border-color:#dae0e5;box-shadow:0 0 0 .2rem rgba(216,217,219,.5)}.btn-light:disabled{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-dark{color:#fff;background-color:#343a40;border-color:#343a40}.btn-dark:hover{color:#fff;background-color:#23272b;border-color:#1d2124}.btn-dark:focus{color:#fff;background-color:#23272b;border-color:#1d2124;box-shadow:0 0 0 .2rem rgba(82,88,93,.5)}.btn-dark:disabled{color:#fff;background-color:#343a40;border-color:#343a40}.btn-outline-primary{color:#007bff;border-color:#007bff}.btn-outline-primary:hover{color:#fff;background-color:#007bff;border-color:#007bff}.btn-outline-primary:focus{box-shadow:0 0 0 .2rem rgba(0,123,255,.5)}.btn-outline-primary:disabled{color:#007bff;background-color:transparent}.btn-outline-light{color:#f8f9fa;border-color:#f8f9fa}.btn-outline-light:hover{color:#212529;background-color:#f8f9fa;border-color:#f8f9fa}.btn-outline-light:focus{box-shadow:0 0 0 .2rem rgba(248,249,250,.5)}.btn-outline-light:disabled{color:#f8f9fa;background-color:transparent}.btn-outline-dark{color:#343a40;border-color:#343a40}.btn-outline-dark:hover{color:#fff;background-color:#343a40;border-color:#343a40}.btn-outline-dark:focus{box-shadow:0 0 0 .2rem rgba(52,58,64,.5)}.btn-outline-dark:disabled{color:#343a40;background-color:transparent}.btn-link{font-weight:400;color:#007bff;text-decoration:none}.btn-link:hover{color:#0056b3;text-decoration:underline}.btn-link:focus{text-decoration:underline;box-shadow:none}.btn-link:disabled{color:#6c757d;pointer-events:none}.btn-group-lg>.btn,.btn-lg{padding:.5rem 1rem;font-size:1.25rem;line-height:1.5;border-radius:.3rem}.btn-block{display:block;width:100%}.btn-block+.btn-block{margin-top:.5rem}.btn-group{position:relative;display:-ms-inline-flexbox;display:inline-flex;vertical-align:middle}.btn-group>.btn{position:relative;-ms-flex:1 1 auto;flex:1 1 auto}.btn-group>.btn:hover{z-index:1}.btn-group>.btn:active,.btn-group>.btn:focus{z-index:1}.btn-group>.btn-group:not(:first-child),.btn-group>.btn:not(:first-child){margin-left:-1px}.btn-group>.btn-group:not(:last-child)>.btn{border-top-right-radius:0;border-bottom-right-radius:0}.btn-group>.btn-group:not(:first-child)>.btn,.btn-group>.btn:not(:first-child){border-top-left-radius:0;border-bottom-left-radius:0}.custom-select{display:inline-block;width:100%;height:calc(1.5em+.75rem+2px);padding:.375rem 1.75rem .375rem .75rem;font-size:1rem;font-weight:400;line-height:1.5;color:#495057;vertical-align:middle;background:#fff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='4' height='5' viewBox='0 0 4 5'%3e%3cpath fill='%23343a40' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e") no-repeat right .75rem center/8px 10px;border:1px solid #ced4da;border-radius:.25rem;-webkit-appearance:none;-moz-appearance:none;appearance:none}.custom-select:focus{border-color:#80bdff;outline:0;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}.custom-select:focus::-ms-value{color:#495057;background-color:#fff}.custom-select[multiple],.custom-select[size]:not([size="1"]){height:auto;padding-right:.75rem;background-image:none}.custom-select:disabled{color:#6c757d;background-color:#e9ecef}.custom-select::-ms-expand{display:none}.custom-select:-moz-focusring{color:transparent;text-shadow:0 0 0 #495057}.custom-select-lg{height:calc(1.5em+1rem+2px);padding-top:.5rem;padding-bottom:.5rem;padding-left:1rem;font-size:1.25rem}@media(prefers-reduced-motion:reduce){.custom-select{transition:none}}.alert{position:relative;padding:.75rem 1.25rem;margin-bottom:1rem;border:1px solid transparent;border-radius:.25rem}.alert-heading{color:inherit}.alert-link{font-weight:700}.alert-primary{color:#004085;background-color:#cce5ff;border-color:#b8daff}.alert-primary .alert-link{color:#002752}.alert-light{color:#818182;background-color:#fefefe;border-color:#fdfdfe}.alert-light .alert-link{color:#686868}.alert-dark{color:#1b1e21;background-color:#d6d8d9;border-color:#c6c8ca}.alert-dark .alert-link{color:#040505}@-webkit-keyframes progress-bar-stripes{from{background-position:1rem 0}to{background-position:0 0}}@keyframes progress-bar-stripes{from{background-position:1rem 0}to{background-position:0 0}}@-webkit-keyframes spinner-border{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spinner-border{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-webkit-keyframes spinner-grow{0%{-webkit-transform:scale(0);transform:scale(0)}50%{opacity:1}}@keyframes spinner-grow{0%{-webkit-transform:scale(0);transform:scale(0)}50%{opacity:1}}.bg-primary{background-color:#007bff}a.bg-primary:focus,a.bg-primary:hover{background-color:#0062cc}.bg-light{background-color:#f8f9fa}a.bg-light:focus,a.bg-light:hover{background-color:#dae0e5}.bg-dark{background-color:#343a40}a.bg-dark:focus,a.bg-dark:hover{background-color:#1d2124}.bg-white{background-color:#fff}.d-none{display:none}.d-inline{display:inline}.d-inline-block{display:inline-block}.d-block{display:block}@media(min-width:768px){.d-md-none{display:none}.d-md-inline{display:inline}.d-md-inline-block{display:inline-block}.d-md-block{display:block}}@media(min-width:992px){.d-lg-none{display:none}.d-lg-inline{display:inline}.d-lg-inline-block{display:inline-block}.d-lg-block{display:block}}.float-right{float:right}.float-none{float:none}@media(min-width:768px){.float-md-right{float:right}.float-md-none{float:none}}@media(min-width:992px){.float-lg-right{float:right}.float-lg-none{float:none}}.fixed-bottom{position:fixed;right:0;bottom:0;left:0;z-index:1030}.h-25{height:25%}.h-50{height:50%}.h-75{height:75%}.h-100{height:100%}.my-0{margin-top:0}.mr-0{margin-right:0}.mb-0,.my-0{margin-bottom:0}.my-1{margin-top:.25rem}.mr-1{margin-right:.25rem}.mb-1,.my-1{margin-bottom:.25rem}.my-2{margin-top:.5rem}.mr-2{margin-right:.5rem}.mb-2,.my-2{margin-bottom:.5rem}.my-3{margin-top:1rem}.mr-3{margin-right:1rem}.mb-3,.my-3{margin-bottom:1rem}.my-4{margin-top:1.5rem}.mr-4{margin-right:1.5rem}.mb-4,.my-4{margin-bottom:1.5rem}.my-5{margin-top:3rem}.mr-5{margin-right:3rem}.mb-5,.my-5{margin-bottom:3rem}.p-0{padding:0}.pt-0,.py-0{padding-top:0}.pb-0,.py-0{padding-bottom:0}.p-1{padding:.25rem}.pt-1,.py-1{padding-top:.25rem}.pb-1,.py-1{padding-bottom:.25rem}.p-2{padding:.5rem}.pt-2,.py-2{padding-top:.5rem}.pb-2,.py-2{padding-bottom:.5rem}.p-3{padding:1rem}.pt-3,.py-3{padding-top:1rem}.pb-3,.py-3{padding-bottom:1rem}.p-4{padding:1.5rem}.pt-4,.py-4{padding-top:1.5rem}.pb-4,.py-4{padding-bottom:1.5rem}.p-5{padding:3rem}.pt-5,.py-5{padding-top:3rem}.pb-5,.py-5{padding-bottom:3rem}.my-n1{margin-top:-.25rem}.mr-n1{margin-right:-.25rem}.mb-n1,.my-n1{margin-bottom:-.25rem}.my-n2{margin-top:-.5rem}.mr-n2{margin-right:-.5rem}.mb-n2,.my-n2{margin-bottom:-.5rem}.my-n3{margin-top:-1rem}.mr-n3{margin-right:-1rem}.mb-n3,.my-n3{margin-bottom:-1rem}.my-n4{margin-top:-1.5rem}.mr-n4{margin-right:-1.5rem}.mb-n4,.my-n4{margin-bottom:-1.5rem}.my-n5{margin-top:-3rem}.mr-n5{margin-right:-3rem}.mb-n5,.my-n5{margin-bottom:-3rem}@media(min-width:768px){.my-md-0{margin-top:0}.mr-md-0{margin-right:0}.mb-md-0,.my-md-0{margin-bottom:0}.my-md-1{margin-top:.25rem}.mr-md-1{margin-right:.25rem}.mb-md-1,.my-md-1{margin-bottom:.25rem}.my-md-2{margin-top:.5rem}.mr-md-2{margin-right:.5rem}.mb-md-2,.my-md-2{margin-bottom:.5rem}.my-md-3{margin-top:1rem}.mr-md-3{margin-right:1rem}.mb-md-3,.my-md-3{margin-bottom:1rem}.my-md-4{margin-top:1.5rem}.mr-md-4{margin-right:1.5rem}.mb-md-4,.my-md-4{margin-bottom:1.5rem}.my-md-5{margin-top:3rem}.mr-md-5{margin-right:3rem}.mb-md-5,.my-md-5{margin-bottom:3rem}.p-md-0{padding:0}.pt-md-0,.py-md-0{padding-top:0}.pb-md-0,.py-md-0{padding-bottom:0}.p-md-1{padding:.25rem}.pt-md-1,.py-md-1{padding-top:.25rem}.pb-md-1,.py-md-1{padding-bottom:.25rem}.p-md-2{padding:.5rem}.pt-md-2,.py-md-2{padding-top:.5rem}.pb-md-2,.py-md-2{padding-bottom:.5rem}.p-md-3{padding:1rem}.pt-md-3,.py-md-3{padding-top:1rem}.pb-md-3,.py-md-3{padding-bottom:1rem}.p-md-4{padding:1.5rem}.pt-md-4,.py-md-4{padding-top:1.5rem}.pb-md-4,.py-md-4{padding-bottom:1.5rem}.p-md-5{padding:3rem}.pt-md-5,.py-md-5{padding-top:3rem}.pb-md-5,.py-md-5{padding-bottom:3rem}.my-md-n1{margin-top:-.25rem}.mr-md-n1{margin-right:-.25rem}.mb-md-n1,.my-md-n1{margin-bottom:-.25rem}.my-md-n2{margin-top:-.5rem}.mr-md-n2{margin-right:-.5rem}.mb-md-n2,.my-md-n2{margin-bottom:-.5rem}.my-md-n3{margin-top:-1rem}.mr-md-n3{margin-right:-1rem}.mb-md-n3,.my-md-n3{margin-bottom:-1rem}.my-md-n4{margin-top:-1.5rem}.mr-md-n4{margin-right:-1.5rem}.mb-md-n4,.my-md-n4{margin-bottom:-1.5rem}.my-md-n5{margin-top:-3rem}.mr-md-n5{margin-right:-3rem}.mb-md-n5,.my-md-n5{margin-bottom:-3rem}}@media(min-width:992px){.my-lg-0{margin-top:0}.mr-lg-0{margin-right:0}.mb-lg-0,.my-lg-0{margin-bottom:0}.my-lg-1{margin-top:.25rem}.mr-lg-1{margin-right:.25rem}.mb-lg-1,.my-lg-1{margin-bottom:.25rem}.my-lg-2{margin-top:.5rem}.mr-lg-2{margin-right:.5rem}.mb-lg-2,.my-lg-2{margin-bottom:.5rem}.my-lg-3{margin-top:1rem}.mr-lg-3{margin-right:1rem}.mb-lg-3,.my-lg-3{margin-bottom:1rem}.my-lg-4{margin-top:1.5rem}.mr-lg-4{margin-right:1.5rem}.mb-lg-4,.my-lg-4{margin-bottom:1.5rem}.my-lg-5{margin-top:3rem}.mr-lg-5{margin-right:3rem}.mb-lg-5,.my-lg-5{margin-bottom:3rem}.p-lg-0{padding:0}.pt-lg-0,.py-lg-0{padding-top:0}.pb-lg-0,.py-lg-0{padding-bottom:0}.p-lg-1{padding:.25rem}.pt-lg-1,.py-lg-1{padding-top:.25rem}.pb-lg-1,.py-lg-1{padding-bottom:.25rem}.p-lg-2{padding:.5rem}.pt-lg-2,.py-lg-2{padding-top:.5rem}.pb-lg-2,.py-lg-2{padding-bottom:.5rem}.p-lg-3{padding:1rem}.pt-lg-3,.py-lg-3{padding-top:1rem}.pb-lg-3,.py-lg-3{padding-bottom:1rem}.p-lg-4{padding:1.5rem}.pt-lg-4,.py-lg-4{padding-top:1.5rem}.pb-lg-4,.py-lg-4{padding-bottom:1.5rem}.p-lg-5{padding:3rem}.pt-lg-5,.py-lg-5{padding-top:3rem}.pb-lg-5,.py-lg-5{padding-bottom:3rem}.my-lg-n1{margin-top:-.25rem}.mr-lg-n1{margin-right:-.25rem}.mb-lg-n1,.my-lg-n1{margin-bottom:-.25rem}.my-lg-n2{margin-top:-.5rem}.mr-lg-n2{margin-right:-.5rem}.mb-lg-n2,.my-lg-n2{margin-bottom:-.5rem}.my-lg-n3{margin-top:-1rem}.mr-lg-n3{margin-right:-1rem}.mb-lg-n3,.my-lg-n3{margin-bottom:-1rem}.my-lg-n4{margin-top:-1.5rem}.mr-lg-n4{margin-right:-1.5rem}.mb-lg-n4,.my-lg-n4{margin-bottom:-1.5rem}.my-lg-n5{margin-top:-3rem}.mr-lg-n5{margin-right:-3rem}.mb-lg-n5,.my-lg-n5{margin-bottom:-3rem}}.text-right{text-align:right}.text-center{text-align:center}@media(min-width:768px){.text-md-right{text-align:right}.text-md-center{text-align:center}}@media(min-width:992px){.text-lg-right{text-align:right}.text-lg-center{text-align:center}}.text-white{color:#fff}.text-primary{color:#007bff}a.text-primary:focus,a.text-primary:hover{color:#0056b3}.text-light{color:#f8f9fa}a.text-light:focus,a.text-light:hover{color:#cbd3da}.text-dark{color:#343a40}a.text-dark:focus,a.text-dark:hover{color:#121416}.text-body{color:#212529}.text-muted{color:#6c757d}.text-black-50{color:rgba(0,0,0,.5)}.text-white-50{color:rgba(255,255,255,.5)}.text-decoration-none{text-decoration:none}.text-reset{color:inherit}.visible{visibility:visible}@media print{*,::after,::before{text-shadow:none;box-shadow:none}a:not(.btn){text-decoration:underline}blockquote{border:1px solid #adb5bd;page-break-inside:avoid}img{page-break-inside:avoid}h2,h3,p{orphans:3;widows:3}h2,h3{page-break-after:avoid}@page{size:a3}body{min-width:992px}.container{min-width:992px}}@-webkit-keyframes sbx-reset-in{0%{-webkit-transform:translate3d(-20%,0,0);transform:translate3d(-20%,0,0);opacity:0}100%{-webkit-transform:none;transform:none;opacity:1}}@keyframes sbx-reset-in{0%{-webkit-transform:translate3d(-20%,0,0);transform:translate3d(-20%,0,0);opacity:0}100%{-webkit-transform:none;transform:none;opacity:1}}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}a:link,a:visited{color:#f14600;text-decoration:none}a:active,a:hover{text-decoration:underline}.btn:disabled{cursor:default;opacity:.4}#logo-text{width:180px;margin-left:12px}.display-5{font-size:2rem;font-weight:300;line-height:1.2}.display-6{font-size:1.75rem;font-weight:300;line-height:1.2}.bg-dark-alt,.bg-dark-alt:focus{background:#36363f}.bg-orange,.bg-orange:focus{background:#f14600}.text-dark-alt{color:#36363f}.btn-dark-alt{background:#36363f}.btn-dark-alt:focus{background:#36363f}.btn-outline-orange{border-color:#f14600;color:#f14600}.btn-orange,.btn-outline-orange:hover{background:#f14600;color:#fff}.btn:active,.btn:hover{text-decoration:none}.text-orange{color:#f14600}.headerlink{text-decoration:none;margin-left:.5rem}#content code{color:#000;background:#eee;padding:.125rem .25rem}#content code.syntax{padding:0}@media print{body{min-width:0}code,h1,h2,h3,h4,h5,h6,img,li,p{page-break-inside:avoid}}@media(prefers-color-scheme:dark){#to-full-website,body.amp,body[data-spy]{background:#1c1c1c;color:#efefef}.invert-dark{filter:invert(100%)}#content code{background:#444;color:#eee;padding:.125rem .25rem}}@media(prefers-color-scheme:dark){.syntax{background:#2d2d2d;color:#f2f0ec}.syntax .c{color:#747369}.syntax .k{color:#c9c}.syntax .l{color:#f99157}.syntax .n{color:#f2f0ec}.syntax .o{color:#6cc}.syntax .p{color:#f2f0ec}.syntax .c1{color:#747369}.syntax .cs{color:#747369}.syntax .ld{color:#9c9}.syntax .s{color:#9c9}.syntax .py{color:#f2f0ec}.syntax .s2{color:#9c9}.syntax .s1{color:#9c9}}</style><script async custom-element=amp-analytics src=https://cdn.ampproject.org/v0/amp-analytics-0.1.js></script><script async custom-element=amp-iframe src=https://cdn.ampproject.org/v0/amp-iframe-0.1.js></script></head> <body class=amp dir=ltr> <div class="container-fluid container-lg pb-5"> <div class="row pt-3 mb-3"> <div class=col> <a href=/ class=text-decoration-none> <amp-img class="d-inline-block mr-3" layout=fixed width=40 height=36 src=/images/logo.svg alt="ClickHouse logo" title="ClickHouse logo"></amp-img><amp-img class="invert-dark d-inline-block" layout=fixed width=238 height=36 src=/images/clickhouse-black.svg alt=ClickHouse title=ClickHouse></amp-img> </a> </div> </div> <div class=row> <div id=content class=col> <h1 id=overview-of-clickhouse-architecture>Обзор архитектуры ClickHouse<a class=headerlink href=../amp/#overview-of-clickhouse-architecture title="Permanent link"> </a></h1> <p>ClickHouse - полноценная колоночная СУБД. Данные хранятся в колонках, а в процессе обработки - в массивах (векторах или фрагментах (chunk’ах) колонок). По возможности операции выполняются на массивах, а не на индивидуальных значениях. Это называется “векторизованное выполнения запросов” (vectorized query execution), и помогает снизить стоимость фактической обработки данных.</p> <blockquote> <p>Эта идея не нова. Такой подход использовался в <code class=syntax>APL</code> (A programming language, 1957) и его потомках: <code class=syntax>A +</code> (диалект <code class=syntax>APL</code>), <code class=syntax>J</code> (1990), <code class=syntax>K</code> (1993) и <code class=syntax>Q</code> (язык программирования Kx Systems, 2003). Программирование на массивах (Array programming) используется в научных вычислительных системах. Эта идея не является чем-то новым и для реляционных баз данных: например, она используется в системе <code class=syntax>VectorWise</code> (так же известной как Actian Vector Analytic Database от Actian Corporation).</p> </blockquote> <p>Существует два различных подхода для увеличения скорости обработки запросов: выполнение векторизованного запроса и генерация кода во время выполнения (runtime code generation). В последнем случае код генерируется на лету для каждого типа запроса, удаляя все косвенные и динамические обращения. Ни один из этих подходов не имеет явного преимущества. Генерация кода во время выполнения выигрывает, если объединяет большое число операций, таким образом полностью используя вычислительные блоки и конвейер CPU. Выполнение векторизованного запроса может быть менее практично потому, что задействует временные векторы данных, которые должны быть записаны и прочитаны из кэша. Если временные данные не помещаются в L2 кэш, будут проблемы. С другой стороны выполнение векторизованного запроса упрощает использование SIMD инструкций CPU. <a href=http://15721.courses.cs.cmu.edu/spring2016/papers/p5-sompolski.pdf rel="external nofollow noreferrer" target=_blank>Научная работа</a> наших друзей показывает преимущества сочетания обоих подходов. ClickHouse использует выполнение векторизованного запроса и имеет ограниченную начальную поддержку генерации кода во время выполнения.</p> <h2 id=columns>Колонки<a class=headerlink href=../amp/#columns title="Permanent link"> </a></h2> <p>Для представления столбцов в памяти (фактически, фрагментов столбцов) используется интерфейс <code class=syntax>IColumn</code>. Интерфейс предоставляет вспомогательные методы для реализации различных реляционных операторов. Почти все операции иммутабельные: они не изменяют оригинальных колонок, а создают новую с измененными значениями. Например, метод <code class=syntax>IColumn :: filter</code> принимает фильтр - набор байт. Он используется для реляционных операторов <code class=syntax>WHERE</code> и <code class=syntax>HAVING</code>. Другой пример: метод <code class=syntax>IColumn :: permute</code> используется для поддержки <code class=syntax>ORDER BY</code>, метод <code class=syntax>IColumn :: cut</code> - <code class=syntax>LIMIT</code> и т. д.</p> <p>Различные реализации <code class=syntax>IColumn</code> (<code class=syntax>ColumnUInt8</code>, <code class=syntax>ColumnString</code> и т. д.) отвечают за распределение данных колонки в памяти. Для колонок целочисленного типа это один смежный массив, такой как <code class=syntax>std :: vector</code>. Для колонок типа <code class=syntax>String</code> и <code class=syntax>Array</code> это два вектора: один для всех элементов массивов, располагающихся смежно, второй для хранения смещения до начала каждого массива. Также существует реализация <code class=syntax>ColumnConst</code>, в которой хранится только одно значение в памяти, но выглядит как колонка.</p> <h2 id=field>Поля<a class=headerlink href=../amp/#field title="Permanent link"> </a></h2> <p>Тем не менее, можно работать и с индивидуальными значениями. Для представления индивидуальных значений используется <code class=syntax>Поле</code> (<code class=syntax>Field</code>). <code class=syntax>Field</code> - размеченное объединение <code class=syntax>UInt64</code>, <code class=syntax>Int64</code>, <code class=syntax>Float64</code>, <code class=syntax>String</code> и <code class=syntax>Array</code>. <code class=syntax>IColumn</code> имеет метод <code class=syntax>оператор []</code> для получения значения по индексу n как <code class=syntax>Field</code>, а также метод insert для добавления <code class=syntax>Field</code> в конец колонки. Эти методы не очень эффективны, так как требуют временных объектов <code class=syntax>Field</code>, представляющих индивидуальное значение. Есть более эффективные методы, такие как <code class=syntax>insertFrom</code>, <code class=syntax>insertRangeFrom</code> и т.д.</p> <p><code class=syntax>Field</code> не несет в себе достаточно информации о конкретном типе данных в таблице. Например, <code class=syntax>UInt8</code>, <code class=syntax>UInt16</code>, <code class=syntax>UInt32</code> и <code class=syntax>UInt64</code> в <code class=syntax>Field</code> представлены как <code class=syntax>UInt64</code>.</p> <h2 id=leaky-abstractions>Дырявые абстракции (Leaky Abstractions)<a class=headerlink href=../amp/#leaky-abstractions title="Permanent link"> </a></h2> <p><code class=syntax>IColumn</code> предоставляет методы для общих реляционных преобразований данных, но они не отвечают всем потребностям. Например, <code class=syntax>ColumnUInt64</code> не имеет метода для вычисления суммы двух столбцов, а <code class=syntax>ColumnString</code> не имеет метода для запуска поиска по подстроке. Эти бесчисленные процедуры реализованы вне <code class=syntax>IColumn</code>.</p> <p>Различные функции на колонках могут быть реализованы обобщенным, неэффективным путем, используя <code class=syntax>IColumn</code> методы для извлечения значений <code class=syntax>Field</code>, или специальным путем, используя знания о внутреннем распределение данных в памяти в конкретной реализации <code class=syntax>IColumn</code>. Для этого функции приводятся к конкретному типу <code class=syntax>IColumn</code> и работают напрямую с его внутренним представлением. Например, в <code class=syntax>ColumnUInt64</code> есть метод <code class=syntax>getData</code>, который возвращает ссылку на внутренний массив, чтение и заполнение которого, выполняется отдельной процедурой напрямую. Фактически, мы имеем "дырявые абстракции", обеспечивающие эффективные специализации различных процедур.</p> <h2 id=data_types>Типы данных (Data Types)<a class=headerlink href=../amp/#data_types title="Permanent link"> </a></h2> <p><code class=syntax>IDataType</code> отвечает за сериализацию и десериализацию - чтение и запись фрагментов колонок или индивидуальных значений в бинарном или текстовом формате.<br> <code class=syntax>IDataType</code> точно соответствует типам данных в таблицах - <code class=syntax>DataTypeUInt32</code>, <code class=syntax>DataTypeDateTime</code>, <code class=syntax>DataTypeString</code> и т. д.</p> <p><code class=syntax>IDataType</code> и <code class=syntax>IColumn</code> слабо связаны друг с другом. Различные типы данных могут быть представлены в памяти с помощью одной реализации <code class=syntax>IColumn</code>. Например, и <code class=syntax>DataTypeUInt32</code>, и <code class=syntax>DataTypeDateTime</code> в памяти представлены как <code class=syntax>ColumnUInt32</code> или <code class=syntax>ColumnConstUInt32</code>. В добавок к этому, один тип данных может быть представлен различными реализациями <code class=syntax>IColumn</code>. Например, <code class=syntax>DataTypeUInt8</code> может быть представлен как <code class=syntax>ColumnUInt8</code> и <code class=syntax>ColumnConstUInt8</code>.</p> <p><code class=syntax>IDataType</code> хранит только метаданные. Например, <code class=syntax>DataTypeUInt8</code> не хранить ничего (кроме скрытого указателя <code class=syntax>vptr</code>), а <code class=syntax>DataTypeFixedString</code> хранит только <code class=syntax>N</code> (фиксированный размер строки).</p> <p>В <code class=syntax>IDataType</code> есть вспомогательные методы для данных различного формата. Среди них методы сериализации значений, допускающих использование кавычек, сериализации значения в JSON или XML. Среди них нет прямого соответствия форматам данных. Например, различные форматы <code class=syntax>Pretty</code> и <code class=syntax>TabSeparated</code> могут использовать один вспомогательный метод <code class=syntax>serializeTextEscaped</code> интерфейса <code class=syntax>IDataType</code>.</p> <h2 id=block>Блоки (Block)<a class=headerlink href=../amp/#block title="Permanent link"> </a></h2> <p><code class=syntax>Block</code> это контейнер, который представляет фрагмент (chunk) таблицы в памяти. Это набор троек - <code class=syntax>(IColumn, IDataType, имя колонки)</code>. В процессе выполнения запроса, данные обрабатываются <code class=syntax>Block</code>-ами. Если у нас есть <code class=syntax>Block</code>, значит у нас есть данные (в объекте <code class=syntax>IColumn</code>), информация о типе (в <code class=syntax>IDataType</code>), которая говорит нам, как работать с колонкой, и имя колонки (оригинальное имя колонки таблицы или служебное имя, присвоенное для получения промежуточных результатов вычислений).</p> <p>При вычислении некоторой функции на колонках в блоке мы добавляем еще одну колонку с результатами в блок, не трогая колонки аргументов функции, потому что операции иммутабельные. Позже ненужные колонки могут быть удалены из блока, но не модифицированы. Это удобно для устранения общих подвыражений.</p> <p>Блоки создаются для всех обработанных фрагментов данных. Напоминаем, что одни и те же типы вычислений, имена колонок и типы переиспользуются в разных блоках и только данные колонок изменяются. Лучше разделить данные и заголовок блока потому, что в блоках маленького размера мы имеем большой оверхэд по временным строкам при копировании умных указателей (<code class=syntax>shared_ptrs</code>) и имен колонок.</p> <h2 id=block-streams>Потоки блоков (Block Streams)<a class=headerlink href=../amp/#block-streams title="Permanent link"> </a></h2> <p>Потоки блоков обрабатывают данные. Мы используем потоки блоков для чтения данных, трансформации или записи данных куда-либо. <code class=syntax>IBlockInputStream</code> предоставляет метод <code class=syntax>read</code> для получения следующего блока, пока это возможно, и метод <code class=syntax>write</code>, чтобы продвигать (push) блок куда-либо.</p> <p>Потоки отвечают за:</p> <ol> <li>Чтение и запись в таблицу. Таблица лишь возвращает поток для чтения или записи блоков.</li> <li>Реализацию форматов данных. Например, при выводе данных в терминал в формате <code class=syntax>Pretty</code>, вы создаете выходной поток блоков, который форматирует поступающие в него блоки.</li> <li>Трансформацию данных. Допустим, у вас есть <code class=syntax>IBlockInputStream</code> и вы хотите создать отфильтрованный поток. Вы создаете <code class=syntax>FilterBlockInputStream</code> и инициализируете его вашим потоком. Затем вы тянете (pull) блоки из <code class=syntax>FilterBlockInputStream</code>, а он тянет блоки исходного потока, фильтрует их и возвращает отфильтрованные блоки вам. Таким образом построены конвейеры выполнения запросов.</li> </ol> <p>Имеются и более сложные трансформации. Например, когда вы тянете блоки из <code class=syntax>AggregatingBlockInputStream</code>, он считывает все данные из своего источника, агрегирует их, и возвращает поток агрегированных данных вам. Другой пример: конструктор <code class=syntax>UnionBlockInputStream</code> принимает множество источников входных данных и число потоков. Такой <code class=syntax>Stream</code> работает в несколько потоков и читает данные источников параллельно.</p> <blockquote> <p>Потоки блоков используют «втягивающий» (pull) подход к управлению потоком выполнения: когда вы вытягиваете блок из первого потока, он, следовательно, вытягивает необходимые блоки из вложенных потоков, так и работает весь конвейер выполнения. Ни «pull» ни «push» не имеют явного преимущества, потому что поток управления неявный, и это ограничивает в реализации различных функций, таких как одновременное выполнение нескольких запросов (слияние нескольких конвейеров вместе). Это ограничение можно преодолеть с помощью сопрограмм (coroutines) или просто запуском дополнительных потоков, которые ждут друг друга. У нас может быть больше возможностей, если мы сделаем поток управления явным: если мы локализуем логику для передачи данных из одной расчетной единицы в другую вне этих расчетных единиц. Читайте эту <a href=http://journal.stuffwithstuff.com/2013/01/13/iteration-inside-and-out/ rel="external nofollow noreferrer" target=_blank>статью</a> для углубленного изучения.</p> </blockquote> <p>Следует отметить, что конвейер выполнения запроса создает временные данные на каждом шаге. Мы стараемся сохранить размер блока достаточно маленьким, чтобы временные данные помещались в кэш процессора. При таком допущении запись и чтение временных данных практически бесплатны по сравнению с другими расчетами. Мы могли бы рассмотреть альтернативу, которая заключается в том, чтобы объединить многие операции в конвеере вместе. Это может сделать конвейер как можно короче и удалить большую часть временных данных, что может быть преимуществом, но у такого подхода также есть недостатки. Например, разделенный конвейер позволяет легко реализовать кэширование промежуточных данных, использование промежуточных данных из аналогичных запросов, выполняемых одновременно, и объединение конвейеров для аналогичных запросов.</p> <h2 id=formats>Форматы<a class=headerlink href=../amp/#formats title="Permanent link"> </a></h2> <p>Форматы данных реализуются с помощью потоков блоков. Есть форматы представления (presentational), пригодные только для вывода данных клиенту, такие как <code class=syntax>Pretty</code> формат, который предоставляет только <code class=syntax>IBlockOutputStream</code>. И есть форматы ввода/вывода, такие как <code class=syntax>TabSeparated</code> или <code class=syntax>JSONEachRow</code>.</p> <p>Существуют также потоки строк: <code class=syntax>IRowInputStream</code> и <code class=syntax>IRowOutputStream</code>. Они позволяют вытягивать/выталкивать данные отдельными строками, а не блоками. Они нужны только для упрощения реализации ориентированных на строки форматов. Обертка <code class=syntax>BlockInputStreamFromRowInputStream</code> и <code class=syntax>BlockOutputStreamFromRowOutputStream</code> позволяет конвертировать потоки, ориентированные на строки, в обычные потоки, ориентированные на блоки.</p> <h2 id=io>I/O<a class=headerlink href=../amp/#io title="Permanent link"> </a></h2> <p>Для байт-ориентированных ввода/вывода существуют абстрактные классы <code class=syntax>ReadBuffer</code> и <code class=syntax>WriteBuffer</code>. Они используются вместо C++ <code class=syntax>iostream</code>. Не волнуйтесь: каждый зрелый проект C++ использует что-то другое вместо <code class=syntax>iostream</code> по уважительным причинам.</p> <p><code class=syntax>ReadBuffer</code> и <code class=syntax>WriteBuffer</code> это просто непрерывный буфер и курсор, указывающий на позицию в этом буфере. Реализации могут как владеть так и не владеть памятью буфера. Существует виртуальный метод заполнения буфера следующими данными (для <code class=syntax>ReadBuffer</code>) или сброса буфера куда-нибудь (например <code class=syntax>WriteBuffer</code>). Виртуальные методы редко вызываются.</p> <p>Реализации <code class=syntax>ReadBuffer</code>/<code class=syntax>WriteBuffer</code> используются для работы с файлами и файловыми дескрипторами, а также сетевыми сокетами, для реализации сжатия (<code class=syntax>CompressedWriteBuffer</code> инициализируется вместе с другим <code class=syntax>WriteBuffer</code> и осуществляет сжатие данных перед записью в него), и для других целей – названия <code class=syntax>ConcatReadBuffer</code>, <code class=syntax>LimitReadBuffer</code>, и <code class=syntax>HashingWriteBuffer</code> говорят сами за себя.</p> <p>Буферы чтения/записи имеют дело только с байтами. В заголовочных файлах <code class=syntax>ReadHelpers</code> и <code class=syntax>WriteHelpers</code> объявлены некоторые функции, чтобы помочь с форматированием ввода/вывода. Например, есть помощники для записи числа в десятичном формате.</p> <p>Давайте посмотрим, что происходит, когда вы хотите вывести результат в <code class=syntax>JSON</code> формате в стандартный вывод (stdout). У вас есть результирующий набор данных, готовый к извлечению из <code class=syntax>IBlockInputStream</code>. Вы создаете <code class=syntax>WriteBufferFromFileDescriptor(STDOUT_FILENO)</code> чтобы записать байты в stdout. Вы создаете <code class=syntax>JSONRowOutputStream</code>, инициализируете с этим <code class=syntax>WriteBuffer</code>'ом, чтобы записать строки <code class=syntax>JSON</code> в stdout. Кроме того вы создаете <code class=syntax>BlockOutputStreamFromRowOutputStream</code>, реализуя <code class=syntax>IBlockOutputStream</code>. Затем вызывается <code class=syntax>copyData</code> для передачи данных из <code class=syntax>IBlockInputStream</code> в <code class=syntax>IBlockOutputStream</code> и все работает. Внутренний <code class=syntax>JSONRowOutputStream</code> будет писать в формате <code class=syntax>JSON</code> различные разделители и вызвать <code class=syntax>IDataType::serializeTextJSON</code> метод со ссылкой на <code class=syntax>IColumn</code> и номер строки в качестве аргументов. Следовательно, <code class=syntax>IDataType::serializeTextJSON</code> вызовет метод из <code class=syntax>WriteHelpers.h</code>: например, <code class=syntax>writeText</code> для числовых типов и <code class=syntax>writeJSONString</code> для <code class=syntax>DataTypeString</code>.</p> <h2 id=tables>Таблицы<a class=headerlink href=../amp/#tables title="Permanent link"> </a></h2> <p>Интерфейс <code class=syntax>IStorage</code> служит для отображения таблицы. Различные движки таблиц являются реализациями этого интерфейса. Примеры <code class=syntax>StorageMergeTree</code>, <code class=syntax>StorageMemory</code> и так далее. Экземпляры этих классов являются просто таблицами.</p> <p>Ключевые методы <code class=syntax>IStorage</code> это <code class=syntax>read</code> и <code class=syntax>write</code>. Есть и другие варианты - <code class=syntax>alter</code>, <code class=syntax>rename</code>, <code class=syntax>drop</code> и так далее. Метод <code class=syntax>read</code> принимает следующие аргументы: набор столбцов для чтения из таблицы, <code class=syntax>AST</code> запрос и желаемое количество потоков для вывода. Он возвращает один или несколько объектов <code class=syntax>IBlockInputStream</code> и информацию о стадии обработки данных, которая была завершена внутри табличного движка во время выполнения запроса.</p> <p>В большинстве случаев метод read отвечает только за чтение указанных столбцов из таблицы, а не за дальнейшую обработку данных. Вся дальнейшая обработка данных осуществляется интерпретатором запросов и не входит в сферу ответственности <code class=syntax>IStorage</code>.</p> <p>Но есть и заметные исключения:</p> <ul> <li>AST запрос, передающийся в метод <code class=syntax>read</code>, может использоваться движком таблицы для получения информации о возможности использования индекса и считывания меньшего количества данных из таблицы.</li> <li>Иногда движок таблиц может сам обрабатывать данные до определенного этапа. Например, <code class=syntax>StorageDistributed</code> можно отправить запрос на удаленные серверы, попросить их обработать данные до этапа, когда данные с разных удаленных серверов могут быть объединены, и вернуть эти предварительно обработанные данные. Затем интерпретатор запросов завершает обработку данных.</li> </ul> <p>Метод <code class=syntax>read</code> может возвращать несколько объектов <code class=syntax>IBlockInputStream</code>, позволяя осуществлять параллельную обработку данных. Эти несколько блочных входных потоков могут считываться из таблицы параллельно. Затем вы можете обернуть эти потоки различными преобразованиями (такими как вычисление выражений или фильтрация), которые могут быть вычислены независимо, и создать <code class=syntax>UnionBlockInputStream</code> поверх них, чтобы читать из нескольких потоков параллельно.</p> <p>Есть и другие варианты. Например, <code class=syntax>TableFunction</code> возвращает временный объект <code class=syntax>IStorage</code>, который можно подставить во <code class=syntax>FROM</code>.</p> <p>Чтобы получить быстрое представление о том, как реализовать свой движок таблиц, посмотрите на что-то простое, например <code class=syntax>StorageMemory</code> или <code class=syntax>StorageTinyLog</code>.</p> <blockquote> <p>В качестве результата выполнения метода <code class=syntax>read</code>, <code class=syntax>IStorage</code> возвращает <code class=syntax>QueryProcessingStage</code> – информацию о том, какие части запроса были обработаны внутри хранилища.</p> </blockquote> <h2 id=parsers>Парсеры (Parsers)<a class=headerlink href=../amp/#parsers title="Permanent link"> </a></h2> <p>Написанный от руки парсер, анализирующий запрос, работает по методу рекурсивного спуска. Например, <code class=syntax>ParserSelectQuery</code> просто рекурсивно вызывает нижестоящие парсеры для различных частей запроса. Парсеры создают абстрактное синтаксическое дерево (<code class=syntax>AST</code>). <code class=syntax>AST</code> представлен узлами, которые являются экземплярами <code class=syntax>IAST</code>.</p> <blockquote> <p>Генераторы парсеров не используются по историческим причинам.</p> </blockquote> <h2 id=interpreters>Интерпретаторы<a class=headerlink href=../amp/#interpreters title="Permanent link"> </a></h2> <p>Интерпретаторы отвечают за создание конвейера выполнения запроса из <code class=syntax>AST</code>. Есть простые интерпретаторы, такие как <code class=syntax>InterpreterExistsQuery</code> и <code class=syntax>InterpreterDropQuery</code> или более сложный <code class=syntax>InterpreterSelectQuery</code>. Конвейер выполнения запроса представляет собой комбинацию входных и выходных потоков блоков. Например, результатом интерпретации <code class=syntax>SELECT</code> запроса является <code class=syntax>IBlockInputStream</code> для чтения результирующего набора данных; результат интерпретации <code class=syntax>INSERT</code> запроса - это <code class=syntax>IBlockOutputStream</code>, для записи данных, предназначенных для вставки; результат интерпретации <code class=syntax>INSERT SELECT</code> запроса - это <code class=syntax>IBlockInputStream</code>, который возвращает пустой результирующий набор при первом чтении, но копирует данные из <code class=syntax>SELECT</code> к <code class=syntax>INSERT</code>.</p> <p><code class=syntax>InterpreterSelectQuery</code> использует <code class=syntax>ExpressionAnalyzer</code> и <code class=syntax>ExpressionActions</code> механизмы для анализа запросов и преобразований. Именно здесь выполняется большинство оптимизаций запросов на основе правил. <code class=syntax>ExpressionAnalyzer</code> написан довольно грязно и должен быть переписан: различные преобразования запросов и оптимизации должны быть извлечены в отдельные классы, чтобы позволить модульные преобразования или запросы.</p> <h2 id=functions>Функции<a class=headerlink href=../amp/#functions title="Permanent link"> </a></h2> <p>Существуют обычные функции и агрегатные функции. Агрегатные функции смотрите в следующем разделе.</p> <p>Обычный функции не изменяют число строк и работают так, как если бы обрабатывали каждую строку независимо. В действительности же, функции вызываются не к отдельным строкам, а блокам данных для реализации векторизованного выполнения запросов.</p> <p>Некоторые функции, такие как <a href=../../../sql-reference/functions/other-functions/amp/#function-blocksize>blockSize</a>, <a href=../../../sql-reference/functions/other-functions/amp/#function-rownumberinblock>rowNumberInBlock</a>, и <a href=../../../sql-reference/functions/other-functions/amp/#runningaccumulate>runningAccumulate</a>, эксплуатируют блочную обработку и нарушают независимость строк.</p> <p>ClickHouse имеет сильную типизацию, поэтому нет никакого неявного преобразования типов. Если функция не поддерживает определенную комбинацию типов, она создает исключение. Но функции могут работать (перегружаться) для многих различных комбинаций типов. Например, функция <code class=syntax>plus</code> (для реализации <code class=syntax>+</code> оператор) работает для любой комбинации числовых типов: <code class=syntax>UInt8</code> + <code class=syntax>Float32</code>, <code class=syntax>UInt16</code> + <code class=syntax>Int8</code> и так далее. Кроме того, некоторые вариадические функции, такие как <code class=syntax>concat</code>, могут принимать любое количество аргументов.</p> <p>Реализация функции может быть немного неудобной, поскольку функция явно определяет поддерживаемые типы данных и поддерживается <code class=syntax>IColumns</code>. Например, в <code class=syntax>plus</code> функция имеет код, генерируемый экземпляром шаблона C++ для каждой комбинации числовых типов, а также постоянные или непостоянные левые и правые аргументы.</p> <p>Это отличное место для реализации генерации кода во время выполнения, чтобы избежать раздувания кода шаблона. Кроме того, он позволяет добавлять слитые функции, такие как fused multiply-add или выполнять несколько сравнений в одной итерации цикла.</p> <p>Из-за векторизованного выполнения запроса функции не закорачиваются. Например, если вы пишете <code class=syntax>WHERE f(x) AND g(y)</code>, обе части вычисляются, даже для строк, когда <code class=syntax>f(x)</code> равно нулю (за исключением тех случаев, когда <code class=syntax>f(x)</code> является нулевым постоянным выражением). Но если избирательность условия <code class=syntax>f(x)</code> высока, и расчет <code class=syntax>f(x)</code> обходится гораздо дешевле, чем <code class=syntax>g(y)</code>, лучше всего разделить вычисление на этапы. На первом этапе вычислить <code class=syntax>f(x)</code>, отфильтровать результирующие столбцы, а затем вычислять <code class=syntax>g(y)</code> только для меньших, отфильтрованных фрагментов данных.</p> <h2 id=aggregate-functions>Агрегатные функции<a class=headerlink href=../amp/#aggregate-functions title="Permanent link"> </a></h2> <p>Агрегатные функции - это функции с состоянием (stateful). Они накапливают переданные значения в некотором состоянии и позволяют получать результаты из этого состояния. Работа с ними осуществляется с помощью интерфейса <code class=syntax>IAggregateFunction</code>. Состояния могут быть как простыми (состояние для <code class=syntax>AggregateFunctionCount</code> это всего лишь одна переменная типа <code class=syntax>UInt64</code>) так и довольно сложными (состояние <code class=syntax>AggregateFunctionUniqCombined</code> представляет собой комбинацию линейного массива, хэш-таблицы и вероятностной структуры данных <code class=syntax>HyperLogLog</code>).</p> <p>Состояния распределяются в <code class=syntax>Arena</code> (пул памяти) для работы с несколькими состояниями при выполнении запроса <code class=syntax>GROUP BY</code> высокой кардинальности (большим числом уникальных данных). Состояния могут иметь нетривиальный конструктор и деструктор: например, сложные агрегатные состояния могут сами аллоцировать дополнительную память. Потому к созданию и уничтожению состояний, правильной передаче владения и порядку уничтожения следует уделять больше внимание.</p> <p>Агрегатные состояния могут быть сериализованы и десериализованы для передачи их по сети во время выполнения распределенного запроса или для записи их на диск при дефиците оперативной памяти. Они даже могут храниться в таблице с <code class=syntax>DataTypeAggregateFunction</code>, чтобы позволяет выполнять инкрементное агрегирование данных.</p> <blockquote> <p>Формат сериализации данных для состояний агрегатных функций в настоящее время не версионируется. Это нормально, если агрегатные состояния хранятся только временно. Но у нас есть такая возможность <code class=syntax>AggregatingMergeTree</code> механизм таблиц для инкрементной агрегации, и люди уже используют его в эксплуатации. Именно по этой причине требуется помнить об обратная совместимости при изменении формата сериализации для любой агрегатной функции.</p> </blockquote> <h2 id=server>Сервер<a class=headerlink href=../amp/#server title="Permanent link"> </a></h2> <p>Сервер предоставляет несколько различных интерфейсов.</p> <ul> <li>HTTP интерфейс для любых сторонних клиентов.</li> <li>TCP интерфейс для родного ClickHouse клиента и межсерверной взаимодействия при выполнении распределенных запросов.</li> <li>Интерфейс для передачи данных при репликации.</li> </ul> <p>Внутри простой многопоточный сервер без корутин (coroutines), файберов (fibers) и т.д. Поскольку сервер не предназначен для обработки большого количества простых запросов, а ориентирован на обработку сложных запросов относительно низкой интенсивности, каждый из потоков может обрабатывать огромное количество аналитических запросов.</p> <p>Сервер инициализирует класс <code class=syntax>Context</code>, где хранит необходимое для выполнения запроса окружение: список доступных баз данных, пользователей и прав доступа, настройки, кластеры, список процессов, журнал запросов и т.д. Это окружение используется интерпретаторами.</p> <p>Мы поддерживаем полную обратную и прямую совместимость для TCP интерфейса: старые клиенты могут общаться с новыми серверами, а новые клиенты могут общаться со старыми серверами. Но мы не хотим поддерживать его вечно и прекращаем поддержку старых версий примерно через год.</p> <div class="admonition note alert pb-0 mb-4 alert-primary" role=alert> <p class="admonition-title alert-heading display-6 mb-2">Note</p> <p>Для всех сторонних приложений мы рекомендуем использовать HTTP интерфейс, потому что он прост и удобен в использовании. TCP интерфейс тесно связан с внутренними структурами данных: он использует внутренний формат для передачи блоков данных и использует специальное кадрирование для сжатых данных. Мы не выпустили библиотеку C для этого протокола, потому что потребовала бы линковки большей части кодовой базы ClickHouse, что непрактично.</p> </div> <h2 id=distributed-query-execution>Выполнение распределенных запросов (Distributed Query Execution)<a class=headerlink href=../amp/#distributed-query-execution title="Permanent link"> </a></h2> <p>Сервера в кластере в основном независимы. Вы можете создать <code class=syntax>Распределенную</code> (<code class=syntax>Distributed</code>) таблицу на одном или всех серверах в кластере. Такая таблица сама по себе не хранит данные - она только предоставляет возможность "просмотра" всех локальных таблиц на нескольких узлах кластера. При выполнении <code class=syntax>SELECT</code> распределенная таблица переписывает запрос, выбирает удаленные узлы в соответствии с настройками балансировки нагрузки и отправляет им запрос. Распределенная таблица просит удаленные сервера обработать запрос до той стадии, когда промежуточные результаты с разных серверов могут быть объединены. Затем он получает промежуточные результаты и объединяет их. Распределенная таблица пытается возложить как можно больше работы на удаленные серверы и сократить объем промежуточных данных, передаваемых по сети.</p> <p>Ситуация усложняется, при использовании подзапросов в случае <code class=syntax>IN</code> или <code class=syntax>JOIN</code>, когда каждый из них использует таблицу <code class=syntax>Distributed</code>. Есть разные стратегии для выполнения таких запросов.</p> <p>Глобального плана выполнения распределенных запросов не существует. Каждый узел имеет собственный локальный план для своей части работы. У нас есть простое однонаправленное выполнение распределенных запросов: мы отправляем запросы на удаленные узлы и затем объединяем результаты. Но это невозможно для сложных запросов <code class=syntax>GROUP BY</code> высокой кардинальности или запросов с большим числом временных данных в <code class=syntax>JOIN</code>: в таких случаях нам необходимо перераспределить («reshuffle») данные между серверами, что требует дополнительной координации. ClickHouse не поддерживает выполнение запросов такого рода, и нам нужно работать над этим.</p> <h2 id=merge-tree>Merge Tree<a class=headerlink href=../amp/#merge-tree title="Permanent link"> </a></h2> <p><code class=syntax>MergeTree</code> - это семейство движков хранения, поддерживающих индексацию по первичному ключу. Первичный ключ может быть произвольным набором (кортежем) столбцов или выражений. Данные в таблице <code class=syntax>MergeTree</code> хранятся "частями" (“parts”). Каждая часть хранит данные отсортированные по первичному ключу (данные упорядочены лексикографически). Все столбцы таблицы хранятся в отдельных файлах <code class=syntax>column.bin</code> в этих частях. Файлы состоят из сжатых блоков. Каждый блок обычно содержит от 64 КБ до 1 МБ несжатых данных, в зависимости от среднего значения размера данных. Блоки состоят из значений столбцов, расположенных последовательно один за другим. Значения столбцов находятся в одинаковом порядке для каждого столбца (порядок определяется первичным ключом), поэтому, когда вы выполняете итерацию по многим столбцам, вы получаете значения для соответствующих строк.</p> <p>Сам первичный ключ является "разреженным" ("sparse"). Он не относится к каждой отдельной строке, а только к некоторым диапазонам данных. Отдельный файл «primary.idx» имеет значение первичного ключа для каждой N-й строки, где N называется гранулярностью индекса ("index_granularity", обычно N = 8192). Также для каждого столбца у нас есть файлы <code class=syntax>column.mrk</code> с "метками" ("marks"), которые обозначают смещение для каждой N-й строки в файле данных. Каждая метка представляет собой пару: смещение начала сжатого блока от начала файла и смещение к началу данных в распакованном блоке. Обычно сжатые блоки выравниваются по меткам, а смещение в распакованном блоке равно нулю. Данные для <code class=syntax>primary.idx</code> всегда находятся в памяти, а данные для файлов <code class=syntax>column.mrk</code> кэшируются.</p> <p>Когда мы собираемся читать что-то из части данных <code class=syntax>MergeTree</code>, мы смотрим содержимое <code class=syntax>primary.idx</code> и определяем диапазоны, которые могут содержать запрошенные данные, затем просматриваем содержимое <code class=syntax>column.mrk</code> и вычисляем смещение, чтобы начать чтение этих диапазонов. Из-за разреженности могут быть прочитаны лишние данные. ClickHouse не подходит для простых точечных запросов высокой интенсивности, потому что весь диапазон строк размером <code class=syntax>index_granularity</code> должен быть прочитан для каждого ключа, а сжатый блок должен быть полностью распакован для каждого столбца. Мы сделали индекс разреженным, потому что мы должны иметь возможность поддерживать триллионы строк на один сервер без существенных расходов памяти на индексацию. Кроме того, поскольку первичный ключ является разреженным, он не уникален: он не может проверить наличие ключа в таблице во время INSERT. Вы можете иметь множество строк с одним и тем же ключом в таблице.</p> <p>При выполнении <code class=syntax>INSERT</code> для группы данных в <code class=syntax>MergeTree</code>, элементы группы сортируются по первичному ключу и образует новую “часть”. Фоновые потоки периодически выбирают некоторые части и объединяют их в одну отсортированную часть, чтобы сохранить относительно небольшое количество частей. Вот почему он называется <code class=syntax>MergeTree</code>. Конечно, объединение приводит к повышению интенсивности записи. Все части иммутабельные: они только создаются и удаляются, но не изменяются. Когда выполняется <code class=syntax>SELECT</code>, он содержит снимок таблицы (набор частей). После объединения старые части также сохраняются в течение некоторого времени, чтобы упростить восстановление после сбоя, поэтому, если мы видим, что какая-то объединенная часть, вероятно, повреждена, мы можем заменить ее исходными частями.</p> <p><code class=syntax>MergeTree</code> не является деревом LSM (Log-structured merge-tree — журнально-структурированное дерево со слиянием), потому что оно не содержит «memtable» и «log»: вставленные данные записываются непосредственно в файловую систему. Это делает его пригодным только для вставки данных в пакетах, а не по отдельным строкам и не очень часто - примерно раз в секунду это нормально, а тысячу раз в секунду - нет. Мы сделали это для простоты и потому, что мы уже вставляем данные в пакеты в наших приложениях.</p> <blockquote> <p>Таблицы <code class=syntax>MergeTree</code> могут иметь только один (первичный) индекс: вторичных индексов нет. Было бы неплохо разрешить несколько физических представлениям в одной логической таблице, например, хранить данные в более чем одном физическом порядке или даже разрешить представления с предварительно агрегированными данными вместе с исходными данными.</p> </blockquote> <p>Существуют движки <code class=syntax>MergeTree</code>, которые выполняют дополнительную работу во время фоновых слияний. Примерами являются <code class=syntax>CollapsingMergeTree</code> и <code class=syntax>AggregatingMergeTree</code>. Это можно рассматривать как специальную поддержку обновления. Помните, что это не настоящие обновления, поскольку пользователи обычно не контролируют время выполнения фоновых слияний, а данные в таблице <code class=syntax>MergeTree</code> почти всегда хранятся в нескольких частях, а не в полностью объединенной форме.</p> <h2 id=replication>Репликация<a class=headerlink href=../amp/#replication title="Permanent link"> </a></h2> <p>Репликация в ClickHouse может быть настроена для каждой таблицы отдельно. Вы можете иметь несколько реплицированных и несколько не реплицированных таблиц на одном сервере. Вы также можете реплицировать таблицы по-разному, например, одну с двухфакторной репликацией и другую с трехфакторной.</p> <p>Репликация реализована в движке таблицы <code class=syntax>ReplicatedMergeTree</code>. Путь в <code class=syntax>ZooKeeper</code> указывается в качестве параметра движка. Все таблицы с одинаковым путем в <code class=syntax>ZooKeeper</code> становятся репликами друг друга: они синхронизируют свои данные и поддерживают согласованность. Реплики можно добавлять и удалять динамически, просто создавая или удаляя таблицу.</p> <p>Репликация использует асинхронную multi-master схему. Вы можете вставить данные в любую реплику, которая имеет открытую сессию в <code class=syntax>ZooKeeper</code>, и данные реплицируются на все другие реплики асинхронно. Поскольку ClickHouse не поддерживает UPDATE, репликация исключает конфликты (conflict-free replication). Поскольку подтверждение вставок кворумом не реализовано, только что вставленные данные могут быть потеряны в случае сбоя одного узла.</p> <p>Метаданные для репликации хранятся в <code class=syntax>ZooKeeper</code>. Существует журнал репликации, в котором перечислены действия, которые необходимо выполнить. Среди этих действий: получить часть (get the part); объединить части (merge parts); удалить партицию (drop a partition) и так далее. Каждая реплика копирует журнал репликации в свою очередь, а затем выполняет действия из очереди. Например, при вставке в журнале создается действие «получить часть» (get the part), и каждая реплика загружает эту часть. Слияния координируются между репликами, чтобы получить идентичные до байта результаты. Все части объединяются одинаково на всех репликах. Одна из реплик-лидеров инициирует новое слияние кусков первой и записывает действия «слияния частей» в журнал. Несколько реплик (или все) могут быть лидерами одновременно. Реплике можно запретить быть лидером с помощью <code class=syntax>merge_tree</code> настройки <code class=syntax>replicated_can_become_leader</code>.</p> <p>Репликация является физической: между узлами передаются только сжатые части, а не запросы. Слияния обрабатываются на каждой реплике независимо, в большинстве случаев, чтобы снизить затраты на сеть, во избежание усиления роли сети. Крупные объединенные части отправляются по сети только в случае значительной задержки репликации.</p> <p>Кроме того, каждая реплика сохраняет свое состояние в <code class=syntax>ZooKeeper</code> в виде набора частей и его контрольных сумм. Когда состояние в локальной файловой системе расходится с эталонным состоянием в <code class=syntax>ZooKeeper</code>, реплика восстанавливает свою согласованность путем загрузки отсутствующих и поврежденных частей из других реплик. Когда в локальной файловой системе есть неожиданные или испорченные данные, ClickHouse не удаляет их, а перемещает в отдельный каталог и забывает об этом.</p> <div class="admonition note alert pb-0 mb-4 alert-primary" role=alert> <p class="admonition-title alert-heading display-6 mb-2">Note</p> <p>Кластер ClickHouse состоит из независимых шардов, а каждый шард состоит из реплик. Кластер <strong>не является эластичным</strong> (not elastic), поэтому после добавления нового шарда данные не будут автоматически распределены между ними. Вместо этого нужно изменить настройки, чтобы выровнять нагрузку на кластер. Эта реализация дает вам больший контроль, и вполне приемлема для относительно небольших кластеров, таких как десятки узлов. Но для кластеров с сотнями узлов, которые мы используем в эксплуатации, такой подход становится существенным недостатком. Движки таблиц, которые охватывают весь кластер с динамически реплицируемыми областями, которые могут быть автоматически разделены и сбалансированы между кластерами, еще предстоит реализовать.</p> </div> </div> </div> <div class=row> <div class=col> <div class="alert alert-light my-3"> <p class="float-right mb-0">Rating: RATING_VALUE - RATING_COUNT votes</p> <span class="alert-heading display-6">Article Rating</span> <div id=rating-stars class="display-6 mb-0">RATING_STARS</div> </div> <div id=content-footer class="text-muted pt-3 mb-5"> <div class=float-md-right>©2016–2021 Yandex LLC</div> <div>Built from <a href=https://github.com/ClickHouse/ClickHouse/commit/878a159538935028f2d2dce3eb3074d44eb191df rel="external nofollow noreferrer" target=_blank class=text-reset>878a159538</a> </div> </div> </div> </div> <div id=to-full-website class="row fixed-bottom text-center bg-white py-3"> <div class=col> <a href=https://clickhouse.tech/docs/ru/development/architecture/ class="btn btn-lg btn-outline-orange">To full website</a> </div> </div> </div> <amp-analytics type=metrika> <script type=application/json>{
"vars": {
  "counterId": "18343495",
  "triggers": {
    "notBounce": {
      "on": "timer",
      "timerSpec": {
        "immediate": false,
        "interval": 15,
        "maxTimerLength": 16
      },
      "request": "notBounce"
    }
  }
}
}</script> </amp-analytics> </body> </html> 