<!DOCTYPE html><html lang=zh data-version=master data-single-page=false> <head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>MergeTree | ClickHouse文档</title><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/images/logo-180x180.png><meta property=og:title content="MergeTree | ClickHouse文档"><meta property=og:description content="MergeTree Clickhouse 中最强大的表引擎当属 MergeTree （合并树）引擎及该系列（*MergeTree）中的其他引擎。 MergeTree 系列的引擎被设计用于插入极大量的数据到一张表当中。数据可以以数据片段的形式"><meta property=og:type content=article><meta property=og:image content=https://clickhouse.tech/images/logo.png><meta content=https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/mergetree/ property=og:url><link href=https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/mergetree/ rel=canonical><link href=https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/mergetree/amp/ rel=amphtml><link rel=search href=/opensearch.xml title=ClickHouse type=application/opensearchdescription+xml><meta name=description content="MergeTree Clickhouse 中最强大的表引擎当属 MergeTree （合并树）引擎及该系列（*MergeTree）中的其他引擎。 MergeTree 系列的引擎被设计用于插入极大量的数据到一张表当中。数据可以以数据片段的形式"><meta name=keywords content="ClickHouse, DBMS, OLAP, SQL, open-source, relational, analytics, analytical, Big Data, web-analytics"><link rel=alternate href=https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/mergetree/ hreflang=en><link rel=alternate href=https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/mergetree/ hreflang=zh><link rel=alternate href=https://clickhouse.tech/docs/es/engines/table-engines/mergetree-family/mergetree/ hreflang=es><link rel=alternate href=https://clickhouse.tech/docs/fr/engines/table-engines/mergetree-family/mergetree/ hreflang=fr><link rel=alternate href=https://clickhouse.tech/docs/ru/engines/table-engines/mergetree-family/mergetree/ hreflang=ru><link rel=alternate href=https://clickhouse.tech/docs/ja/engines/table-engines/mergetree-family/mergetree/ hreflang=ja><link rel=alternate href=https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/mergetree/ hreflang=x-default><link href=/css/base.css?e27f3458 media=all rel=stylesheet></head> <body dir=ltr data-spy=scroll data-target=#toc data-offset=80> <nav id=top-nav class="navbar navbar-dark navbar-expand-md bg-dark-alt text-white sticky-top"> <div class="container-fluid justify-content-between"> <a href=/ class="d-block navbar-brand mr-3"> <img id=docs-logo-icon src=/images/logo.svg alt="ClickHouse logo" title="ClickHouse logo"> </a> <div class="w-100 navbar-text text-left d-none d-md-block"> <h1 class="h3 m-0 p-0 d-inline"> <a href=# class="text-white text-decoration-none"> MergeTree </a> </h1> </div> <div class="d-none d-md-block"> <ul class="navbar-nav ml-auto mt-2 mt-lg-0 justify-content-end"> <li id=edit-wrapper class=nav-item> <a id=edit-link href=https://github.com/ClickHouse/ClickHouse/edit/master/docs/zh/engines/table-engines/mergetree-family/mergetree.md title="Edit this article" class=nav-link rel="external nofollow noreferrer" target=_blank><img src=/images/mkdocs/edit.svg alt="Edit this article" class=mt-1 height=22></a> </li> <li class=nav-item> <a class=nav-link href=https://github.com/ClickHouse/ClickHouse rel="external nofollow noreferrer"> <img src=/images/index/github.svg alt="GitHub repository" title="Go to GitHub" height=32> </a> </li> <li id=languages-wrapper class="nav-item dropdown"> <div id=languages-dropdown> <a class="nav-link dropdown-toggle d-inline-block mt-1 text-muted" href=# id=lang-dropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false> <img src=/images/flags/zh.svg alt=中文 title=中文 width=32 class="d-inline-block mt-n1"> </a> <div class="dropdown-menu bg-dark" aria-labelledby=lang-dropdown> <a href=/docs/en/engines/table-engines/mergetree-family/mergetree/ class=dropdown-item> <img src=/images/flags/en.svg alt title width=32 class="d-inline-block mr-2">English </a> <a href=/docs/zh/engines/table-engines/mergetree-family/mergetree/ class="dropdown-item disabled"> <img src=/images/flags/zh.svg alt title width=32 class="d-inline-block mr-2">中文 </a> <a href=/docs/es/engines/table-engines/mergetree-family/mergetree/ class=dropdown-item> <img src=/images/flags/es.svg alt title width=32 class="d-inline-block mr-2">Español </a> <a href=/docs/fr/engines/table-engines/mergetree-family/mergetree/ class=dropdown-item> <img src=/images/flags/fr.svg alt title width=32 class="d-inline-block mr-2">Français </a> <a href=/docs/ru/engines/table-engines/mergetree-family/mergetree/ class=dropdown-item> <img src=/images/flags/ru.svg alt title width=32 class="d-inline-block mr-2">Русский </a> <a href=/docs/ja/engines/table-engines/mergetree-family/mergetree/ class=dropdown-item> <img src=/images/flags/ja.svg alt title width=32 class="d-inline-block mr-2">日本語 </a> </div> </div> </li> </ul> </div> <form id=search-form class="form-inline m-0"> <div class=input-group> <div class="input-group-prepend w-100"> <span class="input-group-text bg-secondary-alt text-muted border-0 mr-n1" id=search-icon> <img src=/images/mkdocs/search.svg> </span> <input id=docsearch-input class="form-control bg-secondary-alt text-muted border-0 pl-1" type=search placeholder=Search aria-label=Search> </div> </div> </form> <button id=navbar-toggler class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#sidebar aria-controls=sidebar aria-expanded=false aria-label="Toggle navigation"> <span class=navbar-toggler-icon></span> </button> </div> </nav> <div class=container-fluid> <div class="row justify-content-end justify-content-xl-center"> <div id=sidebar class="col-xl-2 col-md-4 bg-secondary-alt p-3 d-print-none min-vh-100 overflow-auto"> <div class=overflow-auto> <div id=single-page-switch class="btn-group mb-2 float-right" role=group aria-label="Multi-page or single-page"> <a href=../../../.. role=button class="btn btn-dark active" aria-pressed=true> <img src=/images/mkdocs/multi.svg alt="Multi-page version" title="Multi-page version"> </a> <a href=../../../../single/ role=button class="btn btn-dark-alt active" aria-pressed=true> <img src=/images/mkdocs/single.svg alt="Single-page version" title="Single-page version"> </a> </div> <nav id=sidebar-nav class="nav flex-column mb-5"> <a href=#sidebar-sidebar-1 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-1 title=导言 class="nav-link text-light dropdown-toggle px-0">导言</a> <div id=sidebar-sidebar-1 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../ title=什么是ClickHouse？ class="nav-link text-light text-wrap d-inline-block w-100 px-0">什么是ClickHouse？</a> <a href=../../../../getting-started/ title=入门 class="nav-link text-light text-wrap d-inline-block w-100 px-0">入门</a> <a href=../../../../getting-started/install/ title=安装部署 class="nav-link text-light text-wrap d-inline-block w-100 px-0">安装部署</a> <a href=../../../../getting-started/tutorial/ title=使用教程 class="nav-link text-light text-wrap d-inline-block w-100 px-0">使用教程</a> <a href=#sidebar-sidebar-1-5 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-1-5 title=示例数据集 class="nav-link text-light dropdown-toggle px-0">示例数据集</a> <div id=sidebar-sidebar-1-5 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../getting-started/example-datasets/ title=导言 class="nav-link text-light text-wrap d-inline-block w-100 px-0">导言</a> <a href=../../../../getting-started/example-datasets/metrica/ title="Yandex.Metrica Data" class="nav-link text-light text-wrap d-inline-block w-100 px-0">Yandex.Metrica Data</a> <a href=../../../../getting-started/example-datasets/star-schema/ title="Star Schema Benchmark" class="nav-link text-light text-wrap d-inline-block w-100 px-0">Star Schema Benchmark</a> <a href=../../../../getting-started/example-datasets/wikistat/ title=WikiStat class="nav-link text-light text-wrap d-inline-block w-100 px-0">WikiStat</a> <a href=../../../../getting-started/example-datasets/criteo/ title="Terabyte Click Logs from Criteo" class="nav-link text-light text-wrap d-inline-block w-100 px-0">Terabyte Click Logs from Criteo</a> <a href=../../../../getting-started/example-datasets/amplab-benchmark/ title="AMPLab Big Data Benchmark" class="nav-link text-light text-wrap d-inline-block w-100 px-0">AMPLab Big Data Benchmark</a> <a href=../../../../getting-started/example-datasets/nyc-taxi/ title="New York Taxi Data" class="nav-link text-light text-wrap d-inline-block w-100 px-0">New York Taxi Data</a> <a href=../../../../getting-started/example-datasets/ontime/ title=OnTime class="nav-link text-light text-wrap d-inline-block w-100 px-0">OnTime</a> </nav> </div> <a href=../../../../getting-started/playground/ title=体验平台 class="nav-link text-light text-wrap d-inline-block w-100 px-0">体验平台</a> </nav> </div> <a href=#sidebar-sidebar-2 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-2 title=Interfaces class="nav-link text-light dropdown-toggle px-0">Interfaces</a> <div id=sidebar-sidebar-2 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../interfaces/ title=客户端 class="nav-link text-light text-wrap d-inline-block w-100 px-0">客户端</a> <a href=../../../../interfaces/cli/ title=命令行客户端 class="nav-link text-light text-wrap d-inline-block w-100 px-0">命令行客户端</a> <a href=../../../../interfaces/tcp/ title=原生接口(TCP) class="nav-link text-light text-wrap d-inline-block w-100 px-0">原生接口(TCP)</a> <a href=../../../../interfaces/http/ title=HTTP客户端 class="nav-link text-light text-wrap d-inline-block w-100 px-0">HTTP客户端</a> <a href=../../../../interfaces/mysql/ title=MySQL接口 class="nav-link text-light text-wrap d-inline-block w-100 px-0">MySQL接口</a> <a href=../../../../interfaces/formats/ title=输入/输出格式 class="nav-link text-light text-wrap d-inline-block w-100 px-0">输入/输出格式</a> <a href=../../../../interfaces/jdbc/ title=JDBC驱动 class="nav-link text-light text-wrap d-inline-block w-100 px-0">JDBC驱动</a> <a href=../../../../interfaces/odbc/ title=ODBC驱动 class="nav-link text-light text-wrap d-inline-block w-100 px-0">ODBC驱动</a> <a href=../../../../interfaces/cpp/ title=C++客户端库 class="nav-link text-light text-wrap d-inline-block w-100 px-0">C++客户端库</a> <a href=#sidebar-sidebar-2-10 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-2-10 title=第三方工具 class="nav-link text-light dropdown-toggle px-0">第三方工具</a> <div id=sidebar-sidebar-2-10 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../interfaces/third-party/ title=第三方工具 class="nav-link text-light text-wrap d-inline-block w-100 px-0">第三方工具</a> <a href=../../../../interfaces/third-party/client-libraries/ title=客户端开发库 class="nav-link text-light text-wrap d-inline-block w-100 px-0">客户端开发库</a> <a href=../../../../interfaces/third-party/integrations/ title=第三方集成库 class="nav-link text-light text-wrap d-inline-block w-100 px-0">第三方集成库</a> <a href=../../../../interfaces/third-party/proxy/ title=第三方代理 class="nav-link text-light text-wrap d-inline-block w-100 px-0">第三方代理</a> <a href=../../../../interfaces/third-party/gui/ title=第三方开发的可视化界面 class="nav-link text-light text-wrap d-inline-block w-100 px-0">第三方开发的可视化界面</a> </nav> </div> </nav> </div> <a href=#sidebar-sidebar-3 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-3 title=引擎 class="nav-link text-light dropdown-toggle px-0">引擎</a> <div id=sidebar-sidebar-3 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=#sidebar-sidebar-3-2 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-3-2 title=数据库引擎 class="nav-link text-light dropdown-toggle px-0">数据库引擎</a> <div id=sidebar-sidebar-3-2 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../engines/database-engines/lazy/ title=延时引擎 class="nav-link text-light text-wrap d-inline-block w-100 px-0">延时引擎</a> <a href=../../../../engines/database-engines/atomic/ title=Atomic class="nav-link text-light text-wrap d-inline-block w-100 px-0">Atomic</a> <a href=../../../../engines/database-engines/mysql/ title=MySQL class="nav-link text-light text-wrap d-inline-block w-100 px-0">MySQL</a> <a href=../../../../engines/database-engines/ title=数据库引擎 class="nav-link text-light text-wrap d-inline-block w-100 px-0">数据库引擎</a> </nav> </div> <a href=#sidebar-sidebar-3-3 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-3-3 title=表引擎 class="nav-link text-light dropdown-toggle px-0">表引擎</a> <div id=sidebar-sidebar-3-3 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=#sidebar-sidebar-3-3-1 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-3-3-1 title=合并树家族 class="nav-link text-light dropdown-toggle px-0">合并树家族</a> <div id=sidebar-sidebar-3-3-1 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../engines/table-engines/mergetree-family/versionedcollapsingmergetree/ title=版本折叠MergeTree class="nav-link text-light text-wrap d-inline-block w-100 px-0">版本折叠MergeTree</a> <a href=../../../../engines/table-engines/mergetree-family/graphitemergetree/ title=GraphiteMergeTree class="nav-link text-light text-wrap d-inline-block w-100 px-0">GraphiteMergeTree</a> <a href=../../../../engines/table-engines/mergetree-family/aggregatingmergetree/ title=AggregatingMergeTree class="nav-link text-light text-wrap d-inline-block w-100 px-0">AggregatingMergeTree</a> <a href=../../../../engines/table-engines/mergetree-family/mergetree/ title=MergeTree class="nav-link text-white active text-wrap d-inline-block w-100 px-0">MergeTree</a> <a href=../../../../engines/table-engines/mergetree-family/replacingmergetree/ title=ReplacingMergeTree class="nav-link text-light text-wrap d-inline-block w-100 px-0">ReplacingMergeTree</a> <a href=../../../../engines/table-engines/mergetree-family/summingmergetree/ title=SummingMergeTree class="nav-link text-light text-wrap d-inline-block w-100 px-0">SummingMergeTree</a> <a href=../../../../engines/table-engines/mergetree-family/collapsingmergetree/ title=折叠树 class="nav-link text-light text-wrap d-inline-block w-100 px-0">折叠树</a> <a href=../../../../engines/table-engines/mergetree-family/replication/ title=数据副本 class="nav-link text-light text-wrap d-inline-block w-100 px-0">数据副本</a> <a href=../../../../engines/table-engines/mergetree-family/custom-partitioning-key/ title=自定义分区键 class="nav-link text-light text-wrap d-inline-block w-100 px-0">自定义分区键</a> </nav> </div> <a href=#sidebar-sidebar-3-3-2 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-3-3-2 title=日志系列 class="nav-link text-light dropdown-toggle px-0">日志系列</a> <div id=sidebar-sidebar-3-3-2 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../engines/table-engines/log-family/ title=日志引擎系列 class="nav-link text-light text-wrap d-inline-block w-100 px-0">日志引擎系列</a> <a href=../../../../engines/table-engines/log-family/log/ title=Log class="nav-link text-light text-wrap d-inline-block w-100 px-0">Log</a> <a href=../../../../engines/table-engines/log-family/stripelog/ title=StripeLog class="nav-link text-light text-wrap d-inline-block w-100 px-0">StripeLog</a> <a href=../../../../engines/table-engines/log-family/tinylog/ title=TinyLog class="nav-link text-light text-wrap d-inline-block w-100 px-0">TinyLog</a> </nav> </div> <a href=#sidebar-sidebar-3-3-3 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-3-3-3 title=集成 class="nav-link text-light dropdown-toggle px-0">集成</a> <div id=sidebar-sidebar-3-3-3 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../engines/table-engines/integrations/jdbc/ title=JDBC表引擎 class="nav-link text-light text-wrap d-inline-block w-100 px-0">JDBC表引擎</a> <a href=../../../../engines/table-engines/integrations/odbc/ title=ODBC class="nav-link text-light text-wrap d-inline-block w-100 px-0">ODBC</a> <a href=../../../../engines/table-engines/integrations/hdfs/ title=HDFS class="nav-link text-light text-wrap d-inline-block w-100 px-0">HDFS</a> <a href=../../../../engines/table-engines/integrations/kafka/ title=Kafka class="nav-link text-light text-wrap d-inline-block w-100 px-0">Kafka</a> <a href=../../../../engines/table-engines/integrations/mysql/ title=MySQL class="nav-link text-light text-wrap d-inline-block w-100 px-0">MySQL</a> </nav> </div> <a href=#sidebar-sidebar-3-3-4 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-3-3-4 title=特别 class="nav-link text-light dropdown-toggle px-0">特别</a> <div id=sidebar-sidebar-3-3-4 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../engines/table-engines/special/join/ title=关联表引擎 class="nav-link text-light text-wrap d-inline-block w-100 px-0">关联表引擎</a> <a href=../../../../engines/table-engines/special/generate/ title=随机数生成 class="nav-link text-light text-wrap d-inline-block w-100 px-0">随机数生成</a> <a href=../../../../engines/table-engines/special/materializedview/ title=MaterializedView class="nav-link text-light text-wrap d-inline-block w-100 px-0">MaterializedView</a> <a href=../../../../engines/table-engines/special/null/ title=Null class="nav-link text-light text-wrap d-inline-block w-100 px-0">Null</a> <a href=../../../../engines/table-engines/special/url/ title=URL(URL,格式) class="nav-link text-light text-wrap d-inline-block w-100 px-0">URL(URL,格式)</a> <a href=../../../../engines/table-engines/special/memory/ title=内存表 class="nav-link text-light text-wrap d-inline-block w-100 px-0">内存表</a> <a href=../../../../engines/table-engines/special/distributed/ title=分布 class="nav-link text-light text-wrap d-inline-block w-100 px-0">分布</a> <a href=../../../../engines/table-engines/special/merge/ title=合并 class="nav-link text-light text-wrap d-inline-block w-100 px-0">合并</a> <a href=../../../../engines/table-engines/special/dictionary/ title=字典 class="nav-link text-light text-wrap d-inline-block w-100 px-0">字典</a> <a href=../../../../engines/table-engines/special/file/ title=文件(输入格式) class="nav-link text-light text-wrap d-inline-block w-100 px-0">文件(输入格式)</a> <a href=../../../../engines/table-engines/special/external-data/ title=用于查询处理的外部数据 class="nav-link text-light text-wrap d-inline-block w-100 px-0">用于查询处理的外部数据</a> <a href=../../../../engines/table-engines/special/buffer/ title=缓冲区 class="nav-link text-light text-wrap d-inline-block w-100 px-0">缓冲区</a> <a href=../../../../engines/table-engines/special/view/ title=视图 class="nav-link text-light text-wrap d-inline-block w-100 px-0">视图</a> <a href=../../../../engines/table-engines/special/set/ title=设置 class="nav-link text-light text-wrap d-inline-block w-100 px-0">设置</a> </nav> </div> <a href=../../../../engines/table-engines/ title=表引擎 class="nav-link text-light text-wrap d-inline-block w-100 px-0">表引擎</a> </nav> </div> </nav> </div> <a href=#sidebar-sidebar-4 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4 title=SQL参考 class="nav-link text-light dropdown-toggle px-0">SQL参考</a> <div id=sidebar-sidebar-4 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/syntax/ title=SQL语法 class="nav-link text-light text-wrap d-inline-block w-100 px-0">SQL语法</a> <a href=#sidebar-sidebar-4-3 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-3 title=发言 class="nav-link text-light dropdown-toggle px-0">发言</a> <div id=sidebar-sidebar-4-3 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=#sidebar-sidebar-4-3-2 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-3-2 title=SELECT class="nav-link text-light dropdown-toggle px-0">SELECT</a> <div id=sidebar-sidebar-4-3-2 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/statements/select/ title=综述 class="nav-link text-light text-wrap d-inline-block w-100 px-0">综述</a> <a href=../../../../sql-reference/statements/select/all/ title="ALL 子句" class="nav-link text-light text-wrap d-inline-block w-100 px-0">ALL 子句</a> <a href=../../../../sql-reference/statements/select/array-join/ title="ARRAY JOIN" class="nav-link text-light text-wrap d-inline-block w-100 px-0">ARRAY JOIN</a> <a href=../../../../sql-reference/statements/select/distinct/ title=DISTINCT class="nav-link text-light text-wrap d-inline-block w-100 px-0">DISTINCT</a> <a href=../../../../sql-reference/statements/select/format/ title=FORMAT class="nav-link text-light text-wrap d-inline-block w-100 px-0">FORMAT</a> <a href=../../../../sql-reference/statements/select/from/ title=FROM class="nav-link text-light text-wrap d-inline-block w-100 px-0">FROM</a> <a href=../../../../sql-reference/statements/select/group-by/ title="GROUP BY" class="nav-link text-light text-wrap d-inline-block w-100 px-0">GROUP BY</a> <a href=../../../../sql-reference/statements/select/having/ title=HAVING class="nav-link text-light text-wrap d-inline-block w-100 px-0">HAVING</a> <a href=../../../../sql-reference/statements/select/into-outfile/ title="INTO OUTFILE" class="nav-link text-light text-wrap d-inline-block w-100 px-0">INTO OUTFILE</a> <a href=../../../../sql-reference/statements/select/join/ title=JOIN class="nav-link text-light text-wrap d-inline-block w-100 px-0">JOIN</a> <a href=../../../../sql-reference/statements/select/limit/ title=LIMIT class="nav-link text-light text-wrap d-inline-block w-100 px-0">LIMIT</a> <a href=../../../../sql-reference/statements/select/limit-by/ title="LIMIT BY" class="nav-link text-light text-wrap d-inline-block w-100 px-0">LIMIT BY</a> <a href=../../../../sql-reference/statements/select/order-by/ title="ORDER BY" class="nav-link text-light text-wrap d-inline-block w-100 px-0">ORDER BY</a> <a href=../../../../sql-reference/statements/select/prewhere/ title=PREWHERE class="nav-link text-light text-wrap d-inline-block w-100 px-0">PREWHERE</a> <a href=../../../../sql-reference/statements/select/sample/ title=SAMPLE class="nav-link text-light text-wrap d-inline-block w-100 px-0">SAMPLE</a> <a href=../../../../sql-reference/statements/select/union/ title="UNION ALL" class="nav-link text-light text-wrap d-inline-block w-100 px-0">UNION ALL</a> <a href=../../../../sql-reference/statements/select/where/ title=WHERE class="nav-link text-light text-wrap d-inline-block w-100 px-0">WHERE</a> <a href=../../../../sql-reference/statements/select/with/ title=WITH class="nav-link text-light text-wrap d-inline-block w-100 px-0">WITH</a> </nav> </div> <a href=../../../../sql-reference/statements/alter/ title=ALTER class="nav-link text-light text-wrap d-inline-block w-100 px-0">ALTER</a> <a href=../../../../sql-reference/statements/system/ title=SYSTEM class="nav-link text-light text-wrap d-inline-block w-100 px-0">SYSTEM</a> <a href=../../../../sql-reference/statements/show/ title=SHOW class="nav-link text-light text-wrap d-inline-block w-100 px-0">SHOW</a> <a href=../../../../sql-reference/statements/grant/ title=授权操作 class="nav-link text-light text-wrap d-inline-block w-100 px-0">授权操作</a> <a href=../../../../sql-reference/statements/revoke/ title=REVOKE class="nav-link text-light text-wrap d-inline-block w-100 px-0">REVOKE</a> <a href=../../../../sql-reference/statements/misc/ title=其他 class="nav-link text-light text-wrap d-inline-block w-100 px-0">其他</a> <a href=../../../../sql-reference/statements/create/ title="CREATE DATABASE" class="nav-link text-light text-wrap d-inline-block w-100 px-0">CREATE DATABASE</a> <a href=../../../../sql-reference/statements/insert-into/ title="INSERT INTO 语句" class="nav-link text-light text-wrap d-inline-block w-100 px-0">INSERT INTO 语句</a> </nav> </div> <a href=#sidebar-sidebar-4-4 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-4 title=函数 class="nav-link text-light dropdown-toggle px-0">函数</a> <div id=sidebar-sidebar-4-4 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/functions/ title=简介 class="nav-link text-light text-wrap d-inline-block w-100 px-0">简介</a> <a href=../../../../sql-reference/functions/arithmetic-functions/ title=算术函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">算术函数</a> <a href=../../../../sql-reference/functions/comparison-functions/ title=比较函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">比较函数</a> <a href=../../../../sql-reference/functions/logical-functions/ title=逻辑函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">逻辑函数</a> <a href=../../../../sql-reference/functions/type-conversion-functions/ title=类型转换函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">类型转换函数</a> <a href=../../../../sql-reference/functions/in-functions/ title="IN 运算符" class="nav-link text-light text-wrap d-inline-block w-100 px-0">IN 运算符</a> <a href=../../../../sql-reference/functions/introspection/ title=自省 class="nav-link text-light text-wrap d-inline-block w-100 px-0">自省</a> <a href=../../../../sql-reference/functions/geo/ title=GEO函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">GEO函数</a> <a href=../../../../sql-reference/functions/hash-functions/ title=Hash函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">Hash函数</a> <a href=../../../../sql-reference/functions/ip-address-functions/ title=IP函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">IP函数</a> <a href=../../../../sql-reference/functions/json-functions/ title=JSON函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">JSON函数</a> <a href=../../../../sql-reference/functions/functions-for-nulls/ title=Nullable处理函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">Nullable处理函数</a> <a href=../../../../sql-reference/functions/url-functions/ title=URL函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">URL函数</a> <a href=../../../../sql-reference/functions/uuid-functions/ title=UUID函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">UUID函数</a> <a href=../../../../sql-reference/functions/array-join/ title=arrayJoin函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">arrayJoin函数</a> <a href=../../../../sql-reference/functions/bitmap-functions/ title=位图函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">位图函数</a> <a href=../../../../sql-reference/functions/bit-functions/ title=位操作函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">位操作函数</a> <a href=../../../../sql-reference/functions/other-functions/ title=其他函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">其他函数</a> <a href=../../../../sql-reference/functions/ym-dict-functions/ title=功能与Yandex的工作。梅特里卡词典 class="nav-link text-light text-wrap d-inline-block w-100 px-0">功能与Yandex的工作。梅特里卡词典</a> <a href=../../../../sql-reference/functions/rounding-functions/ title=取整函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">取整函数</a> <a href=../../../../sql-reference/functions/ext-dict-functions/ title=字典函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">字典函数</a> <a href=../../../../sql-reference/functions/string-functions/ title=字符串函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">字符串函数</a> <a href=../../../../sql-reference/functions/splitting-merging-functions/ title=字符串拆分合并函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">字符串拆分合并函数</a> <a href=../../../../sql-reference/functions/string-search-functions/ title=字符串搜索函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">字符串搜索函数</a> <a href=../../../../sql-reference/functions/string-replace-functions/ title=字符串替换函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">字符串替换函数</a> <a href=../../../../sql-reference/functions/math-functions/ title=数学函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">数学函数</a> <a href=../../../../sql-reference/functions/array-functions/ title=数组函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">数组函数</a> <a href=../../../../sql-reference/functions/date-time-functions/ title=时间日期函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">时间日期函数</a> <a href=../../../../sql-reference/functions/machine-learning-functions/ title=机器学习函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">机器学习函数</a> <a href=../../../../sql-reference/functions/conditional-functions/ title=条件函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">条件函数</a> <a href=../../../../sql-reference/functions/encoding-functions/ title=编码函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">编码函数</a> <a href=../../../../sql-reference/functions/random-functions/ title=随机函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">随机函数</a> <a href=../../../../sql-reference/functions/higher-order-functions/ title=高阶函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">高阶函数</a> </nav> </div> <a href=#sidebar-sidebar-4-5 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-5 title=聚合函数 class="nav-link text-light dropdown-toggle px-0">聚合函数</a> <div id=sidebar-sidebar-4-5 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/aggregate-functions/ title=简介 class="nav-link text-light text-wrap d-inline-block w-100 px-0">简介</a> <a href=../../../../sql-reference/aggregate-functions/reference/ title=参考手册 class="nav-link text-light text-wrap d-inline-block w-100 px-0">参考手册</a> <a href=../../../../sql-reference/aggregate-functions/combinators/ title=聚合函数组合器 class="nav-link text-light text-wrap d-inline-block w-100 px-0">聚合函数组合器</a> <a href=../../../../sql-reference/aggregate-functions/parametric-functions/ title=参数聚合函数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">参数聚合函数</a> </nav> </div> <a href=#sidebar-sidebar-4-6 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-6 title=表函数 class="nav-link text-light dropdown-toggle px-0">表函数</a> <div id=sidebar-sidebar-4-6 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/table-functions/ title=导言 class="nav-link text-light text-wrap d-inline-block w-100 px-0">导言</a> <a href=../../../../sql-reference/table-functions/file/ title=文件 class="nav-link text-light text-wrap d-inline-block w-100 px-0">文件</a> <a href=../../../../sql-reference/table-functions/merge/ title=合并 class="nav-link text-light text-wrap d-inline-block w-100 px-0">合并</a> <a href=../../../../sql-reference/table-functions/numbers/ title=数字 class="nav-link text-light text-wrap d-inline-block w-100 px-0">数字</a> <a href=../../../../sql-reference/table-functions/url/ title=url class="nav-link text-light text-wrap d-inline-block w-100 px-0">url</a> <a href=../../../../sql-reference/table-functions/mysql/ title=mysql class="nav-link text-light text-wrap d-inline-block w-100 px-0">mysql</a> <a href=../../../../sql-reference/table-functions/jdbc/ title=jdbc class="nav-link text-light text-wrap d-inline-block w-100 px-0">jdbc</a> <a href=../../../../sql-reference/table-functions/odbc/ title=odbc class="nav-link text-light text-wrap d-inline-block w-100 px-0">odbc</a> <a href=../../../../sql-reference/table-functions/hdfs/ title=hdfs class="nav-link text-light text-wrap d-inline-block w-100 px-0">hdfs</a> <a href=../../../../sql-reference/table-functions/input/ title=输入 class="nav-link text-light text-wrap d-inline-block w-100 px-0">输入</a> <a href=../../../../sql-reference/table-functions/generate/ title=generateRandom class="nav-link text-light text-wrap d-inline-block w-100 px-0">generateRandom</a> <a href=../../../../sql-reference/table-functions/remote/ title=远程，远程安全 class="nav-link text-light text-wrap d-inline-block w-100 px-0">远程，远程安全</a> </nav> </div> <a href=#sidebar-sidebar-4-7 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-7 title=字典 class="nav-link text-light dropdown-toggle px-0">字典</a> <div id=sidebar-sidebar-4-7 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/dictionaries/ title=导言 class="nav-link text-light text-wrap d-inline-block w-100 px-0">导言</a> <a href=#sidebar-sidebar-4-7-2 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-7-2 title=外部字典 class="nav-link text-light dropdown-toggle px-0">外部字典</a> <div id=sidebar-sidebar-4-7-2 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/dictionaries/external-dictionaries/external-dicts/ title=概述 class="nav-link text-light text-wrap d-inline-block w-100 px-0">概述</a> <a href=../../../../sql-reference/dictionaries/external-dictionaries/external-dicts-dict/ title=配置外部字典 class="nav-link text-light text-wrap d-inline-block w-100 px-0">配置外部字典</a> <a href=../../../../sql-reference/dictionaries/external-dictionaries/external-dicts-dict-layout/ title=在内存中存储字典 class="nav-link text-light text-wrap d-inline-block w-100 px-0">在内存中存储字典</a> <a href=../../../../sql-reference/dictionaries/external-dictionaries/external-dicts-dict-lifetime/ title=字典更新 class="nav-link text-light text-wrap d-inline-block w-100 px-0">字典更新</a> <a href=../../../../sql-reference/dictionaries/external-dictionaries/external-dicts-dict-sources/ title=外部字典的来源 class="nav-link text-light text-wrap d-inline-block w-100 px-0">外部字典的来源</a> <a href=../../../../sql-reference/dictionaries/external-dictionaries/external-dicts-dict-structure/ title=字典键和字段 class="nav-link text-light text-wrap d-inline-block w-100 px-0">字典键和字段</a> <a href=../../../../sql-reference/dictionaries/external-dictionaries/external-dicts-dict-hierarchical/ title=分层字典 class="nav-link text-light text-wrap d-inline-block w-100 px-0">分层字典</a> </nav> </div> <a href=../../../../sql-reference/dictionaries/internal-dicts/ title=内部字典 class="nav-link text-light text-wrap d-inline-block w-100 px-0">内部字典</a> </nav> </div> <a href=../../../../sql-reference/ansi/ title=ANSI兼容性 class="nav-link text-light text-wrap d-inline-block w-100 px-0">ANSI兼容性</a> <a href=#sidebar-sidebar-4-9 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-9 title=操作符 class="nav-link text-light dropdown-toggle px-0">操作符</a> <div id=sidebar-sidebar-4-9 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/operators/in/ title="IN 操作符" class="nav-link text-light text-wrap d-inline-block w-100 px-0">IN 操作符</a> <a href=../../../../sql-reference/operators/ title=操作符 class="nav-link text-light text-wrap d-inline-block w-100 px-0">操作符</a> </nav> </div> <a href=#sidebar-sidebar-4-10 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-10 title=数据类型 class="nav-link text-light dropdown-toggle px-0">数据类型</a> <div id=sidebar-sidebar-4-10 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/data-types/uuid/ title=UUID class="nav-link text-light text-wrap d-inline-block w-100 px-0">UUID</a> <a href=../../../../sql-reference/data-types/datetime64/ title=DateTime64 class="nav-link text-light text-wrap d-inline-block w-100 px-0">DateTime64</a> <a href=../../../../sql-reference/data-types/lowcardinality/ title=低基数类型 class="nav-link text-light text-wrap d-inline-block w-100 px-0">低基数类型</a> <a href=#sidebar-sidebar-4-10-4 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-10-4 title=域 class="nav-link text-light dropdown-toggle px-0">域</a> <div id=sidebar-sidebar-4-10-4 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/data-types/domains/ title=域 class="nav-link text-light text-wrap d-inline-block w-100 px-0">域</a> <a href=../../../../sql-reference/data-types/domains/ipv4/ title=IPv4 class="nav-link text-light text-wrap d-inline-block w-100 px-0">IPv4</a> <a href=../../../../sql-reference/data-types/domains/ipv6/ title=IPv6 class="nav-link text-light text-wrap d-inline-block w-100 px-0">IPv6</a> </nav> </div> <a href=../../../../sql-reference/data-types/aggregatefunction/ title="AggregateFunction(name, types_of_arguments…)" class="nav-link text-light text-wrap d-inline-block w-100 px-0">AggregateFunction(name, types_of_arguments…)</a> <a href=../../../../sql-reference/data-types/decimal/ title=Decimal(P,S),Decimal32(S),Decimal64(S),Decimal128(S) class="nav-link text-light text-wrap d-inline-block w-100 px-0">Decimal(P,S),Decimal32(S),Decimal64(S),Decimal128(S)</a> <a href=../../../../sql-reference/data-types/enum/ title=Enum8,Enum16 class="nav-link text-light text-wrap d-inline-block w-100 px-0">Enum8,Enum16</a> <a href=../../../../sql-reference/data-types/float/ title=Float32,Float64 class="nav-link text-light text-wrap d-inline-block w-100 px-0">Float32,Float64</a> <a href=../../../../sql-reference/data-types/simpleaggregatefunction/ title=SimpleAggregateFunction class="nav-link text-light text-wrap d-inline-block w-100 px-0">SimpleAggregateFunction</a> <a href=../../../../sql-reference/data-types/tuple/ title="Tuple(T1, T2, …)" class="nav-link text-light text-wrap d-inline-block w-100 px-0">Tuple(T1, T2, …)</a> <a href=../../../../sql-reference/data-types/int-uint/ title=UInt8,UInt16,UInt32,UInt64,Int8,Int16,Int32,Int64 class="nav-link text-light text-wrap d-inline-block w-100 px-0">UInt8,UInt16,UInt32,UInt64,Int8,Int16,Int32,Int64</a> <a href=../../../../sql-reference/data-types/nullable/ title=可为空（类型名称) class="nav-link text-light text-wrap d-inline-block w-100 px-0">可为空（类型名称)</a> <a href=../../../../sql-reference/data-types/fixedstring/ title=固定字符串 class="nav-link text-light text-wrap d-inline-block w-100 px-0">固定字符串</a> <a href=../../../../sql-reference/data-types/string/ title=字符串 class="nav-link text-light text-wrap d-inline-block w-100 px-0">字符串</a> <a href=../../../../sql-reference/data-types/boolean/ title=布尔值 class="nav-link text-light text-wrap d-inline-block w-100 px-0">布尔值</a> <a href=../../../../sql-reference/data-types/ title=数据类型 class="nav-link text-light text-wrap d-inline-block w-100 px-0">数据类型</a> <a href=../../../../sql-reference/data-types/date/ title=日期 class="nav-link text-light text-wrap d-inline-block w-100 px-0">日期</a> <a href=../../../../sql-reference/data-types/datetime/ title=日期时间 class="nav-link text-light text-wrap d-inline-block w-100 px-0">日期时间</a> <a href=../../../../sql-reference/data-types/array/ title=阵列(T) class="nav-link text-light text-wrap d-inline-block w-100 px-0">阵列(T)</a> <a href=#sidebar-sidebar-4-10-20 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-10-20 title=嵌套数据结构 class="nav-link text-light dropdown-toggle px-0">嵌套数据结构</a> <div id=sidebar-sidebar-4-10-20 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/data-types/nested-data-structures/nested/ title="Nested(Name1 Type1, Name2 Type2, …)" class="nav-link text-light text-wrap d-inline-block w-100 px-0">Nested(Name1 Type1, Name2 Type2, …)</a> <a href=../../../../sql-reference/data-types/nested-data-structures/ title=嵌套数据结构 class="nav-link text-light text-wrap d-inline-block w-100 px-0">嵌套数据结构</a> </nav> </div> <a href=#sidebar-sidebar-4-10-21 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-4-10-21 title=特殊数据类型 class="nav-link text-light dropdown-toggle px-0">特殊数据类型</a> <div id=sidebar-sidebar-4-10-21 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../sql-reference/data-types/special-data-types/interval/ title=间隔 class="nav-link text-light text-wrap d-inline-block w-100 px-0">间隔</a> <a href=../../../../sql-reference/data-types/special-data-types/nothing/ title=没什么 class="nav-link text-light text-wrap d-inline-block w-100 px-0">没什么</a> <a href=../../../../sql-reference/data-types/special-data-types/ title=特殊数据类型 class="nav-link text-light text-wrap d-inline-block w-100 px-0">特殊数据类型</a> <a href=../../../../sql-reference/data-types/special-data-types/expression/ title=表达式 class="nav-link text-light text-wrap d-inline-block w-100 px-0">表达式</a> <a href=../../../../sql-reference/data-types/special-data-types/set/ title=设置 class="nav-link text-light text-wrap d-inline-block w-100 px-0">设置</a> </nav> </div> </nav> </div> </nav> </div> <a href=#sidebar-sidebar-5 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-5 title=指南 class="nav-link text-light dropdown-toggle px-0">指南</a> <div id=sidebar-sidebar-5 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../guides/ title=概述 class="nav-link text-light text-wrap d-inline-block w-100 px-0">概述</a> <a href=../../../../guides/apply-catboost-model/ title=应用CatBoost模型 class="nav-link text-light text-wrap d-inline-block w-100 px-0">应用CatBoost模型</a> </nav> </div> <a href=#sidebar-sidebar-6 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-6 title=操作 class="nav-link text-light dropdown-toggle px-0">操作</a> <div id=sidebar-sidebar-6 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../operations/ title=操作 class="nav-link text-light text-wrap d-inline-block w-100 px-0">操作</a> <a href=../../../../operations/requirements/ title=要求 class="nav-link text-light text-wrap d-inline-block w-100 px-0">要求</a> <a href=../../../../operations/monitoring/ title=监控 class="nav-link text-light text-wrap d-inline-block w-100 px-0">监控</a> <a href=../../../../operations/troubleshooting/ title=常见问题 class="nav-link text-light text-wrap d-inline-block w-100 px-0">常见问题</a> <a href=../../../../operations/update/ title=更新 class="nav-link text-light text-wrap d-inline-block w-100 px-0">更新</a> <a href=../../../../operations/access-rights/ title=访问权限和账户管理 class="nav-link text-light text-wrap d-inline-block w-100 px-0">访问权限和账户管理</a> <a href=../../../../operations/backup/ title=数据备份 class="nav-link text-light text-wrap d-inline-block w-100 px-0">数据备份</a> <a href=#sidebar-sidebar-6-8 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-6-8 title=优化性能 class="nav-link text-light dropdown-toggle px-0">优化性能</a> <div id=sidebar-sidebar-6-8 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../operations/optimizing-performance/sampling-query-profiler/ title=查询分析 class="nav-link text-light text-wrap d-inline-block w-100 px-0">查询分析</a> </nav> </div> <a href=#sidebar-sidebar-6-9 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-6-9 title=系统表 class="nav-link text-light dropdown-toggle px-0">系统表</a> <div id=sidebar-sidebar-6-9 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../operations/system-tables/ title=系统表 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统表</a> <a href=../../../../operations/system-tables/query_log/ title=system.query_log class="nav-link text-light text-wrap d-inline-block w-100 px-0">system.query_log</a> <a href=../../../../operations/system-tables/asynchronous_metric_log/ title=系统。asynchronous_metric_log class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。asynchronous_metric_log</a> <a href=../../../../operations/system-tables/asynchronous_metrics/ title=系统。asynchronous_metrics class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。asynchronous_metrics</a> <a href=../../../../operations/system-tables/data_type_families/ title=系统。data_type_families class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。data_type_families</a> <a href=../../../../operations/system-tables/detached_parts/ title=系统。detached_parts class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。detached_parts</a> <a href=../../../../operations/system-tables/graphite_retentions/ title=系统。graphite_retentions class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。graphite_retentions</a> <a href=../../../../operations/system-tables/merge_tree_settings/ title=系统。merge_tree_settings class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。merge_tree_settings</a> <a href=../../../../operations/system-tables/metric_log/ title=系统。metric_log class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。metric_log</a> <a href=../../../../operations/system-tables/numbers_mt/ title=系统。numbers_mt class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。numbers_mt</a> <a href=../../../../operations/system-tables/part_log/ title=系统。part_log class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。part_log</a> <a href=../../../../operations/system-tables/query_thread_log/ title=系统。query_thread_log class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。query_thread_log</a> <a href=../../../../operations/system-tables/storage_policies/ title=系统。storage_policies class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。storage_policies</a> <a href=../../../../operations/system-tables/text_log/ title=系统。text_log class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。text_log</a> <a href=../../../../operations/system-tables/trace_log/ title=系统。trace_log class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。trace_log</a> <a href=../../../../operations/system-tables/one/ title=系统。一 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。一</a> <a href=../../../../operations/system-tables/columns/ title=系统。列 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。列</a> <a href=../../../../operations/system-tables/replicas/ title=系统。副本 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。副本</a> <a href=../../../../operations/system-tables/functions/ title=系统。功能 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。功能</a> <a href=../../../../operations/system-tables/zookeeper/ title=系统。动物园管理员 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。动物园管理员</a> <a href=../../../../operations/system-tables/merges/ title=系统。合并 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。合并</a> <a href=../../../../operations/system-tables/dictionaries/ title=系统。字典 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。字典</a> <a href=../../../../operations/system-tables/metrics/ title=系统。指标 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。指标</a> <a href=../../../../operations/system-tables/numbers/ title=系统。数字 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。数字</a> <a href=../../../../operations/system-tables/databases/ title=系统。数据库 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。数据库</a> <a href=../../../../operations/system-tables/events/ title=系统。活动 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。活动</a> <a href=../../../../operations/system-tables/processes/ title=系统。流程 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。流程</a> <a href=../../../../operations/system-tables/disks/ title=系统。磁盘 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。磁盘</a> <a href=../../../../operations/system-tables/mutations/ title=系统。突变 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。突变</a> <a href=../../../../operations/system-tables/tables/ title=系统。表 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。表</a> <a href=../../../../operations/system-tables/table_engines/ title=系统。表_engines class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。表_engines</a> <a href=../../../../operations/system-tables/settings/ title=系统。设置 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。设置</a> <a href=../../../../operations/system-tables/contributors/ title=系统。贡献者 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。贡献者</a> <a href=../../../../operations/system-tables/clusters/ title=系统。集群 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。集群</a> <a href=../../../../operations/system-tables/parts/ title=系统。零件 class="nav-link text-light text-wrap d-inline-block w-100 px-0">系统。零件</a> </nav> </div> <a href=../../../../operations/performance-test/ title=测试硬件 class="nav-link text-light text-wrap d-inline-block w-100 px-0">测试硬件</a> <a href=../../../../operations/tips/ title=使用建议 class="nav-link text-light text-wrap d-inline-block w-100 px-0">使用建议</a> <a href=../../../../operations/configuration-files/ title=配置文件 class="nav-link text-light text-wrap d-inline-block w-100 px-0">配置文件</a> <a href=../../../../operations/quotas/ title=配额 class="nav-link text-light text-wrap d-inline-block w-100 px-0">配额</a> <a href=#sidebar-sidebar-6-14 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-6-14 title=实用工具 class="nav-link text-light dropdown-toggle px-0">实用工具</a> <div id=sidebar-sidebar-6-14 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../operations/utilities/clickhouse-local/ title=clickhouse-local class="nav-link text-light text-wrap d-inline-block w-100 px-0">clickhouse-local</a> <a href=../../../../operations/utilities/clickhouse-benchmark/ title=性能测试 class="nav-link text-light text-wrap d-inline-block w-100 px-0">性能测试</a> <a href=../../../../operations/utilities/clickhouse-copier/ title=clickhouse-copier class="nav-link text-light text-wrap d-inline-block w-100 px-0">clickhouse-copier</a> <a href=../../../../operations/utilities/ title=实用工具 class="nav-link text-light text-wrap d-inline-block w-100 px-0">实用工具</a> </nav> </div> <a href=#sidebar-sidebar-6-15 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-6-15 title=服务器配置参数 class="nav-link text-light dropdown-toggle px-0">服务器配置参数</a> <div id=sidebar-sidebar-6-15 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../operations/server-configuration-parameters/settings/ title=服务器设置 class="nav-link text-light text-wrap d-inline-block w-100 px-0">服务器设置</a> <a href=../../../../operations/server-configuration-parameters/ title=服务器配置参数 class="nav-link text-light text-wrap d-inline-block w-100 px-0">服务器配置参数</a> </nav> </div> <a href=#sidebar-sidebar-6-16 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-6-16 title=设置 class="nav-link text-light dropdown-toggle px-0">设置</a> <div id=sidebar-sidebar-6-16 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../operations/settings/permissions-for-queries/ title=查询权限 class="nav-link text-light text-wrap d-inline-block w-100 px-0">查询权限</a> <a href=../../../../operations/settings/settings-profiles/ title=设置配置文件 class="nav-link text-light text-wrap d-inline-block w-100 px-0">设置配置文件</a> <a href=../../../../operations/settings/constraints-on-settings/ title=对设置的限制 class="nav-link text-light text-wrap d-inline-block w-100 px-0">对设置的限制</a> <a href=../../../../operations/settings/settings-users/ title=用户设置 class="nav-link text-light text-wrap d-inline-block w-100 px-0">用户设置</a> <a href=../../../../operations/settings/query-complexity/ title=查询复杂性的限制 class="nav-link text-light text-wrap d-inline-block w-100 px-0">查询复杂性的限制</a> <a href=../../../../operations/settings/settings/ title=设置 class="nav-link text-light text-wrap d-inline-block w-100 px-0">设置</a> </nav> </div> </nav> </div> <a href=#sidebar-sidebar-7 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-7 title=商业支持 class="nav-link text-light dropdown-toggle px-0">商业支持</a> <div id=sidebar-sidebar-7 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../commercial/cloud/ title=云 class="nav-link text-light text-wrap d-inline-block w-100 px-0">云</a> <a href=../../../../commercial/support/ title=支持 class="nav-link text-light text-wrap d-inline-block w-100 px-0">支持</a> <a href=../../../../commercial/ title=简介 class="nav-link text-light text-wrap d-inline-block w-100 px-0">简介</a> </nav> </div> <a href=#sidebar-sidebar-8 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-8 title=F.A.Q. class="nav-link text-light dropdown-toggle px-0">F.A.Q.</a> <div id=sidebar-sidebar-8 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../faq/general/ title=常见问题 class="nav-link text-light text-wrap d-inline-block w-100 px-0">常见问题</a> </nav> </div> <a href=#sidebar-sidebar-9 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-9 title=ClickHouse事迹 class="nav-link text-light dropdown-toggle px-0">ClickHouse事迹</a> <div id=sidebar-sidebar-9 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=#sidebar-sidebar-9-1 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-9-1 title=Changelog class="nav-link text-light dropdown-toggle px-0">Changelog</a> <div id=sidebar-sidebar-9-1 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../whats-new/changelog/ title=2021 class="nav-link text-light text-wrap d-inline-block w-100 px-0">2021</a> <a href=../../../../whats-new/changelog/2019/ title=2019 class="nav-link text-light text-wrap d-inline-block w-100 px-0">2019</a> <a href=../../../../whats-new/changelog/2018/ title=2018 class="nav-link text-light text-wrap d-inline-block w-100 px-0">2018</a> <a href=../../../../whats-new/changelog/2017/ title=2017 class="nav-link text-light text-wrap d-inline-block w-100 px-0">2017</a> </nav> </div> <a href=../../../../whats-new/roadmap/ title=Roadmap class="nav-link text-light text-wrap d-inline-block w-100 px-0">Roadmap</a> <a href=../../../../whats-new/security-changelog/ title=安全更新日志 class="nav-link text-light text-wrap d-inline-block w-100 px-0">安全更新日志</a> <a href=../../../../whats-new/ title=ClickHouse变更及改动? class="nav-link text-light text-wrap d-inline-block w-100 px-0">ClickHouse变更及改动?</a> </nav> </div> <a href=#sidebar-sidebar-10 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-10 title="ClickHouse 开发" class="nav-link text-light dropdown-toggle px-0">ClickHouse 开发</a> <div id=sidebar-sidebar-10 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../development/browse-code/ title=浏览源代码 class="nav-link text-light text-wrap d-inline-block w-100 px-0">浏览源代码</a> <a href=../../../../development/build-cross-arm/ title="如何在Linux上构建ClickHouse for AARCH64（ARM64)" class="nav-link text-light text-wrap d-inline-block w-100 px-0">如何在Linux上构建ClickHouse for AARCH64（ARM64)</a> <a href=../../../../development/ title="ClickHouse 开发" class="nav-link text-light text-wrap d-inline-block w-100 px-0">ClickHouse 开发</a> <a href=../../../../development/architecture/ title="ClickHouse 架构概述" class="nav-link text-light text-wrap d-inline-block w-100 px-0">ClickHouse 架构概述</a> <a href=../../../../development/developer-instruction/ title=Windows使用指引 class="nav-link text-light text-wrap d-inline-block w-100 px-0">Windows使用指引</a> <a href=../../../../development/contrib/ title=使用的三方库 class="nav-link text-light text-wrap d-inline-block w-100 px-0">使用的三方库</a> <a href=../../../../development/build-osx/ title="在 Mac OS X 中编译 ClickHouse" class="nav-link text-light text-wrap d-inline-block w-100 px-0">在 Mac OS X 中编译 ClickHouse</a> <a href=../../../../development/build-cross-osx/ title="如何在Linux中编译Mac OS X ClickHouse" class="nav-link text-light text-wrap d-inline-block w-100 px-0">如何在Linux中编译Mac OS X ClickHouse</a> <a href=../../../../development/build/ title="如何构建 ClickHouse 发布包" class="nav-link text-light text-wrap d-inline-block w-100 px-0">如何构建 ClickHouse 发布包</a> <a href=../../../../development/style/ title="如何编写 C++ 代码" class="nav-link text-light text-wrap d-inline-block w-100 px-0">如何编写 C++ 代码</a> </nav> </div> <a href=#sidebar-sidebar-11 data-toggle=collapse aria-expanded=false aria-controls=sidebar-sidebar-11 title=变更日志 class="nav-link text-light dropdown-toggle px-0">变更日志</a> <div id=sidebar-sidebar-11 class="nav flex-column collapse"> <nav class="nav flex-column pl-2"> <a href=../../../../changelog/ title=变更日志 class="nav-link text-light text-wrap d-inline-block w-100 px-0">变更日志</a> </nav> </div> <a href=../../../../single/clickhouse_zh.pdf class="nav-link border-top border-secondary mt-3 px-0 pt-3 text-light"> <img src=/images/mkdocs/pdf.svg alt="PDF version" title="PDF version" height=24 class="d-block mr-1 float-left"><div>PDF version</div> </a> </nav> </div> </div> <div id=content-wrapper class="col-md-8 p-2 p-md-4"> <div id=content class=mt-md-n3> <nav class=text-muted aria-label=breadcrumb> <ol class="breadcrumb bg-transparent p-0"> <li class=breadcrumb-item><a href=../../../ class=text-reset>引擎</a> </li> <li class=breadcrumb-item><a href=../../ class=text-reset>表引擎</a> </li> <li class=breadcrumb-item><a href=../ class=text-reset>合并树家族</a> </li> </ol> </nav> <h1 id=table_engines-mergetree>MergeTree<a class=headerlink href=#table_engines-mergetree title="Permanent link"> </a></h1> <p>Clickhouse 中最强大的表引擎当属 <code class=syntax>MergeTree</code> （合并树）引擎及该系列（<code class=syntax>*MergeTree</code>）中的其他引擎。</p> <p><code class=syntax>MergeTree</code> 系列的引擎被设计用于插入极大量的数据到一张表当中。数据可以以数据片段的形式一个接着一个的快速写入，数据片段在后台按照一定的规则进行合并。相比在插入时不断修改（重写）已存储的数据，这种策略会高效很多。</p> <p>主要特点:</p> <ul> <li> <p>存储的数据按主键排序。</p> <p>这使得你能够创建一个小型的稀疏索引来加快数据检索。</p> </li> <li> <p>支持数据分区，如果指定了 <a href=../custom-partitioning-key/ >分区键</a> 的话。</p> <p>在相同数据集和相同结果集的情况下 ClickHouse 中某些带分区的操作会比普通操作更快。查询中指定了分区键时 ClickHouse 会自动截取分区数据。这也有效增加了查询性能。</p> </li> <li> <p>支持数据副本。</p> <p><code class=syntax>ReplicatedMergeTree</code> 系列的表提供了数据副本功能。更多信息，请参阅 <a href=../replication/ >数据副本</a> 一节。</p> </li> <li> <p>支持数据采样。</p> <p>需要的话，你可以给表设置一个采样方法。</p> </li> </ul> <div class="admonition note alert pb-0 mb-4 alert-primary" role=alert> <p class="admonition-title alert-heading display-6 mb-2">注意</p> <p><a class=alert-link href=../../special/merge/#merge>合并</a> 引擎并不属于 <code class=syntax>*MergeTree</code> 系列。</p> </div> <h2 id=table_engine-mergetree-creating-a-table>建表<a class=headerlink href=#table_engine-mergetree-creating-a-table title="Permanent link"> </a></h2> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=p>[</span><span class=k>IF</span> <span class=k>NOT</span> <span class=k>EXISTS</span><span class=p>]</span> <span class=p>[</span><span class=n>db</span><span class=p>.]</span><span class=k>table_name</span> <span class=p>[</span><span class=k>ON</span> <span class=k>CLUSTER</span> <span class=k>cluster</span><span class=p>]</span>
<span class=p>(</span>
    <span class=n>name1</span> <span class=p>[</span><span class=n>type1</span><span class=p>]</span> <span class=p>[</span><span class=k>DEFAULT</span><span class=o>|</span><span class=n>MATERIALIZED</span><span class=o>|</span><span class=k>ALIAS</span> <span class=n>expr1</span><span class=p>]</span> <span class=p>[</span><span class=n>TTL</span> <span class=n>expr1</span><span class=p>],</span>
    <span class=n>name2</span> <span class=p>[</span><span class=n>type2</span><span class=p>]</span> <span class=p>[</span><span class=k>DEFAULT</span><span class=o>|</span><span class=n>MATERIALIZED</span><span class=o>|</span><span class=k>ALIAS</span> <span class=n>expr2</span><span class=p>]</span> <span class=p>[</span><span class=n>TTL</span> <span class=n>expr2</span><span class=p>],</span>
    <span class=p>...</span>
    <span class=k>INDEX</span> <span class=n>index_name1</span> <span class=n>expr1</span> <span class=k>TYPE</span> <span class=n>type1</span><span class=p>(...)</span> <span class=n>GRANULARITY</span> <span class=n>value1</span><span class=p>,</span>
    <span class=k>INDEX</span> <span class=n>index_name2</span> <span class=n>expr2</span> <span class=k>TYPE</span> <span class=n>type2</span><span class=p>(...)</span> <span class=n>GRANULARITY</span> <span class=n>value2</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span><span class=p>()</span>
<span class=k>ORDER</span> <span class=k>BY</span> <span class=n>expr</span>
<span class=p>[</span><span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>expr</span><span class=p>]</span>
<span class=p>[</span><span class=k>PRIMARY</span> <span class=k>KEY</span> <span class=n>expr</span><span class=p>]</span>
<span class=p>[</span><span class=n>SAMPLE</span> <span class=k>BY</span> <span class=n>expr</span><span class=p>]</span>
<span class=p>[</span><span class=n>TTL</span> <span class=n>expr</span> <span class=p>[</span><span class=k>DELETE</span><span class=o>|</span><span class=k>TO</span> <span class=n>DISK</span> <span class=s1>'xxx'</span><span class=o>|</span><span class=k>TO</span> <span class=n>VOLUME</span> <span class=s1>'xxx'</span><span class=p>],</span> <span class=p>...]</span>
<span class=p>[</span><span class=n>SETTINGS</span> <span class=n>name</span><span class=o>=</span><span class=n>value</span><span class=p>,</span> <span class=p>...]</span>
</code></pre></div> <p>对于以上参数的描述，可参考 <a href=./ >CREATE 语句 的描述</a> 。</p> <p><a name=mergetree-query-clauses></a></p> <p><strong>子句</strong></p> <ul> <li> <p><code class=syntax>ENGINE</code> - 引擎名和参数。 <code class=syntax>ENGINE = MergeTree()</code>. <code class=syntax>MergeTree</code> 引擎没有参数。</p> </li> <li> <p><code class=syntax>ORDER BY</code> — 排序键。</p> <p>可以是一组列的元组或任意的表达式。 例如: <code class=syntax>ORDER BY (CounterID, EventDate)</code> 。</p> <p>如果没有使用 <code class=syntax>PRIMARY KEY</code> 显式的指定主键，ClickHouse 会使用排序键作为主键。</p> <p>如果不需要排序，可以使用 <code class=syntax>ORDER BY tuple()</code>. 参考 <a href=https://clickhouse.tech/docs/en/engines/table-engines/mergetree-family/mergetree/#selecting-the-primary-key target=_blank>选择主键</a></p> </li> <li> <p><code class=syntax>PARTITION BY</code> — <a href=../custom-partitioning-key/ >分区键</a> 。</p> <p>要按月分区，可以使用表达式 <code class=syntax>toYYYYMM(date_column)</code> ，这里的 <code class=syntax>date_column</code> 是一个 <a href=./ >Date</a> 类型的列。分区名的格式会是 <code class=syntax>"YYYYMM"</code> 。</p> </li> <li> <p><code class=syntax>PRIMARY KEY</code> - 主键，如果要 <a href=#choosing-a-primary-key-that-differs-from-the-sorting-key>选择与排序键不同的主键</a>，可选。</p> <p>默认情况下主键跟排序键（由 <code class=syntax>ORDER BY</code> 子句指定）相同。<br> 因此，大部分情况下不需要再专门指定一个 <code class=syntax>PRIMARY KEY</code> 子句。</p> </li> <li> <p><code class=syntax>SAMPLE BY</code> — 用于抽样的表达式。</p> <p>如果要用抽样表达式，主键中必须包含这个表达式。例如：<br> <code class=syntax>SAMPLE BY intHash32(UserID) ORDER BY (CounterID, EventDate, intHash32(UserID))</code> 。</p> </li> <li> <p>TTL 指定行存储的持续时间并定义数据片段在硬盘和卷上的移动逻辑的规则列表，可选。</p> <p>表达式中必须存在至少一个 <code class=syntax>Date</code> 或 <code class=syntax>DateTime</code> 类型的列，比如：</p> <p><code class=syntax>TTL date + INTERVAl 1 DAY</code></p> <p>规则的类型 <code class=syntax>DELETE|TO DISK 'xxx'|TO VOLUME 'xxx'</code>指定了当满足条件（到达指定时间）时所要执行的动作：移除过期的行，还是将数据片段（如果数据片段中的所有行都满足表达式的话）移动到指定的磁盘（<code class=syntax>TO DISK 'xxx'</code>) 或 卷（<code class=syntax>TO VOLUME 'xxx'</code>）。默认的规则是移除（<code class=syntax>DELETE</code>）。可以在列表中指定多个规则，但最多只能有一个<code class=syntax>DELETE</code>的规则。</p> <p>更多细节，请查看 <a href=#table_engine-mergetree-ttl>表和列的 TTL</a></p> </li> <li> <p><code class=syntax>SETTINGS</code> — 控制 <code class=syntax>MergeTree</code> 行为的额外参数：</p> <ul> <li><code class=syntax>index_granularity</code> — 索引粒度。索引中相邻的『标记』间的数据行数。默认值，8192 。参考<a href=#mergetree-data-storage>数据存储</a>。</li> <li><code class=syntax>index_granularity_bytes</code> — 索引粒度，以字节为单位，默认值: 10Mb。如果想要仅按数据行数限制索引粒度, 请设置为0(不建议)。</li> <li><code class=syntax>enable_mixed_granularity_parts</code> — 是否启用通过 <code class=syntax>index_granularity_bytes</code> 控制索引粒度的大小。在19.11版本之前, 只有 <code class=syntax>index_granularity</code> 配置能够用于限制索引粒度的大小。当从具有很大的行（几十上百兆字节）的表中查询数据时候，<code class=syntax>index_granularity_bytes</code> 配置能够提升ClickHouse的性能。如果你的表里有很大的行，可以开启这项配置来提升<code class=syntax>SELECT</code> 查询的性能。</li> <li><code class=syntax>use_minimalistic_part_header_in_zookeeper</code> — 是否在 ZooKeeper 中启用最小的数据片段头 。如果设置了 <code class=syntax>use_minimalistic_part_header_in_zookeeper=1</code> ，ZooKeeper 会存储更少的数据。更多信息参考『服务配置参数』这章中的 <a href=../../../../operations/server-configuration-parameters/settings/#server-settings-use_minimalistic_part_header_in_zookeeper>设置描述</a> 。</li> <li><code class=syntax>min_merge_bytes_to_use_direct_io</code> — 使用直接 I/O 来操作磁盘的合并操作时要求的最小数据量。合并数据片段时，ClickHouse 会计算要被合并的所有数据的总存储空间。如果大小超过了 <code class=syntax>min_merge_bytes_to_use_direct_io</code> 设置的字节数，则 ClickHouse 将使用直接 I/O 接口（<code class=syntax>O_DIRECT</code> 选项）对磁盘读写。如果设置 <code class=syntax>min_merge_bytes_to_use_direct_io = 0</code> ，则会禁用直接 I/O。默认值：<code class=syntax>10 * 1024 * 1024 * 1024</code> 字节。<br> <a name=mergetree_setting-merge_with_ttl_timeout></a></li> <li><code class=syntax>merge_with_ttl_timeout</code> — TTL合并频率的最小间隔时间，单位：秒。默认值: 86400 (1 天)。</li> <li><code class=syntax>write_final_mark</code> — 是否启用在数据片段尾部写入最终索引标记。默认值: 1（不建议更改）。</li> <li><code class=syntax>merge_max_block_size</code> — 在块中进行合并操作时的最大行数限制。默认值：8192</li> <li><code class=syntax>storage_policy</code> — 存储策略。 参见 <a href=#table_engine-mergetree-multiple-volumes>使用具有多个块的设备进行数据存储</a>.</li> <li><code class=syntax>min_bytes_for_wide_part</code>,<code class=syntax>min_rows_for_wide_part</code> 在数据片段中可以使用<code class=syntax>Wide</code>格式进行存储的最小字节数/行数。你可以不设置、只设置一个，或全都设置。参考：<a href=#mergetree-data-storage>数据存储</a></li> </ul> </li> </ul> <p><strong>示例配置</strong></p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>ENGINE</span> <span class=n>MergeTree</span><span class=p>()</span> <span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>toYYYYMM</span><span class=p>(</span><span class=n>EventDate</span><span class=p>)</span> <span class=k>ORDER</span> <span class=k>BY</span> <span class=p>(</span><span class=n>CounterID</span><span class=p>,</span> <span class=n>EventDate</span><span class=p>,</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>))</span> <span class=n>SAMPLE</span> <span class=k>BY</span> <span class=n>intHash32</span><span class=p>(</span><span class=n>UserID</span><span class=p>)</span> <span class=n>SETTINGS</span> <span class=n>index_granularity</span><span class=o>=</span><span class=mi>8192</span>
</code></pre></div> <p>在这个例子中，我们设置了按月进行分区。</p> <p>同时我们设置了一个按用户 ID 哈希的抽样表达式。这使得你可以对该表中每个 <code class=syntax>CounterID</code> 和 <code class=syntax>EventDate</code> 的数据伪随机分布。如果你在查询时指定了 <a href=./#select-sample-clause>SAMPLE</a> 子句。 ClickHouse会返回对于用户子集的一个均匀的伪随机数据采样。</p> <p><code class=syntax>index_granularity</code> 可省略因为 8192 是默认设置 。</p> <details><summary>已弃用的建表方法</summary> <p></p> <div class="admonition attention alert pb-0 mb-4 alert-warning" role=alert> <p class="admonition-title alert-heading display-6 mb-2">注意</p> <p>不要在新版项目中使用该方法，可能的话，请将旧项目切换到上述方法。</p> <p>CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster]<br> (<br> name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1],<br> name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2],<br> ...<br> ) ENGINE [=] MergeTree(date-column [, sampling_expression], (primary, key), index_granularity)</p> </div> <p><strong>MergeTree() 参数</strong></p> <ul> <li><code class=syntax>date-column</code> — 类型为 <a href=./ >日期</a> 的列名。ClickHouse 会自动依据这个列按月创建分区。分区名格式为 <code class=syntax>"YYYYMM"</code> 。</li> <li><code class=syntax>sampling_expression</code> — 采样表达式。</li> <li><code class=syntax>(primary, key)</code> — 主键。类型 — <a href=./ >元组()</a></li> <li><code class=syntax>index_granularity</code> — 索引粒度。即索引中相邻『标记』间的数据行数。设为 8192 可以适用大部分场景。</li> </ul> <p><strong>示例</strong></p> <div class=codehilite><pre><span></span><code class=syntax><span class=err>MergeTree(EventDate, intHash32(UserID), (CounterID, EventDate, intHash32(UserID)), 8192)</span>
</code></pre></div> <p>对于主要的配置方法，这里 <code class=syntax>MergeTree</code> 引擎跟前面的例子一样，可以以同样的方式配置。</p> </details> <h2 id=mergetree-data-storage>数据存储<a class=headerlink href=#mergetree-data-storage title="Permanent link"> </a></h2> <p>表由按主键排序的数据片段（DATA PART）组成。</p> <p>当数据被插入到表中时，会创建多个数据片段并按主键的字典序排序。例如，主键是 <code class=syntax>(CounterID, Date)</code> 时，片段中数据首先按 <code class=syntax>CounterID</code> 排序，具有相同 <code class=syntax>CounterID</code> 的部分按 <code class=syntax>Date</code> 排序。</p> <p>不同分区的数据会被分成不同的片段，ClickHouse 在后台合并数据片段以便更高效存储。不同分区的数据片段不会进行合并。合并机制并不保证具有相同主键的行全都合并到同一个数据片段中。</p> <p>数据片段可以以 <code class=syntax>Wide</code> 或 <code class=syntax>Compact</code> 格式存储。在 <code class=syntax>Wide</code> 格式下，每一列都会在文件系统中存储为单独的文件，在 <code class=syntax>Compact</code> 格式下所有列都存储在一个文件中。<code class=syntax>Compact</code> 格式可以提高插入量少插入频率频繁时的性能。</p> <p>数据存储格式由 <code class=syntax>min_bytes_for_wide_part</code> 和 <code class=syntax>min_rows_for_wide_part</code> 表引擎参数控制。如果数据片段中的字节数或行数少于相应的设置值，数据片段会以 <code class=syntax>Compact</code> 格式存储，否则会以 <code class=syntax>Wide</code> 格式存储。</p> <p>每个数据片段被逻辑的分割成颗粒（granules）。颗粒是 ClickHouse 中进行数据查询时的最小不可分割数据集。ClickHouse 不会对行或值进行拆分，所以每个颗粒总是包含整数个行。每个颗粒的第一行通过该行的主键值进行标记，<br> ClickHouse 会为每个数据片段创建一个索引文件来存储这些标记。对于每列，无论它是否包含在主键当中，ClickHouse 都会存储类似标记。这些标记让你可以在列文件中直接找到数据。</p> <p>颗粒的大小通过表引擎参数 <code class=syntax>index_granularity</code> 和 <code class=syntax>index_granularity_bytes</code> 控制。取决于行的大小，颗粒的行数的在 <code class=syntax>[1, index_granularity]</code> 范围中。如果单行的大小超过了 <code class=syntax>index_granularity_bytes</code> 设置的值，那么一个颗粒的大小会超过 <code class=syntax>index_granularity_bytes</code>。在这种情况下，颗粒的大小等于该行的大小。 </p> <h2 id=primary-keys-and-indexes-in-queries>主键和索引在查询中的表现<a class=headerlink href=#primary-keys-and-indexes-in-queries title="Permanent link"> </a></h2> <p>我们以 <code class=syntax>(CounterID, Date)</code> 以主键。排序好的索引的图示会是下面这样：</p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>全部数据</span><span class=w>  </span><span class=err>:</span><span class=w>     </span><span class=o>[</span><span class=n>-------------------------------------------------------------------------</span><span class=o>]</span><span class=w></span>
<span class=nl>CounterID</span><span class=p>:</span><span class=w>      </span><span class=o>[</span><span class=n>aaaaaaaaaaaaaaaaaabbbbcdeeeeeeeeeeeeefgggggggghhhhhhhhhiiiiiiiiikllllllll</span><span class=o>]</span><span class=w></span>
<span class=nc>Date</span><span class=err>:</span><span class=w>           </span><span class=o>[</span><span class=n>1111111222222233331233211111222222333211111112122222223111112223311122333</span><span class=o>]</span><span class=w></span>
<span class=nl>标记</span><span class=p>:</span><span class=w>            </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w>      </span><span class=o>|</span><span class=w></span>
<span class=w>                </span><span class=n>a</span><span class=p>,</span><span class=mi>1</span><span class=w>    </span><span class=n>a</span><span class=p>,</span><span class=mi>2</span><span class=w>    </span><span class=n>a</span><span class=p>,</span><span class=mi>3</span><span class=w>    </span><span class=n>b</span><span class=p>,</span><span class=mi>3</span><span class=w>    </span><span class=n>e</span><span class=p>,</span><span class=mi>2</span><span class=w>    </span><span class=n>e</span><span class=p>,</span><span class=mi>3</span><span class=w>    </span><span class=n>g</span><span class=p>,</span><span class=mi>1</span><span class=w>    </span><span class=n>h</span><span class=p>,</span><span class=mi>2</span><span class=w>    </span><span class=n>i</span><span class=p>,</span><span class=mi>1</span><span class=w>    </span><span class=n>i</span><span class=p>,</span><span class=mi>3</span><span class=w>    </span><span class=n>l</span><span class=p>,</span><span class=mi>3</span><span class=w></span>
<span class=nl>标记号</span><span class=p>:</span><span class=w>          </span><span class=mi>0</span><span class=w>      </span><span class=mi>1</span><span class=w>      </span><span class=mi>2</span><span class=w>      </span><span class=mi>3</span><span class=w>      </span><span class=mi>4</span><span class=w>      </span><span class=mi>5</span><span class=w>      </span><span class=mi>6</span><span class=w>      </span><span class=mi>7</span><span class=w>      </span><span class=mi>8</span><span class=w>      </span><span class=mi>9</span><span class=w>      </span><span class=mi>10</span><span class=w></span>
</code></pre></div> <p>如果指定查询如下：</p> <ul> <li><code class=syntax>CounterID in ('a', 'h')</code>，服务器会读取标记号在 <code class=syntax>[0, 3)</code> 和 <code class=syntax>[6, 8)</code> 区间中的数据。</li> <li><code class=syntax>CounterID IN ('a', 'h') AND Date = 3</code>，服务器会读取标记号在 <code class=syntax>[1, 3)</code> 和 <code class=syntax>[7, 8)</code> 区间中的数据。</li> <li><code class=syntax>Date = 3</code>，服务器会读取标记号在 <code class=syntax>[1, 10]</code> 区间中的数据。</li> </ul> <p>上面例子可以看出使用索引通常会比全表描述要高效。</p> <p>稀疏索引会引起额外的数据读取。当读取主键单个区间范围的数据时，每个数据块中最多会多读 <code class=syntax>index_granularity * 2</code> 行额外的数据。</p> <p>稀疏索引使得你可以处理极大量的行，因为大多数情况下，这些索引常驻与内存（RAM）中。</p> <p>ClickHouse 不要求主键惟一，所以你可以插入多条具有相同主键的行。</p> <h3 id=zhu-jian-de-xuan-ze>主键的选择<a class=headerlink href=#zhu-jian-de-xuan-ze title="Permanent link"> </a></h3> <p>主键中列的数量并没有明确的限制。依据数据结构，你可以在主键包含多些或少些列。这样可以：</p> <ul> <li> <p>改善索引的性能。</p> <p>如果当前主键是 <code class=syntax>(a, b)</code> ，在下列情况下添加另一个 <code class=syntax>c</code> 列会提升性能：</p> <ul> <li>查询会使用 <code class=syntax>c</code> 列作为条件</li> <li>很长的数据范围（ <code class=syntax>index_granularity</code> 的数倍）里 <code class=syntax>(a, b)</code> 都是相同的值，并且这样的情况很普遍。换言之，就是加入另一列后，可以让你的查询略过很长的数据范围。</li> </ul> </li> <li> <p>改善数据压缩。</p> <p>ClickHouse 以主键排序片段数据，所以，数据的一致性越高，压缩越好。</p> </li> <li> <p>在<a href=../collapsingmergetree/#table_engine-collapsingmergetree>CollapsingMergeTree</a> 和 <a href=../summingmergetree/ >SummingMergeTree</a> 引擎里进行数据合并时会提供额外的处理逻辑。</p> <p>在这种情况下，指定与主键不同的 <em>排序键</em> 也是有意义的。</p> </li> </ul> <p>长的主键会对插入性能和内存消耗有负面影响，但主键中额外的列并不影响 <code class=syntax>SELECT</code> 查询的性能。</p> <p>可以使用 <code class=syntax>ORDER BY tuple()</code> 语法创建没有主键的表。在这种情况下 ClickHouse 根据数据插入的顺序存储。如果在使用 <code class=syntax>INSERT ... SELECT</code> 时希望保持数据的排序，请设置 <a href=../../../../operations/settings/settings/#settings-max-insert-threads>max_insert_threads = 1</a>。</p> <p>想要根据初始顺序进行数据查询，使用 <a href=../../../../operations/settings/settings/#settings-max_threads>单线程查询</a></p> <h3 id=choosing-a-primary-key-that-differs-from-the-sorting-key>选择与排序键不同主键<a class=headerlink href=#choosing-a-primary-key-that-differs-from-the-sorting-key title="Permanent link"> </a></h3> <p>指定一个跟排序键不一样的主键是可以的，此时排序键用于在数据片段中进行排序，主键用于在索引文件中进行标记的写入。这种情况下，主键表达式元组必须是排序键表达式元组的前缀。</p> <p>当使用 <a href=../summingmergetree/ >SummingMergeTree</a> 和 <a href=../aggregatingmergetree/ >AggregatingMergeTree</a> 引擎时，这个特性非常有用。通常在使用这类引擎时，表里的列分两种：<em>维度</em> 和 <em>度量</em> 。典型的查询会通过任意的 <code class=syntax>GROUP BY</code> 对度量列进行聚合并通过维度列进行过滤。由于 SummingMergeTree 和 AggregatingMergeTree 会对排序键相同的行进行聚合，所以把所有的维度放进排序键是很自然的做法。但这将导致排序键中包含大量的列，并且排序键会伴随着新添加的维度不断的更新。</p> <p>在这种情况下合理的做法是，只保留少量的列在主键当中用于提升扫描效率，将维度列添加到排序键中。</p> <p>对排序键进行 <a href=../../../../sql-reference/statements/alter/ >ALTER</a> 是轻量级的操作，因为当一个新列同时被加入到表里和排序键里时，已存在的数据片段并不需要修改。由于旧的排序键是新排序键的前缀，并且新添加的列中没有数据，因此在表修改时的数据对于新旧的排序键来说都是有序的。</p> <h3 id=use-of-indexes-and-partitions-in-queries>索引和分区在查询中的应用<a class=headerlink href=#use-of-indexes-and-partitions-in-queries title="Permanent link"> </a></h3> <p>对于 <code class=syntax>SELECT</code> 查询，ClickHouse 分析是否可以使用索引。如果 <code class=syntax>WHERE/PREWHERE</code> 子句具有下面这些表达式（作为谓词链接一子项或整个）则可以使用索引：包含一个表示与主键/分区键中的部分字段或全部字段相等/不等的比较表达式；基于主键/分区键的字段上的 <code class=syntax>IN</code> 或 固定前缀的<code class=syntax>LIKE</code> 表达式；基于主键/分区键的字段上的某些函数；基于主键/分区键的表达式的逻辑表达式。 <!-- It is too hard for me to translate this section as the original text completely. So I did it with my own understanding. If you have good idea, please help me. --><br> <!-- It is hard for me to translate this section too, but I think change the sentence struct is helpful for understanding. So I change the phraseology--> </p> <p>因此，在索引键的一个或多个区间上快速地执行查询都是可能的。下面例子中，指定标签；指定标签和日期范围；指定标签和日期；指定多个标签和日期范围等执行查询，都会非常快。</p> <p>当引擎配置如下时：</p> <div class=codehilite><pre><span></span><code class=syntax><span class=err>ENGINE MergeTree() PARTITION BY toYYYYMM(EventDate) ORDER BY (CounterID, EventDate) SETTINGS index_granularity=8192</span>
</code></pre></div> <p>这种情况下，这些查询：</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>EventDate</span> <span class=o>=</span> <span class=n>toDate</span><span class=p>(</span><span class=n>now</span><span class=p>())</span> <span class=k>AND</span> <span class=n>CounterID</span> <span class=o>=</span> <span class=mi>34</span>
<span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>EventDate</span> <span class=o>=</span> <span class=n>toDate</span><span class=p>(</span><span class=n>now</span><span class=p>())</span> <span class=k>AND</span> <span class=p>(</span><span class=n>CounterID</span> <span class=o>=</span> <span class=mi>34</span> <span class=k>OR</span> <span class=n>CounterID</span> <span class=o>=</span> <span class=mi>42</span><span class=p>)</span>
<span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=p>((</span><span class=n>EventDate</span> <span class=o>&gt;=</span> <span class=n>toDate</span><span class=p>(</span><span class=s1>'2014-01-01'</span><span class=p>)</span> <span class=k>AND</span> <span class=n>EventDate</span> <span class=o>&lt;=</span> <span class=n>toDate</span><span class=p>(</span><span class=s1>'2014-01-31'</span><span class=p>))</span> <span class=k>OR</span> <span class=n>EventDate</span> <span class=o>=</span> <span class=n>toDate</span><span class=p>(</span><span class=s1>'2014-05-01'</span><span class=p>))</span> <span class=k>AND</span> <span class=n>CounterID</span> <span class=k>IN</span> <span class=p>(</span><span class=mi>101500</span><span class=p>,</span> <span class=mi>731962</span><span class=p>,</span> <span class=mi>160656</span><span class=p>)</span> <span class=k>AND</span> <span class=p>(</span><span class=n>CounterID</span> <span class=o>=</span> <span class=mi>101500</span> <span class=k>OR</span> <span class=n>EventDate</span> <span class=o>!=</span> <span class=n>toDate</span><span class=p>(</span><span class=s1>'2014-05-01'</span><span class=p>))</span>
</code></pre></div> <p>ClickHouse 会依据主键索引剪掉不符合的数据，依据按月分区的分区键剪掉那些不包含符合数据的分区。</p> <p>上文的查询显示，即使索引用于复杂表达式。因为读表操作是组织好的，所以，使用索引不会比完整扫描慢。</p> <p>下面这个例子中，不会使用索引。</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>CounterID</span> <span class=o>=</span> <span class=mi>34</span> <span class=k>OR</span> <span class=n>URL</span> <span class=k>LIKE</span> <span class=s1>'%upyachka%'</span>
</code></pre></div> <p>要检查 ClickHouse 执行一个查询时能否使用索引，可设置 <a href=../../../../operations/settings/settings/#settings-force_index_by_date>force_index_by_date</a> 和 <a href=../../../../operations/settings/settings/ >force_primary_key</a> 。</p> <p>按月分区的分区键是只能读取包含适当范围日期的数据块。这种情况下，数据块会包含很多天（最多整月）的数据。在块中，数据按主键排序，主键第一列可能不包含日期。因此，仅使用日期而没有带主键前几个字段作为条件的查询将会导致需要读取超过这个指定日期以外的数据。</p> <h3 id=bu-fen-dan-diao-zhu-jian-de-shi-yong>部分单调主键的使用<a class=headerlink href=#bu-fen-dan-diao-zhu-jian-de-shi-yong title="Permanent link"> </a></h3> <p>考虑这样的场景，比如一个月中的几天。它们在一个月的范围内形成一个<a href=https://zh.wikipedia.org/wiki/单调函数 rel="external nofollow noreferrer" target=_blank>单调序列</a> ，但如果扩展到更大的时间范围它们就不再单调了。这就是一个部分单调序列。如果用户使用部分单调的主键创建表，ClickHouse同样会创建一个稀疏索引。当用户从这类表中查询数据时，ClickHouse 会对查询条件进行分析。如果用户希望获取两个索引标记之间的数据并且这两个标记在一个月以内，ClickHouse 可以在这种特殊情况下使用到索引，因为它可以计算出查询参数与索引标记之间的距离。</p> <p>如果查询参数范围内的主键不是单调序列，那么 ClickHouse 无法使用索引。在这种情况下，ClickHouse 会进行全表扫描。</p> <p>ClickHouse 在任何主键代表一个部分单调序列的情况下都会使用这个逻辑。</p> <h3 id=tiao-shu-suo-yin-fen-duan-hui-zong-suo-yin-shi-yan-xing-de>跳数索引<a class=headerlink href=#tiao-shu-suo-yin-fen-duan-hui-zong-suo-yin-shi-yan-xing-de title="Permanent link"> </a></h3> <p>此索引在 <code class=syntax>CREATE</code> 语句的列部分里定义。</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>INDEX</span> <span class=n>index_name</span> <span class=n>expr</span> <span class=k>TYPE</span> <span class=k>type</span><span class=p>(...)</span> <span class=n>GRANULARITY</span> <span class=n>granularity_value</span>
</code></pre></div> <p><code class=syntax>*MergeTree</code> 系列的表可以指定跳数索引。</p> <p>这些索引是由数据块按粒度分割后的每部分在指定表达式上汇总信息 <code class=syntax>granularity_value</code> 组成（粒度大小用表引擎里 <code class=syntax>index_granularity</code> 的指定）。<br> 这些汇总信息有助于用 <code class=syntax>where</code> 语句跳过大片不满足的数据，从而减少 <code class=syntax>SELECT</code> 查询从磁盘读取的数据量，</p> <p>这些索引会在数据块上聚合指定表达式的信息，这些信息以 granularity_value 指定的粒度组成 （粒度的大小通过在表引擎中定义 index_granularity 定义）。这些汇总信息有助于跳过大片不满足 <code class=syntax>where</code> 条件的数据，从而减少 <code class=syntax>SELECT</code> 查询从磁盘读取的数据量。</p> <p><strong>示例</strong></p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=k>table_name</span>
<span class=p>(</span>
    <span class=n>u64</span> <span class=n>UInt64</span><span class=p>,</span>
    <span class=n>i32</span> <span class=n>Int32</span><span class=p>,</span>
    <span class=n>s</span> <span class=n>String</span><span class=p>,</span>
    <span class=p>...</span>
    <span class=k>INDEX</span> <span class=n>a</span> <span class=p>(</span><span class=n>u64</span> <span class=o>*</span> <span class=n>i32</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span> <span class=k>TYPE</span> <span class=n>minmax</span> <span class=n>GRANULARITY</span> <span class=mi>3</span><span class=p>,</span>
    <span class=k>INDEX</span> <span class=n>b</span> <span class=p>(</span><span class=n>u64</span> <span class=o>*</span> <span class=k>length</span><span class=p>(</span><span class=n>s</span><span class=p>))</span> <span class=k>TYPE</span> <span class=k>set</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span> <span class=n>GRANULARITY</span> <span class=mi>4</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span><span class=p>()</span>
<span class=p>...</span>
</code></pre></div> <p>上例中的索引能让 ClickHouse 执行下面这些查询时减少读取数据量。</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>s</span> <span class=o>&lt;</span> <span class=s1>'z'</span>
<span class=k>SELECT</span> <span class=k>count</span><span class=p>()</span> <span class=k>FROM</span> <span class=k>table</span> <span class=k>WHERE</span> <span class=n>u64</span> <span class=o>*</span> <span class=n>i32</span> <span class=o>==</span> <span class=mi>10</span> <span class=k>AND</span> <span class=n>u64</span> <span class=o>*</span> <span class=k>length</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>1234</span>
</code></pre></div> <h4 id=table_engine-mergetree-data_skipping-indexes>索引的可用类型<a class=headerlink href=#table_engine-mergetree-data_skipping-indexes title="Permanent link"> </a></h4> <ul> <li> <p><code class=syntax>minmax</code><br> 存储指定表达式的极值（如果表达式是 <code class=syntax>tuple</code> ，则存储 <code class=syntax>tuple</code> 中每个元素的极值），这些信息用于跳过数据块，类似主键。</p> </li> <li> <p><code class=syntax>set(max_rows)</code><br> 存储指定表达式的不重复值（不超过 <code class=syntax>max_rows</code> 个，<code class=syntax>max_rows=0</code> 则表示『无限制』）。这些信息可用于检查 数据块是否满足 <code class=syntax>WHERE</code> 条件。</p> </li> <li> <p><code class=syntax>ngrambf_v1(n, size_of_bloom_filter_in_bytes, number_of_hash_functions, random_seed)</code><br> 存储一个包含数据块中所有 n元短语（ngram） 的 <a href=https://en.wikipedia.org/wiki/Bloom_filter rel="external nofollow noreferrer" target=_blank>布隆过滤器</a> 。只可用在字符串上。<br> 可用于优化 <code class=syntax>equals</code> ， <code class=syntax>like</code> 和 <code class=syntax>in</code> 表达式的性能。<br> <code class=syntax>n</code> – 短语长度。<br> <code class=syntax>size_of_bloom_filter_in_bytes</code> – 布隆过滤器大小，单位字节。（因为压缩得好，可以指定比较大的值，如 256 或 512）。<br> <code class=syntax>number_of_hash_functions</code> – 布隆过滤器中使用的哈希函数的个数。<br> <code class=syntax>random_seed</code> – 哈希函数的随机种子。</p> </li> <li> <p><code class=syntax>tokenbf_v1(size_of_bloom_filter_in_bytes, number_of_hash_functions, random_seed)</code><br> 跟 <code class=syntax>ngrambf_v1</code> 类似，不同于 ngrams 存储字符串指定长度的所有片段。它只存储被非字母数字字符分割的片段。</p> </li> <li> <p><code class=syntax>bloom_filter(bloom_filter([false_positive])</code> – 为指定的列存储布隆过滤器</p> <p>可选的参数 false_positive 用来指定从布隆过滤器收到错误响应的几率。取值范围是 (0,1)，默认值：0.025</p> <p>支持的数据类型：<code class=syntax>Int*</code>, <code class=syntax>UInt*</code>, <code class=syntax>Float*</code>, <code class=syntax>Enum</code>, <code class=syntax>Date</code>, <code class=syntax>DateTime</code>, <code class=syntax>String</code>, <code class=syntax>FixedString</code>, <code class=syntax>Array</code>, <code class=syntax>LowCardinality</code>, <code class=syntax>Nullable</code>。</p> <p>以下函数会用到这个索引： <a href=../../../../sql-reference/functions/comparison-functions/ >equals</a>, <a href=../../../../sql-reference/functions/comparison-functions/ >notEquals</a>, <a href=../../../../sql-reference/functions/in-functions/ >in</a>, <a href=../../../../sql-reference/functions/in-functions/ >notIn</a>, <a href=../../../../sql-reference/functions/array-functions/ >has</a></p> </li> </ul> <!-- --> <div class=codehilite><pre><span></span><code class=syntax><span class=k>INDEX</span> <span class=n>sample_index</span> <span class=p>(</span><span class=n>u64</span> <span class=o>*</span> <span class=k>length</span><span class=p>(</span><span class=n>s</span><span class=p>))</span> <span class=k>TYPE</span> <span class=n>minmax</span> <span class=n>GRANULARITY</span> <span class=mi>4</span>
<span class=k>INDEX</span> <span class=n>sample_index2</span> <span class=p>(</span><span class=n>u64</span> <span class=o>*</span> <span class=k>length</span><span class=p>(</span><span class=n>str</span><span class=p>),</span> <span class=n>i32</span> <span class=o>+</span> <span class=n>f64</span> <span class=o>*</span> <span class=mi>100</span><span class=p>,</span> <span class=nb>date</span><span class=p>,</span> <span class=n>str</span><span class=p>)</span> <span class=k>TYPE</span> <span class=k>set</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span> <span class=n>GRANULARITY</span> <span class=mi>4</span>
<span class=k>INDEX</span> <span class=n>sample_index3</span> <span class=p>(</span><span class=k>lower</span><span class=p>(</span><span class=n>str</span><span class=p>),</span> <span class=n>str</span><span class=p>)</span> <span class=k>TYPE</span> <span class=n>ngrambf_v1</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=n>GRANULARITY</span> <span class=mi>4</span>
</code></pre></div> <h4 id=functions-support>函数支持<a class=headerlink href=#functions-support title="Permanent link"> </a></h4> <p>WHERE 子句中的条件包含对列的函数调用，如果列是索引的一部分，ClickHouse 会在执行函数时尝试使用索引。不同的函数对索引的支持是不同的。</p> <p><code class=syntax>set</code> 索引会对所有函数生效，其他索引对函数的生效情况见下表</p> <table> <thead> <tr> <th>函数 (操作符) / 索引</th> <th>primary key</th> <th>minmax</th> <th>ngrambf_v1</th> <th>tokenbf_v1</th> <th>bloom_filter</th> </tr> </thead> <tbody> <tr> <td><a href=../../../../sql-reference/functions/comparison-functions/#function-equals>equals (=, ==)</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/comparison-functions/#function-notequals>notEquals(!=, \&lt;&gt;)</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/string-search-functions/#function-like>like</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/string-search-functions/#function-notlike>notLike</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/string-functions/#startswith>startsWith</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✗</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/string-functions/#endswith>endsWith</a></td> <td>✗</td> <td>✗</td> <td>✔</td> <td>✔</td> <td>✗</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/string-search-functions/#function-multisearchany>multiSearchAny</a></td> <td>✗</td> <td>✗</td> <td>✔</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/in-functions/#in-functions>in</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/in-functions/#in-functions>notIn</a></td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> <td>✔</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/comparison-functions/#function-less>less (\&lt;)</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/comparison-functions/#function-greater>greater (&gt;)</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/comparison-functions/#function-lessorequals>lessOrEquals (\&lt;=)</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/comparison-functions/#function-greaterorequals>greaterOrEquals (&gt;=)</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/array-functions/#function-empty>empty</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td><a href=../../../../sql-reference/functions/array-functions/#function-notempty>notEmpty</a></td> <td>✔</td> <td>✔</td> <td>✗</td> <td>✗</td> <td>✗</td> </tr> <tr> <td>hasToken</td> <td>✗</td> <td>✗</td> <td>✗</td> <td>✔</td> <td>✗</td> </tr> </tbody> </table> <p>常量参数小于 ngram 大小的函数不能使用 <code class=syntax>ngrambf_v1</code> 进行查询优化。</p> <div class="admonition note alert pb-0 mb-4 alert-primary" role=alert> <p class="admonition-title alert-heading display-6 mb-2">注意</p> </div> <p>布隆过滤器可能会包含不符合条件的匹配，所以 <code class=syntax>ngrambf_v1</code>, <code class=syntax>tokenbf_v1</code> 和 <code class=syntax>bloom_filter</code> 索引不能用于负向的函数，例如：</p> <ul> <li>可以用来优化的场景<ul> <li><code class=syntax>s LIKE '%test%'</code></li> <li><code class=syntax>NOT s NOT LIKE '%test%'</code></li> <li><code class=syntax>s = 1</code></li> <li><code class=syntax>NOT s != 1</code></li> <li><code class=syntax>startsWith(s, 'test')</code></li> </ul> </li> <li>不能用来优化的场景<ul> <li><code class=syntax>NOT s LIKE '%test%'</code></li> <li><code class=syntax>s NOT LIKE '%test%'</code></li> <li><code class=syntax>NOT s = 1</code></li> <li><code class=syntax>s != 1</code></li> <li><code class=syntax>NOT startsWith(s, 'test')</code></li> </ul> </li> </ul> <h2 id=concurrent-data-access>并发数据访问<a class=headerlink href=#concurrent-data-access title="Permanent link"> </a></h2> <p>应对表的并发访问，我们使用多版本机制。换言之，当同时读和更新表时，数据从当前查询到的一组片段中读取。没有冗长的的锁。插入不会阻碍读取。</p> <p>对表的读操作是自动并行的。</p> <h2 id=table_engine-mergetree-ttl>列和表的 TTL<a class=headerlink href=#table_engine-mergetree-ttl title="Permanent link"> </a></h2> <p>TTL 可以设置值的生命周期，它既可以为整张表设置，也可以为每个列字段单独设置。表级别的 TTL 还会指定数据在磁盘和卷上自动转移的逻辑。</p> <p>TTL 表达式的计算结果必须是 <a href=./ >日期</a> 或 <a href=./ >日期时间</a> 类型的字段。</p> <p>示例：</p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>TTL</span> <span class=n>time_column</span>
<span class=n>TTL</span> <span class=n>time_column</span> <span class=o>+</span> <span class=nb>interval</span>
</code></pre></div> <p>要定义<code class=syntax>interval</code>, 需要使用 <a href=./#operators-datetime>时间间隔</a> 操作符。</p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>TTL</span> <span class=n>date_time</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span>
<span class=n>TTL</span> <span class=n>date_time</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>15</span> <span class=n>HOUR</span>
</code></pre></div> <h3 id=mergetree-column-ttl>列 TTL<a class=headerlink href=#mergetree-column-ttl title="Permanent link"> </a></h3> <p>当列中的值过期时, ClickHouse会将它们替换成该列数据类型的默认值。如果数据片段中列的所有值均已过期，则ClickHouse 会从文件系统中的数据片段中删除此列。</p> <p><code class=syntax>TTL</code>子句不能被用于主键字段。</p> <p>示例:</p> <p>创建表时指定 <code class=syntax>TTL</code></p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>example_table</span>
<span class=p>(</span>
    <span class=n>d</span> <span class=n>DateTime</span><span class=p>,</span>
    <span class=n>a</span> <span class=nb>Int</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span><span class=p>,</span>
    <span class=n>b</span> <span class=nb>Int</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span><span class=p>,</span>
    <span class=k>c</span> <span class=n>String</span>
<span class=p>)</span>
<span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span>
<span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>toYYYYMM</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
<span class=k>ORDER</span> <span class=k>BY</span> <span class=n>d</span><span class=p>;</span>
</code></pre></div> <p>为表中已存在的列字段添加 <code class=syntax>TTL</code></p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>ALTER</span> <span class=k>TABLE</span> <span class=n>example_table</span>
    <span class=k>MODIFY</span> <span class=k>COLUMN</span>
    <span class=k>c</span> <span class=n>String</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>DAY</span><span class=p>;</span>
</code></pre></div> <p>修改列字段的 <code class=syntax>TTL</code></p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>ALTER</span> <span class=k>TABLE</span> <span class=n>example_table</span>
    <span class=k>MODIFY</span> <span class=k>COLUMN</span>
    <span class=k>c</span> <span class=n>String</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span><span class=p>;</span>
</code></pre></div> <h3 id=mergetree-table-ttl>表 TTL<a class=headerlink href=#mergetree-table-ttl title="Permanent link"> </a></h3> <p>表可以设置一个用于移除过期行的表达式，以及多个用于在磁盘或卷上自动转移数据片段的表达式。当表中的行过期时，ClickHouse 会删除所有对应的行。对于数据片段的转移特性，必须所有的行都满足转移条件。</p> <div class=codehilite><pre><span></span><code class=syntax><span class=n>TTL</span> <span class=n>expr</span> <span class=p>[</span><span class=k>DELETE</span><span class=o>|</span><span class=k>TO</span> <span class=n>DISK</span> <span class=s1>'aaa'</span><span class=o>|</span><span class=k>TO</span> <span class=n>VOLUME</span> <span class=s1>'bbb'</span><span class=p>],</span> <span class=p>...</span>
</code></pre></div> <p>TTL 规则的类型紧跟在每个 TTL 表达式后面，它会影响满足表达式时（到达指定时间时）应当执行的操作：</p> <ul> <li><code class=syntax>DELETE</code> - 删除过期的行（默认操作）;</li> <li><code class=syntax>TO DISK 'aaa'</code> - 将数据片段移动到磁盘 <code class=syntax>aaa</code>;</li> <li><code class=syntax>TO VOLUME 'bbb'</code> - 将数据片段移动到卷 <code class=syntax>bbb</code>.</li> </ul> <p>示例:</p> <p>创建时指定 TTL</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>example_table</span>
<span class=p>(</span>
    <span class=n>d</span> <span class=n>DateTime</span><span class=p>,</span>
    <span class=n>a</span> <span class=nb>Int</span>
<span class=p>)</span>
<span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span>
<span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>toYYYYMM</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
<span class=k>ORDER</span> <span class=k>BY</span> <span class=n>d</span>
<span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>MONTH</span> <span class=p>[</span><span class=k>DELETE</span><span class=p>],</span>
    <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=n>WEEK</span> <span class=k>TO</span> <span class=n>VOLUME</span> <span class=s1>'aaa'</span><span class=p>,</span>
    <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>2</span> <span class=n>WEEK</span> <span class=k>TO</span> <span class=n>DISK</span> <span class=s1>'bbb'</span><span class=p>;</span>
</code></pre></div> <p>修改表的 <code class=syntax>TTL</code></p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>ALTER</span> <span class=k>TABLE</span> <span class=n>example_table</span>
    <span class=k>MODIFY</span> <span class=n>TTL</span> <span class=n>d</span> <span class=o>+</span> <span class=nb>INTERVAL</span> <span class=mi>1</span> <span class=k>DAY</span><span class=p>;</span>
</code></pre></div> <p><strong>删除数据</strong></p> <p>ClickHouse 在数据片段合并时会删除掉过期的数据。</p> <p>当ClickHouse发现数据过期时, 它将会执行一个计划外的合并。要控制这类合并的频率, 你可以设置 <code class=syntax>merge_with_ttl_timeout</code>。如果该值被设置的太低, 它将引发大量计划外的合并，这可能会消耗大量资源。</p> <p>如果在合并的过程中执行 <code class=syntax>SELECT</code> 查询, 则可能会得到过期的数据。为了避免这种情况，可以在 <code class=syntax>SELECT</code> 之前使用 <a href=./#misc_operations-optimize>OPTIMIZE</a> 查询。</p> <h2 id=table_engine-mergetree-multiple-volumes>使用具有多个块的设备进行数据存储<a class=headerlink href=#table_engine-mergetree-multiple-volumes title="Permanent link"> </a></h2> <h3 id=introduction>介绍<a class=headerlink href=#introduction title="Permanent link"> </a></h3> <p>MergeTree 系列表引擎可以将数据存储在多块设备上。这对某些可以潜在被划分为“冷”“热”的表来说是很有用的。近期数据被定期的查询但只需要很小的空间。相反，详尽的历史数据很少被用到。如果有多块磁盘可用，那么“热”的数据可以放置在快速的磁盘上（比如 NVMe 固态硬盘或内存），“冷”的数据可以放在相对较慢的磁盘上（比如机械硬盘）。</p> <p>数据片段是 <code class=syntax>MergeTree</code> 引擎表的最小可移动单元。属于同一个数据片段的数据被存储在同一块磁盘上。数据片段会在后台自动的在磁盘间移动，也可以通过 <a href=../../../../sql-reference/statements/alter/#alter_move-partition>ALTER</a> 查询来移动。</p> <h3 id=terms>术语<a class=headerlink href=#terms title="Permanent link"> </a></h3> <ul> <li>磁盘 — 挂载到文件系统的块设备</li> <li>默认磁盘 — 在服务器设置中通过 <a href=../../../../operations/server-configuration-parameters/settings/#server_configuration_parameters-path>path</a> 参数指定的数据存储</li> <li>卷 — 磁盘的等效有序集合 （类似于 <a href=https://en.wikipedia.org/wiki/Non-RAID_drive_architectures rel="external nofollow noreferrer" target=_blank>JBOD</a>）</li> <li>存储策略 — 卷的集合及他们之间的数据移动规则</li> </ul> <h3 id=table_engine-mergetree-multiple-volumes_configure>配置<a class=headerlink href=#table_engine-mergetree-multiple-volumes_configure title="Permanent link"> </a></h3> <p>磁盘、卷和存储策略应当在主文件 <code class=syntax>config.xml</code> 或 <code class=syntax>config.d</code> 目录中的独立文件中的 <code class=syntax>&lt;storage_configuration&gt;</code> 标签内定义。</p> <p>配置结构：</p> <div class=codehilite><pre><span></span><code class=syntax><span class=nt>&lt;storage_configuration&gt;</span>
    <span class=nt>&lt;disks&gt;</span>
        <span class=nt>&lt;disk_name_1&gt;</span> <span class=c>&lt;!-- disk name --&gt;</span>
            <span class=nt>&lt;path&gt;</span>/mnt/fast_ssd/clickhouse/<span class=nt>&lt;/path&gt;</span>
        <span class=nt>&lt;/disk_name_1&gt;</span>
        <span class=nt>&lt;disk_name_2&gt;</span>
            <span class=nt>&lt;path&gt;</span>/mnt/hdd1/clickhouse/<span class=nt>&lt;/path&gt;</span>
            <span class=nt>&lt;keep_free_space_bytes&gt;</span>10485760<span class=nt>&lt;/keep_free_space_bytes&gt;</span>
        <span class=nt>&lt;/disk_name_2&gt;</span>
        <span class=nt>&lt;disk_name_3&gt;</span>
            <span class=nt>&lt;path&gt;</span>/mnt/hdd2/clickhouse/<span class=nt>&lt;/path&gt;</span>
            <span class=nt>&lt;keep_free_space_bytes&gt;</span>10485760<span class=nt>&lt;/keep_free_space_bytes&gt;</span>
        <span class=nt>&lt;/disk_name_3&gt;</span>

        ...
    <span class=nt>&lt;/disks&gt;</span>

    ...
<span class=nt>&lt;/storage_configuration&gt;</span>
</code></pre></div> <p>标签：</p> <ul> <li><code class=syntax>&lt;disk_name_N&gt;</code> — 磁盘名，名称必须与其他磁盘不同.</li> <li><code class=syntax>path</code> — 服务器将用来存储数据 (<code class=syntax>data</code> 和 <code class=syntax>shadow</code> 目录) 的路径, 应当以 ‘/’ 结尾.</li> <li><code class=syntax>keep_free_space_bytes</code> — 需要保留的剩余磁盘空间.</li> </ul> <p>磁盘定义的顺序无关紧要。</p> <p>存储策略配置：</p> <div class=codehilite><pre><span></span><code class=syntax><span class=nt>&lt;storage_configuration&gt;</span>
    ...
    <span class=nt>&lt;policies&gt;</span>
        <span class=nt>&lt;policy_name_1&gt;</span>
            <span class=nt>&lt;volumes&gt;</span>
                <span class=nt>&lt;volume_name_1&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>disk_name_from_disks_configuration<span class=nt>&lt;/disk&gt;</span>
                    <span class=nt>&lt;max_data_part_size_bytes&gt;</span>1073741824<span class=nt>&lt;/max_data_part_size_bytes&gt;</span>
                <span class=nt>&lt;/volume_name_1&gt;</span>
                <span class=nt>&lt;volume_name_2&gt;</span>
                    <span class=c>&lt;!-- configuration --&gt;</span>
                <span class=nt>&lt;/volume_name_2&gt;</span>
                <span class=c>&lt;!-- more volumes --&gt;</span>
            <span class=nt>&lt;/volumes&gt;</span>
            <span class=nt>&lt;move_factor&gt;</span>0.2<span class=nt>&lt;/move_factor&gt;</span>
        <span class=nt>&lt;/policy_name_1&gt;</span>
        <span class=nt>&lt;policy_name_2&gt;</span>
            <span class=c>&lt;!-- configuration --&gt;</span>
        <span class=nt>&lt;/policy_name_2&gt;</span>

        <span class=c>&lt;!-- more policies --&gt;</span>
    <span class=nt>&lt;/policies&gt;</span>
    ...
<span class=nt>&lt;/storage_configuration&gt;</span>
</code></pre></div> <p>标签：</p> <ul> <li><code class=syntax>policy_name_N</code> — 策略名称，不能重复。</li> <li><code class=syntax>volume_name_N</code> — 卷名称，不能重复。</li> <li><code class=syntax>disk</code> — 卷中的磁盘。</li> <li><code class=syntax>max_data_part_size_bytes</code> — 任意卷上的磁盘可以存储的数据片段的最大大小。</li> <li><code class=syntax>move_factor</code> — 当可用空间少于这个因子时，数据将自动的向下一个卷（如果有的话）移动 (默认值为 0.1)。</li> </ul> <p>配置示例：</p> <div class=codehilite><pre><span></span><code class=syntax><span class=nt>&lt;storage_configuration&gt;</span>
    ...
    <span class=nt>&lt;policies&gt;</span>
        <span class=nt>&lt;hdd_in_order&gt;</span> <span class=c>&lt;!-- policy name --&gt;</span>
            <span class=nt>&lt;volumes&gt;</span>
                <span class=nt>&lt;single&gt;</span> <span class=c>&lt;!-- volume name --&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>disk1<span class=nt>&lt;/disk&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>disk2<span class=nt>&lt;/disk&gt;</span>
                <span class=nt>&lt;/single&gt;</span>
            <span class=nt>&lt;/volumes&gt;</span>
        <span class=nt>&lt;/hdd_in_order&gt;</span>

        <span class=nt>&lt;moving_from_ssd_to_hdd&gt;</span>
            <span class=nt>&lt;volumes&gt;</span>
                <span class=nt>&lt;hot&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>fast_ssd<span class=nt>&lt;/disk&gt;</span>
                    <span class=nt>&lt;max_data_part_size_bytes&gt;</span>1073741824<span class=nt>&lt;/max_data_part_size_bytes&gt;</span>
                <span class=nt>&lt;/hot&gt;</span>
                <span class=nt>&lt;cold&gt;</span>
                    <span class=nt>&lt;disk&gt;</span>disk1<span class=nt>&lt;/disk&gt;</span>
                <span class=nt>&lt;/cold&gt;</span>
            <span class=nt>&lt;/volumes&gt;</span>
            <span class=nt>&lt;move_factor&gt;</span>0.2<span class=nt>&lt;/move_factor&gt;</span>
        <span class=nt>&lt;/moving_from_ssd_to_hdd&gt;</span>
    <span class=nt>&lt;/policies&gt;</span>
    ...
<span class=nt>&lt;/storage_configuration&gt;</span>
</code></pre></div> <p>在给出的例子中， <code class=syntax>hdd_in_order</code> 策略实现了 <a href=https://zh.wikipedia.org/wiki/循环制 rel="external nofollow noreferrer" target=_blank>循环制</a> 方法。因此这个策略只定义了一个卷（<code class=syntax>single</code>），数据片段会以循环的顺序全部存储到它的磁盘上。当有多个类似的磁盘挂载到系统上，但没有配置 RAID 时，这种策略非常有用。请注意一个每个独立的磁盘驱动都并不可靠，你可能需要用 3 或更大的复制因此来补偿它。</p> <p>如果在系统中有不同类型的磁盘可用，可以使用 <code class=syntax>moving_from_ssd_to_hdd</code>。<code class=syntax>hot</code> 卷由 SSD 磁盘（<code class=syntax>fast_ssd</code>）组成，这个卷上可以存储的数据片段的最大大小为 1GB。所有大于 1GB 的数据片段都会被直接存储到 <code class=syntax>cold</code> 卷上，<code class=syntax>cold</code> 卷包含一个名为 <code class=syntax>disk1</code> 的 HDD 磁盘。<br> 同样，一旦 <code class=syntax>fast_ssd</code> 被填充超过 80%，数据会通过后台进程向 <code class=syntax>disk1</code> 进行转移。</p> <p>存储策略中卷的枚举顺序是很重要的。因为当一个卷被充满时，数据会向下一个卷转移。磁盘的枚举顺序同样重要，因为数据是依次存储在磁盘上的。</p> <p>在创建表时，可以将一个配置好的策略应用到表：</p> <div class=codehilite><pre><span></span><code class=syntax><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>table_with_non_default_policy</span> <span class=p>(</span>
    <span class=n>EventDate</span> <span class=nb>Date</span><span class=p>,</span>
    <span class=n>OrderID</span> <span class=n>UInt64</span><span class=p>,</span>
    <span class=n>BannerID</span> <span class=n>UInt64</span><span class=p>,</span>
    <span class=n>SearchPhrase</span> <span class=n>String</span>
<span class=p>)</span> <span class=n>ENGINE</span> <span class=o>=</span> <span class=n>MergeTree</span>
<span class=k>ORDER</span> <span class=k>BY</span> <span class=p>(</span><span class=n>OrderID</span><span class=p>,</span> <span class=n>BannerID</span><span class=p>)</span>
<span class=n>PARTITION</span> <span class=k>BY</span> <span class=n>toYYYYMM</span><span class=p>(</span><span class=n>EventDate</span><span class=p>)</span>
<span class=n>SETTINGS</span> <span class=n>storage_policy</span> <span class=o>=</span> <span class=s1>'moving_from_ssd_to_hdd'</span>
</code></pre></div> <p><code class=syntax>default</code> 存储策略意味着只使用一个卷，这个卷只包含一个在 <code class=syntax>&lt;path&gt;</code> 中定义的磁盘。表创建后，它的存储策略就不能改变了。</p> <p>可以通过 <a href=../../../../operations/settings/settings/#background_move_pool_size>background_move_pool_size</a> 设置调整执行后台任务的线程数。</p> <h3 id=details>详细说明<a class=headerlink href=#details title="Permanent link"> </a></h3> <p>对于 <code class=syntax>MergeTree</code> 表，数据通过以下不同的方式写入到磁盘当中：</p> <ul> <li>作为插入（<code class=syntax>INSERT</code>查询）的结果</li> <li>在后台合并和<a href=../../../../sql-reference/statements/alter/#alter-mutations>数据变异</a>期间</li> <li>当从另一个副本下载时</li> <li>作为 <a href=../../../../sql-reference/statements/alter/#alter_freeze-partition>ALTER TABLE … FREEZE PARTITION</a> 冻结分区的结果</li> </ul> <p>除了数据变异和冻结分区以外的情况下，数据按照以下逻辑存储到卷或磁盘上：</p> <ol> <li>首个卷（按定义顺序）拥有足够的磁盘空间存储数据片段（<code class=syntax>unreserved_space &gt; current_part_size</code>）并且允许存储给定数据片段的大小（<code class=syntax>max_data_part_size_bytes &gt; current_part_size</code>）</li> <li>在这个数据卷内，紧挨着先前存储数据的那块磁盘之后的磁盘，拥有比数据片段大的剩余空间。（<code class=syntax>unreserved_space - keep_free_space_bytes &gt; current_part_size</code>）</li> </ol> <p>更进一步，数据变异和分区冻结使用的是 <a href=https://en.wikipedia.org/wiki/Hard_link rel="external nofollow noreferrer" target=_blank>硬链接</a>。不同磁盘之间的硬链接是不支持的，所以在这种情况下数据片段都会被存储到初始化的那一块磁盘上。</p> <p>在后台，数据片段基于剩余空间（<code class=syntax>move_factor</code>参数）根据卷在配置文件中定义的顺序进行转移。数据永远不会从最后一个移出也不会从第一个移入。可以通过系统表 <a href=../../../../operations/system-tables/part_log/#system_tables-part-log>system.part_log</a> (字段 <code class=syntax>type = MOVE_PART</code>) 和 <a href=../../../../operations/system-tables/parts/#system_tables-parts>system.parts</a> (字段 <code class=syntax>path</code> 和 <code class=syntax>disk</code>) 来监控后台的移动情况。同时，具体细节可以通过服务器日志查看。</p> <p>用户可以通过 <a href=../../../../sql-reference/statements/alter/#alter_move-partition>ALTER TABLE … MOVE PART|PARTITION … TO VOLUME|DISK …</a> 强制移动一个数据片段或分区到另外一个卷，所有后台移动的限制都会被考虑在内。这个查询会自行启动，无需等待后台操作完成。如果没有足够的可用空间或任何必须条件没有被满足，用户会收到报错信息。</p> <p>数据移动不会妨碍到数据复制。也就是说，同一张表的不同副本可以指定不同的存储策略。</p> <p>在后台合并和数据变异之后，就的数据片段会在一定时间后被移除 (<code class=syntax>old_parts_lifetime</code>)。在这期间，他们不能被移动到其他的卷或磁盘。也就是说，直到数据片段被完全移除，它们仍然会被磁盘占用空间计算在内。</p> <p><a href=https://clickhouse.tech/docs/en/operations/table_engines/mergetree/ target=_blank>原始文章</a> <!--hide--></p> </div> <div class="alert alert-light my-3"> <p class="float-right mb-0">Rating: RATING_VALUE - RATING_COUNT votes</p> <span class="alert-heading display-6">Was this content helpful?</span> <div id=rating-stars class="display-6 mb-0" data-titles="['Unusable', 'Poor', 'OK', 'Good', 'Excellent']" data-documentation=documentation>RATING_STARS</div> </div> <div id=content-footer class="text-muted pt-3 mb-5"> <div class=float-md-right>©2016–2020 Yandex LLC</div> <div>Built from <a href=https://github.com/ClickHouse/ClickHouse/commit/b030bfedd7db4603034643fd183cf7784a820193 rel="external nofollow noreferrer" target=_blank class=text-reset>b030bfedd7</a> </div> </div> </div> <div id=toc class="col-xl-2 d-none d-xl-block d-print-none p-3 overflow-auto toc-right mb-5"> <nav class="nav flex-column text-wrap"> <label for=toc>Table of Contents</label> <a href=#table_engine-mergetree-creating-a-table title=建表 class="nav-link text-wrap d-inline-block w-100"> 建表 </a> <a href=#mergetree-data-storage title=数据存储 class="nav-link text-wrap d-inline-block w-100"> 数据存储 </a> <a href=#primary-keys-and-indexes-in-queries title=主键和索引在查询中的表现 class="nav-link text-wrap d-inline-block w-100"> 主键和索引在查询中的表现 </a> <nav id=toc-toc-3 class="nav flex-column pl-2"> <a href=#zhu-jian-de-xuan-ze title=主键的选择 class="nav-link text-wrap d-inline-block w-100"> 主键的选择 </a> <a href=#choosing-a-primary-key-that-differs-from-the-sorting-key title=选择与排序键不同主键 class="nav-link text-wrap d-inline-block w-100"> 选择与排序键不同主键 </a> <a href=#use-of-indexes-and-partitions-in-queries title=索引和分区在查询中的应用 class="nav-link text-wrap d-inline-block w-100"> 索引和分区在查询中的应用 </a> <a href=#bu-fen-dan-diao-zhu-jian-de-shi-yong title=部分单调主键的使用 class="nav-link text-wrap d-inline-block w-100"> 部分单调主键的使用 </a> <a href=#tiao-shu-suo-yin-fen-duan-hui-zong-suo-yin-shi-yan-xing-de title=跳数索引 class="nav-link text-wrap d-inline-block w-100"> 跳数索引 </a> <nav id=toc-toc-3-5 class="nav flex-column pl-2"> <a href=#table_engine-mergetree-data_skipping-indexes title=索引的可用类型 class="nav-link text-wrap d-inline-block w-100"> 索引的可用类型 </a> <a href=#functions-support title=函数支持 class="nav-link text-wrap d-inline-block w-100"> 函数支持 </a> </nav> </nav> <a href=#concurrent-data-access title=并发数据访问 class="nav-link text-wrap d-inline-block w-100"> 并发数据访问 </a> <a href=#table_engine-mergetree-ttl title="列和表的 TTL" class="nav-link text-wrap d-inline-block w-100"> 列和表的 TTL </a> <nav id=toc-toc-5 class="nav flex-column pl-2"> <a href=#mergetree-column-ttl title="列 TTL" class="nav-link text-wrap d-inline-block w-100"> 列 TTL </a> <a href=#mergetree-table-ttl title="表 TTL" class="nav-link text-wrap d-inline-block w-100"> 表 TTL </a> </nav> <a href=#table_engine-mergetree-multiple-volumes title=使用具有多个块的设备进行数据存储 class="nav-link text-wrap d-inline-block w-100"> 使用具有多个块的设备进行数据存储 </a> <nav id=toc-toc-6 class="nav flex-column pl-2"> <a href=#introduction title=介绍 class="nav-link text-wrap d-inline-block w-100"> 介绍 </a> <a href=#terms title=术语 class="nav-link text-wrap d-inline-block w-100"> 术语 </a> <a href=#table_engine-mergetree-multiple-volumes_configure title=配置 class="nav-link text-wrap d-inline-block w-100"> 配置 </a> <a href=#details title=详细说明 class="nav-link text-wrap d-inline-block w-100"> 详细说明 </a> </nav> </nav> </div> </div> </div> <script async type=text/javascript src=/js/base.js?00223b07></script> <noscript> <div><img src=https://mc.yandex.ru/watch/18343495 alt=Yandex></div> </noscript> </body> </html>